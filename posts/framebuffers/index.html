<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Framebuffers | Project F: FPGA Dev</title>

<meta property='og:title' content='Framebuffers - Project F: FPGA Dev'>
<meta property='og:description' content='Welcome back to Exploring FPGA Graphics. In the previous part, we worked with sprites, but another approach is needed as graphics become more complex. Instead of drawing directly to the screen, we draw to a framebuffer, which is read out to the screen. This post provides an introduction to framebuffers and how to scale them up. We&rsquo;ll also learn how to fizzlefade graphics Wolfenstein 3D style. This post was last updated in July 2022.'>
<meta property='og:url' content='https://projectf.io/posts/framebuffers/'>
<meta property='og:site_name' content='Project F: FPGA Dev'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/framebuffers/social-card.png'><meta property='article:published_time' content='2020-10-30T00:00:00Z'><meta property='article:modified_time' content='2022-07-25T00:00:00Z'><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F: FPGA Dev">

<link rel="stylesheet" href="/css/style.css"><link rel='stylesheet' href='https://projectf.io/css/custom.css'>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/framebuffers/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F: FPGA Dev</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf/projf-explore'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/user/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/boards">
          <h2 class="title is-5">Boards</h2>
        </a><a class="nav-item" href="/demos">
          <h2 class="title is-5">Demos</h2>
        </a><a class="nav-item" href="/howto">
          <h2 class="title is-5">How To</h2>
        </a><a class="nav-item" href="/tags/news">
          <h2 class="title is-5">News</h2>
        </a><a class="nav-item" href="/tutorials">
          <h2 class="title is-5">Tutorials</h2>
        </a><a class="nav-item" href="/verilog-lib">
          <h2 class="title is-5">Verilog Lib</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/graphics/">#graphics</a>




      
    </div>
    <h2 class="subtitle is-6">30 October 2020</h2>
    <h1 class="title">Framebuffers</h1>
    
    <div class="content">
      <p>Welcome back to <em>Exploring FPGA Graphics</em>. In the previous part, we worked with sprites, but another approach is needed as graphics become more complex. Instead of drawing directly to the screen, we draw to a framebuffer, which is read out to the screen. This post provides an introduction to framebuffers and how to scale them up. We&rsquo;ll also learn how to fizzlefade graphics Wolfenstein 3D style. This post was last updated in July 2022.</p>
<p><strong>July 2022 update: draft revised post - additional content will be added soon.</strong></p>
<p>In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series? Start with <a href="/posts/fpga-graphics/">Beginning FPGA Graphics</a>.</p>
<p><em>Get in touch: <a href="https://github.com/projf/projf-explore/issues">GitHub Issues</a>, <a href="https://1bitsquared.com/pages/chat">1BitSquared Discord</a>, <a href="https://mastodon.social/@WillFlux">@WillFlux</a> (Mastodon), <a href="https://twitter.com/WillFlux">@WillFlux</a> (Twitter)</em></p>
<p><img src="/img/posts/framebuffers/banner.png" alt="" title=""></p>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li><a href="/posts/fpga-graphics/">Beginning FPGA Graphics</a> - video signals and basic graphics</li>
<li><a href="/posts/racing-the-beam/">Racing the Beam</a> - simple demos with minimal logic</li>
<li><a href="/posts/fpga-pong/">FPGA Pong</a> - recreate the classic arcade on an FPGA</li>
<li><a href="/posts/display-signals/">Display Signals</a> - revisit display signals and meet colour palettes</li>
<li><a href="/posts/hardware-sprites/">Hardware Sprites</a> - fast, colourful graphics for games</li>
<li>Framebuffers (this post) - bitmap graphics featuring Michelangelo&rsquo;s David</li>
<li><a href="/posts/lines-and-triangles/">Lines and Triangles</a> - drawing lines and triangles</li>
<li><a href="/posts/fpga-shapes/">2D Shapes</a> - filled shapes and simple pictures</li>
<li><a href="/posts/animated-shapes/">Animated Shapes</a> - animation and double-buffering</li>
</ul>
<blockquote>
<p><strong>Sponsor My Work</strong><br>
If you like what I do, consider <a href="https://github.com/sponsors/WillGreen">sponsoring me</a> on GitHub.<br>
I love FPGAs and want to help more people discover and use them in their projects.<br>
My hardware designs are open source, and my blog is advert free.</p>
</blockquote>
<h3 id="requirements">Requirements</h3>
<p>You should be to run these designs to any recent FPGA board. I include complete designs for the <a href="https://docs.icebreaker-fpga.org/hardware/icebreaker/">iCEBreaker</a> with <a href="https://docs.icebreaker-fpga.org/hardware/pmod/dvi/">12-Bit DVI Pmod</a>, <a href="https://digilent.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a> with <a href="https://digilent.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a>, and <a href="/posts/verilog-sim-verilator-sdl/">Verilator Simulation with SDL</a>. See <a href="/posts/fpga-graphics/#requirements">requirements</a> from <em>Beginning FPGA Graphics</em> for more details.</p>
<h2 id="framebuffer">Framebuffer</h2>
<p>A framebuffer is an in-memory bitmap that drives pixels on the screen. When you write to a memory location within the framebuffer, the corresponding pixel will change on the screen. Using a framebuffer provides two big benefits: we&rsquo;re free to create sophisticated graphics using whatever technique we like, and the setting of pixel colour is separated from the process of driving the screen. The flexibility of a framebuffer comes at the cost of increased memory storage.</p>
<h3 id="a-little-buffer">A Little Buffer</h3>
<p>A framebuffer requires enough memory to hold the complete frame. To keep things simple, we&rsquo;ll store our framebuffer in internal FPGA block memory (BRAM). The iCEBreaker&rsquo;s iCE40 FPGA is the smallest and has 120 kb of BRAM, so that&rsquo;s what we&rsquo;ll target in this post.</p>
<p>To keep the buffer memory size small, we use a low resolution and few bits for each pixel.</p>
<p>If we divide our 640x480 screen by four, we get 160x120, which has 19,200 pixels.</p>
<p>With one bit per pixel, we can use two colours, and the buffer requires 19,200 bits (18.75 kb).</p>
<p>With four bits per pixel, we can use 16 colours, and the buffer requires 76,800 bits (75 kb).</p>
<h3 id="a-little-bitmap">A Little Bitmap</h3>
<p><img src="/img/posts/framebuffers/david-comparison.png" alt="Michelangelo&amp;rsquo;s David" title="David is a masterpiece of Renaissance sculpture created in marble between 1501 and 1504 by the Italian artist Michelangelo."></p>
<p>A small monochrome framebuffer calls for a striking image: I&rsquo;ve chosen <a href="https://en.wikipedia.org/wiki/David_(Michelangelo)">David by Michelangelo</a>.</p>
<p>The version on the right is the <a href="https://commons.wikimedia.org/wiki/File:Michelangelo%27s_David_-_63_grijswaarden.png">original from Wikipedia</a>; it has 64 shades of grey. I created the middle image by reducing the original to 16 colours using <code>img2fmem</code> with no dithering (we&rsquo;ll discuss this tool later). The monochrome image on the left was created by <a href="https://commons.wikimedia.org/wiki/User:Gerbrant/Dithering_algorithms">Gerbrant</a> using <a href="https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering">Floyd-Steinberg dithering</a>.</p>
<h2 id="david-mono">David Mono</h2>
<p>Our first example loads a monochrome image of David into the framebuffer and displays it on screen. We use the same display signals and video output design from previous posts.</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/xc7/top_david_mono.sv">xc7/top_david_mono.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/ice40/top_david_mono.sv">ice40/top_david_mono.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/sim/top_david_mono.sv">sim/top_david_mono.sv</a></strong></li>
</ul>
<p>The Arty version is shown below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_david_mono (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst_n,    <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> rst_pix;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_100m,
</span></span><span style="display:flex;"><span>       .rst(<span style="color:#f92672">!</span>btn_rst_n),  <span style="color:#75715e">// reset button is active low
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_5x(),  <span style="color:#75715e">// not used for VGA output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) rst_pix <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">!</span>clk_pix_locked;  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;  <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de, frame;
</span></span><span style="display:flex;"><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de,
</span></span><span style="display:flex;"><span>        .frame,
</span></span><span style="display:flex;"><span>        .line()
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CHANW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;  <span style="color:#75715e">// colour channel width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer (FB)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">120</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_PIXELS <span style="color:#f92672">=</span> FB_WIDTH <span style="color:#f92672">*</span> FB_HEIGHT;  <span style="color:#75715e">// total pixels in buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_ADDRW  <span style="color:#f92672">=</span> $clog2(FB_PIXELS);  <span style="color:#75715e">// address width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_DATAW  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// colour bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_IMAGE  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;david_1bit.mem&#34;</span>;  <span style="color:#75715e">// bitmap file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam FB_IMAGE  = &#34;test_box_mono_160x120.mem&#34;;  // bitmap file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// pixel read address and colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_addr_read;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_colr_read;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bram_sdp #(
</span></span><span style="display:flex;"><span>        .WIDTH(FB_DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(FB_PIXELS),
</span></span><span style="display:flex;"><span>        .INIT_F(FB_IMAGE)
</span></span><span style="display:flex;"><span>    ) bram_inst (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(),
</span></span><span style="display:flex;"><span>        .addr_write(),
</span></span><span style="display:flex;"><span>        .addr_read(fb_addr_read),
</span></span><span style="display:flex;"><span>        .data_in(),
</span></span><span style="display:flex;"><span>        .data_out(fb_colr_read)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// calculate framebuffer read address for display output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LAT <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// read_fb+1, BRAM+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> read_fb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        read_fb <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> FB_HEIGHT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">-</span>LAT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH<span style="color:#f92672">-</span>LAT);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reset address at start of frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (read_fb) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// increment address in painting area
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> fb_addr_read <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint screen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> paint_area;  <span style="color:#75715e">// area of framebuffer to paint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;  <span style="color:#75715e">// colour channels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_area <span style="color:#f92672">=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> FB_HEIGHT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH);
</span></span><span style="display:flex;"><span>        {paint_r, paint_g, paint_b} <span style="color:#f92672">=</span> (paint_area <span style="color:#f92672">&amp;&amp;</span> fb_colr_read) <span style="color:#f92672">?</span> <span style="color:#ae81ff">12&#39;hFFF</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">12&#39;h000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// VGA Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
</span></span><span style="display:flex;"><span>        vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (de) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            vga_r <span style="color:#f92672">&lt;=</span> paint_r;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> paint_g;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> paint_b;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// VGA colour should be black in blanking interval
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            vga_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><blockquote>
<p><strong>Building the Designs</strong><br>
In the <a href="https://github.com/projf/projf-explore/tree/main/graphics/framebuffers">Framebuffers</a> section of the git repo, you&rsquo;ll find the design files, a makefile for iCEBreaker and Verilator, and a Vivado project for Arty. There are also build instructions for boards and simulations.</p>
</blockquote>
<p>Build the designs for your board or the Verilator sim then we&rsquo;ll discuss the design. You should see a small dithered David looking at you from the top-left of the screen.</p>
<p><img src="/img/posts/framebuffers/david_mono.png" alt="Dithered David - Verilator/SDL simulation on macOS" title="David is a masterpiece of Renaissance sculpture, created in marble between 1501 and 1504 by the Italian artist Michelangelo."></p>
<h3 id="framebuffer-memory">Framebuffer Memory</h3>
<p>The core of the framebuffer design is the memory. We use parameters to set the bitmap dimensions and colour bits, determining our buffer&rsquo;s depth and address width.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer (FB)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">120</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_PIXELS <span style="color:#f92672">=</span> FB_WIDTH <span style="color:#f92672">*</span> FB_HEIGHT;  <span style="color:#75715e">// total pixels in buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_ADDRW  <span style="color:#f92672">=</span> $clog2(FB_PIXELS);  <span style="color:#75715e">// address width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_DATAW  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// colour bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_IMAGE  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;david_1bit.mem&#34;</span>;  <span style="color:#75715e">// bitmap file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam FB_IMAGE  = &#34;test_box_mono_160x120.mem&#34;;  // bitmap file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// pixel read address and colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_addr_read;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_colr_read;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bram_sdp #(
</span></span><span style="display:flex;"><span>        .WIDTH(FB_DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(FB_PIXELS),
</span></span><span style="display:flex;"><span>        .INIT_F(FB_IMAGE)
</span></span><span style="display:flex;"><span>    ) bram_inst (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(),
</span></span><span style="display:flex;"><span>        .addr_write(),
</span></span><span style="display:flex;"><span>        .addr_read(fb_addr_read),
</span></span><span style="display:flex;"><span>        .data_in(),
</span></span><span style="display:flex;"><span>        .data_out(fb_colr_read)
</span></span><span style="display:flex;"><span>    );
</span></span></code></pre></div><p>You can find the BRAM module in the Verilog library: <strong>[<a href="https://github.com/projf/projf-explore/blob/main/lib/memory/bram_sdp.sv">lib/memory/bram_sdp.sv</a>]</strong>. This simple module <em>infers</em> block ram without you having to worry about the low-level implementation details.</p>
<p>The memory design has read and write ports, but we only read in david_mono. The bitmap image of David is loaded into BRAM as part of the initial FPGA device configuration.</p>
<p>We store the bitmap in a text file <strong>[<a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/res/david/david_1bit.mem">res/david/david_1bit.mem</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#75715e">// Project F: Framebuffers - David 160x120 Image (Monochrome)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Learn more at https://projectf.io/posts/framebuffers/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>....
</span></span></code></pre></div><h3 id="time-to-read">Time to Read</h3>
<p>We have our image in memory; we just need to know <em>when</em> to read each pixel.</p>
<p>Your first thought might be to calculate the memory address directly from the screen coordinates, such as: <code>fb_addr_read = sy * FB_WIDTH + sx</code>. While superficially appealing, this approach ties the memory clock directly to the pixel clock, limiting our flexibility and efficiency. How would we handle memory latency? How would we share memory access with a CPU?</p>
<p>A better approach is to increment the memory address every time we need to read a pixel. No multiplication is required, and we can easily compensate for any latency:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// calculate framebuffer read address for display output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LAT <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// read_fb+1, BRAM+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> read_fb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        read_fb <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> FB_HEIGHT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">-</span>LAT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH<span style="color:#f92672">-</span>LAT);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reset address at start of frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (read_fb) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// increment address in painting area
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> fb_addr_read <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We define the area of the screen we want to paint with our image using the screen position <code>(sx,sy)</code> and the framebuffer height <code>FB_HEIGHT</code> and width <code>FB_WIDTH</code>. But we subtract the latency <code>LAT</code> from the horizontal position: one cycle allows for the calculation of <code>read_fb</code> and one cycle for the BRAM to return the data.</p>
<p>In this example, with <code>LAT = 2</code>, we have <code>sx &gt;= -2</code> and <code>sx &lt; 158</code>.</p>
<h4 id="latency-testing">Latency Testing</h4>
<p>It&rsquo;s easy to overlook latency in your design, rendering your framebuffer off by one or two pixels. To get the design right, I&rsquo;ve created a test image, <code>test_box_mono_160x120.mem</code>. The test image draws a single pixel around the edge of the framebuffer, making it straightforward to spot errors.</p>
<p>Try <code>test_box_mono</code> with different values for <code>LAT</code>; notice how the rendering of the box changes. If the image is too small to see clearly, don&rsquo;t worry, we&rsquo;ll be scaling it up shortly.</p>
<h3 id="painting-the-screen">Painting the Screen</h3>
<p>Using the pixel data from the framebuffer, we can decide when to draw a white pixel <code>12'hFFF</code> and when to draw black <code>12'h000</code>. Feel free to try your own colours.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// paint screen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> paint_area;  <span style="color:#75715e">// area of framebuffer to paint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;  <span style="color:#75715e">// colour channels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_area <span style="color:#f92672">=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> FB_HEIGHT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH);
</span></span><span style="display:flex;"><span>        {paint_r, paint_g, paint_b} <span style="color:#f92672">=</span> (paint_area <span style="color:#f92672">&amp;&amp;</span> fb_colr_read) <span style="color:#f92672">?</span> <span style="color:#ae81ff">12&#39;hFFF</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">12&#39;h000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><blockquote>
<p><strong>Combinational Painting?</strong><br>
We use combinational logic here to avoid latency correction on the display signals, such as <code>h_sync</code>. The design still easily passes timing, so I think this simplification is worthwhile.</p>
</blockquote>
<h2 id="david-grey">David Grey</h2>
<p>If we increase the number of bits per pixel to four, we can have 16 colours (or shades of grey). We store the colour index for each pixel and then look the colour up in a colour lookup table. We previously discussed colour lookup tables and indexed colour in <a href="/posts/display-signals/#a-refined-palette">Display Signals</a>.</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/xc7/top_david_16colr.sv">xc7/top_david_16colr.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/ice40/top_david_16colr.sv">ice40/top_david_16colr.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/sim/top_david_16colr.sv">sim/top_david_16colr.sv</a></strong></li>
</ul>
<p>The changed part of the design is shown below for Arty (other boards are very similar):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// bitmap images
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> BMAP_IMAGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;david.mem&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// localparam BMAP_IMAGE = &#34;test_box_160x120.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour palettes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> PAL_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey16_4b.mem&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// localparam PAL_FILE = &#34;greyinvert16_4b.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam PAL_FILE = &#34;sepia16_4b.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam PAL_FILE = &#34;sweetie16_4b.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CHANW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;        <span style="color:#75715e">// colour channel width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> COLRW <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>CHANW;  <span style="color:#75715e">// colour width: three channels (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CIDXW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;        <span style="color:#75715e">// colour index width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer (FB)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">120</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_PIXELS <span style="color:#f92672">=</span> FB_WIDTH <span style="color:#f92672">*</span> FB_HEIGHT;  <span style="color:#75715e">// total pixels in buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_ADDRW  <span style="color:#f92672">=</span> $clog2(FB_PIXELS);  <span style="color:#75715e">// address width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_DATAW  <span style="color:#f92672">=</span> CIDXW;  <span style="color:#75715e">// colour bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// pixel read address and colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_addr_read;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_colr_read;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bram_sdp #(
</span></span><span style="display:flex;"><span>        .WIDTH(FB_DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(FB_PIXELS),
</span></span><span style="display:flex;"><span>        .INIT_F(BMAP_IMAGE)
</span></span><span style="display:flex;"><span>    ) bram_inst (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(),
</span></span><span style="display:flex;"><span>        .addr_write(),
</span></span><span style="display:flex;"><span>        .addr_read(fb_addr_read),
</span></span><span style="display:flex;"><span>        .data_in(),
</span></span><span style="display:flex;"><span>        .data_out(fb_colr_read)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// calculate framebuffer read address for display output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LAT <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">// read_fb+1, BRAM+1, CLUT+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> read_fb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        read_fb <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> FB_HEIGHT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">-</span>LAT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH<span style="color:#f92672">-</span>LAT);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reset address at start of frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (read_fb) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// increment address in painting area
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> fb_addr_read <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour lookup table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [COLRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_pix_colr;
</span></span><span style="display:flex;"><span>    clut_simple #(
</span></span><span style="display:flex;"><span>        .COLRW(COLRW),
</span></span><span style="display:flex;"><span>        .CIDXW(CIDXW),
</span></span><span style="display:flex;"><span>        .F_PAL(PAL_FILE)
</span></span><span style="display:flex;"><span>        ) clut_instance (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_write(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_read(fb_colr_read),
</span></span><span style="display:flex;"><span>        .colr_in(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .colr_out(fb_pix_colr)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint screen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> paint_area;  <span style="color:#75715e">// area of framebuffer to paint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;  <span style="color:#75715e">// colour channels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_area <span style="color:#f92672">=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> FB_HEIGHT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH);
</span></span><span style="display:flex;"><span>        {paint_r, paint_g, paint_b} <span style="color:#f92672">=</span> paint_area <span style="color:#f92672">?</span> fb_pix_colr: <span style="color:#ae81ff">12&#39;h000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Looking up a colour in the colour lookup table takes a clock cycle, so we compensate by increasing the latency <code>LAT</code> to three cycles.</p>
<p>There is a coloured test image <code>test_box_160x120.mem</code> you can use to check for latency issues; it works best with <code>sweetie16_4b.mem</code> as the colour palette.</p>
<h3 id="colour-me-in">Colour Me In</h3>
<p>Try changing <code>PAL_FILE</code> to select one of the other palettes: I&rsquo;ve included four in the design.</p>
<p>With the <code>sepia16_4b</code> palette, the simulation looks like this:</p>
<p><img src="/img/posts/framebuffers/david_sepia.png" alt="Sepia David - Verilator/SDL simulation on macOS" title="David with squid ink?"></p>
<h2 id="scaling">Scaling</h2>
<p>Our David is disappointingly small: we want him to fill the screen. Not only that, but we want to scale our image while retaining our efficient memory access.</p>
<p>In scaling David up, we&rsquo;ll introduce a linebuffer <em>and</em> cross clock domains!</p>
<p><img src="/img/posts/framebuffers/david_scale.png" alt="Scaled David - Verilator/SDL simulation on macOS" title="Filling ur screen"></p>
<h2 id="linebuffer">Linebuffer</h2>
<p>Scaling up means repeating pixels, but it shouldn&rsquo;t mean repeating memory access. Scaling our 160x240 framebuffer up to 640x480 repeats each pixel 16 times.</p>
<p>Instead of outputting our framebuffer directly to the screen, we load each line of pixels into a buffer. Each pixel is read into the linebuffer once per frame but displayed as many times as needed. The linebuffer memory is read many times for each pixel, but its small and isolated from the rest of the memory system.</p>
<p>BRAM typically supports two ports, each of which can have its own clock frequency.</p>
<h3 id="linebuffer-module">Linebuffer Module</h3>
<p><em>Explanation being written&hellip;</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> linebuffer_simple #(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">parameter</span> DATAW<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>,  <span style="color:#75715e">// data width of each channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> LEN<span style="color:#f92672">=</span><span style="color:#ae81ff">640</span>,  <span style="color:#75715e">// length of line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SCALEW<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>  <span style="color:#75715e">// scale width (max scale == 2^SCALEW-1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_sys,   <span style="color:#75715e">// input clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_pix,   <span style="color:#75715e">// output clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> line,      <span style="color:#75715e">// line start (clk_pix)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> line_sys,  <span style="color:#75715e">// line start (clk_sys)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> en_in,     <span style="color:#75715e">// enable input (clk_sys)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> en_out,    <span style="color:#75715e">// enable output (clk_pix)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [SCALEW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] scale,   <span style="color:#75715e">// scale factor (&gt;=1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] data_in,  <span style="color:#75715e">// data in (clk_sys)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] data_out  <span style="color:#75715e">// data out (clk_pix)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// output data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(LEN)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] addr_out;  <span style="color:#75715e">// output address (pixel counter)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [SCALEW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_h;  <span style="color:#75715e">// horizontal scale counter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (en_out) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (cnt_h <span style="color:#f92672">==</span> scale<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                cnt_h <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (addr_out <span style="color:#f92672">!=</span> LEN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) addr_out <span style="color:#f92672">&lt;=</span> addr_out <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> cnt_h <span style="color:#f92672">&lt;=</span> cnt_h <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            addr_out <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            cnt_h <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// read data in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(LEN)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] addr_in;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> we;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (en_in) we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (addr_in <span style="color:#f92672">==</span> LEN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (we) addr_in <span style="color:#f92672">&lt;=</span> addr_in <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            addr_in <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bram_sdp #(
</span></span><span style="display:flex;"><span>        .WIDTH(DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(LEN)
</span></span><span style="display:flex;"><span>        ) bram_lb (
</span></span><span style="display:flex;"><span>        .clk_write(clk_sys),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we,
</span></span><span style="display:flex;"><span>        .addr_write(addr_in),
</span></span><span style="display:flex;"><span>        .addr_read(addr_out),
</span></span><span style="display:flex;"><span>        .data_in,
</span></span><span style="display:flex;"><span>        .data_out
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h2 id="clock-domains">Clock Domains</h2>
<p><em>Being written&hellip;</em></p>
<h2 id="scaled-design">Scaled Design</h2>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/xc7/top_david_scale.sv">xc7/top_david_scale.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/ice40/top_david_scale.sv">ice40/top_david_scale.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/sim/top_david_scale.sv">sim/top_david_scale.sv</a></strong></li>
</ul>
<p>The Arty version is shown below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_david_scale (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst_n,    <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate system clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_sys;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_sys_locked;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> rst_sys;
</span></span><span style="display:flex;"><span>    clock_sys clock_sys_inst (
</span></span><span style="display:flex;"><span>       .clk_100m,
</span></span><span style="display:flex;"><span>       .rst(<span style="color:#f92672">!</span>btn_rst_n),  <span style="color:#75715e">// reset button is active low
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_sys,
</span></span><span style="display:flex;"><span>       .clk_sys_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) rst_sys <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">!</span>clk_sys_locked;  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> rst_pix;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_100m,
</span></span><span style="display:flex;"><span>       .rst(<span style="color:#f92672">!</span>btn_rst_n),  <span style="color:#75715e">// reset button is active low
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_5x(),  <span style="color:#75715e">// not used for VGA output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) rst_pix <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">!</span>clk_pix_locked;  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;  <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de, frame, line;
</span></span><span style="display:flex;"><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de,
</span></span><span style="display:flex;"><span>        .frame,
</span></span><span style="display:flex;"><span>        .line
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// bitmap images
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> BMAP_IMAGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;david.mem&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// localparam BMAP_IMAGE = &#34;test_box_160x120.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour palettes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> PAL_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey16_4b.mem&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// localparam PAL_FILE = &#34;greyinvert16_4b.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam PAL_FILE = &#34;sepia16_4b.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam PAL_FILE = &#34;sweetie16_4b.mem&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CHANW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;        <span style="color:#75715e">// colour channel width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> COLRW <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>CHANW;  <span style="color:#75715e">// colour width: three channels (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CIDXW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;        <span style="color:#75715e">// colour index width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer (FB)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">120</span>;  <span style="color:#75715e">// framebuffer height in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_SCALE  <span style="color:#f92672">=</span>   <span style="color:#ae81ff">4</span>;  <span style="color:#75715e">// framebuffer display scale (1-63)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_PIXELS <span style="color:#f92672">=</span> FB_WIDTH <span style="color:#f92672">*</span> FB_HEIGHT;  <span style="color:#75715e">// total pixels in buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_ADDRW  <span style="color:#f92672">=</span> $clog2(FB_PIXELS);  <span style="color:#75715e">// address width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_DATAW  <span style="color:#f92672">=</span> CIDXW;  <span style="color:#75715e">// colour bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// pixel read address and colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_addr_read;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_colr_read;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bram_sdp #(
</span></span><span style="display:flex;"><span>        .WIDTH(FB_DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(FB_PIXELS),
</span></span><span style="display:flex;"><span>        .INIT_F(BMAP_IMAGE)
</span></span><span style="display:flex;"><span>    ) bram_inst (
</span></span><span style="display:flex;"><span>        .clk_write(clk_sys),
</span></span><span style="display:flex;"><span>        .clk_read(clk_sys),
</span></span><span style="display:flex;"><span>        .we(),
</span></span><span style="display:flex;"><span>        .addr_write(),
</span></span><span style="display:flex;"><span>        .addr_read(fb_addr_read),
</span></span><span style="display:flex;"><span>        .data_in(),
</span></span><span style="display:flex;"><span>        .data_out(fb_colr_read)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display flags in system clock domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> frame_sys, line_sys, line0_sys;
</span></span><span style="display:flex;"><span>    xd2 xd_frame (.clk_src(clk_pix),.clk_dst(clk_sys),
</span></span><span style="display:flex;"><span>        .flag_src(frame), .flag_dst(frame_sys));
</span></span><span style="display:flex;"><span>    xd2 xd_line  (.clk_src(clk_pix), .clk_dst(clk_sys),
</span></span><span style="display:flex;"><span>        .flag_src(line),  .flag_dst(line_sys));
</span></span><span style="display:flex;"><span>    xd2 xd_line0 (.clk_src(clk_pix), .clk_dst(clk_sys),
</span></span><span style="display:flex;"><span>        .flag_src(line <span style="color:#f92672">&amp;&amp;</span> sy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>), .flag_dst(line0_sys));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// count lines for scaling via linebuffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FB_SCALE)<span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_lb_line;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line0_sys) cnt_lb_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (line_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            cnt_lb_line <span style="color:#f92672">&lt;=</span> (cnt_lb_line <span style="color:#f92672">==</span> FB_SCALE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> cnt_lb_line <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// which screen lines need linebuffer?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lb_line;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line0_sys) lb_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// enable from sy==0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (frame_sys) lb_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// disable at frame start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// enable linebuffer input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lb_en_in;  <span style="color:#75715e">// enable linebuffer input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FB_WIDTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_lbx;  <span style="color:#75715e">// horizontal pixel counter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> lb_en_in <span style="color:#f92672">=</span> (lb_line <span style="color:#f92672">&amp;&amp;</span> cnt_lb_line <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> cnt_lbx <span style="color:#f92672">&lt;</span> FB_WIDTH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// calculate framebuffer read address for linebuffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line_sys) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reset horizontal counter at start of line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            cnt_lbx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (lb_en_in) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// increment address when LB enabled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> fb_addr_read <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            cnt_lbx <span style="color:#f92672">&lt;=</span> cnt_lbx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame_sys) fb_addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// reset address at frame start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// enable linebuffer output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lb_en_out;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> LB_LAT <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">// output latency compensation: lb_en_out+1, LB+1, CLUT+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        lb_en_out <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> (FB_HEIGHT <span style="color:#f92672">*</span> FB_SCALE)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">-</span>LB_LAT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> (FB_WIDTH <span style="color:#f92672">*</span> FB_SCALE) <span style="color:#f92672">-</span> LB_LAT);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display linebuffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb_colr_out;
</span></span><span style="display:flex;"><span>    linebuffer_simple #(
</span></span><span style="display:flex;"><span>        .DATAW(CIDXW),
</span></span><span style="display:flex;"><span>        .LEN(FB_WIDTH)
</span></span><span style="display:flex;"><span>    ) linebuffer_instance (
</span></span><span style="display:flex;"><span>        .clk_sys,
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .line,
</span></span><span style="display:flex;"><span>        .line_sys,
</span></span><span style="display:flex;"><span>        .en_in(lb_en_in),
</span></span><span style="display:flex;"><span>        .en_out(lb_en_out),
</span></span><span style="display:flex;"><span>        .scale(FB_SCALE),
</span></span><span style="display:flex;"><span>        .data_in(fb_colr_read),
</span></span><span style="display:flex;"><span>        .data_out(lb_colr_out)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour lookup table (CLUT)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [COLRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_pix_colr;
</span></span><span style="display:flex;"><span>    clut_simple #(
</span></span><span style="display:flex;"><span>        .COLRW(COLRW),
</span></span><span style="display:flex;"><span>        .CIDXW(CIDXW),
</span></span><span style="display:flex;"><span>        .F_PAL(PAL_FILE)
</span></span><span style="display:flex;"><span>        ) clut_instance (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_write(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_read(lb_colr_out),
</span></span><span style="display:flex;"><span>        .colr_in(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .colr_out(fb_pix_colr)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint screen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> paint_area;  <span style="color:#75715e">// area of screen to paint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;  <span style="color:#75715e">// colour channels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_area <span style="color:#f92672">=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> (FB_HEIGHT <span style="color:#f92672">*</span> FB_SCALE)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH <span style="color:#f92672">*</span> FB_SCALE);
</span></span><span style="display:flex;"><span>        {paint_r, paint_g, paint_b} <span style="color:#f92672">=</span> (de <span style="color:#f92672">&amp;&amp;</span> paint_area) <span style="color:#f92672">?</span> fb_pix_colr <span style="color:#f92672">:</span> <span style="color:#ae81ff">12&#39;h000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// VGA Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
</span></span><span style="display:flex;"><span>        vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (de) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            vga_r <span style="color:#f92672">&lt;=</span> paint_r;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> paint_g;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> paint_b;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// VGA colour should be black in blanking interval
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            vga_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h2 id="fizzle-fade">Fizzle Fade</h2>
<p>So far we&rsquo;ve only read our image: we&rsquo;ve not made any changes to it. We can use a linear-feedback shift register to fizzle fade our image.</p>
<p><em>Explanation being written&hellip;</em></p>
<p><img src="/img/posts/framebuffers/david_fizzle.png" alt="Fizzled David - Verilator/SDL simulation on macOS" title="Never fade away..."></p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/xc7/top_david_fizzle.sv">xc7/top_david_fizzle.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/ice40/top_david_fizzle.sv">ice40/top_david_fizzle.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/framebuffers/sim/top_david_fizzle.sv">sim/top_david_fizzle.sv</a></strong></li>
</ul>
<p>The iCEBreaker version looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_david_fizzle (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_12m,      <span style="color:#75715e">// 12 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_clk,      <span style="color:#75715e">// DVI pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_hsync,    <span style="color:#75715e">// DVI horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_vsync,    <span style="color:#75715e">// DVI vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_de,       <span style="color:#75715e">// DVI data enable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_r,  <span style="color:#75715e">// 4-bit DVI red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_g,  <span style="color:#75715e">// 4-bit DVI green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_b   <span style="color:#75715e">// 4-bit DVI blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// system clock is the same as pixel clock on iCE40
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_sys, rst_sys;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        clk_sys <span style="color:#f92672">=</span> clk_pix;
</span></span><span style="display:flex;"><span>        rst_sys <span style="color:#f92672">=</span> rst_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_12m,
</span></span><span style="display:flex;"><span>       .rst(btn_rst),
</span></span><span style="display:flex;"><span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// reset in pixel clock domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> rst_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> rst_pix <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>clk_pix_locked;  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;  <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de, frame, line;
</span></span><span style="display:flex;"><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de,
</span></span><span style="display:flex;"><span>        .frame,
</span></span><span style="display:flex;"><span>        .line
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// library resource path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LIB_RES <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../../../lib/res&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// bitmap images
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> BMAP_IMAGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../res/david/david.mem&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// localparam BMAP_IMAGE = {LIB_RES,&#34;/test/test_box_160x120.mem&#34;};
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour palettes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> PAL_FILE <span style="color:#f92672">=</span> {LIB_RES,<span style="color:#e6db74">&#34;/palettes/grey16_4b.mem&#34;</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// localparam PAL_FILE = {LIB_RES,&#34;/palettes/greyinvert16_4b.mem&#34;};
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam PAL_FILE = {LIB_RES,&#34;/palettes/sepia16_4b.mem&#34;};
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// localparam PAL_FILE = {LIB_RES,&#34;/palettes/sweetie16_4b.mem&#34;};
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CHANW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;        <span style="color:#75715e">// colour channel width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> COLRW <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>CHANW;  <span style="color:#75715e">// colour width: three channels (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CIDXW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;        <span style="color:#75715e">// colour index width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer (FB)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>;  <span style="color:#75715e">// framebuffer width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">120</span>;  <span style="color:#75715e">// framebuffer height in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_SCALE  <span style="color:#f92672">=</span>   <span style="color:#ae81ff">4</span>;  <span style="color:#75715e">// framebuffer display scale (1-63)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_PIXELS <span style="color:#f92672">=</span> FB_WIDTH <span style="color:#f92672">*</span> FB_HEIGHT;  <span style="color:#75715e">// total pixels in buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_ADDRW  <span style="color:#f92672">=</span> $clog2(FB_PIXELS);  <span style="color:#75715e">// address width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_DATAW  <span style="color:#f92672">=</span> CIDXW;  <span style="color:#75715e">// colour bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// pixel read and write addresses and colours
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> fb_we;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_addr_write, fb_addr_read;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_colr_write, fb_colr_read;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// framebuffer memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bram_sdp #(
</span></span><span style="display:flex;"><span>        .WIDTH(FB_DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(FB_PIXELS),
</span></span><span style="display:flex;"><span>        .INIT_F(BMAP_IMAGE)
</span></span><span style="display:flex;"><span>    ) bram_inst (
</span></span><span style="display:flex;"><span>        .clk_write(clk_sys),
</span></span><span style="display:flex;"><span>        .clk_read(clk_sys),
</span></span><span style="display:flex;"><span>        .we(fb_we),
</span></span><span style="display:flex;"><span>        .addr_write(fb_addr_write),
</span></span><span style="display:flex;"><span>        .addr_read(fb_addr_read),
</span></span><span style="display:flex;"><span>        .data_in(fb_colr_write),
</span></span><span style="display:flex;"><span>        .data_out(fb_colr_read)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display flags in system clock domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> frame_sys, line_sys, line0_sys;
</span></span><span style="display:flex;"><span>    xd2 xd_frame (.clk_src(clk_pix),.clk_dst(clk_sys),
</span></span><span style="display:flex;"><span>        .flag_src(frame), .flag_dst(frame_sys));
</span></span><span style="display:flex;"><span>    xd2 xd_line  (.clk_src(clk_pix), .clk_dst(clk_sys),
</span></span><span style="display:flex;"><span>        .flag_src(line),  .flag_dst(line_sys));
</span></span><span style="display:flex;"><span>    xd2 xd_line0 (.clk_src(clk_pix), .clk_dst(clk_sys),
</span></span><span style="display:flex;"><span>        .flag_src(line <span style="color:#f92672">&amp;&amp;</span> sy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>), .flag_dst(line0_sys));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// fizzlefade!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lfsr_en;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lfsr;
</span></span><span style="display:flex;"><span>    lfsr #(  <span style="color:#75715e">// 15-bit LFSR (160x120 &lt; 2^15)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        .LEN(<span style="color:#ae81ff">15</span>),
</span></span><span style="display:flex;"><span>        .TAPS(<span style="color:#ae81ff">15</span><span style="color:#ae81ff">&#39;b110000000000000</span>)
</span></span><span style="display:flex;"><span>    ) lsfr_fz (
</span></span><span style="display:flex;"><span>        .clk(clk_sys),
</span></span><span style="display:flex;"><span>        .rst(rst_sys),
</span></span><span style="display:flex;"><span>        .en(lfsr_en),
</span></span><span style="display:flex;"><span>        .seed(<span style="color:#ae81ff">0</span>),  <span style="color:#75715e">// use default seed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        .sreg(lfsr)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// control fade start and rate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FADE_WAIT <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>;   <span style="color:#75715e">// wait for N frames before fading
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FADE_RATE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000</span>;  <span style="color:#75715e">// every N system cycles update LFSR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FADE_WAIT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_wait;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [$clog2(FADE_RATE)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_rate;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame_sys) cnt_wait <span style="color:#f92672">&lt;=</span> (cnt_wait <span style="color:#f92672">!=</span> FADE_WAIT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> cnt_wait <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> cnt_wait;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (cnt_wait <span style="color:#f92672">==</span> FADE_WAIT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (cnt_rate <span style="color:#f92672">==</span> FADE_RATE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                lfsr_en <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                fb_we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                fb_addr_write <span style="color:#f92672">&lt;=</span> lfsr;
</span></span><span style="display:flex;"><span>                cnt_rate <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                cnt_rate <span style="color:#f92672">&lt;=</span> cnt_rate <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                lfsr_en <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                fb_we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        fb_colr_write <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h7</span>;  <span style="color:#75715e">// fade colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// count lines for scaling via linebuffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FB_SCALE)<span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_lb_line;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line0_sys) cnt_lb_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (line_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            cnt_lb_line <span style="color:#f92672">&lt;=</span> (cnt_lb_line <span style="color:#f92672">==</span> FB_SCALE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> cnt_lb_line <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// which screen lines need linebuffer?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lb_line;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line0_sys) lb_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// enable from sy==0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (frame_sys) lb_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// disable at frame start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// enable linebuffer input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lb_en_in;  <span style="color:#75715e">// enable linebuffer input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FB_WIDTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_lbx;  <span style="color:#75715e">// horizontal pixel counter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> lb_en_in <span style="color:#f92672">=</span> (lb_line <span style="color:#f92672">&amp;&amp;</span> cnt_lb_line <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> cnt_lbx <span style="color:#f92672">&lt;</span> FB_WIDTH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// calculate framebuffer read address for linebuffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_sys) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line_sys) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reset horizontal counter at start of line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            cnt_lbx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (lb_en_in) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// increment address when LB enabled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            fb_addr_read <span style="color:#f92672">&lt;=</span> fb_addr_read <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            cnt_lbx <span style="color:#f92672">&lt;=</span> cnt_lbx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame_sys) fb_addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// reset address at frame start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// enable linebuffer output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lb_en_out;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> LB_LAT <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">// output latency compensation: lb_en_out+1, LB+1, CLUT+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        lb_en_out <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> (FB_HEIGHT <span style="color:#f92672">*</span> FB_SCALE)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#f92672">-</span>LB_LAT <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> (FB_WIDTH <span style="color:#f92672">*</span> FB_SCALE) <span style="color:#f92672">-</span> LB_LAT);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display linebuffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb_colr_out;
</span></span><span style="display:flex;"><span>    linebuffer_simple #(
</span></span><span style="display:flex;"><span>        .DATAW(CIDXW),
</span></span><span style="display:flex;"><span>        .LEN(FB_WIDTH)
</span></span><span style="display:flex;"><span>    ) linebuffer_instance (
</span></span><span style="display:flex;"><span>        .clk_sys,
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .line,
</span></span><span style="display:flex;"><span>        .line_sys,
</span></span><span style="display:flex;"><span>        .en_in(lb_en_in),
</span></span><span style="display:flex;"><span>        .en_out(lb_en_out),
</span></span><span style="display:flex;"><span>        .scale(FB_SCALE),
</span></span><span style="display:flex;"><span>        .data_in(fb_colr_read),
</span></span><span style="display:flex;"><span>        .data_out(lb_colr_out)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour lookup table (CLUT)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [COLRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_pix_colr;
</span></span><span style="display:flex;"><span>    clut_simple #(
</span></span><span style="display:flex;"><span>        .COLRW(COLRW),
</span></span><span style="display:flex;"><span>        .CIDXW(CIDXW),
</span></span><span style="display:flex;"><span>        .F_PAL(PAL_FILE)
</span></span><span style="display:flex;"><span>        ) clut_instance (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_write(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_read(lb_colr_out),
</span></span><span style="display:flex;"><span>        .colr_in(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .colr_out(fb_pix_colr)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint screen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> paint_area;  <span style="color:#75715e">// area of screen to paint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;  <span style="color:#75715e">// colour channels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_area <span style="color:#f92672">=</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> (FB_HEIGHT <span style="color:#f92672">*</span> FB_SCALE)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> FB_WIDTH <span style="color:#f92672">*</span> FB_SCALE);
</span></span><span style="display:flex;"><span>        {paint_r, paint_g, paint_b} <span style="color:#f92672">=</span> (de <span style="color:#f92672">&amp;&amp;</span> paint_area) <span style="color:#f92672">?</span> fb_pix_colr <span style="color:#f92672">:</span> <span style="color:#ae81ff">12&#39;h000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// DVI Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SB_IO #(
</span></span><span style="display:flex;"><span>        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010100</span>)  <span style="color:#75715e">// PIN_OUTPUT_REGISTERED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) dvi_signal_io [<span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] (
</span></span><span style="display:flex;"><span>        .PACKAGE_PIN({dvi_hsync, dvi_vsync, dvi_de, dvi_r, dvi_g, dvi_b}),
</span></span><span style="display:flex;"><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>        .D_OUT_0({hsync, vsync, de, paint_r, paint_g, paint_b}),
</span></span><span style="display:flex;"><span>        .D_OUT_1()
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// DVI Pmod clock output: 180° out of phase with other DVI signals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SB_IO #(
</span></span><span style="display:flex;"><span>        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010000</span>)  <span style="color:#75715e">// PIN_OUTPUT_DDR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) dvi_clk_io (
</span></span><span style="display:flex;"><span>        .PACKAGE_PIN(dvi_clk),
</span></span><span style="display:flex;"><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>        .D_OUT_0(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
</span></span><span style="display:flex;"><span>        .D_OUT_1(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h2 id="creating-your-own-images">Creating Your Own Images</h2>
<p>You can easily create your own images using <strong>img2fmem</strong>. The script is written in Python and uses the Pillow image library to perform the conversion. You can find it in the Project F <a href="https://github.com/projf/fpgatools">FPGA Tools</a> repo. Make sure your images are the same dimensions as the framebuffer you&rsquo;re using.</p>
<p>To convert an image called <code>acme.png</code> to 4-bit colour with a 12-bit palette for use with <code>$readmemh</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>img2fmem.py acme.png <span style="color:#ae81ff">4</span> mem <span style="color:#ae81ff">12</span>
</span></span></code></pre></div><p>For details on installation and command-line options, see the <a href="https://github.com/projf/fpgatools/tree/master/img2fmem">img2fmem README</a>.</p>
<h2 id="explore">Explore</h2>
<p>I hope you enjoyed this instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few suggestions to get you started:</p>
<ul>
<li>Create your own picture with <a href="https://github.com/projf/fpgatools">img2fmem</a></li>
<li>Update the fizzle design to handle the first pixel (address zero)</li>
<li>How much memory does a 320x240 framebuffer with 16 colours require?
<ul>
<li>Does it fit into BRAM on your FPGA board?</li>
</ul>
</li>
<li>If you have an Arty board, try increasing the system clock to 200 MHz
<ul>
<li>Does the design still pass timing?</li>
</ul>
</li>
</ul>
<h2 id="next-time">Next Time</h2>
<p>In the next part, we&rsquo;re drawing <a href="/posts/lines-and-triangles/">lines and triangles</a>. Check out the <a href="/sitemap/">site map</a> for more FPGA projects and tutorials.</p>
<p><em>Get in touch: <a href="https://github.com/projf/projf-explore/issues">GitHub Issues</a>, <a href="https://1bitsquared.com/pages/chat">1BitSquared Discord</a>, <a href="https://mastodon.social/@WillFlux">@WillFlux</a> (Mastodon), <a href="https://twitter.com/WillFlux">@WillFlux</a> (Twitter)</em></p>

      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>©2022 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://badgers.projectf.io/script.js" data-site="EVCGKVDN" defer></script>



</body>
</html>

