<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Hello Arty - Part 3 | Project F: FPGA Dev</title>

<meta property='og:title' content='Hello Arty - Part 3 - Project F: FPGA Dev'>
<meta property='og:description' content='Welcome back to our three-part FPGA tutorial with SystemVerilog and the Digilent Arty A7. In this third instalment, we build a countdown timer and model traffic lights. There&rsquo;s a lot to get through this time: enums, case statements, button debouncing, shift registers, and the all-important finite state machine. This post was last updated in December 2021.
New to the series? Start with part 1.
Get in touch: GitHub Issues, 1BitSquared Discord, @WillFlux (Mastodon), @WillFlux (Twitter)'>
<meta property='og:url' content='https://projectf.io/posts/hello-arty-3/'>
<meta property='og:site_name' content='Project F: FPGA Dev'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/hello-arty/social-card.jpg'><meta property='article:published_time' content='2021-05-17T00:00:00Z'><meta property='article:modified_time' content='2021-12-21T00:00:00Z'><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F: FPGA Dev">

<link rel="stylesheet" href="/css/style.css"><link rel='stylesheet' href='https://projectf.io/css/custom.css'>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/hello-arty-3/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F: FPGA Dev</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf/projf-explore'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/user/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/boards">
          <h2 class="title is-5">Boards</h2>
        </a><a class="nav-item" href="/demos">
          <h2 class="title is-5">Demos</h2>
        </a><a class="nav-item" href="/howto">
          <h2 class="title is-5">How To</h2>
        </a><a class="nav-item" href="/tags/news">
          <h2 class="title is-5">News</h2>
        </a><a class="nav-item" href="/tutorials">
          <h2 class="title is-5">Tutorials</h2>
        </a><a class="nav-item" href="/verilog-lib">
          <h2 class="title is-5">Verilog Lib</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/arty/">#arty</a>



  
  | <a class="subtitle is-6" href="/tags/hello/">#hello</a>
  


      
    </div>
    <h2 class="subtitle is-6">17 May 2021</h2>
    <h1 class="title">Hello Arty - Part 3</h1>
    
    <div class="content">
      <p>Welcome back to our three-part FPGA tutorial with <strong>SystemVerilog</strong> and the <strong>Digilent Arty A7</strong>. In this third instalment, we build a countdown timer and model traffic lights. There&rsquo;s a lot to get through this time: enums, case statements, button debouncing, shift registers, and the all-important finite state machine. This post was last updated in December 2021.</p>
<p>New to the series? Start with <strong><a href="/posts/hello-arty-1/">part 1</a></strong>.</p>
<p><em>Get in touch: <a href="https://github.com/projf/projf-explore/issues">GitHub Issues</a>, <a href="https://1bitsquared.com/pages/chat">1BitSquared Discord</a>, <a href="https://mastodon.social/@WillFlux">@WillFlux</a> (Mastodon), <a href="https://twitter.com/WillFlux">@WillFlux</a> (Twitter)</em></p>
<h3 id="requirements">Requirements</h3>
<p>For this series, we are using the <a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/start">Digilent Arty A7-35T</a>, a $130 dev board based on a <a href="https://www.xilinx.com/products/silicon-devices/fpga/artix-7.html">Xilinx Artix-7 FPGA</a>. This board is widely available and supports Xilinx&rsquo;s Vivado software, which runs on Linux and Windows.</p>
<p>For this <em>Hello Arty</em> series you need:</p>
<ol>
<li><a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/start">Digilent Arty A7-35T</a></li>
<li>Micro USB cable to program and power the Arty</li>
<li>Xilinx Vivado 2019 or later: <a href="https://www.xilinx.com/support/download.html">Download</a> and <a href="https://www.xilinx.com/support/documentation-navigation/see-all-versions.html?xlnxproducttypes=Design%20Tools&amp;xlnxdocumentid=UG973">Install Guide</a></li>
<li><a href="https://reference.digilentinc.com/vivado/installing-vivado/start#installing_digilent_board_files">Digilent board files</a></li>
</ol>
<p><em>The original Arty (without the A7) is the same physical board so you can use that too.</em></p>
<h3 id="source">Source</h3>
<p>The SystemVerilog designs featured in this series are available from the <a href="https://github.com/projf/projf-explore/tree/main/hello">projf-explore</a> git repo under the open-source MIT licence: build on them to your heart&rsquo;s content. The rest of the blog content is subject to standard copyright restrictions: don&rsquo;t republish it without permission.</p>
<h2 id="new-project">New Project</h2>
<p>Create a new project in Vivado called <strong><code>timer</code></strong> using the same settings as in <a href="/posts/hello-arty-1/">part 1</a>: an RTL Project with the Arty A7-35 board.</p>
<h2 id="timer">Timer</h2>
<p>In <a href="/posts/hello-arty-2/">part 2</a>, we created a binary clock that counted up to 15. A timer is a clock that counts <em>down</em> from a time chosen by the user. Our timer is more complex than our clock; not only does it require user input, but it has distinct operating modes:</p>
<ol>
<li>The user sets the timer length</li>
<li>The user chooses when to start the timer</li>
<li>The timer counts downs to zero</li>
<li>The timer informs the user it&rsquo;s reached zero</li>
</ol>
<p>As with our clock, we limit ourselves to 4-bit values so we can use the four LEDs for binary display.</p>
<h3 id="finite-state-machine">Finite State Machine</h3>
<p>Our timer moves between several different modes, for example: setting the time, then counting down. To handle these different modes, we use a <strong>Finite State Machine (FSM)</strong>.</p>
<p>Finite state machines are one of the most widely used concepts in digital design. A finite state machine has a limited number of states with well-defined transitions between them. Simple real-world FSMs include lifts (elevators), traffic lights, and vending machines.</p>
<p>It helps to quickly sketch out your FSM states and transitions. For our timer design, I&rsquo;ve drawn this:</p>
<p><img src="/img/posts/hello-arty/timer-fsm.jpg" alt="Timer FSM" title="Timer Finite State Machine"></p>
<h4 id="states">States</h4>
<ul>
<li><strong>Idle</strong> - wait for the user to tell us what to do</li>
<li><strong>Init</strong> - set initial values, such as default timer length</li>
<li><strong>Set Time</strong> - user presses buttons to set timer length</li>
<li><strong>Countdown</strong> - timer is running</li>
<li><strong>Done</strong> - flash LEDs to tell user timer is done</li>
</ul>
<h4 id="transitions">Transitions</h4>
<ul>
<li>From <em>Idle</em> to <em>Init</em> - user presses control button</li>
<li>From <em>Init</em> to <em>Set Time</em> - automatically happens after one clock tick</li>
<li>From <em>Set Time</em> to <em>Countdown</em> - user presses control button</li>
<li>From <em>Countdown</em> to <em>Done</em> - after the timer reaches zero</li>
<li>From <em>Done</em> to <em>Idle</em> - after LED flashing counter reaches zero</li>
</ul>
<h3 id="fsm-implementation">FSM Implementation</h3>
<p>Now we have a design; we need to translate this into Verilog.</p>
<p>I&rsquo;m going to create the timer FSM in two parts: one handles the transitions between states, and one carries out the other logic, such as counting down. Using two separate processes is only one approach to FSMs; you&rsquo;ll see another later in this tutorial.</p>
<blockquote>
<p><strong>FSM Theory</strong><br>
This series focuses on practical design. If you want to learn the theory behind finite machines, how they&rsquo;re encoded and
what distinguishes a Moore FSM from a Mealy, you can find plenty of academic resources online.
A good place to start is with <a href="https://web.mit.edu/6.111/www/f2017/handouts/L06.pdf">MIT 6.111</a> (PDF).</p>
</blockquote>
<h3 id="enums">Enums</h3>
<p>We use an <strong>enum</strong> to define our states. Enums are one of the small but useful features added in SystemVerilog. As in software programming, an enum creates a variable with a fixed list of named values.</p>
<p>For example, you could represent the days of the week:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> {SUN, MON, TUE, WED, THU, FRI, SAT} week_day;
</span></span></code></pre></div><p>Using an enum makes your finite state machine less error-prone and easier to debug.</p>
<h3 id="state-transitions">State Transitions</h3>
<p>To handle state transitions, we use combinational logic with a <strong>case statement</strong>.</p>
<p>A case statement allows you to select between several different options, again much in the same way as software programming. In C, you have the <a href="https://en.wikipedia.org/wiki/Switch_statement">switch</a> statement.</p>
<p>We handle our state transitions using the conditional operator we learnt about in <a href="/posts/hello-arty-1/#conditional-love">part 1</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> {IDLE, INIT, SET_TIME, COUNTDOWN, DONE} state, state_next;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>        IDLE:      state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> INIT <span style="color:#f92672">:</span> IDLE;
</span></span><span style="display:flex;"><span>        INIT:      state_next <span style="color:#f92672">=</span> SET_TIME;
</span></span><span style="display:flex;"><span>        SET_TIME:  state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> COUNTDOWN <span style="color:#f92672">:</span> SET_TIME;
</span></span><span style="display:flex;"><span>        COUNTDOWN: state_next <span style="color:#f92672">=</span> (led <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> DONE <span style="color:#f92672">:</span> COUNTDOWN;
</span></span><span style="display:flex;"><span>        DONE:      state_next <span style="color:#f92672">=</span> (cnt_flash <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> IDLE <span style="color:#f92672">:</span> DONE;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>   state_next <span style="color:#f92672">=</span> IDLE;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>In hardware design, you should ensure all cases are covered, or you <em>will</em> have problems. Alas, SystemVerilog doesn&rsquo;t enforce this (<a href="https://doc.rust-lang.org/book/ch06-02-match.html">unlike Rust <em>match</em></a>). We&rsquo;ve got an explicit default for this case statement that catches any value that doesn&rsquo;t have an explicit option.</p>
<p><em>ProTip: Unlike a C switch statement, there is no <a href="https://en.wikipedia.org/wiki/Switch_statement#Fallthrough">fall-through</a> between Verilog case options.</em></p>
<p>The state changes match up with our design. For example, if we&rsquo;re in the <code>IDLE</code> state, we transition to the <code>INIT</code> state when <code>sig_ctrl</code> goes high; otherwise, we remain idle.</p>
<p>The signals used in transitions are:</p>
<ul>
<li><code>sig_ctrl</code> - signals a control button press (discussed shortly)</li>
<li><code>led</code> - timer value <em>and</em> drives LEDs</li>
<li><code>cnt_flash</code> - flashing counter</li>
</ul>
<p>Combinational logic doesn&rsquo;t maintain state, so we register the FSM state in an <code>always_ff</code> block:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#75715e">// move to next FSM state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) state <span style="color:#f92672">&lt;=</span> state_next;
</span></span></code></pre></div><p>We have a working FSM, but it doesn&rsquo;t do anything useful: we need some logic to handle the behaviour of each operating modes.</p>
<h3 id="initialization">Initialization</h3>
<p>The <code>INIT</code> state allows us to do initialization when our FSM starts. In this design, we use <code>INIT</code> to set a default timer length and the counter for the flashing LEDs. We can use <code>led</code> to hold the time remaining as we want to display this in binary on the LEDs anyway.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> DEF_TIME <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b1000</span>;  <span style="color:#75715e">// default timer in seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FLASH_TIME <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;      <span style="color:#75715e">// seconds to flash when done
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FLASH_TIME<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_flash;  <span style="color:#75715e">// counter for done flashing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// finite state machine: behaviour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>            INIT: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                led <span style="color:#f92672">&lt;=</span> DEF_TIME;  <span style="color:#75715e">// set default time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                cnt_flash <span style="color:#f92672">&lt;=</span> FLASH_TIME;  <span style="color:#75715e">// initialize flash timer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span></code></pre></div><p>The default timer length, <code>4'b1000</code>, shows the timer is ready to accept input but doesn&rsquo;t inconvenience the user: the <code>1</code> gets shifted out on the first button press. We&rsquo;ll explain how this works shortly.</p>
<h3 id="user-input">User Input</h3>
<p>Handling user input is the most complex part of the design. In this section, you&rsquo;ll learn about button debouncing and shift registers.</p>
<p>We use three buttons on the Arty board for user input:</p>
<ul>
<li><code>BTN3</code> - control</li>
<li><code>BTN0</code> - zero digit</li>
<li><code>BTN1</code> - one digit</li>
</ul>
<p>The user presses the control button to switch mode, while zero and one set the timer length. Handling button presses seems trivial, but this is an occasion where hardware requires more thought than software.</p>
<p><strong>What defines a single button press?</strong></p>
<p>In practice, a button rarely makes a single clean contact when pressed. Instead, a button will &lsquo;bounce&rsquo;, making several brief contacts before making a definite connection. Hence the need to &ldquo;debounce&rdquo; a button before using it in a design.</p>
<h4 id="debounce">Debounce</h4>
<p>We have three buttons to handle, so we create a module to handle debouncing. Add a new module called <code>debounce.sv</code> to your project with  <strong>[<a href="https://github.com/projf/projf-explore/blob/main/hello/hello-arty/K/debounce.sv">src</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> debounce (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,   <span style="color:#75715e">// clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> in,    <span style="color:#75715e">// signal input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> out,   <span style="color:#75715e">// signal output (debounced)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> onup   <span style="color:#75715e">// on up (one tick)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sync with clock and combat metastability
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> sync_0, sync_1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) sync_0 <span style="color:#f92672">&lt;=</span> in;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) sync_1 <span style="color:#f92672">&lt;=</span> sync_0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt;  <span style="color:#75715e">// 2^20 = 10 ms counter at 100 MHz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> idle, max;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        idle <span style="color:#f92672">=</span> (out <span style="color:#f92672">==</span> sync_1);
</span></span><span style="display:flex;"><span>        max  <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cnt;
</span></span><span style="display:flex;"><span>        onup <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>idle <span style="color:#f92672">&amp;</span> max <span style="color:#f92672">&amp;</span> out;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (idle) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (max) out <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">~</span>out;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>This module synchronizes the button press with our clock, then waits for 10 ms before considering a button to be pressed. You can easily tweak the width of <code>cnt</code> if you want to adjust the delay. If the delay is too short, you risk getting phantom button presses; if the delay is too long, we could miss a press, and the interface doesn&rsquo;t feel responsive.</p>
<p>The debounce module provides an <code>onup</code> signal that is high for one clock tick after a button is released.</p>
<p>We have three buttons, and each needs a separate instance of the debounce module:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// debounce each button using the debounce module
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> sig_ctrl, sig_0, sig_1;  <span style="color:#75715e">// button press signals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    debounce deb_ctrl (.clk, .in(btn_ctrl), .out(), .onup(sig_ctrl));
</span></span><span style="display:flex;"><span>    debounce deb_0 (.clk, .in(btn_0), .out(), .onup(sig_0));
</span></span><span style="display:flex;"><span>    debounce deb_1 (.clk, .in(btn_1), .out(), .onup(sig_1));
</span></span></code></pre></div><p>We don&rsquo;t use the <code>out</code> signal, hence the empty brackets: <code>.out()</code>.</p>
<h4 id="shift-register">Shift Register</h4>
<p>To record the user button presses, we treat the four-bit LED variable as a <strong>shift register</strong>.</p>
<p>In a shift register, the output of one register connects to the input of the next. With a <strong>left shift</strong>, all values move left one place, with the left-most bit falling off the end with a new bit added on the right. A <strong>right shift</strong> works the same way but in the opposite direction. Don&rsquo;t worry if this isn&rsquo;t clear; we will look at some real-world examples.</p>
<h5 id="concat">Concat</h5>
<p>In Verilog, we don&rsquo;t need anything special to create a shift register. We use the <strong>Concatenation</strong> operator <code>{a,b}</code> to left (or right) shift a variable.</p>
<p>Concatenation combines the bits of two (or more) variables. For example, if we concat a two-bit value and a four-bit value, we get a six-bit value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>{<span style="color:#ae81ff">2</span><span style="color:#ae81ff">&#39;b10</span>, <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b1001</span>} <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b101001</span>
</span></span></code></pre></div><p>To left-shift <code>1</code> into <code>led</code>, we combine it with three existing bits from <code>led</code> and discard <code>led[3]</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>led <span style="color:#f92672">&lt;=</span> {led[<span style="color:#ae81ff">2</span>], led[<span style="color:#ae81ff">1</span>], led[<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>};
</span></span></code></pre></div><p>We can express this more compactly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>led <span style="color:#f92672">&lt;=</span> {led[<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>};
</span></span></code></pre></div><h5 id="shift-logic">Shift Logic</h5>
<p>Numerical input comes from two separate buttons, so we need to handle both:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    SET_TIME: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (sig_0) led <span style="color:#f92672">&lt;=</span> {led[<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>};       <span style="color:#75715e">// user pressed 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sig_1) led <span style="color:#f92672">&lt;=</span> {led[<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>};  <span style="color:#75715e">// user pressed 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h5 id="shift-example">Shift Example</h5>
<p>Our timer defaults to <code>4'b1000</code> (eight seconds).</p>
<p>If the user presses <code>1</code> then <code>0</code>, the timer becomes <code>4'b0010</code> (two seconds):</p>
<p><img src="/img/posts/hello-arty/shift-register.jpg" alt="Shift Register" title="A shift register records user input."></p>
<p>Note how the first press shifts out the <code>1</code> on the left and shifts in a <code>1</code> on the right.</p>
<h3 id="counting-down">Counting Down</h3>
<p>After the complexity of user input, counting is straightforward.</p>
<p><code>led</code> holds the remaining time. Every time <code>stb</code> is high, we decrement the time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    COUNTDOWN: <span style="color:#66d9ef">if</span> (stb) led <span style="color:#f92672">&lt;=</span> led <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>The one-second strobe should be familiar from <a href="/posts/hello-arty-2/#every-second-counts">part 2</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// generate 1 second strobe from 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> DIV_BY <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#ae81ff">&#39;d100</span>_000_000;  <span style="color:#75715e">// 100 million
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> stb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [$clog2(DIV_BY)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_stb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (cnt_stb <span style="color:#f92672">!=</span> DIV_BY<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            cnt_stb <span style="color:#f92672">&lt;=</span> cnt_stb <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            cnt_stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h3 id="done-and-dusted">Done and Dusted</h3>
<p>When the timer reaches zero, we flash all four LEDs.</p>
<p>We take a bit from the counter to set the flash rate;
I&rsquo;ve chosen the 23rd bit, but you can easily adjust this with <code>FLASH_BIT</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> FLASH_BIT <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DONE: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        led <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">4</span>{cnt_stb[FLASH_BIT]}};  <span style="color:#75715e">// flash all four LEDs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (stb) cnt_flash <span style="color:#f92672">&lt;=</span> cnt_flash <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We&rsquo;re using the concat operator again, this time to replicate a bit to drive all four LEDs.</p>
<p>Replication is easiest to understand with a couple of examples:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>{<span style="color:#ae81ff">4</span>{<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>}}  <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b1111</span>
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">4</span>{<span style="color:#ae81ff">2</span><span style="color:#ae81ff">&#39;b10</span>}} <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b10101010</span>
</span></span></code></pre></div><h3 id="top-timer">Top Timer</h3>
<p>The finished timer <code>top.sv</code> looks like this <strong>[<a href="https://github.com/projf/projf-explore/blob/main/hello/hello-arty/K/top.sv">src</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_ctrl,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_0,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_1,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> DEF_TIME <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b1000</span>;  <span style="color:#75715e">// default timer in seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FLASH_BIT <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span>;      <span style="color:#75715e">// bit of counter to use for done flashing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FLASH_TIME <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;      <span style="color:#75715e">// seconds to flash when done
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FLASH_TIME<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_flash;  <span style="color:#75715e">// counter for done flashing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// debounce each button using the debounce module
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> sig_ctrl, sig_0, sig_1;  <span style="color:#75715e">// button press signals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    debounce deb_ctrl (.clk, .in(btn_ctrl), .out(), .onup(sig_ctrl));
</span></span><span style="display:flex;"><span>    debounce deb_0 (.clk, .in(btn_0), .out(), .onup(sig_0));
</span></span><span style="display:flex;"><span>    debounce deb_1 (.clk, .in(btn_1), .out(), .onup(sig_1));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// finite state machine: state change
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {IDLE, INIT, SET_TIME, COUNTDOWN, DONE} state, state_next;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>            IDLE:      state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> INIT <span style="color:#f92672">:</span> IDLE;
</span></span><span style="display:flex;"><span>            INIT:      state_next <span style="color:#f92672">=</span> SET_TIME;
</span></span><span style="display:flex;"><span>            SET_TIME:  state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> COUNTDOWN <span style="color:#f92672">:</span> SET_TIME;
</span></span><span style="display:flex;"><span>            COUNTDOWN: state_next <span style="color:#f92672">=</span> (led <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> DONE <span style="color:#f92672">:</span> COUNTDOWN;
</span></span><span style="display:flex;"><span>            DONE:      state_next <span style="color:#f92672">=</span> (cnt_flash <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> IDLE <span style="color:#f92672">:</span> DONE;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>   state_next <span style="color:#f92672">=</span> IDLE;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// move to next FSM state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) state <span style="color:#f92672">&lt;=</span> state_next;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate 1 second strobe from 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> DIV_BY <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#ae81ff">&#39;d100</span>_000_000;  <span style="color:#75715e">// 100 million
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> stb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [$clog2(DIV_BY)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_stb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (cnt_stb <span style="color:#f92672">!=</span> DIV_BY<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            cnt_stb <span style="color:#f92672">&lt;=</span> cnt_stb <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            cnt_stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// finite state machine: behaviour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>            INIT: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                led <span style="color:#f92672">&lt;=</span> DEF_TIME;  <span style="color:#75715e">// set default time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                cnt_flash <span style="color:#f92672">&lt;=</span> FLASH_TIME;  <span style="color:#75715e">// initialize flash timer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            SET_TIME: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (sig_0) led <span style="color:#f92672">&lt;=</span> {led[<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>};       <span style="color:#75715e">// user pressed 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sig_1) led <span style="color:#f92672">&lt;=</span> {led[<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>};  <span style="color:#75715e">// user pressed 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            COUNTDOWN: <span style="color:#66d9ef">if</span> (stb) led <span style="color:#f92672">&lt;=</span> led <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            DONE: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                led <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">4</span>{cnt_stb[FLASH_BIT]}};  <span style="color:#75715e">// flash all four LEDs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (stb) cnt_flash <span style="color:#f92672">&lt;=</span> cnt_flash <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> led <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b0000</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h3 id="building-your-timer">Building Your Timer</h3>
<p>We need some constraints, including the three buttons. Save the following as <code>arty.xdc</code> <strong>[<a href="https://github.com/projf/projf-explore/blob/main/hello/hello-arty/K/arty.xdc">src</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tcl" data-lang="tcl"><span style="display:flex;"><span><span style="color:#75715e">## FPGA Configuration I/O Options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_property CONFIG_VOLTAGE <span style="color:#ae81ff">3.3</span> <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>
</span></span><span style="display:flex;"><span>set_property CFGBVS VCCO <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Board Clock: 100 MHz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN E3 IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>create_clock <span style="color:#f92672">-</span>name clk_100m <span style="color:#f92672">-</span>period <span style="color:#ae81ff">10.00</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Buttons
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN B8  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>btn_ctrl<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN D9  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>btn_0<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN C9  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>btn_1<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## LEDs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN H5  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>0<span style="color:#66d9ef">]}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN J5  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>1<span style="color:#66d9ef">]}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN T9  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>2<span style="color:#66d9ef">]}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN T10 IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>3<span style="color:#66d9ef">]}];</span>
</span></span></code></pre></div><p>Make sure your project includes <code>top.sv</code>, <code>debounce.sv</code>, and <code>arty.xdc</code>.</p>
<p>Select <em>Generate Bitstream</em>, then program your Arty board using <em>Hardware Manager</em>.</p>
<p>To use the timer, press <code>BTN3</code> once to enter &ldquo;set time&rdquo; mode, where you can use <code>BTN0</code> and <code>BTN1</code> to set your timer length. Press <code>BTN3</code> again to start the timer. When the timer reaches zero, it flashes all four LEDs before returning to the idle state, ready to be set again.</p>
<h2 id="and-there-was-light">And There Was Light</h2>
<p><img src="/img/posts/hello-arty/traffic_lights.jpg" alt="Traffic Lights" title="Traffic lights in Warrington, England. By Wikipedia user Velela (public domain)"></p>
<p>In the second part of this tutorial, we&rsquo;re going to use what we&rsquo;ve already learnt to model traffic lights. This should solidify what you learnt in the first part and allows us to play with the RGB LEDs again. :)</p>
<p>We&rsquo;re going to start a new project for our traffic light design. Close your timer design and create a fresh project in Vivado called <strong><code>traffic-lights</code></strong> using the same settings as in <a href="/posts/hello-arty-1/">part 1</a>: an RTL Project with the Arty A7-35 board.</p>
<h3 id="t-junction">T-Junction</h3>
<p>For this project, we&rsquo;re modelling a T-junction with three sets of traffic lights controlling traffic flow.</p>
<p><img src="/img/posts/hello-arty/t-junction.jpg" alt="T-Junction" title="A T-junction in the UK."></p>
<p>I&rsquo;m going to use British traffic lights for my model, but you can adjust the colours and sequence to match your local roads. The usual  sequence for a British traffic light is:</p>
<ul>
<li>red</li>
<li>red + amber</li>
<li>green</li>
<li>amber</li>
<li>red</li>
</ul>
<p>The specification for our traffic lights:</p>
<ul>
<li>If the main road is not red, the side road <em>must</em> be red (and vice versa)</li>
<li>Both main road signals show the same lights at all times (we will use one LED for both)</li>
</ul>
<p>Timings should be as follows:</p>
<ul>
<li>1 second of red lights for both roads between changeover</li>
<li>1 second of red + amber before turning green</li>
<li>10 seconds of green on the main road</li>
<li>5 seconds of green on the side road</li>
<li>2 seconds of amber after green, before turning red</li>
</ul>
<p>We store these times in parameters, so they&rsquo;re easy to edit and debug:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// traffic light phases in seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> T_RED <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_RED_AMBER <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_GREEN_MAIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_GREEN_SIDE <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_AMBER <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span></code></pre></div><p>We need a register to track how long each phase is lasting:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_phase;  <span style="color:#75715e">// 4-bit allows up to 15 second phase
</span></span></span></code></pre></div><p>And a register to track which set of lights is active:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> light_set;  <span style="color:#75715e">// active lights: 0 = main, 1 = side
</span></span></span></code></pre></div><h3 id="light-fsm">Light FSM</h3>
<p>For this FSM, we&rsquo;re going to use a single process combining state change and behaviour:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#66d9ef">enum</span> {IDLE, INIT, RED, RED_AMBER, GREEN, AMBER} state;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>            IDLE: state <span style="color:#f92672">&lt;=</span> INIT;
</span></span><span style="display:flex;"><span>            INIT: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">&lt;=</span> RED;
</span></span><span style="display:flex;"><span>                cnt_phase <span style="color:#f92672">&lt;=</span> T_RED;
</span></span><span style="display:flex;"><span>                light_set <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// main set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            RED: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> RED_AMBER;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> T_RED_AMBER;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            RED_AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> GREEN;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> T_GREEN_SIDE <span style="color:#f92672">:</span> T_GREEN_MAIN;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            GREEN: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> AMBER;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> T_AMBER;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> RED;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> T_RED;
</span></span><span style="display:flex;"><span>                    light_set <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">~</span>light_set;  <span style="color:#75715e">// switch active light set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>However, we&rsquo;re going to put the light colour logic in a separate block for clarity.</p>
<h3 id="light--colour">Light &amp; Colour</h3>
<p>A regular traffic light has three bulbs: red, amber, and green. We have four RGB LEDs but want to model two (or more) sets of traffic lights, so we&rsquo;ll use one RGB LED per traffic light, switching it between the different colours. For red + amber, I&rsquo;ll use a colour intermediate between red and amber.</p>
<p>We&rsquo;re going to use PWM with our RGB LEDs, just like we did in <a href="/posts/hello-arty-2/#duty-cycle-module">part 2</a>. Create a new module called <code>pwm.sv</code> using the following <strong>[<a href="https://github.com/projf/projf-explore/blob/main/hello/hello-arty/L/pwm.sv">src</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> pwm (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> pwm_out
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        pwm_out <span style="color:#f92672">=</span> (cnt <span style="color:#f92672">&lt;</span> duty);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>We control the light colours like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// PWM duty values are 8-bit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty_main_r, duty_main_g;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty_side_r, duty_side_g;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pwm pwm_main_r (.clk, .duty(duty_main_r), .pwm_out(led_main_r));
</span></span><span style="display:flex;"><span>    pwm pwm_main_g (.clk, .duty(duty_main_g), .pwm_out(led_main_g));
</span></span><span style="display:flex;"><span>    pwm pwm_side_r (.clk, .duty(duty_side_r), .pwm_out(led_side_r));
</span></span><span style="display:flex;"><span>    pwm pwm_side_g (.clk, .duty(duty_side_g), .pwm_out(led_side_g));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// set light colour based on active light set and state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// all lights are red by default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>        duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>        duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>        duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>            RED_AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d56</span>;
</span></span><span style="display:flex;"><span>                    duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d8</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d56</span>;
</span></span><span style="display:flex;"><span>                    duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d8</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            GREEN: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>                    duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>                    duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d48</span>;
</span></span><span style="display:flex;"><span>                    duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d16</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d48</span>;
</span></span><span style="display:flex;"><span>                    duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d16</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>This design ensures all signals have a default value by explicitly setting them separately from the <code>case</code> statement.</p>
<p>We keep the system safe by having both sets of lights be red by default and using an <code>if ... else</code> block such that only one set of lights can have their colour altered from red.</p>
<h2 id="traffic-control">Traffic Control</h2>
<p>Our finished traffic light <code>top.sv</code> looks like this <strong>[<a href="https://github.com/projf/projf-explore/blob/main/hello/hello-arty/L/top.sv">src</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> led_main_r,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> led_main_g,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> led_side_r,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> led_side_g
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// traffic light phases in seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> T_RED <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_RED_AMBER <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_GREEN_MAIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_GREEN_SIDE <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> T_AMBER <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_phase;  <span style="color:#75715e">// 4-bit allows up to 15 second phase
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> light_set;  <span style="color:#75715e">// active lights: 0 = main, 1 = side
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate 1 second strobe from 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> DIV_BY <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#ae81ff">&#39;d100</span>_000_000;  <span style="color:#75715e">// 100 million
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> stb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [$clog2(DIV_BY)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_stb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (cnt_stb <span style="color:#f92672">!=</span> DIV_BY<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            cnt_stb <span style="color:#f92672">&lt;=</span> cnt_stb <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            cnt_stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// finite state machine: state change &amp; behavior
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {IDLE, INIT, RED, RED_AMBER, GREEN, AMBER} state;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>            IDLE: state <span style="color:#f92672">&lt;=</span> INIT;
</span></span><span style="display:flex;"><span>            INIT: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">&lt;=</span> RED;
</span></span><span style="display:flex;"><span>                cnt_phase <span style="color:#f92672">&lt;=</span> T_RED;
</span></span><span style="display:flex;"><span>                light_set <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// main set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            RED: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> RED_AMBER;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> T_RED_AMBER;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            RED_AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> GREEN;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> T_GREEN_SIDE <span style="color:#f92672">:</span> T_GREEN_MAIN;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            GREEN: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> AMBER;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> T_AMBER;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (cnt_phase <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> RED;
</span></span><span style="display:flex;"><span>                    cnt_phase <span style="color:#f92672">&lt;=</span> T_RED;
</span></span><span style="display:flex;"><span>                    light_set <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">~</span>light_set;  <span style="color:#75715e">// switch active light set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (stb) cnt_phase <span style="color:#f92672">&lt;=</span> cnt_phase <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// PWM duty values are 8-bit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty_main_r, duty_main_g;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty_side_r, duty_side_g;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pwm pwm_main_r (.clk, .duty(duty_main_r), .pwm_out(led_main_r));
</span></span><span style="display:flex;"><span>    pwm pwm_main_g (.clk, .duty(duty_main_g), .pwm_out(led_main_g));
</span></span><span style="display:flex;"><span>    pwm pwm_side_r (.clk, .duty(duty_side_r), .pwm_out(led_side_r));
</span></span><span style="display:flex;"><span>    pwm pwm_side_g (.clk, .duty(duty_side_g), .pwm_out(led_side_g));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// set light colour based on active light set and state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// all lights are red by default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>        duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>        duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>        duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>            RED_AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d56</span>;
</span></span><span style="display:flex;"><span>                    duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d8</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d56</span>;
</span></span><span style="display:flex;"><span>                    duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d8</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            GREEN: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>                    duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d0</span>;
</span></span><span style="display:flex;"><span>                    duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d64</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            AMBER: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_main_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d48</span>;
</span></span><span style="display:flex;"><span>                    duty_main_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d16</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (light_set <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    duty_side_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d48</span>;
</span></span><span style="display:flex;"><span>                    duty_side_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d16</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h3 id="build-your-lights">Build Your Lights</h3>
<p>We need some constraints. Save the following as <code>arty.xdc</code> <strong>[<a href="https://github.com/projf/projf-explore/blob/main/hello/hello-arty/L/arty.xdc">src</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tcl" data-lang="tcl"><span style="display:flex;"><span><span style="color:#75715e">## FPGA Configuration I/O Options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_property CONFIG_VOLTAGE <span style="color:#ae81ff">3.3</span> <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>
</span></span><span style="display:flex;"><span>set_property CFGBVS VCCO <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Board Clock: 100 MHz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN E3 IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>create_clock <span style="color:#f92672">-</span>name clk_100m <span style="color:#f92672">-</span>period <span style="color:#ae81ff">10.00</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## RGB LEDs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN G6  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_main_r<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN F6  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_main_g<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN G3  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_side_r<span style="color:#66d9ef">}];</span>
</span></span><span style="display:flex;"><span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN J4  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_side_g<span style="color:#66d9ef">}];</span>
</span></span></code></pre></div><p>Make sure your project includes <code>top.sv</code>, <code>pwm.sv</code>, and <code>arty.xdc</code>.</p>
<p>Select <em>Generate Bitstream</em>, then program your Arty board using <em>Hardware Manager</em>.</p>
<p>This design runs automatically without any user interaction. You should see two of the RGB LEDs cycle through the traffic light colour sequence.</p>
<h2 id="explore">Explore</h2>
<p>That about wraps it up for this post, but there are oodles  of things you can do to improve and expand on these designs. Here are a few ideas:</p>
<ul>
<li>Create a separate module for the one-second strobe</li>
<li>Add external hardware to the timer
<ul>
<li>Use a seven-segment display in place of the LEDs for timer display</li>
<li>Use a speaker or buzzer instead of flashing LEDs</li>
</ul>
</li>
<li>Use an enum for <code>light_set</code> with values <code>MAIN</code> and <code>SIDE</code></li>
<li>Add a pedestrian crossing phase to your traffic lights
<ul>
<li>Pedestrians can request to cross using a push button on the Arty</li>
<li>Use a third RGB light to show when it&rsquo;s safe for pedestrians to cross</li>
<li>How do you prevent unsafe combinations of lights?</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>Sponsor My Work</strong><br>
If you like what I do, consider <a href="https://github.com/sponsors/WillGreen">sponsoring me</a> on GitHub.<br>
I love FPGAs and want to help more people discover and use them in their projects.<br>
My hardware designs are open source, and my blog is advert free.</p>
</blockquote>
<h2 id="what-next">What Next?</h2>
<p>This concludes our three-part introduction to FPGA development with SystemVerilog and the Digilent Arty A7 board. If there&rsquo;s enough interest, I&rsquo;ll do a post on test benches with Vivado. In the meantime, grab a VGA Pmod and get designing with <a href="/posts/fpga-graphics/">Beginning FPGA Graphics</a>.</p>
<p>If you&rsquo;re looking for other great resources, try <a href="/recommended-fpga-sites">recommended FPGA sites</a>.</p>
<p><em>Get in touch: <a href="https://github.com/projf/projf-explore/issues">GitHub Issues</a>, <a href="https://1bitsquared.com/pages/chat">1BitSquared Discord</a>, <a href="https://mastodon.social/@WillFlux">@WillFlux</a> (Mastodon), <a href="https://twitter.com/WillFlux">@WillFlux</a> (Twitter)</em></p>

      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>2022 Will Green, Project F</p>
    
  </div>
</section>


<script>
    (function(f, a, t, h, o, m){
        a[h]=a[h]||function(){
            (a[h].q=a[h].q||[]).push(arguments)
        };
        o=f.createElement('script'),
        m=f.getElementsByTagName('script')[0];
        o.async=1; o.src=t; o.id='fathom-script';
        m.parentNode.insertBefore(o,m)
    })(document, window, 'tracker.js', 'fathom');
    fathom('trackPageview');
</script>


</body>
</html>

