<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Hello Nexys - Part 2 | Project F - FPGA Development</title>

<meta property='og:title' content='Hello Nexys - Part 2 - Project F - FPGA Development'>
<meta property='og:description' content='Welcome back to our three-part FPGA tutorial with SystemVerilog and the Digilent Nexys Video. In part two, we&rsquo;re going to learn about clocks and counting. Along the way, we&rsquo;ll cover maintaining state with flip-flops, timing things with clock dividers, creating our first Verilog module, and controlling LEDs with pulse width modulation. This post is also available for the Arty.
New to the series? Start with part 1.
Updated 2021-06-28. Get in touch with @WillFlux or open an issue on GitHub.'>
<meta property='og:url' content='https://projectf.io/posts/hello-nexys-2/'>
<meta property='og:site_name' content='Project F - FPGA Development'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/hello-nexys/social-card.jpg'><meta property='article:published_time' content='2021-02-11T00:00:00Z'/><meta property='article:modified_time' content='2021-02-11T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F - FPGA Development" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/hello-nexys-2/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="referrer" content="no-referrer, same-origin">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F - FPGA Development</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/sitemap">
          <h2 class="title is-5">Sitemap</h2>
        </a><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/explore">
          <h2 class="title is-5">Explore</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/explore/">#explore</a>



  
  | <a class="subtitle is-6" href="/tags/hello/">#hello</a>
  


      
    </div>
    <h2 class="subtitle is-6">11 February 2021</h2>
    <h1 class="title">Hello Nexys - Part 2</h1>
    
    <div class="content">
      <p>Welcome back to our three-part FPGA tutorial with <strong>SystemVerilog</strong> and the <strong>Digilent Nexys Video</strong>. In part two, we&rsquo;re going to learn about clocks and counting. Along the way, we&rsquo;ll cover maintaining state with flip-flops, timing things with clock dividers, creating our first Verilog module, and controlling LEDs with pulse width modulation. This post is also available for the <strong><a href="/posts/hello-arty-2/">Arty</a></strong>.</p>
<p>New to the series? Start with <strong><a href="/posts/hello-nexys-1/">part 1</a></strong>.</p>
<p><em>Updated 2021-06-28. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>
<h3 id="requirements">Requirements</h3>
<p>For this series, we are be using the <a href="https://reference.digilentinc.com/reference/programmable-logic/nexys-video/start">Digilent Nexys Video</a>, a $480 dev board based on a <a href="https://www.xilinx.com/products/silicon-devices/fpga/artix-7.html">Xilinx Artix-7 FPGA</a>. This board is widely available and supports Xilinx&rsquo;s latest Vivado software, which runs on Linux and Windows.</p>
<p>For this <em>Hello Nexys</em> series you need:</p>
<ol>
<li><a href="https://reference.digilentinc.com/reference/programmable-logic/nexys-video/start">Digilent Nexys Video</a></li>
<li>Micro USB cable to program the Nexys Video board</li>
<li>12V power adaptor (EU/US plug is provided by Digilent - UK users will need an adaptor)</li>
<li>Xilinx Vivado 2019 or later: <a href="https://www.xilinx.com/support/download.html">Download</a> and <a href="https://www.xilinx.com/support/documentation-navigation/see-all-versions.html?xlnxproducttypes=Design%20Tools&amp;xlnxdocumentid=UG973">Install Guide</a></li>
<li><a href="https://reference.digilentinc.com/vivado/installing-vivado/start#installing_digilent_board_files">Digilent board files</a></li>
</ol>
<h3 id="source">Source</h3>
<p>The SystemVerilog designs featured in this series are available from the <a href="https://github.com/projf/projf-explore/tree/master/hello">projf-explore</a> git repo under the open-source MIT licence: build on them to your heart&rsquo;s content. The rest of the blog content is subject to standard copyright restrictions: don&rsquo;t republish it without permission.</p>
<h2 id="learning-to-count">Learning to Count</h2>
<p>Think about what happens when you count <a href="https://www.youtube.com/watch?v=M7AAwIWxIpM">1, 2, 3, 4, 5&hellip;</a>. You need to <em>remember</em> the current number in order to decide what comes next. If you&rsquo;re interrupted while counting, you lose your place and have to start over. Without memory, you can&rsquo;t count.</p>
<p>In <a href="/posts/hello-nexys-1/">part 1</a> our designs had no memory; to put it more abstractly they didn&rsquo;t maintain any <strong>state</strong>.</p>
<p>That&rsquo;s not quite true: when you moved a slide switch, it did maintain its state. Alas, that&rsquo;s not a viable approach for circuit design: the switches are huge, and the FPGA can&rsquo;t move them! Instead, we&rsquo;re going to make use of <strong>flip-flops</strong>.</p>
<p>A flip-flop maintains the state of a single bit. That&rsquo;s right: 1 bit. Are you dismayed? Don&rsquo;t be: the FPGA on the Nexys Video board has 270,000 flip-flops, and we don&rsquo;t use them as general-purpose ram. Think of a flip-flop as a tiny, extremely fast, box for storing something you&rsquo;re working on right now: like a CPU register.</p>
<p>When a flip-flop receives a trigger, it updates its bit. You could use any signal to trigger an update, but we&rsquo;ll always use a common clock to trigger our flip-flops simultaneously. Using a common clock ensures that all signals are updated and ready at the same time. The clock is like the conductor of an orchestra keeping everyone playing to time.</p>
<p>To see a flip-flop in action watch the LearnElectronics video: <a href="https://youtu.be/OYtGr2faYpw">Digital Logic: D type Flip Flop</a>.</p>
<h3 id="counting-project">Counting Project</h3>
<p>Create a new project in Vivado called <strong><code>hello-nexys-2</code></strong> using the same settings as in <a href="/posts/hello-nexys-1/">part 1</a>: an RTL Project with the Nexys Video board.</p>
<p>Add a new SystemVerilog design source to your project called <code>top.sv</code> with <strong>[<a href="https://github.com/projf/projf-explore/blob/master/hello/hello-nexys/E/top.sv">src</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">31</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// 32-bit counter
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        led[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">26</span>];
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>In part 1, we used <code>always_comb</code> blocks. Flip-flips require a new type of block: <strong>always_ff</strong>.</p>
<p>Our <code>always_ff</code> block has the positive edge (<code>posedge</code>) of the clock (<code>clk</code>) on its <strong>sensitivity list</strong> <code>@(...)</code>. This means the block is triggered on every rising (positive) edge of the clock.</p>
<p>We&rsquo;re using the 100 MHz oscillator on the Nexys Video board, so we get a rising clock edge every 10 nanoseconds: this is known as the <strong>clock period</strong>. Every 10 ns our counter <code>cnt</code> increments; when it reaches its maximum value, it rolls over to 0 and repeats.</p>
<blockquote>
<p>How long does it take the 32-bit counter to roll over?</p>
</blockquote>
<p>At the <em>same time</em> as our counter is being incremented, one bit of the counter is being copied to a flip-flop that maintains the LED state. Statements in an <code>always_ff</code> block happen independently and in parallel.</p>
<blockquote>
<p><strong>Assignment</strong><br>
You may have noticed we snuck in a new type of assignment with flip-flops:</p>
<p><code>always_comb</code> blocks use <code>=</code> for assignment<br>
<code>always_ff</code> blocks use <code>&lt;=</code> for assignment</p>
<p><em>We won&rsquo;t go into the reasons for this right now, but follow this rule and all will be well.</em></p>
</blockquote>
<h3 id="constraints">Constraints</h3>
<p>Add the following <code>nexys.xdc</code>constraints file to your project <strong>[<a href="https://github.com/projf/projf-explore/blob/master/hello/hello-nexys/E/nexys.xdc">src</a>]</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tcl" data-lang="tcl"><span style="color:#75715e">## FPGA Configuration I/O Options
</span><span style="color:#75715e"></span>set_property CONFIG_VOLTAGE <span style="color:#ae81ff">3.3</span> <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>
set_property CFGBVS VCCO <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>

<span style="color:#75715e">## Board Clock: 100 MHz
</span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN R4 IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>
create_clock <span style="color:#f92672">-</span>name clk_100m <span style="color:#f92672">-</span>period <span style="color:#ae81ff">10.00</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>

<span style="color:#75715e">## LEDs
</span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN T14 IOSTANDARD LVCMOS25<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>0<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN T15 IOSTANDARD LVCMOS25<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>1<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN T16 IOSTANDARD LVCMOS25<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>2<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN U16 IOSTANDARD LVCMOS25<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>3<span style="color:#66d9ef">]}];</span>
</code></pre></div><p><em>See <a href="/posts/hello-nexys-1/#constraints-file">part 1</a> if you need a reminder on how to add constraints.</em></p>
<p>Note how the period of the clock is set to 10.00 ns. This tells Vivado what the oscillator clock period is: you can&rsquo;t use it to adjust the clock frequency! We&rsquo;ll learn how to generate other frequencies later in this tutorial.</p>
<h3 id="generate--program-bitstream">Generate &amp; Program Bitstream</h3>
<p>We&rsquo;re ready to run this design on our board. We could individually synthesise, implement, and generate bitstream as we learnt in part 1. However, you don&rsquo;t have to run these steps one-by-one: you can select <strong>Generate Bitstream</strong>, and Vivado performs all the necessary steps.</p>
<p>Program your board, and you should see the green LED <strong><code>LD0</code></strong> blinking. We&rsquo;ve wired up bit 26 of our counter to <code>led[0]</code>, so it changes state every 2<sup>26</sup> x 10 ns = 0.67 seconds. That&rsquo;s one blink every 1.34 seconds.</p>
<h3 id="blinky-blinky">Blinky, Blinky</h3>
<p>Try replacing the <code>always_ff</code> block in <code>top.sv</code> with <strong>[<a href="https://github.com/projf/projf-explore/blob/master/hello/hello-nexys/F/top.sv">src</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
    cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    led[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">26</span>];
    led[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">24</span>];
    led[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">22</span>];
    led[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">20</span>];
<span style="color:#66d9ef">end</span>
</code></pre></div><p><em>NB. We use code snippets to focus on what&rsquo;s changed, but the full design is available via [src].</em></p>
<p>Rerun bitstream generation and program your board. How often is each LED blinking?</p>
<p><strong><code>LD3</code></strong> on our board (<strong><code>led[3]</code></strong> in Verilog) looks like it&rsquo;s on all time, but is less bright. It&rsquo;s blinking fifty times per second, so fast that your eyes hardly see the flashes. We&rsquo;ll make use of this later.</p>
<h2 id="division-of-time">Division of Time</h2>
<p>Earlier we said we would always use a single clock in our designs. What happens if we want to do something less than 100 million times a second? We could take a bit from a counter, but there&rsquo;s a more elegant way using a <strong>strobe</strong>. With a strobe we&rsquo;re not limited to dividing by powers of two.</p>
<p>For example, to divide by three:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">logic</span> stb;
<span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> (cnt <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span><span style="color:#ae81ff">&#39;d2</span>) <span style="color:#66d9ef">begin</span>
        stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
        stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
        cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>This example divides by three because we start counting at zero: 0, 1, 2, 0, 1, 2&hellip;</p>
<p>The following simulation shows how the counter and strobe vary over time:</p>
<p><img src="/img/posts/hello-arty/strobe_div_by_3.png" alt="Strobe dividing by three" title="Strobe dividing by three"></p>
<p>To use the strobe, you add a test for it inside your always block:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> (stb) <span style="color:#66d9ef">begin</span>
        <span style="color:#75715e">// do something every time the strobe fires
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>It&rsquo;s tempting to simplify this by using: <code>always_ff @(posedge stb)</code>.</p>
<p><strong>Never do this!</strong></p>
<p>While this might work for simple designs, it quickly leads to unstable designs and debugging headaches. Hardware design is hard enough without messing with clock distribution and crossing clock domains unnecessarily. Always use a proper clock signal in your sensitivity list.</p>
<h3 id="every-second-counts">Every Second Counts</h3>
<p>Let&rsquo;s say you want a one-second strobe: our clock is 100 MHz, so we need to divide by 100 million! Our counter needs to be 27 bits wide because log<sub>2</sub>(100,000,000) = 26.6.</p>
<p>We can use our new one-second strobe to turn the four green LEDs into a simple binary clock <strong>[<a href="https://github.com/projf/projf-explore/blob/master/hello/hello-nexys/G/top.sv">src</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    <span style="color:#66d9ef">localparam</span> DIV_BY <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#ae81ff">&#39;d100</span>_000_000;  <span style="color:#75715e">// 100 million
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">logic</span> stb;
    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">26</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (cnt <span style="color:#f92672">!=</span> DIV_BY<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
            stb <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (stb) led <span style="color:#f92672">&lt;=</span> led <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p><code>led</code> is a normal variable, so we can perform arithmetic on it, even though each of its bits is driving an LED.
<code>localparam</code> allows us to define a constant. You can use underscores to make numbers more readable.</p>
<blockquote>
<p>Our binary clock counts from zero to fifteen, then repeats.
You can extend this design to create a clock with seconds, minutes, and hours. How many LEDs would you need for this?</p>
</blockquote>
<h2 id="brighter-dimmer">Brighter, Dimmer</h2>
<p>Earlier we used a counter to blink LEDs. At low switching speeds they blink, but at higher speeds, they look like they&rsquo;re on all the time, but less bright. By altering the <em>proportion</em> of time the signal is high, and hence the LED is illuminated, we can control the perceived brightness. The is known as <strong>pulse width modulation</strong> or <strong>PWM</strong>.</p>
<p>PWN is commonly used in digital circuits to control the speed of motors as well as the brightness of lights (for example in the backlight of LCD screens).</p>
<p>The proportion of time the signal is high is known as the <strong>duty cycle</strong>. An 8-bit value (0-255), is commonly used for the duty cycle. The brightness of the LED is proportional to the duty: for example, if the duty is 64/255, the LED is roughly a quarter as bright.</p>
<p><img src="/img/posts/hello-arty/pwm.jpg" alt="Pulse Width Modulation" title="Pulse Width Modulation"></p>
<p>In the following example, we reduce the brightness of all four LEDs using a small duty cycle of 5/255. Replace the existing module in <code>top.sv</code> with <strong>[<a href="https://github.com/projf/projf-explore/blob/master/hello/hello-nexys/H/top.sv">src</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d5</span>;

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        led[<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> (cnt <span style="color:#f92672">&lt;</span> duty) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b1111</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b0000</span>;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>Run through the usual steps to program your board. The green LEDs should all be very dim; around 2% of maximum brightness.</p>
<p>Try adjusting the <strong>duty</strong> value to different values between 0 and 255 to see how the brightness changes. You can use binary, decimal, or hexadecimal literals as you like.</p>
<h2 id="duty-cycle-module">Duty Cycle Module</h2>
<p>If we wanted to control the brightness of each individual LED using the above approach we&rsquo;d end up with a great deal of duplication. Instead, we can break the PWM design out into a separate Verilog <strong>module</strong>. You should keep each module in a separate file.</p>
<p>The <code>pwm</code> module has inputs and outputs, just like the <code>top</code> module: it takes a duty input between 0 and 255 and produces the expected PWM output.</p>
<p>Create a <strong>new</strong> design source called <code>pwm.sv</code>, being sure to choose SystemVerilog as the file type. The module looks like this <strong>[<a href="https://github.com/projf/projf-explore/blob/master/hello/hello-nexys/I/pwm.sv">src</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> pwm (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> pwm_out
    );

    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b0</span>;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_comb</span> pwm_out <span style="color:#f92672">=</span> (cnt <span style="color:#f92672">&lt;</span> duty);
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p><em>ProTip: If you only have one statement in a block you don&rsquo;t need <code>begin</code> and <code>end</code>.</em></p>
<p>This design makes use of an <code>always_comb</code> and an <code>always_ff</code> block. <code>pwm_out</code> only depends on its current inputs, so we use an <code>always_comb</code> block. Whereas the counter <code>cnt</code> needs to maintain state, so has to use an <code>always_ff</code> block.</p>
<blockquote>
<p><strong>Combinational Logic</strong><br>
Depends on the combination of present inputs; past inputs are irrelevant.
Combinational outputs change immediately. Combinational logic is created with an <code>always_comb</code> block.</p>
<p><strong>Sequential Logic</strong><br>
Depends on the past sequence of inputs, as well as the present ones.
Sequential outputs change on a clock edge and use flip-flops. Sequential logic is created with an <code>always_ff</code> block.</p>
<p><em>Don&rsquo;t worry if this doesn&rsquo;t make sense right away. Keep designing and come back to it.</em></p>
</blockquote>
<h3 id="duty-to-our-leds">Duty to our LEDs</h3>
<p>To use the <code>pwm</code> module within our <code>top</code> module, we create an instance and connect up the inputs and outputs. Each module instance needs a unique name. We have four LEDs, so we create four instances: <code>pwm_led_0</code>, <code>pwm_led_1</code> etc. Replace your existing <code>top.sv</code> with <strong>[<a href="https://github.com/projf/projf-explore/blob/master/hello/hello-nexys/I/top.sv">src</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    pwm pwm_led_0 (.clk, .duty(<span style="color:#ae81ff">4</span>),   .pwm_out(led[<span style="color:#ae81ff">0</span>]));
    pwm pwm_led_1 (.clk, .duty(<span style="color:#ae81ff">16</span>),  .pwm_out(led[<span style="color:#ae81ff">1</span>]));
    pwm pwm_led_2 (.clk, .duty(<span style="color:#ae81ff">64</span>),  .pwm_out(led[<span style="color:#ae81ff">2</span>]));
    pwm pwm_led_3 (.clk, .duty(<span style="color:#ae81ff">255</span>), .pwm_out(led[<span style="color:#ae81ff">3</span>]));
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p><em>ProTip: You can write <code>.clk</code> rather than <code>.clk(clk)</code> because the names match.</em></p>
<p>Once you&rsquo;ve programmed your board with the updated design, you should see all four green LEDs lit, getting brighter from <strong><code>LD0</code></strong> to <strong><code>LD3</code></strong>.</p>
<h2 id="explore">Explore</h2>
<p>In the <a href="/posts/hello-arty-2/#red-green-blue">Arty version</a> of this post we now turn our attention to RGB LEDs. The Nexys Video doesn&rsquo;t have any RGB LEDs; instead try extending the designs to use all eight green LEDs on your board.</p>
<ul>
<li>Can you reduce the intensity of an LED to 50% <em>and</em> make it flash once a second?</li>
<li>Create a binary clock that counts the seconds from 0 to 59.</li>
</ul>
<h2 id="whats-next">What&rsquo;s Next?</h2>
<p>In the final part of this series, we’ll be covering shift registers, button debouncing, and the all-important finite state machine. The final part will be available soon. Part 3 is <a href="/posts/hello-arty-3/">already available for Arty</a>, if you&rsquo;d like a sneak peak.</p>
<p><em>Constructive feedback is always welcome. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/hello-nexys-1/">Hello Nexys - Part 1</a></li>
	
	<li><a href="/posts/hello-arty-2/">Hello Arty - Part 2</a></li>
	
	<li><a href="/posts/hello-arty-1/">Hello Arty - Part 1</a></li>
	
	<li><a href="/posts/lines-and-triangles/">Lines and Triangles</a></li>
	
	<li><a href="/posts/framebuffers/">Framebuffers</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>©2021 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://narwhal.projectf.io/script.js" site="EVCGKVDN" defer></script>
</body>
</html>

