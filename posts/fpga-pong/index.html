<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>FPGA Pong | Project F - FPGA Development</title>

<meta property='og:title' content='FPGA Pong - Project F - FPGA Development'>
<meta property='og:description' content='Welcome back to Exploring FPGA Graphics. In the previous part we got an introduction to FPGA graphics; now we&rsquo;re ready to put our graphical skills to work recreating the arcade classic: Pong.
In this series we explore graphics at the hardware level and get a feel for the power of FPGAs. We start by learning how displays work, before racing the beam with Pong, drawing starfields and sprites, simulating life with bitmaps, drawing lines and triangles, and finally creating simple 3D models.'>
<meta property='og:url' content='https://projectf.io/posts/fpga-pong/'>
<meta property='og:site_name' content='Project F - FPGA Development'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/fpga-pong/social-card.jpg'><meta property='article:published_time' content='2020-07-30T00:00:00Z'/><meta property='article:modified_time' content='2020-07-30T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F - FPGA Development" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/fpga-pong/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="referrer" content="no-referrer, same-origin">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F - FPGA Development</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/sitemap">
          <h2 class="title is-5">Sitemap</h2>
        </a><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/explore">
          <h2 class="title is-5">Explore</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/explore/">#explore</a>



  
  | <a class="subtitle is-6" href="/tags/graphics/">#graphics</a>
  


      
    </div>
    <h2 class="subtitle is-6">30 July 2020</h2>
    <h1 class="title">FPGA Pong</h1>
    
    <div class="content">
      <p>Welcome back to <em>Exploring FPGA Graphics</em>. In the previous part we got an <a href="/posts/fpga-graphics/">introduction to FPGA graphics</a>; now we&rsquo;re ready to put our graphical skills to work recreating the arcade classic: Pong.</p>
<p>In this series we explore graphics at the hardware level and get a feel for the power of FPGAs. We start by learning how displays work, before racing the beam with Pong, drawing starfields and sprites, simulating life with bitmaps, drawing lines and triangles, and finally creating simple 3D models. I&rsquo;ll be writing and revising this series throughout 2020. New to the series? Start with <a href="/posts/fpga-graphics/">Exploring FPGA Graphics</a>.</p>
<p><em>Revised 2020-08-18. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li><a href="/posts/fpga-graphics/">Exploring FPGA Graphics</a> - how displays work and simple animated colour graphics</li>
<li>FPGA Pong (this post) - race the beam to create the arcade classic</li>
<li><a href="/posts/fpga-ad-astra/">FPGA Ad Astra</a> - animated starfields, hardware sprites, and bitmap fonts</li>
<li>Life on Screen - bitmaps and Conway&rsquo;s Game of Life (being written)</li>
<li>Hard Lines - drawing lines and screen coordinates (planned Sep 2020)</li>
<li>More 2D &amp; 3D to follow (details TBC)</li>
</ul>
<h3 id="requirements">Requirements</h3>
<p>For this series, you need an FPGA board with video output. We&rsquo;ll be working at 640x480, so pretty much any video output will do. You should be comfortable with programming your FPGA board and reasonably familiar with Verilog.</p>
<p>We&rsquo;ll be demoing with these boards (FPGA type):</p>
<ul>
<li><strong><a href="https://github.com/icebreaker-fpga/icebreaker">iCEBreaker</a></strong> (Lattice iCE40) with <strong><a href="https://github.com/icebreaker-fpga/icebreaker">12-Bit DVI Pmod</a></strong></li>
<li><strong><a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a></strong> (Xilinx XC7) with <strong><a href="https://reference.digilentinc.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a></strong></li>
</ul>
<p>Follow the source <a href="https://github.com/projf/projf-explore/tree/master/fpga-pong">README</a> to quickly build a project for either of these boards.</p>
<blockquote>
<p><strong>iCEBreaker with VGA Pmod</strong><br>
The first part of this series included VGA designs for iCEBreaker. Maintaining three sets of designs was a significant overhead, so the iCEBreaker VGA version has been dropped from the examples.</p>
</blockquote>
<h3 id="source">Source</h3>
<p>All the Verilog designs featured in this series are available in the <a href="https://github.com/projf/projf-explore/">Exploring FPGAs repo</a>, and source links are included throughout the blog. The designs are open source under the permissive MIT licence, but this blog is subject to normal copyright restrictions.</p>
<h2 id="invading-the-living-room">Invading the Living Room</h2>
<p><img src="/img/posts/fpga-pong/pong_living_room.jpg" alt="70s gaming room in Computerspielemuseum, Berlin" title="So 70s it hurts"></p>
<p><em>Photograph by Sergey Galyonkin via <a href="https://commons.wikimedia.org/wiki/File:70s_gaming_room_in_Computerspielemuseum,_Berlin.jpg">Wikimedia</a> under Creative Commons <a href="https://creativecommons.org/licenses/by-sa/2.0/deed.en">Attribution-Share Alike</a> licence.</em></p>
<p><strong>Pong</strong> may not have been the first computer game, but it has an excellent claim to being the first to break into public consciousness when it was released in 1972. Originally an arcade cabinet, it was quickly adapted to be played at home attached to a television. If you&rsquo;d like to learn more about the early history of Atari, including Pong, I recommend <em><a href="https://mitpress.mit.edu/books/racing-beam">Racing the Beam</a></em> by Nick Montfort and Ian Bogost.</p>
<p><em>ProTip: If you&rsquo;re unfamiliar with Pong gameplay, check out this <a href="https://www.youtube.com/watch?v=it0sf4CMDeM">Pong video</a> on YouTube.</em></p>
<h2 id="ball--paddles">Ball &amp; Paddles</h2>
<p>In the <a href="/posts/fpga-graphics/">previous part</a> of this series, we learnt how to draw animated squares and perform collision detection. This gives us all we need to implement a square Pong ball:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// ball
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> B_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;          <span style="color:#75715e">// size in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] bx, by;       <span style="color:#75715e">// position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> dx, dy;                   <span style="color:#75715e">// direction: 0 is right/down
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spx <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d1</span>;  <span style="color:#75715e">// horizontal speed
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spy <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d1</span>;  <span style="color:#75715e">// vertical speed
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> b_draw;                   <span style="color:#75715e">// draw ball?
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (animate) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (bx <span style="color:#f92672">&gt;=</span> H_RES <span style="color:#f92672">-</span> (spx <span style="color:#f92672">+</span> B_SIZE)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// right edge
</span><span style="color:#75715e"></span>                dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                bx <span style="color:#f92672">&lt;=</span> bx <span style="color:#f92672">-</span> spx;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (bx <span style="color:#f92672">&lt;</span> spx) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// left edge
</span><span style="color:#75715e"></span>                dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                bx <span style="color:#f92672">&lt;=</span> bx <span style="color:#f92672">+</span> spx;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> bx <span style="color:#f92672">&lt;=</span> (dx) <span style="color:#f92672">?</span> bx <span style="color:#f92672">-</span> spx <span style="color:#f92672">:</span> bx <span style="color:#f92672">+</span> spx;

            <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&gt;=</span> V_RES <span style="color:#f92672">-</span> (spy <span style="color:#f92672">+</span> B_SIZE)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// bottom edge
</span><span style="color:#75715e"></span>                dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                by <span style="color:#f92672">&lt;=</span> by <span style="color:#f92672">-</span> spy;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&lt;</span> spy) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// top edge
</span><span style="color:#75715e"></span>                dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                by <span style="color:#f92672">&lt;=</span> by <span style="color:#f92672">+</span> spy;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> by <span style="color:#f92672">&lt;=</span> (dy) <span style="color:#f92672">?</span> by <span style="color:#f92672">-</span> spy <span style="color:#f92672">:</span> by <span style="color:#f92672">+</span> spy;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        b_draw <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;=</span> bx) <span style="color:#f92672">&amp;&amp;</span> (sx <span style="color:#f92672">&lt;</span> bx <span style="color:#f92672">+</span> B_SIZE)
              <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;=</span> by) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&lt;</span> by <span style="color:#f92672">+</span> B_SIZE);
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>Next, we need to add some paddles. The paddles are simple rectangles that move vertically on the left and right sides of the screen. These paddles have a crude AI that compares their vertical position to the ball and moves them in the direction of the ball. We check if the paddles have reached the screen edge, but not whether they&rsquo;ve have collided with the ball.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// paddles
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> P_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>;       <span style="color:#75715e">// height in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> P_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;       <span style="color:#75715e">// width in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> P_SPEED  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;        <span style="color:#75715e">// speed
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> P_OFFSET <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;       <span style="color:#75715e">// offset from screen edge
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] p1y, p2y;     <span style="color:#75715e">// vertical position of paddles 1 and 2
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> p1_draw, p2_draw;         <span style="color:#75715e">// draw paddles?
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (animate) <span style="color:#66d9ef">begin</span>
            <span style="color:#75715e">// &#34;AI&#34; paddle 1
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ((p1y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;</span> by) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// top of ball is below
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (p1y <span style="color:#f92672">&lt;</span> V_RES <span style="color:#f92672">-</span> (P_HEIGHT <span style="color:#f92672">+</span> P_SPEED)) p1y <span style="color:#f92672">&lt;=</span> p1y <span style="color:#f92672">+</span> P_SPEED;  <span style="color:#75715e">// screen bottom?
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">if</span> ((p1y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&gt;</span> (by <span style="color:#f92672">+</span> B_SIZE)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// bottom of ball is above
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (p1y <span style="color:#f92672">&gt;</span> P_SPEED) p1y <span style="color:#f92672">&lt;=</span> p1y <span style="color:#f92672">-</span> P_SPEED;  <span style="color:#75715e">// screen top?
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>

            <span style="color:#75715e">// &#34;AI&#34; paddle 2
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ((p2y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;</span> by) <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (p2y <span style="color:#f92672">&lt;</span> V_RES <span style="color:#f92672">-</span> (P_HEIGHT <span style="color:#f92672">+</span> P_SPEED)) p2y <span style="color:#f92672">&lt;=</span> p2y <span style="color:#f92672">+</span> P_SPEED;
            <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">if</span> ((p2y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&gt;</span> (by <span style="color:#f92672">+</span> B_SIZE)) <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (p2y <span style="color:#f92672">&gt;</span> P_SPEED) p2y <span style="color:#f92672">&lt;=</span> p2y <span style="color:#f92672">-</span> P_SPEED;
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        p1_draw <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;=</span> P_OFFSET) <span style="color:#f92672">&amp;&amp;</span> (sx <span style="color:#f92672">&lt;</span> P_OFFSET <span style="color:#f92672">+</span> P_WIDTH)
               <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;=</span> p1y) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&lt;</span> p1y <span style="color:#f92672">+</span> P_HEIGHT);
        p2_draw <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;=</span> H_RES <span style="color:#f92672">-</span> P_OFFSET <span style="color:#f92672">-</span> P_WIDTH) <span style="color:#f92672">&amp;&amp;</span> (sx <span style="color:#f92672">&lt;</span> H_RES <span style="color:#f92672">-</span> P_OFFSET)
               <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;=</span> p2y) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&lt;</span> p2y <span style="color:#f92672">+</span> P_HEIGHT);
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>We compare paddle positions with the top or bottom of the ball to prevent them being too twitchy.</p>
<h3 id="pong-v1">Pong v1</h3>
<p>We can use the ball and paddle logic to create a first version of the top module for Pong. Our top module is based on that from <a href="/posts/fpga-graphics/">Exploring FPGA Graphics</a>, with the same clock generator and display timings.</p>
<ul>
<li>Xilinx XC7: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/xc7/top_pong_v1.sv">xc7/top_pong_v1.sv</a></strong></li>
<li>Lattice iCE40: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/ice40/top_pong_v1.sv">ice40/top_pong_v1.sv</a></strong></li>
</ul>
<p>All the files you need to build this design are available in the <a href="https://github.com/projf/projf-explore/tree/master/fpga-pong">FPGA Pong repo</a>. There is a makefile for iCEBreaker and a Vivado project for Arty.</p>
<p><img src="/img/posts/fpga-pong/icebreaker-pong.jpg" alt="Pong on the iCEBreaker" title="iCEBreaker Pong"></p>
<p><em>Pong on the iCEBreaker board. You can easily change the colours of the background and ball/paddles.</em></p>
<h2 id="collision">Collision</h2>
<p>It&rsquo;s briefly fun to watch the ball crawl around the screen with the paddles, but this isn&rsquo;t exactly a game, even a demo of one: the ball shows a blatant disregard for the paddles.</p>
<p>To test for paddle collision, we take advantage of the drawing signals: if we&rsquo;re drawing the ball and a paddle at the same time, then there&rsquo;s a collision. The collision occurs during the drawing process, so we need to store it and use it when we next animate.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#66d9ef">logic</span> p1_col, p2_col;  <span style="color:#75715e">// paddle collision?
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// paddle collision detection
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (animate) <span style="color:#66d9ef">begin</span>
            p1_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            p2_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (b_draw) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (p1_draw) p1_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">if</span> (p2_draw) p2_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>We reset the collision detection when we receive the <code>animate</code> signal. However, the value of <code>col_p1</code> and <code>col_p2</code> is available until the next clock tick, so the ball animation can always use it.</p>
<p>Update the horizontal ball animation to check for paddle collisions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// ball animation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (animate) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (p1_col) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// left paddle collision
</span><span style="color:#75715e"></span>                dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                bx <span style="color:#f92672">&lt;=</span> bx <span style="color:#f92672">+</span> spx;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (p2_col) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// right paddle collision
</span><span style="color:#75715e"></span>                dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                bx <span style="color:#f92672">&lt;=</span> bx <span style="color:#f92672">-</span> spx;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (bx <span style="color:#f92672">&gt;=</span> H_RES <span style="color:#f92672">-</span> (spx <span style="color:#f92672">+</span> B_SIZE)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// right edge
</span><span style="color:#75715e"></span>                dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                bx <span style="color:#f92672">&lt;=</span> bx <span style="color:#f92672">-</span> spx;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (bx <span style="color:#f92672">&lt;</span> spx) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// left edge
</span><span style="color:#75715e"></span>                dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                bx <span style="color:#f92672">&lt;=</span> bx <span style="color:#f92672">+</span> spx;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> bx <span style="color:#f92672">&lt;=</span> (dx) <span style="color:#f92672">?</span> bx <span style="color:#f92672">-</span> spx <span style="color:#f92672">:</span> bx <span style="color:#f92672">+</span> spx;
</code></pre></div><p>We can also speed up the ball and paddles by editing the following values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spx <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d6</span>;  <span style="color:#75715e">// horizontal speed
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spy <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d4</span>;  <span style="color:#75715e">// vertical speed
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">localparam</span> P_SPEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</code></pre></div><h3 id="pong-v2">Pong v2</h3>
<p>Build and test the updated version with paddle collisions:</p>
<ul>
<li>Xilinx XC7: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/xc7/top_pong_v2.sv">xc7/top_pong_v2.sv</a></strong></li>
<li>Lattice iCE40: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/ice40/top_pong_v2.sv">ice40/top_pong_v2.sv</a></strong></li>
</ul>
<h2 id="controls">Controls</h2>
<p>So far the FPGA has been playing against itself. If you want to get in on the action, we need to add some controls. We&rsquo;re going to use three buttons: up, control, and down.</p>
<p>Add the buttons to the top module ports:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_up,       <span style="color:#75715e">// up button
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_ctrl,     <span style="color:#75715e">// control button
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_dn,       <span style="color:#75715e">// down button
</span></code></pre></div><p>We need to map these buttons to FPGA pins in the constraints file. You&rsquo;ll be happy to hear I&rsquo;ve already done this for you:</p>
<ul>
<li>Xilinx XC7: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/xc7/arty.xdc">arty.xdc</a></strong></li>
<li>Lattice iCE40: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/ice40/icebreaker.pcf">ice40/icebreaker.pcf</a></strong></li>
</ul>
<p>On the iCEBreaker the buttons map as follows:</p>
<ul>
<li>Button 1 - down</li>
<li>Button 2 - control</li>
<li>Button 3 - up</li>
</ul>
<p>And on the Arty:</p>
<ul>
<li>BTN0 - down</li>
<li>BTN1 - control</li>
<li>BTN3 - up</li>
</ul>
<p>To safely use buttons in our design, we need to debounce them. Debouncing ensures we get a single, clean, transition from button presses. The debounce module looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> debounce (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,  <span style="color:#75715e">// clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> in,   <span style="color:#75715e">// signal input
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> out,  <span style="color:#75715e">// signal output (debounced)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> ondn, <span style="color:#75715e">// on down (one tick)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> onup  <span style="color:#75715e">// on up (one tick)
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// sync with clock and combat metastability
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> sync_0, sync_1;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) sync_0 <span style="color:#f92672">&lt;=</span> in;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) sync_1 <span style="color:#f92672">&lt;=</span> sync_0;

    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt;  <span style="color:#75715e">// 2^17 = 1.3 ms counter at 100 MHz
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> idle, max;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        idle <span style="color:#f92672">=</span> (out <span style="color:#f92672">==</span> sync_1);
        max  <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cnt;
        ondn <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>idle <span style="color:#f92672">&amp;</span> max <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>out;
        onup <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>idle <span style="color:#f92672">&amp;</span> max <span style="color:#f92672">&amp;</span> out;
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (idle) <span style="color:#66d9ef">begin</span>
            cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
            cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">if</span> (max) out <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">~</span>out;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>We want continuous signals for up and down, but a one-off event for the control button:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// debounce buttons
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> sig_ctrl, move_up, move_dn;
    debounce deb_btn_ctrl (.clk(clk_pix), .in(btn_ctrl), .out(), .ondn(), .onup(sig_ctrl));
    debounce deb_btn_up (.clk(clk_pix), .in(btn_up), .out(move_up), .ondn(), .onup());
    debounce deb_btn_dn (.clk(clk_pix), .in(btn_dn), .out(move_dn), .ondn(), .onup());
</code></pre></div><p>The <code>onup()</code> and <code>ondown()</code> outputs work like traditional UI events. In this case, <code>sig_ctrl</code> will be high for one tick when the control button is released.</p>
<p>We start with two states:</p>
<ul>
<li><strong>IDLE</strong> - both paddles are controlled by the AI (demo)</li>
<li><strong>PLAY</strong> - enable player paddle</li>
</ul>
<p>Pressing the control button switches between these states, while the up and down buttons are used to control the paddle.</p>
<p>We define the state using an enum and a simple finite state machine. This is overkill for two states but makes it easy to expand our game to include other concepts, such as the end of a point.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// game state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {IDLE, PLAY} state, state_next;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        state_next <span style="color:#f92672">=</span> IDLE;
        <span style="color:#66d9ef">case</span>(state)
            IDLE: state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> PLAY <span style="color:#f92672">:</span> IDLE;
            PLAY: state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> IDLE <span style="color:#f92672">:</span> PLAY;
        <span style="color:#66d9ef">endcase</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        state <span style="color:#f92672">&lt;=</span> state_next;
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>The first paddle control logic meeds updating to reflect the state of play:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// paddle animation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (animate) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> PLAY) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// human paddle 1
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (move_up) <span style="color:#66d9ef">begin</span>
                    <span style="color:#66d9ef">if</span> (p1y <span style="color:#f92672">&gt;</span> P_SPEED) p1y <span style="color:#f92672">&lt;=</span> p1y <span style="color:#f92672">-</span> P_SPEED;  <span style="color:#75715e">// at top?
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">end</span>
                <span style="color:#66d9ef">if</span> (move_dn) <span style="color:#66d9ef">begin</span>
                    <span style="color:#66d9ef">if</span> (p1y <span style="color:#f92672">&lt;</span> V_RES <span style="color:#f92672">-</span> (P_HEIGHT <span style="color:#f92672">+</span> P_SPEED)) p1y <span style="color:#f92672">&lt;=</span> p1y <span style="color:#f92672">+</span> P_SPEED;  <span style="color:#75715e">// at bottom?
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// &#34;AI&#34; paddle 1
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> ((p1y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;</span> (by <span style="color:#f92672">+</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// ball is below
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (p1y <span style="color:#f92672">&lt;</span> V_RES <span style="color:#f92672">-</span> (P_HEIGHT <span style="color:#f92672">+</span> P_SPEED)) p1y <span style="color:#f92672">&lt;=</span> p1y <span style="color:#f92672">+</span> P_SPEED;  <span style="color:#75715e">// at bottom?
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">end</span>
                <span style="color:#66d9ef">if</span> ((p1y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&gt;</span> by <span style="color:#f92672">+</span> (B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// ball is above
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (p1y <span style="color:#f92672">&gt;</span> P_SPEED) p1y <span style="color:#f92672">&lt;=</span> p1y <span style="color:#f92672">-</span> P_SPEED;  <span style="color:#75715e">// at top?
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span>

            <span style="color:#75715e">// &#34;AI&#34; paddle 2
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ((p2y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;</span> (by <span style="color:#f92672">+</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (p2y <span style="color:#f92672">&lt;</span> V_RES <span style="color:#f92672">-</span> (P_HEIGHT <span style="color:#f92672">+</span> P_SPEED)) p2y <span style="color:#f92672">&lt;=</span> p2y <span style="color:#f92672">+</span> P_SPEED;
            <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">if</span> ((p2y <span style="color:#f92672">+</span> P_HEIGHT<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&gt;</span> (by <span style="color:#f92672">+</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (p2y <span style="color:#f92672">&gt;</span> P_SPEED) p2y <span style="color:#f92672">&lt;=</span> p2y <span style="color:#f92672">-</span> P_SPEED;
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="pong-v3">Pong v3</h3>
<p>Build and test the updated version with controls:</p>
<ul>
<li>Xilinx XC7: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/xc7/top_pong_v3.sv">xc7/top_pong_v3.sv</a></strong></li>
<li>Lattice iCE40: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/ice40/top_pong_v3.sv">ice40/top_pong_v3.sv</a></strong></li>
</ul>
<p>Press the control (middle) button to take over the left-hand paddle. How do you get on? Is the ball too fast or slow? You can adjust the speed of the ball, changing the values of <code>spx</code> and <code>spy</code>.</p>
<h2 id="wheres-the-skill">Where&rsquo;s the Skill?</h2>
<p>We still don&rsquo;t have a game: the ball doesn&rsquo;t go out of play. Let&rsquo;s fix this.</p>
<p>First off, we&rsquo;ll add additional states to the game:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// game state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {INIT, IDLE, START, PLAY, POINT_END} state, state_next;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        state_next <span style="color:#f92672">=</span> INIT;
        <span style="color:#66d9ef">case</span>(state)
            INIT: state_next <span style="color:#f92672">=</span> IDLE;
            IDLE: state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> START <span style="color:#f92672">:</span> IDLE;
            START: state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> PLAY <span style="color:#f92672">:</span> START;
            PLAY: state_next <span style="color:#f92672">=</span> (lft_col <span style="color:#f92672">||</span> rgt_col) <span style="color:#f92672">?</span> POINT_END <span style="color:#f92672">:</span> PLAY;
            POINT_END: state_next <span style="color:#f92672">=</span> (sig_ctrl) <span style="color:#f92672">?</span> START <span style="color:#f92672">:</span> POINT_END;
        <span style="color:#66d9ef">endcase</span>
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>The five states:</p>
<ul>
<li><strong>INIT</strong> - initialize ball position, speed, etc. when powered on</li>
<li><strong>IDLE</strong> - both paddles are controlled by the AI (demo)</li>
<li><strong>START</strong> - reset ball position, speed, etc. in preparation to play a point</li>
<li><strong>PLAY</strong> - enable player paddle and play a point</li>
<li><strong>POINT_END</strong> - ball has collided with left or right edge of the screen, so stop</li>
</ul>
<p>Once a point has ended, the player presses the control button to set up the game for the next point. Pressing the control button no longer switches to demo mode.</p>
<p>You&rsquo;ll notice that the PLAY state transitions to POINT_END if <code>lft_col</code> or <code>rgt_col</code> are high. We need to set these when the ball collides with the left or right edge of the screen.</p>
<p>It&rsquo;s a quick change to the ball animation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (bx <span style="color:#f92672">&gt;=</span> H_RES <span style="color:#f92672">-</span> (spx <span style="color:#f92672">+</span> B_SIZE)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// right edge
</span><span style="color:#75715e"></span>        rgt_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (bx <span style="color:#f92672">&lt;</span> spx) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// left edge
</span><span style="color:#75715e"></span>        lft_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> bx <span style="color:#f92672">&lt;=</span> (dx) <span style="color:#f92672">?</span> bx <span style="color:#f92672">-</span> spx <span style="color:#f92672">:</span> bx <span style="color:#f92672">+</span> spx;
</code></pre></div><blockquote>
<p><strong>Quick Aside:</strong> If you&rsquo;re not sure what goes where, check out the finished versions.<br>
Lattice iCE40: <a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/ice40/top_pong_v4.sv">ice40/top_pong_v4.sv</a> or Xilinx XC7: <a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/xc7/top_pong_v4.sv">xc7/top_pong_v4.sv</a>.
.</p>
</blockquote>
<p>We then add support for the INIT and START states to paddle and ball animation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// paddle animation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> INIT <span style="color:#f92672">||</span> state <span style="color:#f92672">==</span> START) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reset paddle positions
</span><span style="color:#75715e"></span>            p1y <span style="color:#f92672">&lt;=</span> (V_RES <span style="color:#f92672">-</span> P_HEIGHT) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>;
            p2y <span style="color:#f92672">&lt;=</span> (V_RES <span style="color:#f92672">-</span> P_HEIGHT) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (animate <span style="color:#f92672">&amp;&amp;</span> state <span style="color:#f92672">!=</span> POINT_END) <span style="color:#66d9ef">begin</span>

    ...
    <span style="color:#75715e">// ball animation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> INIT <span style="color:#f92672">||</span> state <span style="color:#f92672">==</span> START) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reset ball position
</span><span style="color:#75715e"></span>            bx <span style="color:#f92672">&lt;=</span> (H_RES <span style="color:#f92672">-</span> B_SIZE) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>;
            by <span style="color:#f92672">&lt;=</span> (V_RES <span style="color:#f92672">-</span> B_SIZE) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>;
            dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// serve towards player 2 (AI)
</span><span style="color:#75715e"></span>            dy <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">~</span>dy;
            spx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d5</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d2</span>;
            lft_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            rgt_col <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (animate <span style="color:#f92672">&amp;&amp;</span> state <span style="color:#f92672">!=</span> POINT_END) <span style="color:#66d9ef">begin</span>
</code></pre></div><h2 id="bouncing-mad">Bouncing Mad</h2>
<p>To make the game more interesting we can change the angle of bounce depending on whether the ball hits the paddle. The simple way to do this is to update the vertical speed depending on where the ball hits the paddle. We create a new parameter called <strong>P_SEC</strong>, which is the size of a section of paddle:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// paddles
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> P_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>;           <span style="color:#75715e">// height in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> P_SEC <span style="color:#f92672">=</span> P_HEIGHT <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>;    <span style="color:#75715e">// paddle sections
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> P_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;           <span style="color:#75715e">// width in pixels
</span></code></pre></div><p>It&rsquo;s then just a case of comparing the vertical ball position with that of the paddle when a collision occurs. Here&rsquo;s the logic for the 1st paddle:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#66d9ef">if</span> (p1_col) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// left paddle collision
</span><span style="color:#75715e"></span>        dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        bx <span style="color:#f92672">&lt;=</span> bx <span style="color:#f92672">+</span> spx;
        <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&lt;</span> p1y <span style="color:#f92672">-</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> P_SEC) <span style="color:#66d9ef">begin</span>
            dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d5</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&lt;</span> p1y <span style="color:#f92672">-</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>P_SEC) <span style="color:#66d9ef">begin</span> 
            dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d4</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&lt;</span> p1y <span style="color:#f92672">-</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>P_SEC) <span style="color:#66d9ef">begin</span> 
            dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d2</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&lt;</span> p1y <span style="color:#f92672">-</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span>P_SEC) <span style="color:#66d9ef">begin</span> 
            dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&lt;</span> p1y <span style="color:#f92672">-</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">*</span>P_SEC) <span style="color:#66d9ef">begin</span> 
            dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d2</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (by <span style="color:#f92672">&lt;</span> p1y <span style="color:#f92672">-</span> B_SIZE<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span><span style="color:#f92672">*</span>P_SEC) <span style="color:#66d9ef">begin</span> 
            dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d4</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
            dy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            spy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span><span style="color:#ae81ff">&#39;d5</span>;
        <span style="color:#66d9ef">end</span>
</code></pre></div><p>Repeat this for the second paddle <code>p2y</code>, and you&rsquo;ve got a pretty decent game of Pong.</p>
<h3 id="pong-v4">Pong v4</h3>
<p>Our fourth version is ready to play. With the default speeds it is possible to win a point against the AI:</p>
<ul>
<li>Xilinx XC7: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/xc7/top_pong_v4.sv">xc7/top_pong_v4.sv</a></strong></li>
<li>Lattice iCE40: <strong><a href="https://github.com/projf/projf-explore/blob/master/fpga-pong/ice40/top_pong_v4.sv">ice40/top_pong_v4.sv</a></strong></li>
</ul>
<h2 id="scoring">Scoring</h2>
<p>At the moment we don&rsquo;t show a score for the players. We&rsquo;ll come back to this once we can draw sprites. Alternatively, you could draw simple blocks on screen to keep score.</p>
<h2 id="explore">Explore</h2>
<p>I hope you enjoyed this instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few suggestions to improve FPGA Pong:</p>
<ul>
<li>Change the colours of the ball and paddles</li>
<li>Add a net down the middle of the screen</li>
<li>Increase the ball speed over time until a point is lost</li>
<li>Improve AI, so it positions the paddle to direct the ball away from the player</li>
</ul>
<h2 id="next-time">Next Time</h2>
<p>In the next part, we&rsquo;ll learn about hardware sprites and generate an animated starfield in <a href="/posts/fpga-ad-astra/">FPGA Ad Astra</a>.</p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/fpga-ad-astra/">FPGA Ad Astra</a></li>
	
	<li><a href="/posts/fpga-graphics/">Exploring FPGA Graphics</a></li>
	
	<li><a href="/posts/video-timings-vga-720p-1080p/">Video Timings: VGA, SVGA, 720p, 1080p</a></li>
	
	<li><a href="/posts/hello-arty-2/">Hello Arty - Part 2</a></li>
	
	<li><a href="/posts/hello-arty-1/">Hello Arty - Part 1</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>2020 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://narwhal.projectf.io/script.js" site="EVCGKVDN" defer></script>
</body>
</html>

