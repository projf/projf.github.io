<!doctype html><html class="not-ready lg:text-base" style=--bg:#fff lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>FPGA Pong - Project F</title><meta name=theme-color><meta name=description content="Welcome back to Exploring FPGA Graphics. Last time, we raced the beam; this time, we&rsquo;ll recreate the arcade classic, Pong and play against our FPGA.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series?"><meta name=author content="Will Green"><link rel="preload stylesheet" as=style href=https://projectf.io/main.min.css><script defer src=https://projectf.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://projectf.io/theme.png><link rel=preload as=image href=https://projectf.io/github.svg><link rel=preload as=image href=https://projectf.io/mastodon.svg><link rel=preload as=image href=https://projectf.io/rss.svg><link rel=icon href=https://projectf.io/favicon.ico><link rel=apple-touch-icon href=https://projectf.io/apple-touch-icon.png><meta name=generator content="Hugo 0.118.2"><script src=https://cdn-eu.usefathom.com/script.js data-site=EVCGKVDN defer></script><meta itemprop=name content="FPGA Pong"><meta itemprop=description content="Welcome back to Exploring FPGA Graphics. Last time, we raced the beam; this time, we&rsquo;ll recreate the arcade classic, Pong and play against our FPGA.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series?"><meta itemprop=datePublished content="2020-07-30T00:00:00+00:00"><meta itemprop=dateModified content="2023-07-14T00:00:00+00:00"><meta itemprop=wordCount content="4087"><meta itemprop=image content="https://projectf.io/img/posts/fpga-pong/social-card.jpg"><meta itemprop=keywords content="games,graphics,arty-a7,icebreaker,verilator,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://projectf.io/img/posts/fpga-pong/social-card.jpg"><meta name=twitter:title content="FPGA Pong"><meta name=twitter:description content="Welcome back to Exploring FPGA Graphics. Last time, we raced the beam; this time, we&rsquo;ll recreate the arcade classic, Pong and play against our FPGA.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series?"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-4xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://projectf.io>Project F</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#fff".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/demos/>Demos</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/verilog-lib/>Lib</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tools/>Tools</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tutorials/>Tutorials</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/projf target=_blank rel=me>github</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./mastodon.svg) href=https://mastodon.social/@WillFlux target=_blank rel=me>mastodon</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://projectf.io/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-4xl px-8 pb-4 pt-4 dark:prose-invert"><article><header class=mb-4><h1 class="!my-0 pb-2.5">FPGA Pong</h1><div class="text-sm antialiased opacity-60">Published
<time>30 Jul 2020</time>
<span class=mx-1>&#183;</span>
<span>Updated
<time>14 Jul 2023</time></span></div></header><section><p>Welcome back to <em>Exploring FPGA Graphics</em>. Last time, we <a href=/posts/racing-the-beam/>raced the beam</a>; this time, we&rsquo;ll recreate the arcade classic, Pong and play against our FPGA.</p><p>In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series? Start with <a href=/posts/fpga-graphics/>Beginning FPGA Graphics</a>.</p><p><img src=/img/posts/fpga-pong/banner.png alt title></p><h3 id=series-outline>Series Outline</h3><ul><li><a href=/posts/fpga-graphics/>Beginning FPGA Graphics</a> - video signals and basic graphics</li><li><a href=/posts/racing-the-beam/>Racing the Beam</a> - simple demo effects with minimal logic</li><li>Pong (this post) - recreate the classic arcade on an FPGA</li><li><a href=/posts/display-signals/>Display Signals</a> - revisit display signals and meet colour palettes</li><li><a href=/posts/hardware-sprites/>Hardware Sprites</a> - fast, colourful graphics for games</li><li><a href=/posts/framebuffers/>Framebuffers</a> - bitmap graphics featuring Michelangelo&rsquo;s David</li><li><a href=/posts/life-on-screen/>Life on Screen</a> - Conway&rsquo;s Game of Life in logic</li><li><a href=/posts/lines-and-triangles/>Lines and Triangles</a> - drawing lines and triangles</li><li><a href=/posts/fpga-shapes/>2D Shapes</a> - filled shapes and simple pictures</li><li><a href=/posts/animated-shapes/>Animated Shapes</a> - animation and double-buffering</li></ul><h3 id=requirements>Requirements</h3><p>You should be to run these designs on any recent FPGA board. I include everything you need for the <a href=https://docs.icebreaker-fpga.org/hardware/icebreaker/>iCEBreaker</a> with <a href=https://docs.icebreaker-fpga.org/hardware/pmod/dvi/>12-Bit DVI Pmod</a>, <a href=https://digilent.com/reference/programmable-logic/arty-a7/reference-manual>Digilent Arty A7-35T</a> with <a href=https://digilent.com/reference/pmod/pmodvga/reference-manual>Pmod VGA</a>, <a href=https://digilent.com/reference/programmable-logic/nexys-video/reference-manual>Digilent Nexys Video</a> with on-board HDMI output, and <a href=/posts/verilog-sim-verilator-sdl/>Verilator Simulation with SDL</a>. See <a href=/posts/fpga-graphics/#requirements>requirements</a> from <em>Beginning FPGA Graphics</em> for more details.</p><h2 id=invading-the-living-room>Invading the Living Room</h2><p><img src=/img/posts/fpga-pong/pong_living_room.jpg alt="70s gaming room in Computerspielemuseum, Berlin" title="So 70s it hurts"></p><p><em>Photo by <a href=https://commons.wikimedia.org/wiki/File:70s_gaming_room_in_Computerspielemuseum,_Berlin.jpg>Sergey Galyonkin</a> under Creative Commons <a href=https://creativecommons.org/licenses/by-sa/2.0/deed.en>Attribution-Share Alike</a> licence.</em></p><p>Pong may not have been the first computer game, but it has an excellent claim to being the first to break into public consciousness on release in 1972. Originally an arcade cabinet, it was quickly adapted for play at home with a television.</p><p><a href=http://www.pong-story.com/atpong1.htm>The Pong Story</a> explains the history of Atari Pong and includes a detailed PDF on the design: <a href=http://www.pong-story.com/LAWN_TENNIS.pdf>Atari Pong E Circuit Analysis & Lawn Tennis</a>. You can also watch <a href="https://www.youtube.com/watch?v=it0sf4CMDeM">Pong gameplay</a> on YouTube.</p><p>If you&rsquo;d like to learn more about the early history of Atari, including Pong, I recommend the book <em><a href=https://mitpress.mit.edu/books/racing-beam>Racing the Beam</a></em> by Nick Montfort and Ian Bogost.</p><h2 id=pong-design>Pong Design</h2><p>This design is not based on the detail of the original Pong gameplay. I&rsquo;ve chosen FPGA design over authenticity, but you&rsquo;re welcome to change the design however you like (it&rsquo;s open source):</p><ul><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/pong/ice40/top_pong.sv>ice40/top_pong.sv</a></strong></li><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/pong/xc7/top_pong.sv>xc7/top_pong.sv</a></strong></li><li>Nexys Video (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/pong/xc7-dvi/top_pong.sv>xc7-dvi/top_pong.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/pong/sim/top_pong.sv>sim/top_pong.sv</a></strong></li></ul><p>Try the design out on your board or in simulation; see the <a href=https://github.com/projf/projf-explore/tree/main/graphics/pong>README</a> or <a href=https://github.com/projf/projf-explore/tree/main/graphics/pong>Sim README</a> for build instructions.</p><p>On the iCEBreaker, the controls are:</p><ul><li>Button 1 - down</li><li>Button 2 - start (fire)</li><li>Button 3 - up</li></ul><p>On the Arty:</p><ul><li>BTN0 - down</li><li>BTN1 - start (fire)</li><li>BTN3 - up</li></ul><p>In the Verilator Sim:</p><ul><li>Down Arrow - down</li><li>Space - start (fire)</li><li>Up Arrow - up</li></ul><p><em>You can edit the simulation keyboard controls in main_pong.cpp.</em></p><p><img src=/img/posts/fpga-pong/pong-vs-icebreaker.jpeg alt="Playing Pong against the iCEBreaker dev board using DVI Pmod." title="Losing a point to iCEBreaker!"></p><h2 id=pong-in-verilog>Pong in Verilog</h2><p>Here&rsquo;s the whole game as a Verilator simulation. Have a glance over it, then scroll down to learn how the different parts of the design work.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_pong #(<span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>) (    <span style=color:#75715e>// coordinate width
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_pix,             <span style=color:#75715e>// pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> sim_rst,             <span style=color:#75715e>// sim reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_fire,            <span style=color:#75715e>// fire button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_up,              <span style=color:#75715e>// up button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_dn,              <span style=color:#75715e>// down button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_sx,  <span style=color:#75715e>// horizontal SDL position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_sy,  <span style=color:#75715e>// vertical SDL position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> sdl_de,              <span style=color:#75715e>// data enable (low in blanking interval)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_r,         <span style=color:#75715e>// 8-bit red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_g,         <span style=color:#75715e>// 8-bit green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_b          <span style=color:#75715e>// 8-bit blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// gameplay parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> WIN        <span style=color:#f92672>=</span>  <span style=color:#ae81ff>4</span>;  <span style=color:#75715e>// score needed to win a game (max 9)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPEEDUP    <span style=color:#f92672>=</span>  <span style=color:#ae81ff>5</span>;  <span style=color:#75715e>// speed up ball after this many shots (max 16)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> BALL_SIZE  <span style=color:#f92672>=</span>  <span style=color:#ae81ff>8</span>;  <span style=color:#75715e>// ball size in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> BALL_ISPX  <span style=color:#f92672>=</span>  <span style=color:#ae81ff>5</span>;  <span style=color:#75715e>// initial horizontal ball speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> BALL_ISPY  <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// initial vertical ball speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> PAD_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>48</span>;  <span style=color:#75715e>// paddle height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> PAD_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;  <span style=color:#75715e>// paddle width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> PAD_OFFS   <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;  <span style=color:#75715e>// paddle distance from edge of screen in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> PAD_SPY    <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// vertical paddle speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de;
</span></span><span style=display:flex><span>    simple_480p display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix(sim_rst),
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync(),
</span></span><span style=display:flex><span>        .vsync(),
</span></span><span style=display:flex><span>        .de
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// screen dimensions (must match display_inst)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> H_RES <span style=color:#f92672>=</span> <span style=color:#ae81ff>640</span>;  <span style=color:#75715e>// horizontal screen resolution
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> V_RES <span style=color:#f92672>=</span> <span style=color:#ae81ff>480</span>;  <span style=color:#75715e>// vertical screen resolution
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> frame;  <span style=color:#75715e>// high for one clock tick at the start of vertical blanking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> frame <span style=color:#f92672>=</span> (sy <span style=color:#f92672>==</span> V_RES <span style=color:#f92672>&amp;&amp;</span> sx <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// scores
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] score_l;  <span style=color:#75715e>// left-side score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] score_r;  <span style=color:#75715e>// right-side score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// drawing signals
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> ball, padl, padr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ball properties
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] ball_x, ball_y;  <span style=color:#75715e>// position (origin at top left)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] ball_spx;        <span style=color:#75715e>// horizontal speed (pixels/frame)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] ball_spy;        <span style=color:#75715e>// vertical speed (pixels/frame)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] shot_cnt;              <span style=color:#75715e>// shot counter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> ball_dx, ball_dy;            <span style=color:#75715e>// direction: 0 is right/down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> ball_dx_prev;                <span style=color:#75715e>// direction in previous tick (for shot counting)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> coll_r, coll_l;              <span style=color:#75715e>// screen collision flags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// paddle properties
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] padl_y, padr_y;  <span style=color:#75715e>// vertical position of left and right paddles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] ai_y, play_y;    <span style=color:#75715e>// vertical position of AI and player paddle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// link paddles to AI or player
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        padl_y <span style=color:#f92672>=</span> play_y;
</span></span><span style=display:flex><span>        padr_y <span style=color:#f92672>=</span> ai_y;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// debounce buttons
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> sig_fire, sig_up, sig_dn;
</span></span><span style=display:flex><span>    debounce deb_fire (.clk(clk_pix), .in(btn_fire), .out(), .ondn(), .onup(sig_fire));
</span></span><span style=display:flex><span>    debounce deb_up (.clk(clk_pix), .in(btn_up), .out(sig_up), .ondn(), .onup());
</span></span><span style=display:flex><span>    debounce deb_dn (.clk(clk_pix), .in(btn_dn), .out(sig_dn), .ondn(), .onup());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// game state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>enum</span> {NEW_GAME, POSITION, READY, POINT, END_GAME, PLAY} state, state_next;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>            NEW_GAME: state_next <span style=color:#f92672>=</span> POSITION;
</span></span><span style=display:flex><span>            POSITION: state_next <span style=color:#f92672>=</span> READY;
</span></span><span style=display:flex><span>            READY: state_next <span style=color:#f92672>=</span> (sig_fire) <span style=color:#f92672>?</span> PLAY <span style=color:#f92672>:</span> READY;
</span></span><span style=display:flex><span>            POINT: state_next <span style=color:#f92672>=</span> (sig_fire) <span style=color:#f92672>?</span> POSITION <span style=color:#f92672>:</span> POINT;
</span></span><span style=display:flex><span>            END_GAME: state_next <span style=color:#f92672>=</span> (sig_fire) <span style=color:#f92672>?</span> NEW_GAME <span style=color:#f92672>:</span> END_GAME;
</span></span><span style=display:flex><span>            PLAY: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (coll_l <span style=color:#f92672>||</span> coll_r) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> ((score_l <span style=color:#f92672>==</span> WIN) <span style=color:#f92672>||</span> (score_r <span style=color:#f92672>==</span> WIN)) state_next <span style=color:#f92672>=</span> END_GAME;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>else</span> state_next <span style=color:#f92672>=</span> POINT;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> state_next <span style=color:#f92672>=</span> PLAY;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> state_next <span style=color:#f92672>=</span> NEW_GAME;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sim_rst) state_next <span style=color:#f92672>=</span> NEW_GAME;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// update game state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) state <span style=color:#f92672>&lt;=</span> state_next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// AI paddle control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (state <span style=color:#f92672>==</span> POSITION) ai_y <span style=color:#f92672>&lt;=</span> (V_RES <span style=color:#f92672>-</span> PAD_HEIGHT)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (frame <span style=color:#f92672>&amp;&amp;</span> state <span style=color:#f92672>==</span> PLAY) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>+</span> PAD_HEIGHT<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&lt;</span> ball_y) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// ball below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>+</span> PAD_HEIGHT <span style=color:#f92672>+</span> PAD_SPY <span style=color:#f92672>&gt;=</span> V_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// bottom of screen?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    ai_y <span style=color:#f92672>&lt;=</span> V_RES <span style=color:#f92672>-</span> PAD_HEIGHT <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move down as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ai_y <span style=color:#f92672>&lt;=</span> ai_y <span style=color:#f92672>+</span> PAD_SPY;  <span style=color:#75715e>// move down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>+</span> PAD_HEIGHT<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&gt;</span> ball_y <span style=color:#f92672>+</span> BALL_SIZE) <span style=color:#66d9ef>begin</span> <span style=color:#75715e>// ball above
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>&lt;</span> PAD_SPY) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// top of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    ai_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move up as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ai_y <span style=color:#f92672>&lt;=</span> ai_y <span style=color:#f92672>-</span> PAD_SPY;  <span style=color:#75715e>// move up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Player paddle control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (state <span style=color:#f92672>==</span> POSITION) play_y <span style=color:#f92672>&lt;=</span> (V_RES <span style=color:#f92672>-</span> PAD_HEIGHT)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (frame <span style=color:#f92672>&amp;&amp;</span> state <span style=color:#f92672>==</span> PLAY) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sig_dn) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (play_y <span style=color:#f92672>+</span> PAD_HEIGHT <span style=color:#f92672>+</span> PAD_SPY <span style=color:#f92672>&gt;=</span> V_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// bottom of screen?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    play_y <span style=color:#f92672>&lt;=</span> V_RES <span style=color:#f92672>-</span> PAD_HEIGHT <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move down as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> play_y <span style=color:#f92672>&lt;=</span> play_y <span style=color:#f92672>+</span> PAD_SPY;  <span style=color:#75715e>// move down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sig_up) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (play_y <span style=color:#f92672>&lt;</span> PAD_SPY) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// top of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    play_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move up as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> play_y <span style=color:#f92672>&lt;=</span> play_y <span style=color:#f92672>-</span> PAD_SPY;  <span style=color:#75715e>// move up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ball control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>            NEW_GAME: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                score_l <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// reset score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                score_r <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            POSITION: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                coll_l <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// reset screen collision flags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                coll_r <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                ball_spx <span style=color:#f92672>&lt;=</span> BALL_ISPX;  <span style=color:#75715e>// reset speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ball_spy <span style=color:#f92672>&lt;=</span> BALL_ISPY;
</span></span><span style=display:flex><span>                shot_cnt <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// reset shot count
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// centre ball vertically and position on paddle (right or left)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ball_y <span style=color:#f92672>&lt;=</span> (V_RES <span style=color:#f92672>-</span> BALL_SIZE)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (coll_r) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    ball_x <span style=color:#f92672>&lt;=</span> H_RES <span style=color:#f92672>-</span> (PAD_OFFS <span style=color:#f92672>+</span> PAD_WIDTH <span style=color:#f92672>+</span> BALL_SIZE);
</span></span><span style=display:flex><span>                    ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    ball_x <span style=color:#f92672>&lt;=</span> PAD_OFFS <span style=color:#f92672>+</span> PAD_WIDTH;
</span></span><span style=display:flex><span>                    ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            PLAY: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (frame) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// horizontal ball position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> (ball_dx <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> (ball_x <span style=color:#f92672>+</span> BALL_SIZE <span style=color:#f92672>+</span> ball_spx <span style=color:#f92672>&gt;=</span> H_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                            ball_x <span style=color:#f92672>&lt;=</span> H_RES<span style=color:#f92672>-</span>BALL_SIZE;  <span style=color:#75715e>// move to edge of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            score_l <span style=color:#f92672>&lt;=</span> score_l <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                            coll_r <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ball_x <span style=color:#f92672>&lt;=</span> ball_x <span style=color:#f92672>+</span> ball_spx;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> (ball_x <span style=color:#f92672>&lt;</span> ball_spx) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                            ball_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move to edge of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            score_r <span style=color:#f92672>&lt;=</span> score_r <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                            coll_l <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ball_x <span style=color:#f92672>&lt;=</span> ball_x <span style=color:#f92672>-</span> ball_spx;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// vertical ball position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> (ball_dy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> (ball_y <span style=color:#f92672>+</span> BALL_SIZE <span style=color:#f92672>+</span> ball_spy <span style=color:#f92672>&gt;=</span> V_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                            ball_dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move up next frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>else</span> ball_y <span style=color:#f92672>&lt;=</span> ball_y <span style=color:#f92672>+</span> ball_spy;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> (ball_y <span style=color:#f92672>&lt;</span> ball_spy)
</span></span><span style=display:flex><span>                            ball_dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move down next frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>else</span> ball_y <span style=color:#f92672>&lt;=</span> ball_y <span style=color:#f92672>-</span> ball_spy;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// ball speed increases after SPEEDUP shots
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> (ball_dx_prev <span style=color:#f92672>!=</span> ball_dx) shot_cnt <span style=color:#f92672>&lt;=</span> shot_cnt <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (shot_cnt <span style=color:#f92672>==</span> SPEEDUP) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// increase ball speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        ball_spx <span style=color:#f92672>&lt;=</span> (ball_spx <span style=color:#f92672>&lt;</span> PAD_WIDTH) <span style=color:#f92672>?</span> ball_spx <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> ball_spx;
</span></span><span style=display:flex><span>                        ball_spy <span style=color:#f92672>&lt;=</span> ball_spy <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                        shot_cnt <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// change direction if ball collides with paddle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (ball <span style=color:#f92672>&amp;&amp;</span> padl <span style=color:#f92672>&amp;&amp;</span> ball_dx<span style=color:#f92672>==</span><span style=color:#ae81ff>1</span>) ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// left paddle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (ball <span style=color:#f92672>&amp;&amp;</span> padr <span style=color:#f92672>&amp;&amp;</span> ball_dx<span style=color:#f92672>==</span><span style=color:#ae81ff>0</span>) ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// right paddle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// record ball direction in previous frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (frame) ball_dx_prev <span style=color:#f92672>&lt;=</span> ball_dx;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// check for ball and paddles at current screen position (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        ball <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> ball_x) <span style=color:#f92672>&amp;&amp;</span> (sx <span style=color:#f92672>&lt;</span> ball_x <span style=color:#f92672>+</span> BALL_SIZE)
</span></span><span style=display:flex><span>               <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&gt;=</span> ball_y) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&lt;</span> ball_y <span style=color:#f92672>+</span> BALL_SIZE);
</span></span><span style=display:flex><span>        padl <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> PAD_OFFS) <span style=color:#f92672>&amp;&amp;</span> (sx <span style=color:#f92672>&lt;</span> PAD_OFFS <span style=color:#f92672>+</span> PAD_WIDTH)
</span></span><span style=display:flex><span>               <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&gt;=</span> padl_y) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&lt;</span> padl_y <span style=color:#f92672>+</span> PAD_HEIGHT);
</span></span><span style=display:flex><span>        padr <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> H_RES <span style=color:#f92672>-</span> PAD_OFFS <span style=color:#f92672>-</span> PAD_WIDTH <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&amp;&amp;</span> (sx <span style=color:#f92672>&lt;</span> H_RES <span style=color:#f92672>-</span> PAD_OFFS <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>               <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&gt;=</span> padr_y) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&lt;</span> padr_y <span style=color:#f92672>+</span> PAD_HEIGHT);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// draw the score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> pix_score;  <span style=color:#75715e>// pixel of score char
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    simple_score simple_score_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .score_l,
</span></span><span style=display:flex><span>        .score_r,
</span></span><span style=display:flex><span>        .pix(pix_score)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// paint colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] paint_r, paint_g, paint_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (pix_score) {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;hF30</span>;  <span style=color:#75715e>// score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (ball) {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;hFC0</span>;  <span style=color:#75715e>// ball
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (padl <span style=color:#f92672>||</span> padr) {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;hFFF</span>;  <span style=color:#75715e>// paddles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;h137</span>;  <span style=color:#75715e>// background
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display colour: paint colour but black in blanking interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] display_r, display_g, display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        display_r <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_r <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_g <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_g <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_b <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_b <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SDL output (8 bits per colour channel)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        sdl_sx <span style=color:#f92672>&lt;=</span> sx;
</span></span><span style=display:flex><span>        sdl_sy <span style=color:#f92672>&lt;=</span> sy;
</span></span><span style=display:flex><span>        sdl_de <span style=color:#f92672>&lt;=</span> de;
</span></span><span style=display:flex><span>        sdl_r <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_r}};
</span></span><span style=display:flex><span>        sdl_g <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_g}};
</span></span><span style=display:flex><span>        sdl_b <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_b}};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><h3 id=parameters-and-properties>Parameters and Properties</h3><p>The first lines of the module let you configure gameplay parameters. The parameters should be self-explanatory, but you cannot set the &lsquo;WIN&rsquo; score to more than 9 because the score display only supports one digit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>localparam</span> WIN        <span style=color:#f92672>=</span>  <span style=color:#ae81ff>4</span>;  <span style=color:#75715e>// score needed to win a game (max 9)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> SPEEDUP    <span style=color:#f92672>=</span>  <span style=color:#ae81ff>5</span>;  <span style=color:#75715e>// speed up ball after this many shots (max 16)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> BALL_SIZE  <span style=color:#f92672>=</span>  <span style=color:#ae81ff>8</span>;  <span style=color:#75715e>// ball size in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> BALL_ISPX  <span style=color:#f92672>=</span>  <span style=color:#ae81ff>5</span>;  <span style=color:#75715e>// initial horizontal ball speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> BALL_ISPY  <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// initial vertical ball speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> PAD_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>48</span>;  <span style=color:#75715e>// paddle height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> PAD_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;  <span style=color:#75715e>// paddle width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> PAD_OFFS   <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;  <span style=color:#75715e>// paddle distance from edge of screen in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>localparam</span> PAD_SPY    <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// vertical paddle speed
</span></span></span></code></pre></div><h3 id=display-signals>Display Signals</h3><p>This section deals with display sync signals, coordinates, and the frame signal. This design is unchanged from &lsquo;Colour Cycle&rsquo; in <a href=/posts/racing-the-beam/#colour-cycle>Racing the Beam</a>.</p><h3 id=variable-declarations>Variable Declarations</h3><p>We then have a big block of variable declarations.</p><p>This is followed by a little logic to connect the left and right paddles to the player or AI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    padl_y <span style=color:#f92672>=</span> play_y;
</span></span><span style=display:flex><span>    padr_y <span style=color:#f92672>=</span> ai_y;
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Switch sides here if you prefer to play as the right paddle. You can also set two AI paddles against each other (though you still need to start each point by pressing fire).</p><h3 id=debouncing>Debouncing</h3><p>To safely use buttons in our design, we need to debounce them. Debouncing ensures we get a single, clean transition from button presses. The debounce module looks like this <strong>[<a href=https://github.com/projf/projf-explore/blob/main/lib/essential/debounce.sv>debounce.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> debounce (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk,   <span style=color:#75715e>// clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> in,    <span style=color:#75715e>// signal input
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> out,   <span style=color:#75715e>// signal output (debounced)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> ondn,  <span style=color:#75715e>// on down (one tick)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> onup   <span style=color:#75715e>// on up (one tick)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sync with clock and combat metastability
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> sync_0, sync_1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) sync_0 <span style=color:#f92672>&lt;=</span> in;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) sync_1 <span style=color:#f92672>&lt;=</span> sync_0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>17</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] cnt;  <span style=color:#75715e>// 2^18 = 2.6 ms counter at 100 MHz
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> idle, max;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        idle <span style=color:#f92672>=</span> (out <span style=color:#f92672>==</span> sync_1);
</span></span><span style=display:flex><span>        max  <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>cnt;
</span></span><span style=display:flex><span>        ondn <span style=color:#f92672>=</span> <span style=color:#f92672>~</span>idle <span style=color:#f92672>&amp;</span> max <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span>out;
</span></span><span style=display:flex><span>        onup <span style=color:#f92672>=</span> <span style=color:#f92672>~</span>idle <span style=color:#f92672>&amp;</span> max <span style=color:#f92672>&amp;</span> out;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (idle) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            cnt <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            cnt <span style=color:#f92672>&lt;=</span> cnt <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (max) out <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>~</span>out;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>We want continuous signals for up and down, but a one-off event for the fire button:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>logic</span> sig_fire, sig_up, sig_dn;
</span></span><span style=display:flex><span>debounce deb_fire (.clk(clk_pix), .in(btn_fire), .out(), .ondn(), .onup(sig_fire));
</span></span><span style=display:flex><span>debounce deb_up (.clk(clk_pix), .in(btn_up), .out(sig_up), .ondn(), .onup());
</span></span><span style=display:flex><span>debounce deb_dn (.clk(clk_pix), .in(btn_dn), .out(sig_dn), .ondn(), .onup());
</span></span></code></pre></div><p>The <code>onup()</code> and <code>ondown()</code> outputs work like traditional UI events. In this case, <code>sig_fire</code> will be high for one tick when the fire button is released.</p><h3 id=the-state-of-play>The State of Play</h3><p>We don&rsquo;t have a CPU, so we use a finite state machine (FSM) to keep track of the game state. The player controls the state of the game with the fire button (spacebar in simulation):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>enum</span> {NEW_GAME, POSITION, READY, POINT, END_GAME, PLAY} state, state_next;
</span></span><span style=display:flex><span><span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>        NEW_GAME: state_next <span style=color:#f92672>=</span> POSITION;
</span></span><span style=display:flex><span>        POSITION: state_next <span style=color:#f92672>=</span> READY;
</span></span><span style=display:flex><span>        READY: state_next <span style=color:#f92672>=</span> (sig_fire) <span style=color:#f92672>?</span> PLAY <span style=color:#f92672>:</span> READY;
</span></span><span style=display:flex><span>        POINT: state_next <span style=color:#f92672>=</span> (sig_fire) <span style=color:#f92672>?</span> POSITION <span style=color:#f92672>:</span> POINT;
</span></span><span style=display:flex><span>        END_GAME: state_next <span style=color:#f92672>=</span> (sig_fire) <span style=color:#f92672>?</span> NEW_GAME <span style=color:#f92672>:</span> END_GAME;
</span></span><span style=display:flex><span>        PLAY: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (coll_l <span style=color:#f92672>||</span> coll_r) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> ((score_l <span style=color:#f92672>==</span> WIN) <span style=color:#f92672>||</span> (score_r <span style=color:#f92672>==</span> WIN)) state_next <span style=color:#f92672>=</span> END_GAME;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> state_next <span style=color:#f92672>=</span> POINT;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> state_next <span style=color:#f92672>=</span> PLAY;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> state_next <span style=color:#f92672>=</span> NEW_GAME;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sim_rst) state_next <span style=color:#f92672>=</span> NEW_GAME;
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>The state machine is straightforward; the only complex state change is <code>PLAY</code>. When there&rsquo;s a collision with the left or right of the screen, a point is over; if either player has reached the <code>WIN</code> score, the game is over.</p><p><em>NB. The reset signal ensures the state machine begins in a known state.</em></p><h3 id=paddle-position>Paddle Position</h3><p>A paddle may be controlled by the player or the AI; each has separate logic. In the <code>POSITION</code> state, the paddle is returned to the vertical centre of the screen.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#75715e>// AI paddle control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (state <span style=color:#f92672>==</span> POSITION) ai_y <span style=color:#f92672>&lt;=</span> (V_RES <span style=color:#f92672>-</span> PAD_HEIGHT)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (frame <span style=color:#f92672>&amp;&amp;</span> state <span style=color:#f92672>==</span> PLAY) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>+</span> PAD_HEIGHT<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&lt;</span> ball_y) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// ball below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>+</span> PAD_HEIGHT <span style=color:#f92672>+</span> pad_spy <span style=color:#f92672>&gt;=</span> V_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// bottom of screen?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ai_y <span style=color:#f92672>&lt;=</span> V_RES <span style=color:#f92672>-</span> PAD_HEIGHT <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move down as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ai_y <span style=color:#f92672>&lt;=</span> ai_y <span style=color:#f92672>+</span> pad_spy;  <span style=color:#75715e>// move down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>+</span> PAD_HEIGHT<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&gt;</span> ball_y <span style=color:#f92672>+</span> BALL_SIZE) <span style=color:#66d9ef>begin</span> <span style=color:#75715e>// ball above
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (ai_y <span style=color:#f92672>&lt;</span> pad_spy) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// top of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ai_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move up as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ai_y <span style=color:#f92672>&lt;=</span> ai_y <span style=color:#f92672>-</span> pad_spy;  <span style=color:#75715e>// move up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>In play, the AI compares the centre of the paddle to the top of the ball. If the ball is below, it moves the paddle down as far as possible (without going beyond the bottom of the screen). Otherwise, it compares the middle of the paddle to the bottom of the ball, and if the ball is above, it moves up.</p><p>If the middle of the paddle is level with any part of the ball, we don&rsquo;t move the paddle; this avoids jerky paddle movement.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#75715e>// Player paddle control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (state <span style=color:#f92672>==</span> POSITION) play_y <span style=color:#f92672>&lt;=</span> (V_RES <span style=color:#f92672>-</span> PAD_HEIGHT)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (frame <span style=color:#f92672>&amp;&amp;</span> state <span style=color:#f92672>==</span> PLAY) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sig_dn) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (play_y <span style=color:#f92672>+</span> PAD_HEIGHT <span style=color:#f92672>+</span> pad_spy <span style=color:#f92672>&gt;=</span> V_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// bottom of screen?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                play_y <span style=color:#f92672>&lt;=</span> V_RES <span style=color:#f92672>-</span> PAD_HEIGHT <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move down as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> play_y <span style=color:#f92672>&lt;=</span> play_y <span style=color:#f92672>+</span> pad_spy;  <span style=color:#75715e>// move down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sig_up) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (play_y <span style=color:#f92672>&lt;</span> pad_spy) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// top of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                play_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move up as far as we can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> play_y <span style=color:#f92672>&lt;=</span> play_y <span style=color:#f92672>-</span> pad_spy;  <span style=color:#75715e>// move up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>The player control is similar but responds to user input instead of the ball position.</p><h3 id=ball-control>Ball Control</h3><p>The ball logic is the most complex part of the design; we consider each state in turn.</p><p>At the start of a game, we reset player scores:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>NEW_GAME: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    score_l <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// reset score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    score_r <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Position prepares the ball for the next point:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>POSITION: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    coll_l <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// reset screen collision flags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    coll_r <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    ball_spx <span style=color:#f92672>&lt;=</span> BALL_ISPX;  <span style=color:#75715e>// reset speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ball_spy <span style=color:#f92672>&lt;=</span> BALL_ISPY;
</span></span><span style=display:flex><span>    shot_cnt <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// reset shot count
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// centre ball vertically and position on paddle (right or left)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ball_y <span style=color:#f92672>&lt;=</span> (V_RES <span style=color:#f92672>-</span> BALL_SIZE)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (coll_r) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        ball_x <span style=color:#f92672>&lt;=</span> H_RES <span style=color:#f92672>-</span> (PAD_OFFS <span style=color:#f92672>+</span> PAD_WIDTH <span style=color:#f92672>+</span> BALL_SIZE);
</span></span><span style=display:flex><span>        ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        ball_x <span style=color:#f92672>&lt;=</span> PAD_OFFS <span style=color:#f92672>+</span> PAD_WIDTH;
</span></span><span style=display:flex><span>        ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>In play, we check for ball collisions with the edge of the screen. If the ball collides with the left or right edge of the screen, then a point is over: we record this by setting the <code>coll_r</code> or <code>coll_l</code> flag. These collision flags are used by the finite state machine (above).</p><p>If the ball collides with the top or bottom of the screen, we reverse direction, so it bounces.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>PLAY: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (frame) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// horizontal ball position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (ball_dx <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (ball_x <span style=color:#f92672>+</span> BALL_SIZE <span style=color:#f92672>+</span> ball_spx <span style=color:#f92672>&gt;=</span> H_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                ball_x <span style=color:#f92672>&lt;=</span> H_RES<span style=color:#f92672>-</span>BALL_SIZE;  <span style=color:#75715e>// move to edge of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                score_l <span style=color:#f92672>&lt;=</span> score_l <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                coll_r <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ball_x <span style=color:#f92672>&lt;=</span> ball_x <span style=color:#f92672>+</span> ball_spx;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (ball_x <span style=color:#f92672>&lt;</span> ball_spx) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                ball_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move to edge of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                score_r <span style=color:#f92672>&lt;=</span> score_r <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                coll_l <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> ball_x <span style=color:#f92672>&lt;=</span> ball_x <span style=color:#f92672>-</span> ball_spx;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// vertical ball position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (ball_dy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (ball_y <span style=color:#f92672>+</span> BALL_SIZE <span style=color:#f92672>+</span> ball_spy <span style=color:#f92672>&gt;=</span> V_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                ball_dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move up next frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> ball_y <span style=color:#f92672>&lt;=</span> ball_y <span style=color:#f92672>+</span> ball_spy;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (ball_y <span style=color:#f92672>&lt;</span> ball_spy)
</span></span><span style=display:flex><span>                ball_dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move down next frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> ball_y <span style=color:#f92672>&lt;=</span> ball_y <span style=color:#f92672>-</span> ball_spy;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ball speed increases after SPEEDUP shots
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (ball_dx_prev <span style=color:#f92672>!=</span> ball_dx) shot_cnt <span style=color:#f92672>&lt;=</span> shot_cnt <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (shot_cnt <span style=color:#f92672>==</span> SPEEDUP) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// increase ball speed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ball_spx <span style=color:#f92672>&lt;=</span> (ball_spx <span style=color:#f92672>&lt;</span> PAD_WIDTH) <span style=color:#f92672>?</span> ball_spx <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> ball_spx;
</span></span><span style=display:flex><span>            ball_spy <span style=color:#f92672>&lt;=</span> ball_spy <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            shot_cnt <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>The final part of the play state handles the ball speed. After <code>SPEEDUP</code> shots have occurred, we increase the vertical and horizontal ball speed by one. However, we don&rsquo;t want the horizontal speed to be larger than the paddle width, or the collision logic won&rsquo;t work, and it&rsquo;s this collision logic we turn to next.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#75715e>// change direction if ball collides with paddle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (ball <span style=color:#f92672>&amp;&amp;</span> padl <span style=color:#f92672>&amp;&amp;</span> ball_dx<span style=color:#f92672>==</span><span style=color:#ae81ff>1</span>) ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// left paddle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (ball <span style=color:#f92672>&amp;&amp;</span> padr <span style=color:#f92672>&amp;&amp;</span> ball_dx<span style=color:#f92672>==</span><span style=color:#ae81ff>0</span>) ball_dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// right paddle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// record ball direction in previous frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (frame) ball_dx_prev <span style=color:#f92672>&lt;=</span> ball_dx;
</span></span></code></pre></div><p>We use the drawing signals to detect collisions between the ball and paddles, so the collision check occurs on every rising clock edge, not once per frame.</p><p>The three drawing signals are continuouly evaluated; a collision occurs if both the ball and a paddle are high at the same time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#75715e>// check for ball and paddles at current screen position (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    ball <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> ball_x) <span style=color:#f92672>&amp;&amp;</span> (sx <span style=color:#f92672>&lt;</span> ball_x <span style=color:#f92672>+</span> BALL_SIZE)
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&gt;=</span> ball_y) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&lt;</span> ball_y <span style=color:#f92672>+</span> BALL_SIZE);
</span></span><span style=display:flex><span>    padl <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> PAD_OFFS) <span style=color:#f92672>&amp;&amp;</span> (sx <span style=color:#f92672>&lt;</span> PAD_OFFS <span style=color:#f92672>+</span> PAD_WIDTH)
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&gt;=</span> padl_y) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&lt;</span> padl_y <span style=color:#f92672>+</span> PAD_HEIGHT);
</span></span><span style=display:flex><span>    padr <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> H_RES <span style=color:#f92672>-</span> PAD_OFFS <span style=color:#f92672>-</span> PAD_WIDTH <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&amp;&amp;</span> (sx <span style=color:#f92672>&lt;</span> H_RES <span style=color:#f92672>-</span> PAD_OFFS <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&gt;=</span> padr_y) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>&lt;</span> padr_y <span style=color:#f92672>+</span> PAD_HEIGHT);
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Using the drawing signals to detect ball-paddle collisions avoids the need to model collisions between moving objects.</p><p>This method is reliable, provided the horizontal speed of the ball isn&rsquo;t greater than the paddle width; in that case, the ball can pass right through the paddle! We avoid this problem by limiting the maximum horizontal ball speed (discussed above).</p><p>A similar problem occurs with the vertical ball speed and paddle height, but this requires <em>ludicrous</em> speeds for reasonable paddle height.</p><h3 id=keeping-score>Keeping Score</h3><p>We use a dedicated module to draw the score for both players:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> simple_score #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>,                <span style=color:#75715e>// coordinate width
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> H_RES<span style=color:#f92672>=</span><span style=color:#ae81ff>640</span>                <span style=color:#75715e>// horizontal screen resolution
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_pix,         <span style=color:#75715e>// pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx,  <span style=color:#75715e>// horizontal screen position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sy,  <span style=color:#75715e>// vertical screen position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] score_l,   <span style=color:#75715e>// score for left-side player (0-9)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] score_r,   <span style=color:#75715e>// score for right-side player (0-9)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> pix              <span style=color:#75715e>// draw pixel at this position?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// number characters: MSB first, so we can write pixels left to right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span style=color:#ae81ff>14</span>] chars [<span style=color:#ae81ff>10</span>];  <span style=color:#75715e>// ten characters of 15 pixels each
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>initial</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b111</span>_101_101_101_111;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b110</span>_010_010_010_111;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b111</span>_001_111_100_111;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b111</span>_001_011_001_111;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b101</span>_101_111_001_001;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>5</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b111</span>_100_111_001_111;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b100</span>_100_111_101_111;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>7</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b111</span>_001_001_001_001;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>8</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b111</span>_101_111_101_111;
</span></span><span style=display:flex><span>        chars[<span style=color:#ae81ff>9</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#ae81ff>&#39;b111</span>_101_111_001_001;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ensure score in range of characters (0-9)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] char_l, char_r;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        char_l <span style=color:#f92672>=</span> (score_l <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span>) <span style=color:#f92672>?</span> score_l <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        char_r <span style=color:#f92672>=</span> (score_r <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span>) <span style=color:#f92672>?</span> score_r <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// set screen region for each score: 12x20 pixels (8,8) from corner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// subtract one from &#39;sx&#39; to account for latency for registering &#39;pix&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> score_l_region, score_r_region;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        score_l_region <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>&amp;&amp;</span> sx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>19</span> <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>8</span> <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>28</span>);
</span></span><span style=display:flex><span>        score_r_region <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> H_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>22</span> <span style=color:#f92672>&amp;&amp;</span> sx <span style=color:#f92672>&lt;</span> H_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>10</span> <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>8</span> <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>28</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// determine character pixel address from screen position (scale 4x)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (score_l_region) pix_addr <span style=color:#f92672>=</span> (sx<span style=color:#f92672>-</span><span style=color:#ae81ff>7</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span>((sy<span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (score_r_region) pix_addr <span style=color:#f92672>=</span> (sx<span style=color:#f92672>-</span>(H_RES<span style=color:#f92672>-</span><span style=color:#ae81ff>22</span>))<span style=color:#f92672>/</span><span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span>((sy<span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> pix_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// score pixel for current screen position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] pix_addr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (score_l_region) pix <span style=color:#f92672>&lt;=</span> chars[char_l][pix_addr];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (score_r_region) pix <span style=color:#f92672>&lt;=</span> chars[char_r][pix_addr];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>This module is neither flexible nor elegant, but it gets the job done until we learn about sprites. Each number, 0-9, is represented by five rows of three pixels. We scale the score bitmaps by four, so they&rsquo;re not tiny.</p><p>At least the module is easy to use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>logic</span> pix_score;  <span style=color:#75715e>// pixel of score char
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>simple_score simple_score_inst (
</span></span><span style=display:flex><span>    .clk_pix,
</span></span><span style=display:flex><span>    .sx,
</span></span><span style=display:flex><span>    .sy,
</span></span><span style=display:flex><span>    .score_l,
</span></span><span style=display:flex><span>    .score_r,
</span></span><span style=display:flex><span>    .pix(pix_score)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h3 id=colours>Colours</h3><p>Original Pong was a monochrome affair, but I&rsquo;ve chosen to support separate colours for the score, ball, paddles, and background. Whether you want traditional monochrome or pink and green, you can select your own colour scheme with this logic; see <a href=/posts/fpga-graphics/#12-bit-colour>12-bit Colour</a> if you need a reminder on how our colour system works.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    <span style=color:#75715e>// paint colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] paint_r, paint_g, paint_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (pix_score) {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;hF30</span>;  <span style=color:#75715e>// score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (ball) {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;hFC0</span>;  <span style=color:#75715e>// ball
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (padl <span style=color:#f92672>||</span> padr) {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;hFFF</span>;  <span style=color:#75715e>// paddles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>else</span> {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> <span style=color:#ae81ff>12&#39;h137</span>;  <span style=color:#75715e>// background
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>We won&rsquo;t cover the video output here, as we&rsquo;ve already discussed it in <a href=/posts/fpga-graphics/#video-output>Beginning FPGA Graphics</a>.</p><h2 id=explore>Explore</h2><p>I hope you enjoyed this instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few suggestions to improve FPGA Pong:</p><ul><li>Experiment with the gameplay parameters</li><li>Change the background colour at the end of the game</li><li>Draw a net down the middle of the screen</li><li>Update the vertical ball direction depending on where it hits the paddle</li></ul><p>If you&rsquo;re looking for a bigger challenge, try creating the game <a href=https://en.wikipedia.org/wiki/Snake_(video_game_genre)>Snake</a>.</p><h2 id=whats-next>What&rsquo;s Next?</h2><p>Next, we&rsquo;ll revisit <a href=/posts/display-signals/>display signals</a> and learn about palettes and indexed colour. Check out the <a href=/demos/>demo</a> and <a href=/tutorials/>tutorial</a> sections for more FPGA projects.</p><p>Have a question or suggestion? Contact <a href=https://mastodon.social/@WillFlux>@WillFlux</a> or join me on <a href=https://github.com/projf/projf-explore/discussions>Project F Discussions</a> or <a href=https://discord.gg/cf869yDbXf>1BitSquared Discord</a>. If you like what I do, consider <a href=https://github.com/sponsors/WillGreen>sponsoring me</a> on GitHub. Thank you.</p></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/games>games</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/graphics>graphics</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/arty-a7>arty-a7</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/icebreaker>icebreaker</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/verilator>verilator</a></footer></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-4xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto><a class=link href=https://projectf.io>Project F</a>
&copy; 2023 Will Green.</div></footer></body></html>