<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Ad Astra | Project F - FPGA Development</title>

<meta property='og:title' content='Ad Astra - Project F - FPGA Development'>
<meta property='og:description' content='Welcome back to Exploring FPGA Graphics. In the previous part we learnt how to create hardware sprites. In this fourth part, we create a demo by combining our knowledge of sprites with animated starfields.
In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how displays work, race the beam with Pong, animate starfields and sprites, paint Michelangelo&rsquo;s David, simulate life with bitmaps, draw lines and shapes, and create smooth animation with double buffering.'>
<meta property='og:url' content='https://projectf.io/posts/fpga-ad-astra/'>
<meta property='og:site_name' content='Project F - FPGA Development'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/fpga-ad-astra/social-card.png'><meta property='article:published_time' content='2020-06-10T00:00:00Z'/><meta property='article:modified_time' content='2022-01-31T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F - FPGA Development" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/fpga-ad-astra/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="referrer" content="no-referrer, same-origin">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F - FPGA Development</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf/projf-explore'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/sitemap">
          <h2 class="title is-5">Site Map</h2>
        </a><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/graphics">
          <h2 class="title is-5">Graphics</h2>
        </a><a class="nav-item" href="/tags/maths">
          <h2 class="title is-5">Maths</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/explore/">#explore</a>



  
  | <a class="subtitle is-6" href="/tags/graphics/">#graphics</a>
  


      
    </div>
    <h2 class="subtitle is-6">10 June 2020</h2>
    <h1 class="title">Ad Astra</h1>
    
    <div class="content">
      <p>Welcome back to <em>Exploring FPGA Graphics</em>. In the previous part we learnt how to create <a href="/posts/hardware-sprites/">hardware sprites</a>. In this fourth part, we create a demo by combining our knowledge of sprites with animated starfields.</p>
<p>In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how displays work, race the beam with Pong, animate starfields and sprites, paint Michelangelo&rsquo;s David, simulate life with bitmaps, draw lines and shapes, and create smooth animation with double buffering. New to the series? Start with <a href="/posts/fpga-graphics/">Intro to FPGA Graphics</a>.</p>
<p><strong>You can watch an <a href="https://www.youtube.com/watch?v=ezJv7pB-UmA" target="_blank">FPGA Graphics demo reel</a> with designs from across this series.</strong></p>
<p><em>Updated 2022-01-31. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li><a href="/posts/fpga-graphics/">Intro to FPGA Graphics</a> - draw your first FPGA graphics</li>
<li><a href="/posts/fpga-pong/">Pong</a> - race the beam to create the arcade classic</li>
<li><a href="/posts/hardware-sprites/">Hardware Sprites</a> - fast, colourful, graphics with minimal logic</li>
<li>Ad Astra (this post) - graphics demo with starfields and hardware sprites</li>
<li><a href="/posts/framebuffers/">Framebuffers</a> - driving the display from a bitmap in memory</li>
<li><a href="/posts/life-on-screen/">Life on Screen</a> - the screen comes alive with Conway&rsquo;s Game of Life</li>
<li><a href="/posts/lines-and-triangles/">Lines and Triangles</a> - drawing lines and triangles with a framebuffer</li>
<li><a href="/posts/fpga-shapes/">2D Shapes</a> - filling shapes and drawing pictures</li>
<li><a href="/posts/animated-shapes/">Animated Shapes</a> - animation and double-buffering</li>
</ul>
<h3 id="requirements">Requirements</h3>
<p>For this series, you need an FPGA board with video output. We&rsquo;ll be working at 640x480, so pretty much any video output will do. It helps to be comfortable with programming your FPGA board and reasonably familiar with Verilog.</p>
<p>We&rsquo;ll be demoing with these boards:</p>
<ul>
<li><strong><a href="https://docs.icebreaker-fpga.org/hardware/icebreaker/">iCEBreaker</a></strong> (Lattice iCE40) with <strong><a href="https://docs.icebreaker-fpga.org/hardware/pmod/dvi/">12-Bit DVI Pmod</a></strong></li>
<li><strong><a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a></strong> (Xilinx Artix-7) with <strong><a href="https://reference.digilentinc.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a></strong></li>
</ul>
<h3 id="source">Source</h3>
<p>The SystemVerilog designs featured in this series are available from the <a href="https://github.com/projf/projf-explore/">projf-explore</a> git repo under the open-source MIT licence: build on them to your heart&rsquo;s content. The rest of the blog content is subject to standard copyright restrictions: don&rsquo;t republish it without permission.</p>
<h2 id="computer-space">Computer Space</h2>
<p><a href="https://en.wikipedia.org/wiki/Computer_Space">Computer Space</a> was the first video arcade game: it features a simple backdrop of stars over which the player&rsquo;s rocket battles two flying saucers. The backdrop may have been simple, but this game was released in 1971, when a &ldquo;cheap&rdquo; computer, such as the <a href="https://www.computerhistory.org/revolution/minicomputers/11/338">Data General Nova</a>, cost around $8,000 (c. $40,000 in 2020). Unable to find anything both fast and cheap, developers Nolan Bushnell and Ted Dabney created their own custom hardware instead. It&rsquo;s strangely hard to find details of the Computer Space logic design on the Internet, but <a href="https://en.wikipedia.org/wiki/7400-series_integrated_circuits">TTL 7400s</a> were used.</p>
<blockquote>
<p><strong>Computer Space Cabinet</strong><br>
Computer Space had an amazing fibreglass cabinet. You can see more photos at <a href="https://web.archive.org/web/20090130053055/http://www.marvin3m.com/arcade/cspace.htm">Marvin&rsquo;s Marvelous Mechanical Museum</a> (courtesy of the Wayback Machine).</p>
</blockquote>
<h2 id="linear-feedback-shift-register">Linear Feedback Shift Register</h2>
<p>I don&rsquo;t know how Computer Space created its starfield, but we&rsquo;re going to use a <strong>linear feedback shift register</strong> (henceforth LFSR). Rather like field programmable gate arrays themselves, their name makes LFSRs sound arcane and inscrutable; happily for us, this is not the case.</p>
<p>An LFSR can create a pseudorandom number sequence in which every number appears just once. For example, an 8-bit LSFR can generate all the numbers from 1-255 in a repeatable sequence that seems random. The logic for an LFSR can be written in a single line of Verilog:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">sreg <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>, sreg[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>]} <span style="color:#f92672">^</span> (sreg[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">?</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b10111000</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b0</span>);
</code></pre></div><p>The first part of the statement right-shifts the shift-register one bit. In the second part, we check the value of the bit we shifted: this is the feedback. If the feedback is true, we XOR the whole shift register with a magic pattern of bits known as <strong>taps</strong>. Values at the bit positions of the taps are flipped by the XOR. The initial value of an LFSR is known as the <strong>seed</strong>.</p>
<p>For example, an 8-bit LFSR with a seed of 169:</p>
<ul>
<li><strong><code>10101001</code> - seed value (169)</strong></li>
<li><code>01010100</code> - after right shift (bit shifted out was <code>1</code>)</li>
<li><code>01010100 XOR 10111000</code> - XOR with taps</li>
<li><strong><code>11101100</code> - 2nd value (236)</strong></li>
<li><code>01110110</code> - after right shift (bit shifted out was <code>0</code>)</li>
<li><code>01110110 XOR 00000000</code> - XOR with 0</li>
<li><strong><code>01110110</code> - 3rd value (118)</strong></li>
<li>&hellip;</li>
</ul>
<p>For an 8-bit LFSR, we set tap bits 8, 6, 5, and 4. To find taps for other lengths, you can refer to the <a href="https://en.wikipedia.org/wiki/Linear-feedback_shift_register#Some_polynomials_for_maximal_LFSRs">feedback polynomials on Wikipedia</a>.</p>
<p>To create a starfield, we need a sequence that&rsquo;s the same length as the number of pixels we&rsquo;re drawing. If we iterate through our shift register every time we get to a new pixel, then each pixel will always be associated with the same number in the shift register. We could take a single bit and draw a star if it were true, but that would cover half the pixels on the screen with stars; instead, we only draw a star if a group of bits are all 1.</p>
<p>We&rsquo;ll start with a 17-bit LFSR, as its longest sequence, 2<sup>17</sup>-1, fits within 640x480. If we draw this within an area of 512x256, which has 2<sup>17</sup> pixels, then the starfield will move left by one pixel every frame.</p>
<p>Create an LFSR module <strong>[<a href="https://github.com/projf/projf-explore/blob/master/lib/maths/lfsr.sv">lfsr.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> lfsr #(
    <span style="color:#66d9ef">parameter</span> LEN<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,                   <span style="color:#75715e">// shift register length
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> TAPS<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b10111000</span>         <span style="color:#75715e">// XOR taps
</span><span style="color:#75715e"></span>    ) (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,             <span style="color:#75715e">// clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,             <span style="color:#75715e">// reset
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> en,              <span style="color:#75715e">// enable
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [LEN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] seed,  <span style="color:#75715e">// seed (uses default seed if zero)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [LEN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sreg   <span style="color:#75715e">// lfsr output
</span><span style="color:#75715e"></span>    );

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (en)  sreg <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>, sreg[LEN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>]} <span style="color:#f92672">^</span> (sreg[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">?</span> TAPS <span style="color:#f92672">:</span> {LEN{<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>}});
        <span style="color:#66d9ef">if</span> (rst) sreg <span style="color:#f92672">&lt;=</span> (seed <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> seed <span style="color:#f92672">:</span> {LEN{<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>}};
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>We use a simple top module to drive it, based on the design we used in <a href="/posts/fpga-graphics/">Intro to FPGA Graphics</a>.</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/xc7/top_lfsr.sv">xc7/top_lfsr.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/ice40/top_lfsr.sv">ice40/top_lfsr.sv</a></strong></li>
</ul>
<blockquote>
<p><strong>Building the Designs</strong><br>
In the <a href="https://github.com/projf/projf-explore/tree/master/graphics/ad-astra">FPGA Ad Astra</a> section of the git repo, you&rsquo;ll find the design files, a makefile for iCEBreaker, a Vivado project for Arty, and instructions for building the designs for both boards.</p>
</blockquote>
<p>Shown below is the LSFR top module for iCEBreaker:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top_lfsr (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_12m,      <span style="color:#75715e">// 12 MHz clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button (active high)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_clk,      <span style="color:#75715e">// DVI pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_hsync,    <span style="color:#75715e">// DVI horizontal sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_vsync,    <span style="color:#75715e">// DVI vertical sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_de,       <span style="color:#75715e">// DVI data enable
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_r,  <span style="color:#75715e">// 4-bit DVI red
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_g,  <span style="color:#75715e">// 4-bit DVI green
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_b   <span style="color:#75715e">// 4-bit DVI blue
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// generate pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
    <span style="color:#66d9ef">logic</span> clk_locked;
    clock_gen_480p clock_pix_inst (
       .clk(clk_12m),
       .rst(btn_rst),
       .clk_pix,
       .clk_locked
    );

    <span style="color:#75715e">// display sync signals and coordinates
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
    <span style="color:#66d9ef">logic</span> hsync, vsync;
    <span style="color:#66d9ef">logic</span> de;
    display_480p #(.CORDW(CORDW)) display_inst (
        .clk_pix,
        .rst(<span style="color:#f92672">!</span>clk_locked),
        .sx,
        .sy,
        .hsync,
        .vsync,
        .de,
        .frame(),
        .line()
    );

    <span style="color:#66d9ef">logic</span> sf_area;
    <span style="color:#66d9ef">always_comb</span> sf_area <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>);

    <span style="color:#75715e">// 17-bit LFSR
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sf_reg;
    lfsr #(
        .LEN(<span style="color:#ae81ff">17</span>),
        .TAPS(<span style="color:#ae81ff">17</span><span style="color:#ae81ff">&#39;b10010000000000000</span>)
    ) lsfr_sf (
        .clk(clk_pix),
        .rst(<span style="color:#f92672">!</span>clk_locked),
        .en(sf_area <span style="color:#f92672">&amp;&amp;</span> de),
        .seed(<span style="color:#ae81ff">0</span>),  <span style="color:#75715e">// use default seed
</span><span style="color:#75715e"></span>        .sreg(sf_reg)
    );

    <span style="color:#75715e">// adjust star density (~512 stars for AND 8 bits with 512x256)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> star;
    <span style="color:#66d9ef">always_comb</span> star <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>{sf_reg[<span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">9</span>]};

    <span style="color:#75715e">// colours
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] red, green, blue;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        red   <span style="color:#f92672">=</span> (de <span style="color:#f92672">&amp;&amp;</span> sf_area <span style="color:#f92672">&amp;&amp;</span> star) <span style="color:#f92672">?</span> sf_reg[<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
        green <span style="color:#f92672">=</span> (de <span style="color:#f92672">&amp;&amp;</span> sf_area <span style="color:#f92672">&amp;&amp;</span> star) <span style="color:#f92672">?</span> sf_reg[<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
        blue  <span style="color:#f92672">=</span> (de <span style="color:#f92672">&amp;&amp;</span> sf_area <span style="color:#f92672">&amp;&amp;</span> star) <span style="color:#f92672">?</span> sf_reg[<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// Output DVI clock: 180Â° out of phase with other DVI signals
</span><span style="color:#75715e"></span>    SB_IO #(
        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010000</span>)  <span style="color:#75715e">// PIN_OUTPUT_DDR
</span><span style="color:#75715e"></span>    ) dvi_clk_io (
        .PACKAGE_PIN(dvi_clk),
        .OUTPUT_CLK(clk_pix),
        .D_OUT_0(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
        .D_OUT_1(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>)
    );

    <span style="color:#75715e">// Output DVI signals
</span><span style="color:#75715e"></span>    SB_IO #(
        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010100</span>)  <span style="color:#75715e">// PIN_OUTPUT_REGISTERED
</span><span style="color:#75715e"></span>    ) dvi_signal_io [<span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] (
        .PACKAGE_PIN({dvi_hsync, dvi_vsync, dvi_de, dvi_r, dvi_g, dvi_b}),
        .OUTPUT_CLK(clk_pix),
        .D_OUT_0({hsync, vsync, de, red, green, blue}),
        .D_OUT_1()
    );
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><h2 id="a-screen-full-of-sky">A Screen Full of Sky</h2>
<p>If we use the maximum sequence of an LFSR, then our starfield is limited to a few sizes. To fill the screen, we choose an LFSR that produces a sequence longer than our number of pixels, then restart it when we reach the end of the screen. There are two ways to do this:</p>
<ol>
<li>Find the LFSR value at the point we want to restart</li>
<li>Use a separate counter</li>
</ol>
<p>The first option is extremely efficient when it comes to logic. As each value appears only once, it uniquely describes a position in the sequence. Historically, LFSR were used as counters, including on FPGAs. Xilinx has a nice application note describing this: <a href="https://www.xilinx.com/support/documentation/application_notes/xapp210.pdf">XAPP210</a>.</p>
<p>The second option requires separate counter logic, but on a contemporary FPGA, the cost is minimal. The advantage of this approach is we can easily adjust the direction and speed of the starfield by counting a little more or a little less. This is the approach we&rsquo;ll use in this project.</p>
<p>We&rsquo;re going to want a few starfields, so let&rsquo;s create a dedicated module <strong>[<a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/starfield.sv">starfield.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> starfield #(
    <span style="color:#66d9ef">parameter</span> H<span style="color:#f92672">=</span><span style="color:#ae81ff">800</span>,
    <span style="color:#66d9ef">parameter</span> V<span style="color:#f92672">=</span><span style="color:#ae81ff">525</span>,
    <span style="color:#66d9ef">parameter</span> INC<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,
    <span style="color:#66d9ef">parameter</span> SEED<span style="color:#f92672">=</span><span style="color:#ae81ff">21&#39;h1FFFFF</span>,
    <span style="color:#66d9ef">parameter</span> MASK<span style="color:#f92672">=</span><span style="color:#ae81ff">21&#39;hFFF</span>
    ) (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,           <span style="color:#75715e">// clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> en,            <span style="color:#75715e">// enable
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,           <span style="color:#75715e">// reset
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> sf_on,         <span style="color:#75715e">// star on
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sf_star  <span style="color:#75715e">// star brightness
</span><span style="color:#75715e"></span>    );

    <span style="color:#66d9ef">localparam</span> RST_CNT <span style="color:#f92672">=</span> H <span style="color:#f92672">*</span> V <span style="color:#f92672">+</span> INC <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// counter starts at zero, so sub 1
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">20</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sf_reg, sf_cnt;

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (en) <span style="color:#66d9ef">begin</span>
            sf_cnt <span style="color:#f92672">&lt;=</span> sf_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">if</span> (sf_cnt <span style="color:#f92672">==</span> RST_CNT) sf_cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">if</span> (rst) sf_cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// select some bits to form stars
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        sf_on <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>{sf_reg <span style="color:#f92672">|</span> MASK};
        sf_star <span style="color:#f92672">=</span> sf_reg[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>];
    <span style="color:#66d9ef">end</span>

    lfsr #(
        .LEN(<span style="color:#ae81ff">21</span>),
        .TAPS(<span style="color:#ae81ff">21</span><span style="color:#ae81ff">&#39;b101000000000000000000</span>)
        ) lsfr_sf (
        .clk,
        .rst(sf_cnt <span style="color:#f92672">==</span> <span style="color:#ae81ff">21</span><span style="color:#ae81ff">&#39;b0</span>),
        .en,
        .seed(SEED),
        .sreg(sf_reg)
    );
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>The starfield module defaults to a 21-bit LFSR, which has a maximum sequence of just over two million. The module takes the screen dimensions as parameters <code>H</code> and <code>W</code>: we&rsquo;re using the full screen, including the blanking interval, so the starfield doesn&rsquo;t immediately repeat. The <code>MASK</code> allows us to control the stellar density, the more 1s in the mask, the more stars there will be. Finally, the module outputs an 8-bit value for star brightness, which can be used to create a more varied starfield.</p>
<h2 id="into-space">Into Space</h2>
<p>Using our module, we can create multiple starfields at different speeds and densities to give that real in-space feeling. Our example top module has three starfields:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/xc7/top_starfields.sv">xc7/top_starfields.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/ice40/top_starfields.sv">ice40/top_starfields.sv</a></strong></li>
</ul>
<p>Rebuild your project with the new starfield and top modules. Try experimenting with the <code>INC</code> and <code>MASK</code> parameters to create different speeds and densities.</p>
<h2 id="greetings-world">Greetings, World!</h2>
<p>Our starfields make an ideal backdrop for a greetings demo. Sprites are not ideal for large quantities of text, but do make for a flexible way to animate short messages.</p>
<h3 id="bitmap-font">Bitmap Font</h3>
<p>If we&rsquo;re going to display text messages, we need a font. I&rsquo;ve experimented with a few simple bitmap fonts in the past, but <a href="http://viznut.fi/unscii/">Unscii</a> is one of the best. It&rsquo;s available in 8x8 and 8x16/16x16 pixels with thousands of glyphs for many languages and those for ASCII art. Plus, the GNU Unifont hexdump version is trivial to convert to <code>readmemh</code> format for use with Verilog.</p>
<p>The full list of glyphs is too large to be held in internal FPGA memory. For the purposes of this demo, I&rsquo;ve created two subsets of the Unscii font: one for upper-case basic Latin (including punctuation and numbers), and one for <a href="https://en.wikipedia.org/wiki/Hiragana">Hiragana</a> (without marks):</p>
<ul>
<li><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/res/font_unscii_8x8_latin_uc.mem"><code>font_unscii_8x8_latin_uc.mem</code></a>: (<a href="https://www.unicode.org/charts/PDF/U0000.pdf">U+0020 - U+005F</a>) - 4,096 bits (512 bytes)</li>
<li><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/res/font_unscii_16x16_hiragana.mem"><code>font_unscii_16x16_hiragana.mem</code></a>: (<a href="https://www.unicode.org/charts/PDF/U3040.pdf">U+3041 - U+3096</a>) - 22,016 bits (2,752 bytes)</li>
</ul>
<h4 id="hex-glyphs">Hex Glyphs</h4>
<p>If you look at the entry for &lsquo;F&rsquo; in the Latin memory file you won&rsquo;t find an 8x8 array of 1s and 0s:<br>
<code>7E 60 60 7C 60 60 60 00 // U+0046 (F)</code></p>
<p>Each eight-pixel line of the glyph is represented by two hex digits, so <code>0x7E</code> is the first line of pixels, <code>0x60</code> the second etc. There are two ways these lines could be drawn: most significant bit (MSB) first, or least significant bit (LSB) first. For our &lsquo;F&rsquo; glyph the results of MSB and LSB first are shown below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"> ######         ######
 ##                 ##
 ##                 ##
 #####           #####
 ##                 ##
 ##                 ##
 ##                 ##
</code></pre></div><p>For this font we want to draw the MSB first, but other font data might require the LSB first; we provide support for both options in our module (discussed below).</p>
<blockquote>
<p><strong>Choosing Your Own Characters</strong><br>
You can easily create your own font version with different characters: check out the hex source on the <a href="http://pelulamu.net/unscii/">Unscii site</a>. Use VS Code <em>Column Selection Mode</em> to quickly turn Unifont hex into readmemh format. Just be aware you can&rsquo;t mix different glyph sizes with our sprite design, and watch out for memory usage: the Hiragana file uses 6/30 iCEBreaker BRAMs.</p>
</blockquote>
<h3 id="new-sprite-features">New Sprite Features</h3>
<p>We already have a solid sprite design from the <a href="/posts/hardware-sprites/">previous part</a>, but there are three improvements we&rsquo;ll make for working with fonts.</p>
<h4 id="shared-memory-bus">Shared Memory Bus</h4>
<p>In <a href="/posts/hardware-sprites/">Hardware Sprites</a>, each sprite had exclusive access to a memory instance. Exclusivity works well for simple sprites with fixed graphics, but doesn&rsquo;t make it easy to change or share sprite graphics. Instead, we&rsquo;ll load a set of font glyphs into memory, then share them amongst all the sprite instances.</p>
<p>Sharing requires arbitration between the different sprite instances: only one sprite can read from the memory at a time. We control access by adding a <code>dma_avail</code> signal to the sprite module: the sprite waits for this signal before reading from memory. To avoid potential clashes, we read the required data for each sprite in the blanking interval, then it can freely draw whenever it likes on the following line.</p>
<h4 id="an-entire-line">An Entire Line</h4>
<p>Our fonts are monochrome: each pixel is either 0 or 1, so we could read one bit at a time over a one-bit bus. However, as we&rsquo;re reading the sprite during the blanking interval there&rsquo;s no need to read a pixel at a time; it&rsquo;s more efficient to read a whole line of 8 or 16 pixels (for the Hiragana glyphs) at a time. By reading a whole sprite line in a single clock, we make very light use of the memory bus. We will also change the memory layout in the top module (covered later), so each glyph consists of 8 or 16 entries of 8 or 16 bits.</p>
<h4 id="most-or-least-significant">Most or Least Significant?</h4>
<p>As we discussed in Hex Glyphs, above, a font may be drawn most or least significant bit first. Because we load an entire glyph line into our sprite at a time, it&rsquo;s easy to reverse the bits with a <strong>for loop</strong> if required:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    READ_MEM: <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (LSB) <span style="color:#66d9ef">begin</span>
            spr_line <span style="color:#f92672">&lt;=</span> data_in;  <span style="color:#75715e">// assume read takes one clock cycle
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reverse if MSB is left-most pixel
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>WIDTH; i<span style="color:#f92672">=</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
                spr_line[i] <span style="color:#f92672">&lt;=</span> data_in[(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span>i];
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>On the surface, for loops in Verilog seem the same as those in software; this is misleading.</p>
<p>A for loop in Verilog <strong>duplicates logic</strong>, so the above bit reversal is actually equivalent to (if <code>WIDTH=8</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    spr_line[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">7</span>];
    spr_line[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">6</span>];
    spr_line[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">5</span>];
    spr_line[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">4</span>];
    spr_line[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">3</span>];
    spr_line[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">2</span>];
    spr_line[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">1</span>];
    spr_line[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">&lt;=</span> data_in[<span style="color:#ae81ff">0</span>];
</code></pre></div><p>All eight bits are read in one cycle. Using the for loop doesn&rsquo;t change the design, but makes writing it much more compact and less error prone. We&rsquo;ll make further use of for loops shortly, to handle multiple sprites.</p>
<h3 id="new-sprite-module">New Sprite Module</h3>
<p>Our new sprite module incorporating these changes <strong>[<a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/sprite.sv">sprite.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> sprite #(
    <span style="color:#66d9ef">parameter</span> WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,         <span style="color:#75715e">// graphic width in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HEIGHT<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,        <span style="color:#75715e">// graphic height in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SCALE_X<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,       <span style="color:#75715e">// sprite width scale-factor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SCALE_Y<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,       <span style="color:#75715e">// sprite height scale-factor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> LSB<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,           <span style="color:#75715e">// first pixel in LSB
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> CORDW<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>,        <span style="color:#75715e">// screen coordinate width in bits
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> ADDRW<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>          <span style="color:#75715e">// width of graphic memory address bus
</span><span style="color:#75715e"></span>    ) (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,                  <span style="color:#75715e">// clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,                  <span style="color:#75715e">// reset
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> start,                <span style="color:#75715e">// start control
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> dma_avail,            <span style="color:#75715e">// memory access control
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx,    <span style="color:#75715e">// horizontal screen position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx,  <span style="color:#75715e">// horizontal sprite position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] data_in,  <span style="color:#75715e">// data from external memory
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] pos,      <span style="color:#75715e">// sprite line position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> pix,                  <span style="color:#75715e">// pixel colour to draw (0 or 1)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> drawing,              <span style="color:#75715e">// sprite is drawing
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> done                  <span style="color:#75715e">// sprite drawing is complete
</span><span style="color:#75715e"></span>    );

    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_line;  <span style="color:#75715e">// local copy of sprite line
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// position within sprite
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(WIDTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]  ox;
    <span style="color:#66d9ef">logic</span> [$clog2(HEIGHT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] oy;

    <span style="color:#75715e">// scale counters
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(SCALE_X)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_x;
    <span style="color:#66d9ef">logic</span> [$clog2(SCALE_Y)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_y;

    <span style="color:#66d9ef">enum</span> {
        IDLE,       <span style="color:#75715e">// awaiting start signal
</span><span style="color:#75715e"></span>        START,      <span style="color:#75715e">// prepare for new sprite drawing
</span><span style="color:#75715e"></span>        AWAIT_DMA,  <span style="color:#75715e">// await access to memory
</span><span style="color:#75715e"></span>        READ_MEM,   <span style="color:#75715e">// read line of sprite from memory
</span><span style="color:#75715e"></span>        AWAIT_POS,  <span style="color:#75715e">// await horizontal position
</span><span style="color:#75715e"></span>        DRAW,       <span style="color:#75715e">// draw pixel
</span><span style="color:#75715e"></span>        NEXT_LINE,  <span style="color:#75715e">// prepare for next sprite line
</span><span style="color:#75715e"></span>        DONE        <span style="color:#75715e">// set done signal
</span><span style="color:#75715e"></span>    } state, state_next;

    <span style="color:#66d9ef">integer</span> i;  <span style="color:#75715e">// for bit reversal in READ_MEM
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        state <span style="color:#f92672">&lt;=</span> state_next;  <span style="color:#75715e">// advance to next state
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">case</span> (state)
            START: <span style="color:#66d9ef">begin</span>
                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                oy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                cnt_y <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                pos <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span>
            READ_MEM: <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (LSB) <span style="color:#66d9ef">begin</span>
                    spr_line <span style="color:#f92672">&lt;=</span> data_in;  <span style="color:#75715e">// assume read takes one clock cycle
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// reverse if MSB is left-most pixel
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>WIDTH; i<span style="color:#f92672">=</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
                        spr_line[i] <span style="color:#f92672">&lt;=</span> data_in[(WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span>i];
                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span>
            AWAIT_POS: <span style="color:#66d9ef">begin</span>
                ox <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                cnt_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span>
            DRAW: <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (SCALE_X <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> cnt_x <span style="color:#f92672">==</span> SCALE_X<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
                    ox <span style="color:#f92672">&lt;=</span> ox <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                    cnt_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                    cnt_x <span style="color:#f92672">&lt;=</span> cnt_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span>
            NEXT_LINE: <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (SCALE_Y <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> cnt_y <span style="color:#f92672">==</span> SCALE_Y<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
                    oy <span style="color:#f92672">&lt;=</span> oy <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                    cnt_y <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                    pos <span style="color:#f92672">&lt;=</span> pos <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                    cnt_y <span style="color:#f92672">&lt;=</span> cnt_y <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span>
            DONE: done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">endcase</span>

        <span style="color:#66d9ef">if</span> (rst) <span style="color:#66d9ef">begin</span>
            state <span style="color:#f92672">&lt;=</span> IDLE;
            ox <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            oy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            cnt_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            cnt_y <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            spr_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            pos <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// output current pixel colour when drawing
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        pix <span style="color:#f92672">=</span> (state <span style="color:#f92672">==</span> DRAW) <span style="color:#f92672">?</span> spr_line[ox] <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// create status signals
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> last_pixel, load_line, last_line;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        last_pixel <span style="color:#f92672">=</span> (ox <span style="color:#f92672">==</span> WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> cnt_x <span style="color:#f92672">==</span> SCALE_X<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
        load_line  <span style="color:#f92672">=</span> (cnt_y <span style="color:#f92672">==</span> SCALE_Y<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
        last_line  <span style="color:#f92672">=</span> (oy <span style="color:#f92672">==</span> HEIGHT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> cnt_y <span style="color:#f92672">==</span> SCALE_Y<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
        drawing <span style="color:#f92672">=</span> (state <span style="color:#f92672">==</span> DRAW);
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// determine next state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">case</span> (state)
            IDLE:       state_next <span style="color:#f92672">=</span> start <span style="color:#f92672">?</span> START <span style="color:#f92672">:</span> IDLE;
            START:      state_next <span style="color:#f92672">=</span> AWAIT_DMA;
            AWAIT_DMA:  state_next <span style="color:#f92672">=</span> dma_avail <span style="color:#f92672">?</span> READ_MEM <span style="color:#f92672">:</span> AWAIT_DMA;
            READ_MEM:   state_next <span style="color:#f92672">=</span> AWAIT_POS;
            AWAIT_POS:  state_next <span style="color:#f92672">=</span> (sx <span style="color:#f92672">==</span> sprx<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">?</span> DRAW <span style="color:#f92672">:</span> AWAIT_POS;
            DRAW:       state_next <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>last_pixel <span style="color:#f92672">?</span> DRAW <span style="color:#f92672">:</span>
                                    (<span style="color:#f92672">!</span>last_line <span style="color:#f92672">?</span> NEXT_LINE <span style="color:#f92672">:</span> DONE);
            NEXT_LINE:  state_next <span style="color:#f92672">=</span> load_line <span style="color:#f92672">?</span> AWAIT_DMA <span style="color:#f92672">:</span> AWAIT_POS;
            DONE:       state_next <span style="color:#f92672">=</span> IDLE;
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>    state_next <span style="color:#f92672">=</span> IDLE;
        <span style="color:#66d9ef">endcase</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><h2 id="f-in-space">F in Space!</h2>
<p>We have an animated starfield, we have a font-friendly sprite module, let&rsquo;s draw an &lsquo;F&rsquo; in space.</p>
<p>To avoid confusion, we&rsquo;re going to use <strong><a href="https://en.wikipedia.org/wiki/Code_point">code point</a></strong> to refer to the numerical representation of a character and <strong><a href="https://en.wikipedia.org/wiki/Glyph">glyph</a></strong> to refer to the graphicical representation.</p>
<p>Capital F has the code point <code>U+0046</code>. However, our Latin font file has 64 glyphs covering code points <code>U+0020 - U+005F</code>, so we need to subtract <code>0x20</code> (32 decimal) from the code point to load the correct glyph.</p>
<p>The new top module combines the starfield design from earlier in this post, with a single sprite:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/xc7/top_space_f.sv">xc7/top_space_f.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/ice40/top_space_f.sv">ice40/top_space_f.sv</a></strong></li>
</ul>
<p>Arty version shown below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top_space_f (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button (active low)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// generate pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
    <span style="color:#66d9ef">logic</span> clk_locked;
    clock_gen_480p clock_pix_inst (
       .clk(clk_100m),
       .rst(<span style="color:#f92672">!</span>btn_rst),  <span style="color:#75715e">// reset button is active low
</span><span style="color:#75715e"></span>       .clk_pix,
       .clk_locked
    );

    <span style="color:#75715e">// display sync signals and coordinates
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
    <span style="color:#66d9ef">logic</span> hsync, vsync;
    <span style="color:#66d9ef">logic</span> de, line;
    display_480p #(.CORDW(CORDW)) display_inst (
        .clk_pix,
        .rst(<span style="color:#f92672">!</span>clk_locked),
        .sx,
        .sy,
        .hsync,
        .vsync,
        .de,
        .frame(),
        .line
    );

    <span style="color:#75715e">// font glyph ROM
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FONT_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;   <span style="color:#75715e">// width in pixels (also ROM width)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FONT_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;   <span style="color:#75715e">// height in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FONT_GLYPHS <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>;  <span style="color:#75715e">// number of glyphs
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> F_ROM_DEPTH <span style="color:#f92672">=</span> FONT_GLYPHS <span style="color:#f92672">*</span> FONT_HEIGHT;
    <span style="color:#66d9ef">localparam</span> FONT_FILE   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;font_unscii_8x8_latin_uc.mem&#34;</span>;

    <span style="color:#66d9ef">logic</span> [$clog2(F_ROM_DEPTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] font_rom_addr;
    <span style="color:#66d9ef">logic</span> [FONT_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] font_rom_data;  <span style="color:#75715e">// line of glyph pixels
</span><span style="color:#75715e"></span>
    rom_sync #(
        .WIDTH(FONT_WIDTH),
        .DEPTH(F_ROM_DEPTH),
        .INIT_F(FONT_FILE)
    ) font_rom (
        .clk(clk_pix),
        .addr(font_rom_addr),
        .data(font_rom_data)
    );

    <span style="color:#75715e">// sprite
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_SCALE_X <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;  <span style="color:#75715e">// enlarge sprite width by this factor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_SCALE_Y <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;  <span style="color:#75715e">// enlarge sprite height by this factor
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// horizontal and vertical screen position of letter
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_X <span style="color:#f92672">=</span> <span style="color:#ae81ff">192</span>;
    <span style="color:#66d9ef">localparam</span> SPR_Y <span style="color:#f92672">=</span> <span style="color:#ae81ff">112</span>;

    <span style="color:#75715e">// signal to start sprite drawing
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_start;
    <span style="color:#66d9ef">always_comb</span> spr_start <span style="color:#f92672">=</span> (line <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">==</span> SPR_Y);

    <span style="color:#75715e">// subtract 0x20 from code points as font starts at U+0020
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_GLYPH_ADDR <span style="color:#f92672">=</span> FONT_HEIGHT <span style="color:#f92672">*</span> <span style="color:#ae81ff">&#39;h26</span>;  <span style="color:#75715e">// F U+0046
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// font ROM address
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FONT_HEIGHT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_glyph_line;
    <span style="color:#66d9ef">logic</span> spr_fdma;  <span style="color:#75715e">// font ROM DMA slot
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        font_rom_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        spr_fdma <span style="color:#f92672">=</span> line;  <span style="color:#75715e">// load glyph line at start of horizontal blanking
</span><span style="color:#75715e"></span>        font_rom_addr <span style="color:#f92672">=</span> (spr_fdma) <span style="color:#f92672">?</span> SPR_GLYPH_ADDR <span style="color:#f92672">+</span> spr_glyph_line <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">logic</span> spr_pix;  <span style="color:#75715e">// sprite pixel
</span><span style="color:#75715e"></span>    sprite #(
        .WIDTH(FONT_WIDTH),
        .HEIGHT(FONT_HEIGHT),
        .SCALE_X(SPR_SCALE_X),
        .SCALE_Y(SPR_SCALE_Y),
        .LSB(<span style="color:#ae81ff">0</span>),
        .CORDW(CORDW),
        .ADDRW($clog2(FONT_HEIGHT))
        ) spr (
        .clk(clk_pix),
        .rst(<span style="color:#f92672">!</span>clk_locked),
        .start(spr_start),
        .dma_avail(spr_fdma),
        .sx,
        .sprx(SPR_X),
        .data_in(font_rom_data),
        .pos(spr_glyph_line),
        .pix(spr_pix),
        .drawing(),
        .done()
    );

    <span style="color:#75715e">// starfields
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> sf1_on, sf2_on, sf3_on;
    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sf1_star, sf2_star, sf3_star;

    starfield #(.INC(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), .SEED(<span style="color:#ae81ff">21&#39;h9A9A9</span>)) sf1 (
        .clk(clk_pix),
        .en(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>),
        .rst(<span style="color:#f92672">!</span>clk_locked),
        .sf_on(sf1_on),
        .sf_star(sf1_star)
    );

    starfield #(.INC(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>), .SEED(<span style="color:#ae81ff">21&#39;hA9A9A</span>)) sf2 (
        .clk(clk_pix),
        .en(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>),
        .rst(<span style="color:#f92672">!</span>clk_locked),
        .sf_on(sf2_on),
        .sf_star(sf2_star)
    );

    starfield #(.INC(<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>), .MASK(<span style="color:#ae81ff">21&#39;h7FF</span>)) sf3 (
        .clk(clk_pix),
        .en(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>),
        .rst(<span style="color:#f92672">!</span>clk_locked),
        .sf_on(sf3_on),
        .sf_star(sf3_star)
    );

    <span style="color:#75715e">// sprite colour &amp; star brightness
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] red_spr, green_spr, blue_spr, starlight;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        {red_spr, green_spr, blue_spr} <span style="color:#f92672">=</span> (spr_pix) <span style="color:#f92672">?</span> <span style="color:#ae81ff">12&#39;hFC0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">12&#39;h000</span>;
        starlight <span style="color:#f92672">=</span> (sf1_on) <span style="color:#f92672">?</span> sf1_star[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">:</span>
                    (sf2_on) <span style="color:#f92672">?</span> sf2_star[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">:</span>
                    (sf3_on) <span style="color:#f92672">?</span> sf3_star[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// VGA output
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
        vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
        vga_r <span style="color:#f92672">&lt;=</span> de <span style="color:#f92672">?</span> spr_pix <span style="color:#f92672">?</span> red_spr   <span style="color:#f92672">:</span> starlight <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
        vga_g <span style="color:#f92672">&lt;=</span> de <span style="color:#f92672">?</span> spr_pix <span style="color:#f92672">?</span> green_spr <span style="color:#f92672">:</span> starlight <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
        vga_b <span style="color:#f92672">&lt;=</span> de <span style="color:#f92672">?</span> spr_pix <span style="color:#f92672">?</span> blue_spr  <span style="color:#f92672">:</span> starlight <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><h2 id="hello---ããã«ã¡ã¯">Hello - ããã«ã¡ã¯</h2>
<p>Our &lsquo;F&rsquo; in space doesn&rsquo;t take advantage of the new functionality of the sprite module. Let&rsquo;s update our top module to say &ldquo;Hello&rdquo; using five sprites; I&rsquo;ve done this for English and Japanese:</p>
<ul>
<li>Hello - Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/xc7/top_hello_en.sv">xc7/top_hello_en.sv</a></strong></li>
<li>Hello - iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/ice40/top_hello_en.sv">ice40/top_hello_en.sv</a></strong></li>
<li>ããã«ã¡ã¯ - Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/xc7/top_hello_jp.sv">xc7/top_hello_jp.sv</a></strong></li>
<li>ããã«ã¡ã¯ - iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/ice40/top_hello_jp.sv">ice40/top_hello_jp.sv</a></strong></li>
</ul>
<p>Try creating your own five-character message. Check the fonts for which characters are available, or create your own font-variant to write in another language.</p>
<p>These modules make extensive use of for loops to avoid duplication. To create multiple instances of a module we need to use <code>generate</code> rather than a normal <code>for</code> loop.</p>
<p><em>NB. The iCE40 designs don&rsquo;t make full use of generate due to rendering issues. See issue <a href="https://github.com/projf/projf-explore/issues/31">#31</a>.</em></p>
<p><img src="/img/posts/fpga-ad-astra/hello-jp.png" alt="ããã«ã¡ã¯" title="ããã«ã¡ã¯ - Hello! Captured from my FPGA board."></p>
<h2 id="controlling-the-message">Controlling the Message</h2>
<p>To display a custom message we can store a message as code points: <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/res/greet.mem">greet.mem</a></strong>.</p>
<p>A single two-line message looks like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">//   FPGA
// AD ASTRA
20 20 46 50 47 41 20 20
41 44 20 41 53 54 52 41
</code></pre></div><p>The greeting ROM loads the messages and looks similar to the font ROM:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// greeting message ROM
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> GREET_MSGS   <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;    <span style="color:#75715e">// 32 messages
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> GREET_LENGTH <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;    <span style="color:#75715e">// each containing 16 code points
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> G_ROM_WIDTH  <span style="color:#f92672">=</span> $clog2(<span style="color:#ae81ff">&#39;h5F</span>);  <span style="color:#75715e">// highest code point is U+005F
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> G_ROM_DEPTH  <span style="color:#f92672">=</span> GREET_MSGS <span style="color:#f92672">*</span> GREET_LENGTH;
    <span style="color:#66d9ef">localparam</span> GREET_FILE   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;greet.mem&#34;</span>;

    <span style="color:#66d9ef">logic</span> [$clog2(G_ROM_DEPTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] greet_rom_addr;
    <span style="color:#66d9ef">logic</span> [G_ROM_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] greet_rom_data;  <span style="color:#75715e">// code point
</span><span style="color:#75715e"></span>
    rom_sync #(
        .WIDTH(G_ROM_WIDTH),
        .DEPTH(G_ROM_DEPTH),
        .INIT_F(GREET_FILE)
    ) greet_rom (
        .clk(clk_pix),
        .addr(greet_rom_addr),
        .data(greet_rom_data)
    );
</code></pre></div><p>To express ourselves better, I&rsquo;ve expanded the number of sprites to eight, then reused them to form a second line of text. This gives us 16 characters to work with per message.</p>
<p>Now we have our message in memory, the process for calculating the font ROM address is more complex:</p>
<ol>
<li>Set the greeting ROM address to the chosen message (at start of blanking)</li>
<li>Save the code points of the characters from the ROM (one cycle later)</li>
<li>Use the code points to calculate the glyph address (two cycles later)</li>
</ol>
<p>We use for loops and offset the times relative to the start of the blanking interval:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#66d9ef">integer</span> i;  <span style="color:#75715e">// for looping over sprite signals
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// greeting ROM address
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(G_ROM_DEPTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] msg_start;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        greet_rom_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        msg_start <span style="color:#f92672">=</span> greeting <span style="color:#f92672">*</span> GREET_LENGTH;  <span style="color:#75715e">// calculate start of message
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> SPR_CNT; i <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (sx <span style="color:#f92672">==</span> SPR_DMA<span style="color:#f92672">+</span>i)
                greet_rom_addr <span style="color:#f92672">=</span> (sy <span style="color:#f92672">&lt;</span> LINE2) <span style="color:#f92672">?</span> (msg_start<span style="color:#f92672">+</span>i) <span style="color:#f92672">:</span>
                                                (msg_start<span style="color:#f92672">+</span>i<span style="color:#f92672">+</span>GREET_LENGTH<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>);
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// load code point from greeting ROM
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [G_ROM_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_cp [SPR_CNT];
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> SPR_CNT; i <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (sx <span style="color:#f92672">==</span> SPR_DMA<span style="color:#f92672">+</span>i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) spr_cp[i] <span style="color:#f92672">&lt;=</span> greet_rom_data;  <span style="color:#75715e">// wait 1
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// font ROM address
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(F_ROM_DEPTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_glyph_addr [SPR_CNT];
    <span style="color:#66d9ef">logic</span> [$clog2(FONT_HEIGHT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_glyph_line [SPR_CNT];
    <span style="color:#66d9ef">logic</span> [SPR_CNT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_fdma;  <span style="color:#75715e">// font ROM DMA slots
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        font_rom_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> SPR_CNT; i <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
            spr_fdma[i] <span style="color:#f92672">=</span> (sx <span style="color:#f92672">==</span> SPR_DMA<span style="color:#f92672">+</span>i <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// wait 2
</span><span style="color:#75715e"></span>            spr_glyph_addr[i] <span style="color:#f92672">=</span> (spr_cp[i] <span style="color:#f92672">-</span> CP_START) <span style="color:#f92672">*</span> FONT_HEIGHT;
            <span style="color:#66d9ef">if</span> (spr_fdma[i])
                font_rom_addr <span style="color:#f92672">=</span> spr_glyph_addr[i] <span style="color:#f92672">+</span> spr_glyph_line[i];
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="greetings-demo-v1">Greetings Demo v1</h3>
<p>Using the greetings logic, I&rsquo;ve created a demo to greet a few of the open-source FPGA projects we love; apologies to everyone we missed:</p>
<ul>
<li>Greetings - Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/xc7/top_greet_v1.sv">xc7/top_greet_v1.sv</a></strong></li>
<li>Greetings - iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/ice40/top_greet_v1.sv">ice40/top_greet_v1.sv</a></strong></li>
</ul>
<p>We cycle through the greetings using a frame counter; I&rsquo;ve chosen 80 frames (1.25 seconds). You can adjust this with the <code>MSG_CHG</code> parameter.</p>
<h3 id="copperbars">Copperbars</h3>
<p>The text feels a bit flat in plain gold: what we need are <a href="https://en.wikipedia.org/wiki/Copperbar">copper bars</a>! While we don&rsquo;t have a co-processor (yet), we can create the effect using a simple counter. I&rsquo;ve gone for a sky and earth colour scheme, but you can easily change the colours to your own taste:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// font colours
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> COLR_A   <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;h125</span>;  <span style="color:#75715e">// initial colour A
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> COLR_B   <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;h421</span>;  <span style="color:#75715e">// initial colour B
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SLIN_1A  <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;d150</span>;  <span style="color:#75715e">// 1st line of colour A
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SLIN_1B  <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;d178</span>;  <span style="color:#75715e">// 1st line of colour B
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SLIN_2A  <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;d250</span>;  <span style="color:#75715e">// 2nd line of colour A
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SLIN_2B  <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;d278</span>;  <span style="color:#75715e">// 2nd line of colour B
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LINE_INC <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;      <span style="color:#75715e">// lines of each colour
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">11</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] font_colr;  <span style="color:#75715e">// 12 bit colour (4-bit per channel)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(LINE_INC)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_line;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (line) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> SLIN_1A <span style="color:#f92672">||</span> sy <span style="color:#f92672">==</span> SLIN_2A) <span style="color:#66d9ef">begin</span>
                cnt_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                font_colr <span style="color:#f92672">&lt;=</span> COLR_A;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> SLIN_1B <span style="color:#f92672">||</span> sy <span style="color:#f92672">==</span> SLIN_2B) <span style="color:#66d9ef">begin</span>
                cnt_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                font_colr <span style="color:#f92672">&lt;=</span> COLR_B;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                cnt_line <span style="color:#f92672">&lt;=</span> cnt_line <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">if</span> (cnt_line <span style="color:#f92672">==</span> LINE_INC<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
                    cnt_line <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                    font_colr <span style="color:#f92672">&lt;=</span> font_colr <span style="color:#f92672">+</span> <span style="color:#ae81ff">&#39;h111</span>;
                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>Our final greeting design:</p>
<ul>
<li>Greetings - Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/xc7/top_greet.sv">xc7/top_greet.sv</a></strong></li>
<li>Greetings - iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/ad-astra/ice40/top_greet.sv">ice40/top_greet.sv</a></strong></li>
</ul>
<p><img src="/img/posts/fpga-ad-astra/fpga-ad-astra.png" alt="FPGA Ad Astra" title="To the stars!"></p>
<h2 id="explore">Explore</h2>
<p>I hope you enjoyed this instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few suggestions to get you started:</p>
<ul>
<li>Change starfield speed and direction with buttons on your FPGA board (see <a href="/posts/fpga-pong/">FPGA Pong</a>)</li>
<li>Write your own greeting messages</li>
<li>Cycle the greetings colours over time</li>
<li>Animate the text from different directions, so it slides in from all sides of the screen</li>
</ul>
<p>If you create a cool demo, drop me a message <a href="https://twitter.com/WillFlux">@WillFlux</a>, and I&rsquo;ll add it to the blog.</p>
<blockquote>
<p><strong>Sponsor Project F</strong><br>
If you like what I do, consider <a href="https://github.com/sponsors/WillGreen">sponsoring me</a> on GitHub.<br>
I use contributions to spend more time creating open-source FPGA designs and tutorials.</p>
</blockquote>
<h2 id="next-time">Next Time</h2>
<p>In the next part, we&rsquo;ll introduce bitmaps and learn about <a href="/posts/framebuffers/">framebuffers</a>.</p>
<p><em>Constructive feedback is always welcome. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/fpga-graphics/">Intro to FPGA Graphics</a></li>
	
	<li><a href="/posts/hello-arty-2/">Hello Arty - Part 2</a></li>
	
	<li><a href="/posts/hello-arty-1/">Hello Arty - Part 1</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>Â©2022 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://badgers.projectf.io/script.js" data-site="EVCGKVDN" defer></script>
</body>
</html>

