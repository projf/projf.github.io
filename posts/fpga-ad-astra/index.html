<!doctype html><html class="not-ready lg:text-base" style=--bg:#fff lang=en-gb><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Ad Astra - Project F</title>
<meta name=theme-color><meta name=description content="This collection of related demos combines some of my earliest FPGA designs from 2018: simple sprites and an animated starfield generated with a linear-feedback shift register."><meta name=author content="Will Green"><link rel="preload stylesheet" as=style href=https://projectf.io/main.min.css><link rel=preload as=image href=https://projectf.io/theme.png><link rel=preload as=image href=https://projectf.io/twitter.svg><link rel=preload as=image href=https://projectf.io/github.svg><link rel=preload as=image href=https://projectf.io/mastodon.svg><link rel=preload as=image href=https://projectf.io/rss.svg><script defer src=https://projectf.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://projectf.io/favicon.ico><link rel=apple-touch-icon href=https://projectf.io/apple-touch-icon.png><meta name=generator content="Hugo 0.125.3"><script src=https://cdn-eu.usefathom.com/script.js data-site=EVCGKVDN defer></script><meta itemprop=name content="Ad Astra"><meta itemprop=description content="This collection of related demos combines some of my earliest FPGA designs from 2018: simple sprites and an animated starfield generated with a linear-feedback shift register."><meta itemprop=datePublished content="2020-06-10T00:00:00+00:00"><meta itemprop=dateModified content="2023-10-14T00:00:00+00:00"><meta itemprop=wordCount content="4033"><meta itemprop=image content="https://projectf.io/img/posts/fpga-ad-astra/social-card.png"><meta itemprop=keywords content="Graphics,Arty-A7"><meta property="og:url" content="https://projectf.io/posts/fpga-ad-astra/"><meta property="og:site_name" content="Project F"><meta property="og:title" content="Ad Astra"><meta property="og:description" content="This collection of related demos combines some of my earliest FPGA designs from 2018: simple sprites and an animated starfield generated with a linear-feedback shift register."><meta property="og:locale" content="en-gb"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-10T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-14T00:00:00+00:00"><meta property="article:tag" content="Graphics"><meta property="article:tag" content="Arty-A7"><meta property="og:image" content="https://projectf.io/img/posts/fpga-ad-astra/social-card.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://projectf.io/img/posts/fpga-ad-astra/social-card.png"><meta name=twitter:title content="Ad Astra"><meta name=twitter:description content="This collection of related demos combines some of my earliest FPGA designs from 2018: simple sprites and an animated starfield generated with a linear-feedback shift register."><link rel=canonical href=https://projectf.io/posts/fpga-ad-astra/></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-4xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://projectf.io/>Project F</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#fff".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/demos/>Demos</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/verilog-lib/>Lib</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tools/>Tools</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tutorials/>Tutorials</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/@WillFlux target=_blank rel=me>twitter
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/projf target=_blank rel=me>github
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./mastodon.svg) href=https://mastodon.social/@WillFlux target=_blank rel=me>mastodon
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://projectf.io/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-4xl px-8 pb-4 pt-4 dark:prose-invert"><article><header class=mb-4><h1 class="!my-0 pb-2.5">Ad Astra</h1><div class="text-sm antialiased opacity-60">Published
<time>10 Jun 2020</time>
<span class=mx-1>&#183;</span>
<span>Updated
<time>14 Oct 2023</time></span></div></header><section><p>This collection of related <a href=/demos>demos</a> combines some of my earliest FPGA designs from 2018: simple sprites and an animated starfield generated with a linear-feedback shift register. I don&rsquo;t recommend using this approach to sprites in new designs; check out the <a href=/posts/hardware-sprites/>hardware sprites</a> tutorial instead.</p><p>Share your thoughts with @WillFlux on <a href=https://mastodon.social/@WillFlux>Mastodon</a> or <a href=https://twitter.com/WillFlux>Twitter</a>. If you like what I do, <a href=https://github.com/sponsors/WillGreen>sponsor me</a>. üôè</p><p><img src=/img/posts/fpga-ad-astra/banner.png alt title></p><h3 id=requirements>Requirements</h3><p>For these demos you need an FPGA board with video output. I&rsquo;ll be working with the <a href=https://reference.digilentinc.com/reference/programmable-logic/arty-a7/reference-manual>Digilent Arty A7</a>, but it should be easy to adapt this design to other boards. It helps to be comfortable with programming your FPGA board and reasonably familiar with Verilog.</p><p>If you&rsquo;ve not played with FPGA graphics before, check out <a href=/posts/fpga-graphics/>Beginning FPGA Graphics</a>.</p><h2 id=computer-space>Computer Space</h2><p><a href=https://en.wikipedia.org/wiki/Computer_Space>Computer Space</a> was the first video arcade game: it features a simple backdrop of stars over which the player&rsquo;s rocket battles two flying saucers. The backdrop may have been simple, but this game was released in 1971, when a &ldquo;cheap&rdquo; computer, such as the <a href=https://www.computerhistory.org/revolution/minicomputers/11/338>Data General Nova</a>, cost around $8,000 (c. $40,000 in 2020). Unable to find anything both fast and cheap, developers Nolan Bushnell and Ted Dabney created their own custom hardware instead. It&rsquo;s strangely hard to find details of the Computer Space logic design on the Internet, but <a href=https://en.wikipedia.org/wiki/7400-series_integrated_circuits>TTL 7400s</a> were used.</p><blockquote><p><strong>Computer Space Cabinet</strong><br>Computer Space had an amazing fibreglass cabinet. You can see more photos at <a href=https://web.archive.org/web/20090130053055/http://www.marvin3m.com/arcade/cspace.htm>Marvin&rsquo;s Marvelous Mechanical Museum</a> (courtesy of the Wayback Machine).</p></blockquote><h2 id=linear-feedback-shift-register>Linear-Feedback Shift Register</h2><p>I don&rsquo;t know how Computer Space created its starfield, but we&rsquo;re going to use a <strong>linear-feedback shift register</strong> (henceforth LFSR). Rather like field programmable gate arrays themselves, their name makes LFSRs sound arcane and inscrutable; happily for us, this is not the case.</p><p>An LFSR can create a pseudorandom number sequence in which every number appears just once. For example, an 8-bit LSFR can generate all the numbers from 1-255 in a repeatable sequence that seems random. The logic for an LFSR can be written in a single line of Verilog:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>sreg <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b0</span>, sreg[<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span>]} <span style=color:#f92672>^</span> (sreg[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>?</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b10111000</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b0</span>);
</span></span></code></pre></div><p>The first part of the statement right-shifts the shift-register one bit. In the second part, we check the value of the bit we shifted: this is the feedback. If the feedback is true, we XOR the whole shift register with a magic pattern of bits known as <strong>taps</strong>. Values at the bit positions of the taps are flipped by the XOR. The initial value of an LFSR is known as the <strong>seed</strong>.</p><p>For example, an 8-bit LFSR with a seed of 169:</p><ul><li><strong><code>10101001</code> - seed value (169)</strong></li><li><code>01010100</code> - after right shift (bit shifted out was <code>1</code>)</li><li><code>01010100 XOR 10111000</code> - XOR with taps</li><li><strong><code>11101100</code> - 2nd value (236)</strong></li><li><code>01110110</code> - after right shift (bit shifted out was <code>0</code>)</li><li><code>01110110 XOR 00000000</code> - XOR with 0</li><li><strong><code>01110110</code> - 3rd value (118)</strong></li><li>&mldr;</li></ul><p>For an 8-bit LFSR, we set tap bits 8, 6, 5, and 4. To find taps for other lengths, you can refer to the <a href=https://en.wikipedia.org/wiki/Linear-feedback_shift_register#Some_polynomials_for_maximal_LFSRs>feedback polynomials on Wikipedia</a>.</p><p>To create a starfield, we need a sequence that&rsquo;s the same length as the number of pixels we&rsquo;re drawing. If we iterate through our shift register every time we get to a new pixel, then each pixel will always be associated with the same number in the shift register. We could take a single bit and draw a star if it were true, but that would cover half the pixels on the screen with stars; instead, we only draw a star if a group of bits are all 1.</p><p>We&rsquo;ll start with a 17-bit LFSR, as its longest sequence, 2<sup>17</sup>-1, fits within 640x480. If we draw this within an area of 512x256, which has 2<sup>17</sup> pixels, then the starfield will move left by one pixel every frame.</p><p>Galois Linear-Feedback Shift Register <strong>[<a href=https://github.com/projf/projf-explore/blob/main/lib/maths/lfsr.sv>lfsr.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> lfsr #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> LEN<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,                   <span style=color:#75715e>// shift register length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> TAPS<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b10111000</span>         <span style=color:#75715e>// XOR taps
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk,             <span style=color:#75715e>// clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst,             <span style=color:#75715e>// reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> en,              <span style=color:#75715e>// enable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> [LEN<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] seed,  <span style=color:#75715e>// seed (uses default seed if zero)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [LEN<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sreg   <span style=color:#75715e>// lfsr output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (en)  sreg <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b0</span>, sreg[LEN<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span>]} <span style=color:#f92672>^</span> (sreg[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>?</span> TAPS <span style=color:#f92672>:</span> {LEN{<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b0</span>}});
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst) sreg <span style=color:#f92672>&lt;=</span> (seed <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>?</span> seed <span style=color:#f92672>:</span> {LEN{<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b1</span>}};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>With modules from the <a href=/verilog-lib>Verilog Lib</a> we can draw to the Arty VGA output - <strong>[<a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/xc7/top_lfsr.sv>xc7/top_lfsr.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_lfsr (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_100m,     <span style=color:#75715e>// 100 MHz clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_rst_n,    <span style=color:#75715e>// reset button (active low)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_hsync,    <span style=color:#75715e>// horizontal sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_vsync,    <span style=color:#75715e>// vertical sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_r,  <span style=color:#75715e>// 4-bit VGA red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_g,  <span style=color:#75715e>// 4-bit VGA green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_b   <span style=color:#75715e>// 4-bit VGA blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// generate pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> clk_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> clk_pix_locked;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> rst_pix;
</span></span><span style=display:flex><span>    clock_480p clock_pix_inst (
</span></span><span style=display:flex><span>       .clk_100m,
</span></span><span style=display:flex><span>       .rst(<span style=color:#f92672>!</span>btn_rst_n),  <span style=color:#75715e>// reset button is active low
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix,
</span></span><span style=display:flex><span>       .clk_pix_5x(),  <span style=color:#75715e>// not used for VGA output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix_locked
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) rst_pix <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>!</span>clk_pix_locked;  <span style=color:#75715e>// wait for clock lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CORDW <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> hsync, vsync;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de;
</span></span><span style=display:flex><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync,
</span></span><span style=display:flex><span>        .vsync,
</span></span><span style=display:flex><span>        .de,
</span></span><span style=display:flex><span>        .frame(),
</span></span><span style=display:flex><span>        .line()
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> sf_area;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> sf_area <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>512</span> <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>256</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 17-bit LFSR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>16</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sf_reg;
</span></span><span style=display:flex><span>    lfsr #(
</span></span><span style=display:flex><span>        .LEN(<span style=color:#ae81ff>17</span>),
</span></span><span style=display:flex><span>        .TAPS(<span style=color:#ae81ff>17</span><span style=color:#ae81ff>&#39;b10010000000000000</span>)
</span></span><span style=display:flex><span>    ) lsfr_sf (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .en(sf_area <span style=color:#f92672>&amp;&amp;</span> de),
</span></span><span style=display:flex><span>        .seed(<span style=color:#ae81ff>0</span>),  <span style=color:#75715e>// use default seed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .sreg(sf_reg)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// adjust star density (~512 stars for AND 8 bits with 512x256)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> star;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> star <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>{sf_reg[<span style=color:#ae81ff>16</span><span style=color:#f92672>:</span><span style=color:#ae81ff>9</span>]};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VGA output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        vga_hsync <span style=color:#f92672>&lt;=</span> hsync;
</span></span><span style=display:flex><span>        vga_vsync <span style=color:#f92672>&lt;=</span> vsync;
</span></span><span style=display:flex><span>        vga_r <span style=color:#f92672>&lt;=</span> (de <span style=color:#f92672>&amp;&amp;</span> sf_area <span style=color:#f92672>&amp;&amp;</span> star) <span style=color:#f92672>?</span> sf_reg[<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        vga_g <span style=color:#f92672>&lt;=</span> (de <span style=color:#f92672>&amp;&amp;</span> sf_area <span style=color:#f92672>&amp;&amp;</span> star) <span style=color:#f92672>?</span> sf_reg[<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        vga_b <span style=color:#f92672>&lt;=</span> (de <span style=color:#f92672>&amp;&amp;</span> sf_area <span style=color:#f92672>&amp;&amp;</span> star) <span style=color:#f92672>?</span> sf_reg[<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><blockquote><p><strong>Building the Demo</strong><br>In the <a href=https://github.com/projf/projf-explore/tree/main/demos/ad-astra>Ad Astra</a> section of the git repo, you&rsquo;ll find the design files and build instructions.</p></blockquote><h2 id=a-screen-full-of-sky>A Screen Full of Sky</h2><p>If we use the maximum sequence of an LFSR, then our starfield is limited to a few sizes. To fill the screen, we choose an LFSR that produces a sequence longer than our number of pixels, then restart it when we reach the end of the screen. There are two ways to do this:</p><ol><li>Find the LFSR value at the point we want to restart</li><li>Use a separate counter</li></ol><p>The first option is extremely efficient when it comes to logic. As each value appears only once, it uniquely describes a position in the sequence. Historically, LFSR were used as counters, including on FPGAs. Xilinx has a nice application note describing this: <a href=https://www.xilinx.com/support/documentation/application_notes/xapp210.pdf>XAPP210</a>.</p><p>The second option requires separate counter logic, but on a contemporary FPGA, the cost is minimal. The advantage of this approach is we can easily adjust the direction and speed of the starfield by counting a little more or a little less. This is the approach we&rsquo;ll use.</p><p>We&rsquo;re going to want a few starfields, so let&rsquo;s create a dedicated module <strong>[<a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/starfield.sv>starfield.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> starfield #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> H<span style=color:#f92672>=</span><span style=color:#ae81ff>800</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> V<span style=color:#f92672>=</span><span style=color:#ae81ff>525</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> INC<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> SEED<span style=color:#f92672>=</span><span style=color:#ae81ff>21&#39;h1FFFFF</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> MASK<span style=color:#f92672>=</span><span style=color:#ae81ff>21&#39;hFFF</span>
</span></span><span style=display:flex><span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk,           <span style=color:#75715e>// clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> en,            <span style=color:#75715e>// enable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst,           <span style=color:#75715e>// reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> sf_on,         <span style=color:#75715e>// star on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sf_star  <span style=color:#75715e>// star brightness
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> RST_CNT <span style=color:#f92672>=</span> H <span style=color:#f92672>*</span> V <span style=color:#f92672>+</span> INC <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// counter starts at zero, so sub 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>20</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sf_reg, sf_cnt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (en) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            sf_cnt <span style=color:#f92672>&lt;=</span> sf_cnt <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sf_cnt <span style=color:#f92672>==</span> RST_CNT) sf_cnt <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst) sf_cnt <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select some bits to form stars
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        sf_on <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>{sf_reg <span style=color:#f92672>|</span> MASK};
</span></span><span style=display:flex><span>        sf_star <span style=color:#f92672>=</span> sf_reg[<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lfsr #(
</span></span><span style=display:flex><span>        .LEN(<span style=color:#ae81ff>21</span>),
</span></span><span style=display:flex><span>        .TAPS(<span style=color:#ae81ff>21</span><span style=color:#ae81ff>&#39;b101000000000000000000</span>)
</span></span><span style=display:flex><span>        ) lsfr_sf (
</span></span><span style=display:flex><span>        .clk,
</span></span><span style=display:flex><span>        .rst(sf_cnt <span style=color:#f92672>==</span> <span style=color:#ae81ff>21</span><span style=color:#ae81ff>&#39;b0</span>),
</span></span><span style=display:flex><span>        .en,
</span></span><span style=display:flex><span>        .seed(SEED),
</span></span><span style=display:flex><span>        .sreg(sf_reg)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>The starfield module defaults to a 21-bit LFSR, which has a maximum sequence of just over two million. The module takes the screen dimensions as parameters <code>H</code> and <code>W</code>: we&rsquo;re using the full screen, including the blanking interval, so the starfield doesn&rsquo;t immediately repeat. The <code>MASK</code> allows us to control the stellar density, the more 1s in the mask, the more stars there will be. Finally, the module outputs an 8-bit value for star brightness, which can be used to create a more varied starfield.</p><h2 id=into-space>Into Space</h2><p>Using our module, we can create multiple starfields at different speeds and densities to give that real in-space feeling. The example top module has three starfields: <strong>[<a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/xc7/top_starfields.sv>xc7/top_starfields.sv</a>]</strong>.</p><p>Try experimenting with the <code>INC</code> and <code>MASK</code> parameters to create different speeds and densities.</p><h2 id=greetings-world>Greetings, World!</h2><p>Our starfields make an ideal backdrop for a greetings demo. Sprites are not ideal for large quantities of text, but do make for a flexible way to animate short messages.</p><h3 id=bitmap-font>Bitmap Font</h3><p>If we&rsquo;re going to display text messages, we need a font. I&rsquo;ve experimented with a few simple bitmap fonts in the past, but <a href=http://viznut.fi/unscii/>Unscii</a> is one of the best. It&rsquo;s available in 8x8 and 8x16/16x16 pixels with thousands of glyphs for many languages and those for ASCII art. Plus, the GNU Unifont hexdump version is trivial to convert to <code>readmemh</code> format for use with Verilog.</p><p>The full list of glyphs is too large to be held in internal FPGA memory. For the purposes of this demo, I&rsquo;ve created two subsets of the Unscii font: one for upper-case basic Latin (including punctuation and numbers), and one for <a href=https://en.wikipedia.org/wiki/Hiragana>Hiragana</a> (without marks):</p><ul><li><a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/res/font_unscii_8x8_latin_uc.mem><code>font_unscii_8x8_latin_uc.mem</code></a>: (<a href=https://www.unicode.org/charts/PDF/U0000.pdf>U+0020 - U+005F</a>) - 4096 bits (512 bytes)</li><li><a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/res/font_unscii_16x16_hiragana.mem><code>font_unscii_16x16_hiragana.mem</code></a>: (<a href=https://www.unicode.org/charts/PDF/U3040.pdf>U+3041 - U+3096</a>) - 22016 bits (2752 bytes)</li></ul><h4 id=hex-glyphs>Hex Glyphs</h4><p>If you look at the entry for &lsquo;F&rsquo; in the Latin memory file you won&rsquo;t find an 8x8 array of 1s and 0s:<br><code>7E 60 60 7C 60 60 60 00 // U+0046 (F)</code></p><p>Each eight-pixel line of the glyph is represented by two hex digits, so <code>0x7E</code> is the first line of pixels, <code>0x60</code> the second etc. There are two ways these lines could be drawn: most significant bit (MSB) first, or least significant bit (LSB) first. For our &lsquo;F&rsquo; glyph the results of MSB and LSB first are shown below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span> ######         ######
</span></span><span style=display:flex><span> ##                 ##
</span></span><span style=display:flex><span> ##                 ##
</span></span><span style=display:flex><span> #####           #####
</span></span><span style=display:flex><span> ##                 ##
</span></span><span style=display:flex><span> ##                 ##
</span></span><span style=display:flex><span> ##                 ##
</span></span></code></pre></div><p>For this font we want to draw the MSB first, but other font data might require the LSB first; we provide support for both options in our module (discussed below).</p><blockquote><p><strong>Choosing Your Own Characters</strong><br>You can easily create your own font version with different characters: check out the hex source on the <a href=http://pelulamu.net/unscii/>Unscii site</a>. Use VS Code <em>Column Selection Mode</em> to quickly turn Unifont hex into readmemh format. Just be aware you can&rsquo;t mix different glyph sizes with our sprite design, and watch out for memory usage.</p></blockquote><h3 id=shared-memory-bus>Shared Memory Bus</h3><p>We want to share a set of font glyphs amongst multiple sprite instances. Otherwise each sprite would needs its own copy of every glyph it wanted to display, which would quickly get messy and memory hungry.</p><p>Sharing requires arbitration between the different sprite instances: only one sprite can read from the memory at a time. We control access by adding a <code>dma_avail</code> signal to the sprite module: the sprite waits for this signal before reading from memory. To avoid potential clashes, we read the required data for each sprite in the blanking interval, then it can freely draw whenever it likes on the following line.</p><p>Our fonts are monochrome: each pixel is either 0 or 1, so we could read one bit at a time over a one-bit bus. However, as we&rsquo;re reading the sprite during the blanking interval there&rsquo;s no need to read a pixel at a time; it&rsquo;s more efficient to read a whole line of 8 or 16 pixels (for the Hiragana glyphs) at a time. By reading a whole sprite line in a single clock, we make very light use of the memory bus.</p><h4 id=most-or-least-significant>Most or Least Significant?</h4><p>As we discussed in Hex Glyphs, above, a font may be drawn most or least significant bit first. Because we load an entire glyph line into our sprite at a time, it&rsquo;s easy to reverse the bits with a <strong>for loop</strong> if required:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    READ_MEM: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (LSB) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            spr_line <span style=color:#f92672>&lt;=</span> data_in;  <span style=color:#75715e>// assume read takes one clock cycle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// reverse if MSB is left-most pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> (i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>; i<span style=color:#f92672>&lt;</span>WIDTH; i<span style=color:#f92672>=</span>i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                spr_line[i] <span style=color:#f92672>&lt;=</span> data_in[(WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>-</span>i];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>On the surface, for loops in Verilog seem the same as those in software; this is misleading.</p><p>A for loop in Verilog <strong>duplicates logic</strong>, so the above bit reversal is equivalent to (<code>WIDTH=8</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>7</span>];
</span></span><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>6</span>];
</span></span><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>5</span>];
</span></span><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>3</span>];
</span></span><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>5</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>6</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    spr_line[<span style=color:#ae81ff>7</span>] <span style=color:#f92672>&lt;=</span> data_in[<span style=color:#ae81ff>0</span>];
</span></span></code></pre></div><p>All eight bits are read in one cycle. Using the for loop doesn&rsquo;t change the design, but makes writing it much more compact and less error prone. We&rsquo;ll make further use of for loops shortly, to handle multiple sprites.</p><h3 id=sprite-module>Sprite Module</h3><p>Our Ad Astra sprite module <strong>[<a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/sprite.sv>sprite.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> sprite #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> WIDTH<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,         <span style=color:#75715e>// graphic width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> HEIGHT<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,        <span style=color:#75715e>// graphic height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SCALE_X<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,       <span style=color:#75715e>// sprite width scale-factor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SCALE_Y<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,       <span style=color:#75715e>// sprite height scale-factor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> LSB<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,           <span style=color:#75715e>// first pixel in LSB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>,        <span style=color:#75715e>// screen coordinate width in bits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> ADDRW<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>          <span style=color:#75715e>// width of graphic memory address bus
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk,                  <span style=color:#75715e>// clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst,                  <span style=color:#75715e>// reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> start,                <span style=color:#75715e>// start control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> dma_avail,            <span style=color:#75715e>// memory access control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx,    <span style=color:#75715e>// horizontal screen position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx,  <span style=color:#75715e>// horizontal sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> [WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] data_in,  <span style=color:#75715e>// data from external memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [ADDRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] pos,      <span style=color:#75715e>// sprite line position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> pix,                  <span style=color:#75715e>// pixel colour to draw (0 or 1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> drawing,              <span style=color:#75715e>// sprite is drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> done                  <span style=color:#75715e>// sprite drawing is complete
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_line;  <span style=color:#75715e>// local copy of sprite line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// position within sprite
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(WIDTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>]  ox;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(HEIGHT)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] oy;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// scale counters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(SCALE_X)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] cnt_x;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(SCALE_Y)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] cnt_y;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> {
</span></span><span style=display:flex><span>        IDLE,       <span style=color:#75715e>// awaiting start signal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        START,      <span style=color:#75715e>// prepare for new sprite drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        AWAIT_DMA,  <span style=color:#75715e>// await access to memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        READ_MEM,   <span style=color:#75715e>// read line of sprite from memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        AWAIT_POS,  <span style=color:#75715e>// await horizontal position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DRAW,       <span style=color:#75715e>// draw pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        NEXT_LINE,  <span style=color:#75715e>// prepare for next sprite line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DONE        <span style=color:#75715e>// set done signal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } state, state_next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>integer</span> i;  <span style=color:#75715e>// for bit reversal in READ_MEM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        state <span style=color:#f92672>&lt;=</span> state_next;  <span style=color:#75715e>// advance to next state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>            START: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                done <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                oy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                cnt_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                pos <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            READ_MEM: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (LSB) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    spr_line <span style=color:#f92672>&lt;=</span> data_in;  <span style=color:#75715e>// assume read takes one clock cycle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// reverse if MSB is left-most pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>for</span> (i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>; i<span style=color:#f92672>&lt;</span>WIDTH; i<span style=color:#f92672>=</span>i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                        spr_line[i] <span style=color:#f92672>&lt;=</span> data_in[(WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>-</span>i];
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            AWAIT_POS: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                ox <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                cnt_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            DRAW: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (SCALE_X <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> cnt_x <span style=color:#f92672>==</span> SCALE_X<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    ox <span style=color:#f92672>&lt;=</span> ox <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    cnt_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    cnt_x <span style=color:#f92672>&lt;=</span> cnt_x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            NEXT_LINE: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (SCALE_Y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> cnt_y <span style=color:#f92672>==</span> SCALE_Y<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    oy <span style=color:#f92672>&lt;=</span> oy <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    cnt_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    pos <span style=color:#f92672>&lt;=</span> pos <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    cnt_y <span style=color:#f92672>&lt;=</span> cnt_y <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            DONE: done <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            ox <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            oy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            cnt_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            cnt_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            spr_line <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            pos <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            done <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// output current pixel colour when drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        pix <span style=color:#f92672>=</span> (state <span style=color:#f92672>==</span> DRAW) <span style=color:#f92672>?</span> spr_line[ox] <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create status signals
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> last_pixel, load_line, last_line;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        last_pixel <span style=color:#f92672>=</span> (ox <span style=color:#f92672>==</span> WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> cnt_x <span style=color:#f92672>==</span> SCALE_X<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        load_line  <span style=color:#f92672>=</span> (cnt_y <span style=color:#f92672>==</span> SCALE_Y<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        last_line  <span style=color:#f92672>=</span> (oy <span style=color:#f92672>==</span> HEIGHT<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> cnt_y <span style=color:#f92672>==</span> SCALE_Y<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        drawing <span style=color:#f92672>=</span> (state <span style=color:#f92672>==</span> DRAW);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// determine next state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>            IDLE:       state_next <span style=color:#f92672>=</span> start <span style=color:#f92672>?</span> START <span style=color:#f92672>:</span> IDLE;
</span></span><span style=display:flex><span>            START:      state_next <span style=color:#f92672>=</span> AWAIT_DMA;
</span></span><span style=display:flex><span>            AWAIT_DMA:  state_next <span style=color:#f92672>=</span> dma_avail <span style=color:#f92672>?</span> READ_MEM <span style=color:#f92672>:</span> AWAIT_DMA;
</span></span><span style=display:flex><span>            READ_MEM:   state_next <span style=color:#f92672>=</span> AWAIT_POS;
</span></span><span style=display:flex><span>            AWAIT_POS:  state_next <span style=color:#f92672>=</span> (sx <span style=color:#f92672>==</span> sprx<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>) <span style=color:#f92672>?</span> DRAW <span style=color:#f92672>:</span> AWAIT_POS;
</span></span><span style=display:flex><span>            DRAW:       state_next <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>last_pixel <span style=color:#f92672>?</span> DRAW <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                    (<span style=color:#f92672>!</span>last_line <span style=color:#f92672>?</span> NEXT_LINE <span style=color:#f92672>:</span> DONE);
</span></span><span style=display:flex><span>            NEXT_LINE:  state_next <span style=color:#f92672>=</span> load_line <span style=color:#f92672>?</span> AWAIT_DMA <span style=color:#f92672>:</span> AWAIT_POS;
</span></span><span style=display:flex><span>            DONE:       state_next <span style=color:#f92672>=</span> IDLE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>    state_next <span style=color:#f92672>=</span> IDLE;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><h2 id=f-in-space>F in Space!</h2><p>We have an animated starfield, we have a font-friendly sprite module, let&rsquo;s draw an &lsquo;F&rsquo; in space.</p><p>To avoid confusion, we&rsquo;re going to use <strong><a href=https://en.wikipedia.org/wiki/Code_point>code point</a></strong> to refer to the numerical representation of a character and <strong><a href=https://en.wikipedia.org/wiki/Glyph>glyph</a></strong> to refer to the graphicical representation.</p><p>Capital F has the code point <code>U+0046</code>. However, our Latin font file has 64 glyphs covering code points <code>U+0020 - U+005F</code>, so we need to subtract <code>0x20</code> (32 decimal) from the code point to load the correct glyph.</p><p>The new top module combines the starfield design from earlier in this post, with a single sprite: <strong>[<a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/xc7/top_space_f.sv>xc7/top_space_f.sv</a>]</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_space_f (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_100m,     <span style=color:#75715e>// 100 MHz clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_rst_n,    <span style=color:#75715e>// reset button (active low)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_hsync,    <span style=color:#75715e>// horizontal sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_vsync,    <span style=color:#75715e>// vertical sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_r,  <span style=color:#75715e>// 4-bit VGA red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_g,  <span style=color:#75715e>// 4-bit VGA green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_b   <span style=color:#75715e>// 4-bit VGA blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// generate pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> clk_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> clk_pix_locked;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> rst_pix;
</span></span><span style=display:flex><span>    clock_480p clock_pix_inst (
</span></span><span style=display:flex><span>       .clk_100m,
</span></span><span style=display:flex><span>       .rst(<span style=color:#f92672>!</span>btn_rst_n),  <span style=color:#75715e>// reset button is active low
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix,
</span></span><span style=display:flex><span>       .clk_pix_5x(),  <span style=color:#75715e>// not used for VGA output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix_locked
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) rst_pix <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>!</span>clk_pix_locked;  <span style=color:#75715e>// wait for clock lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CORDW <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> hsync, vsync;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de, line;
</span></span><span style=display:flex><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync,
</span></span><span style=display:flex><span>        .vsync,
</span></span><span style=display:flex><span>        .de,
</span></span><span style=display:flex><span>        .frame(),
</span></span><span style=display:flex><span>        .line
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// font glyph ROM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FONT_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;   <span style=color:#75715e>// width in pixels (also ROM width)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FONT_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;   <span style=color:#75715e>// height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FONT_GLYPHS <span style=color:#f92672>=</span> <span style=color:#ae81ff>64</span>;  <span style=color:#75715e>// number of glyphs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> F_ROM_DEPTH <span style=color:#f92672>=</span> FONT_GLYPHS <span style=color:#f92672>*</span> FONT_HEIGHT;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> FONT_FILE   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;font_unscii_8x8_latin_uc.mem&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(F_ROM_DEPTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] font_rom_addr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [FONT_WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] font_rom_data;  <span style=color:#75715e>// line of glyph pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    rom_sync #(
</span></span><span style=display:flex><span>        .WIDTH(FONT_WIDTH),
</span></span><span style=display:flex><span>        .DEPTH(F_ROM_DEPTH),
</span></span><span style=display:flex><span>        .INIT_F(FONT_FILE)
</span></span><span style=display:flex><span>    ) font_rom (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .addr(font_rom_addr),
</span></span><span style=display:flex><span>        .data(font_rom_data)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_SCALE_X <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;  <span style=color:#75715e>// enlarge sprite width by this factor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_SCALE_Y <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;  <span style=color:#75715e>// enlarge sprite height by this factor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// horizontal and vertical screen position of letter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_X <span style=color:#f92672>=</span> <span style=color:#ae81ff>192</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> SPR_Y <span style=color:#f92672>=</span> <span style=color:#ae81ff>112</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// signal to start sprite drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_start;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> spr_start <span style=color:#f92672>=</span> (line <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>==</span> SPR_Y);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// subtract 0x20 from code points as font starts at U+0020
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_GLYPH_ADDR <span style=color:#f92672>=</span> FONT_HEIGHT <span style=color:#f92672>*</span> <span style=color:#ae81ff>&#39;h26</span>;  <span style=color:#75715e>// F U+0046
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// font ROM address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(FONT_HEIGHT)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_glyph_line;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> spr_fdma;  <span style=color:#75715e>// font ROM DMA slot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        font_rom_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        spr_fdma <span style=color:#f92672>=</span> line;  <span style=color:#75715e>// load glyph line at start of horizontal blanking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        font_rom_addr <span style=color:#f92672>=</span> (spr_fdma) <span style=color:#f92672>?</span> SPR_GLYPH_ADDR <span style=color:#f92672>+</span> spr_glyph_line <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> spr_pix;  <span style=color:#75715e>// sprite pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    sprite #(
</span></span><span style=display:flex><span>        .WIDTH(FONT_WIDTH),
</span></span><span style=display:flex><span>        .HEIGHT(FONT_HEIGHT),
</span></span><span style=display:flex><span>        .SCALE_X(SPR_SCALE_X),
</span></span><span style=display:flex><span>        .SCALE_Y(SPR_SCALE_Y),
</span></span><span style=display:flex><span>        .LSB(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .CORDW(CORDW),
</span></span><span style=display:flex><span>        .ADDRW($clog2(FONT_HEIGHT))
</span></span><span style=display:flex><span>        ) spr (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .start(spr_start),
</span></span><span style=display:flex><span>        .dma_avail(spr_fdma),
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sprx(SPR_X),
</span></span><span style=display:flex><span>        .data_in(font_rom_data),
</span></span><span style=display:flex><span>        .pos(spr_glyph_line),
</span></span><span style=display:flex><span>        .pix(spr_pix),
</span></span><span style=display:flex><span>        .drawing(),
</span></span><span style=display:flex><span>        .done()
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// starfields
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> sf1_on, sf2_on, sf3_on;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sf1_star, sf2_star, sf3_star;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    starfield #(.INC(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>), .SEED(<span style=color:#ae81ff>21&#39;h9A9A9</span>)) sf1 (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .en(<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b1</span>),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .sf_on(sf1_on),
</span></span><span style=display:flex><span>        .sf_star(sf1_star)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    starfield #(.INC(<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>), .SEED(<span style=color:#ae81ff>21&#39;hA9A9A</span>)) sf2 (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .en(<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b1</span>),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .sf_on(sf2_on),
</span></span><span style=display:flex><span>        .sf_star(sf2_star)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    starfield #(.INC(<span style=color:#f92672>-</span><span style=color:#ae81ff>4</span>), .MASK(<span style=color:#ae81ff>21&#39;h7FF</span>)) sf3 (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .en(<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b1</span>),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .sf_on(sf3_on),
</span></span><span style=display:flex><span>        .sf_star(sf3_star)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite colour &amp; star brightness
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] red_spr, green_spr, blue_spr, starlight;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        {red_spr, green_spr, blue_spr} <span style=color:#f92672>=</span> (spr_pix) <span style=color:#f92672>?</span> <span style=color:#ae81ff>12&#39;hFC0</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>12&#39;h000</span>;
</span></span><span style=display:flex><span>        starlight <span style=color:#f92672>=</span> (sf1_on) <span style=color:#f92672>?</span> sf1_star[<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>4</span>] <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    (sf2_on) <span style=color:#f92672>?</span> sf2_star[<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>4</span>] <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    (sf3_on) <span style=color:#f92672>?</span> sf3_star[<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>4</span>] <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VGA output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        vga_hsync <span style=color:#f92672>&lt;=</span> hsync;
</span></span><span style=display:flex><span>        vga_vsync <span style=color:#f92672>&lt;=</span> vsync;
</span></span><span style=display:flex><span>        vga_r <span style=color:#f92672>&lt;=</span> de <span style=color:#f92672>?</span> spr_pix <span style=color:#f92672>?</span> red_spr   <span style=color:#f92672>:</span> starlight <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        vga_g <span style=color:#f92672>&lt;=</span> de <span style=color:#f92672>?</span> spr_pix <span style=color:#f92672>?</span> green_spr <span style=color:#f92672>:</span> starlight <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        vga_b <span style=color:#f92672>&lt;=</span> de <span style=color:#f92672>?</span> spr_pix <span style=color:#f92672>?</span> blue_spr  <span style=color:#f92672>:</span> starlight <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><h2 id=hello---„Åì„Çì„Å´„Å°„ÅØ>Hello - „Åì„Çì„Å´„Å°„ÅØ</h2><p>Our &lsquo;F&rsquo; in space doesn&rsquo;t take advantage of the full functionality of the sprite module. Let&rsquo;s update our top module to say &ldquo;Hello&rdquo; using five sprites; I&rsquo;ve done this for English and Japanese:</p><ul><li>Hello: <strong><a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/xc7/top_hello_en.sv>xc7/top_hello_en.sv</a></strong></li><li>„Åì„Çì„Å´„Å°„ÅØ: <strong><a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/xc7/top_hello_jp.sv>xc7/top_hello_jp.sv</a></strong></li></ul><p>Try creating your own five-character message. Check the fonts for which characters are available, or create your own font-variant to write in another language.</p><p>These modules make extensive use of for loops to avoid duplication. To create multiple instances of a module we need to use <code>generate</code> rather than a normal <code>for</code> loop.</p><p><img src=/img/posts/fpga-ad-astra/hello-jp.png alt=„Åì„Çì„Å´„Å°„ÅØ title="„Åì„Çì„Å´„Å°„ÅØ - Hello! Captured from my FPGA board."></p><h2 id=controlling-the-message>Controlling the Message</h2><p>To display a custom message we can store a message as code points: <strong><a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/res/greet.mem>greet.mem</a></strong>.</p><p>A single two-line message looks like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>//   FPGA
</span></span><span style=display:flex><span>// AD ASTRA
</span></span><span style=display:flex><span>20 20 46 50 47 41 20 20
</span></span><span style=display:flex><span>41 44 20 41 53 54 52 41
</span></span></code></pre></div><p>The greeting ROM loads the messages and looks similar to the font ROM:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    <span style=color:#75715e>// greeting message ROM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> GREET_MSGS   <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;    <span style=color:#75715e>// 32 messages
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> GREET_LENGTH <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;    <span style=color:#75715e>// each containing 16 code points
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> G_ROM_WIDTH  <span style=color:#f92672>=</span> $clog2(<span style=color:#ae81ff>&#39;h5F</span>);  <span style=color:#75715e>// highest code point is U+005F
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> G_ROM_DEPTH  <span style=color:#f92672>=</span> GREET_MSGS <span style=color:#f92672>*</span> GREET_LENGTH;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> GREET_FILE   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;greet.mem&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(G_ROM_DEPTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] greet_rom_addr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [G_ROM_WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] greet_rom_data;  <span style=color:#75715e>// code point
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    rom_sync #(
</span></span><span style=display:flex><span>        .WIDTH(G_ROM_WIDTH),
</span></span><span style=display:flex><span>        .DEPTH(G_ROM_DEPTH),
</span></span><span style=display:flex><span>        .INIT_F(GREET_FILE)
</span></span><span style=display:flex><span>    ) greet_rom (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .addr(greet_rom_addr),
</span></span><span style=display:flex><span>        .data(greet_rom_data)
</span></span><span style=display:flex><span>    );
</span></span></code></pre></div><p>To express ourselves better, I&rsquo;ve expanded the number of sprites to eight, then reused them to form a second line of text. This gives us 16 characters to work with per message.</p><p>Now we have our message in memory, the process for calculating the font ROM address is more complex:</p><ol><li>Set the greeting ROM address to the chosen message (at start of blanking)</li><li>Save the code points of the characters from the ROM (one cycle later)</li><li>Use the code points to calculate the glyph address (two cycles later)</li></ol><p>We use for loops and offset the times relative to the start of the blanking interval:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    <span style=color:#66d9ef>integer</span> i;  <span style=color:#75715e>// for looping over sprite signals
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// greeting ROM address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(G_ROM_DEPTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] msg_start;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        greet_rom_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        msg_start <span style=color:#f92672>=</span> greeting <span style=color:#f92672>*</span> GREET_LENGTH;  <span style=color:#75715e>// calculate start of message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> SPR_CNT; i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sx <span style=color:#f92672>==</span> SPR_DMA<span style=color:#f92672>+</span>i)
</span></span><span style=display:flex><span>                greet_rom_addr <span style=color:#f92672>=</span> (sy <span style=color:#f92672>&lt;</span> LINE2) <span style=color:#f92672>?</span> (msg_start<span style=color:#f92672>+</span>i) <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                                (msg_start<span style=color:#f92672>+</span>i<span style=color:#f92672>+</span>GREET_LENGTH<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// load code point from greeting ROM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [G_ROM_WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_cp [SPR_CNT];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> SPR_CNT; i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sx <span style=color:#f92672>==</span> SPR_DMA<span style=color:#f92672>+</span>i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) spr_cp[i] <span style=color:#f92672>&lt;=</span> greet_rom_data;  <span style=color:#75715e>// wait 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// font ROM address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(F_ROM_DEPTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_glyph_addr [SPR_CNT];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(FONT_HEIGHT)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_glyph_line [SPR_CNT];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [SPR_CNT<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_fdma;  <span style=color:#75715e>// font ROM DMA slots
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        font_rom_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> SPR_CNT; i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            spr_fdma[i] <span style=color:#f92672>=</span> (sx <span style=color:#f92672>==</span> SPR_DMA<span style=color:#f92672>+</span>i <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>);  <span style=color:#75715e>// wait 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            spr_glyph_addr[i] <span style=color:#f92672>=</span> (spr_cp[i] <span style=color:#f92672>-</span> CP_START) <span style=color:#f92672>*</span> FONT_HEIGHT;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (spr_fdma[i])
</span></span><span style=display:flex><span>                font_rom_addr <span style=color:#f92672>=</span> spr_glyph_addr[i] <span style=color:#f92672>+</span> spr_glyph_line[i];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h3 id=greetings-demo-v1>Greetings Demo v1</h3><p>Using the greetings logic, I&rsquo;ve created a demo to greet a few of the open-source FPGA projects we love; apologies to everyone we missed: <strong>[<a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/xc7/top_greet_v1.sv>xc7/top_greet_v1.sv</a>]</strong></p><p>We cycle through the greetings using a frame counter; I&rsquo;ve chosen 80 frames (1.25 seconds). You can adjust this with the <code>MSG_CHG</code> parameter.</p><h3 id=copperbars>Copperbars</h3><p>The text feels a bit flat in plain gold: what we need are <a href=https://en.wikipedia.org/wiki/Copperbar>copper bars</a>! While we don&rsquo;t have a co-processor (yet), we can create the effect using a simple counter. I&rsquo;ve gone for a sky and earth colour scheme, but you can easily change the colours to your own taste:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    <span style=color:#75715e>// font colours
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> COLR_A   <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;h125</span>;  <span style=color:#75715e>// initial colour A
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> COLR_B   <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;h421</span>;  <span style=color:#75715e>// initial colour B
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SLIN_1A  <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;d150</span>;  <span style=color:#75715e>// 1st line of colour A
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SLIN_1B  <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;d178</span>;  <span style=color:#75715e>// 1st line of colour B
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SLIN_2A  <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;d250</span>;  <span style=color:#75715e>// 2nd line of colour A
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SLIN_2B  <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;d278</span>;  <span style=color:#75715e>// 2nd line of colour B
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> LINE_INC <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;      <span style=color:#75715e>// lines of each colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>11</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] font_colr;  <span style=color:#75715e>// 12 bit colour (4-bit per channel)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(LINE_INC)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] cnt_line;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> SLIN_1A <span style=color:#f92672>||</span> sy <span style=color:#f92672>==</span> SLIN_2A) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                cnt_line <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                font_colr <span style=color:#f92672>&lt;=</span> COLR_A;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> SLIN_1B <span style=color:#f92672>||</span> sy <span style=color:#f92672>==</span> SLIN_2B) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                cnt_line <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                font_colr <span style=color:#f92672>&lt;=</span> COLR_B;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                cnt_line <span style=color:#f92672>&lt;=</span> cnt_line <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (cnt_line <span style=color:#f92672>==</span> LINE_INC<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    cnt_line <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    font_colr <span style=color:#f92672>&lt;=</span> font_colr <span style=color:#f92672>+</span> <span style=color:#ae81ff>&#39;h111</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Our final greeting design: <strong>[<a href=https://github.com/projf/projf-explore/blob/main/demos/ad-astra/xc7/top_greet.sv>xc7/top_greet.sv</a>]</strong></p><p><img src=/img/posts/fpga-ad-astra/fpga-ad-astra.png alt="FPGA Ad Astra" title="To the stars!"></p><h2 id=whats-next>What&rsquo;s Next?</h2><p>Check out my other <a href=/demos>FPGA demos</a> or the <a href=/posts/fpga-graphics/>FPGA graphics tutorials</a>. The <a href=/posts/framebuffers/>Framebuffers</a> post uses a LFSR to fizzle fade a bitmap image.</p></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/graphics>graphics</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/arty-a7>arty-a7</a></footer></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-4xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto><a class=link href=https://projectf.io/>Project F</a>: A little oasis for FPGA and RISC-V design.
&copy; 2024 Will Green.</div></footer></body></html>