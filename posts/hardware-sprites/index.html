<!doctype html><html class="not-ready text-sm lg:text-base" style=--bg:#fff lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Hardware Sprites - Project F</title><meta name=theme-color><meta name=description content="Welcome back to Exploring FPGA Graphics. In the previous part, we updated our display signals and learnt about colour palettes. This part shows you how to create fast, colourful graphics with minimal logic. Hardware sprites maintain much of the simplicity of our Pong design while offering greater creative freedom.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes."><meta name=author content="Will Green"><link rel="preload stylesheet" as=style href=https://projectf.io/main.min.css><script defer src=https://projectf.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://projectf.io/theme.png><link rel=preload as=image href=https://projectf.io/github.svg><link rel=preload as=image href=https://projectf.io/mastodon.svg><link rel=preload as=image href=https://projectf.io/rss.svg><link rel=icon href=https://projectf.io/favicon.ico><link rel=apple-touch-icon href=https://projectf.io/apple-touch-icon.png><meta name=generator content="Hugo 0.111.3"><script src=https://cdn-eu.usefathom.com/script.js data-site=EVCGKVDN defer></script><meta property="og:title" content="Hardware Sprites"><meta property="og:description" content="Welcome back to Exploring FPGA Graphics. In the previous part, we updated our display signals and learnt about colour palettes. This part shows you how to create fast, colourful graphics with minimal logic. Hardware sprites maintain much of the simplicity of our Pong design while offering greater creative freedom.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes."><meta property="og:type" content="article"><meta property="og:url" content="https://projectf.io/posts/hardware-sprites/"><meta property="og:image" content="https://projectf.io/img/posts/hardware-sprites/social-card.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-28T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-26T00:00:00+00:00"><meta itemprop=name content="Hardware Sprites"><meta itemprop=description content="Welcome back to Exploring FPGA Graphics. In the previous part, we updated our display signals and learnt about colour palettes. This part shows you how to create fast, colourful graphics with minimal logic. Hardware sprites maintain much of the simplicity of our Pong design while offering greater creative freedom.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes."><meta itemprop=datePublished content="2020-10-28T00:00:00+00:00"><meta itemprop=dateModified content="2023-03-26T00:00:00+00:00"><meta itemprop=wordCount content="5093"><meta itemprop=image content="https://projectf.io/img/posts/hardware-sprites/social-card.png"><meta itemprop=keywords content="graphics,arty-a7,icebreaker,verilator,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://projectf.io/img/posts/hardware-sprites/social-card.png"><meta name=twitter:title content="Hardware Sprites"><meta name=twitter:description content="Welcome back to Exploring FPGA Graphics. In the previous part, we updated our display signals and learnt about colour palettes. This part shows you how to create fast, colourful graphics with minimal logic. Hardware sprites maintain much of the simplicity of our Pong design while offering greater creative freedom.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes."></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href=https://projectf.io/>Project F</a><div class="btn-dark text-[0] ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg=`"#fff"`.replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/demos/>Demos</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/verilog-lib/>Lib</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tools/>Tools</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tutorials/>Tutorials</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/projf target=_blank rel=me>github</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./mastodon.svg) href=https://mastodon.social/@WillFlux target=_blank rel=me>mastodon</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://projectf.io/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-1 dark:prose-invert"><article><header class=mb-1><h1 class="!my-0 pb-2.5">Hardware Sprites</h1><div class="text-sm opacity-60">Published
<time>28 Oct 2020</time>
<span class=mx-1>&#183;</span>
<span>Updated
<time>26 Mar 2023</time></span></div></header><section><p>Welcome back to <em>Exploring FPGA Graphics</em>. In the previous part, we updated our <a href=/posts/display-signals/>display signals</a> and learnt about colour palettes. This part shows you how to create fast, colourful graphics with minimal logic. Hardware sprites maintain much of the simplicity of our <a href=/posts/fpga-pong/>Pong</a> design while offering greater creative freedom.</p><p>In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series? Start with <a href=/posts/fpga-graphics/>Beginning FPGA Graphics</a>.</p><p><img src=/img/posts/hardware-sprites/banner.png alt title></p><h3 id=series-outline>Series Outline</h3><ul><li><a href=/posts/fpga-graphics/>Beginning FPGA Graphics</a> - video signals and basic graphics</li><li><a href=/posts/racing-the-beam/>Racing the Beam</a> - simple demo effects with minimal logic</li><li><a href=/posts/fpga-pong/>FPGA Pong</a> - recreate the classic arcade on an FPGA</li><li><a href=/posts/display-signals/>Display Signals</a> - revisit display signals and meet colour palettes</li><li>Hardware Sprites (this post) - fast, colourful graphics for games</li><li><a href=/posts/framebuffers/>Framebuffers</a> - bitmap graphics featuring Michelangelo&rsquo;s David</li><li><a href=/posts/lines-and-triangles/>Lines and Triangles</a> - drawing lines and triangles</li><li><a href=/posts/fpga-shapes/>2D Shapes</a> - filled shapes and simple pictures</li><li><a href=/posts/animated-shapes/>Animated Shapes</a> - animation and double-buffering</li></ul><h3 id=requirements>Requirements</h3><p>You should be to run these designs on any recent FPGA board. I include everything you need for the <a href=https://docs.icebreaker-fpga.org/hardware/icebreaker/>iCEBreaker</a> with <a href=https://docs.icebreaker-fpga.org/hardware/pmod/dvi/>12-Bit DVI Pmod</a>, <a href=https://digilent.com/reference/programmable-logic/arty-a7/reference-manual>Digilent Arty A7-35T</a> with <a href=https://digilent.com/reference/pmod/pmodvga/reference-manual>Pmod VGA</a>, and <a href=/posts/verilog-sim-verilator-sdl/>Verilator Simulation with SDL</a>. See <a href=/posts/fpga-graphics/#requirements>requirements</a> from <em>Beginning FPGA Graphics</em> for more details.</p><h2 id=what-is-a-sprite>What is a Sprite?</h2><p>A sprite is a graphics object that can be moved and animated independently of the background and other sprites. Hardware sprites use dedicated logic for drawing. Until the mid-90s, they were an essential part of computer graphics.</p><p>Hardware sprites are a good fit for an FPGA as they&rsquo;re easy to control, and we can scale them to fit a game design: whether we want hundreds of tiny sprites or a few huge ones. Hardware sprites are also valuable for cursors or pointers in professional applications, providing a responsive UI without complex screen redrawing.</p><p><img src=/img/posts/hardware-sprites/amiga-pointer.png alt="Amiga Pointer" title="The future was here.">
<em>Workbench 2 Mouse Pointer (Commodore Amiga)</em></p><p><img src=/img/posts/hardware-sprites/sonic-megadrive.png alt=Sonic title="Don't you wag your finger at me!">
<em>Sonic the Hedgehog (Sega Megadrive)</em></p><h2 id=a-simple-sprite>A Simple Sprite</h2><p>We&rsquo;re going to start with a tiny 8x8 pixel sprite using just two colours. Our first sprite is the letter &lsquo;F&rsquo; with a full stop (period). It&rsquo;s a simple, asymmetric design, making it easier to spot bugs (such as incorrect orientation or pixels being missed off):</p><p><img src=/img/posts/hardware-sprites/letter-f.png alt=F. title="F for Project F"></p><p>We can represent this sprite as a two-dimensional array, like we did in the earlier <a href=/posts/racing-the-beam#hello>Hello</a> demo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>initial</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>0</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1111</span>_1100;
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>1</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>2</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>3</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1111</span>_1000;
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>4</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>5</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>6</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0011;
</span></span><span style=display:flex><span>    bmap[<span style=color:#ae81ff>7</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b0000</span>_0011;
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h3 id=simple-sprite-drawing>Simple Sprite Drawing</h3><p>Before we start writing Verilog, we should outline the steps required to draw the sprite. You could take many approaches, but I&rsquo;ve opted for a simple line-based algorithm.</p><p>On every screen line:</p><ol><li>Register sprite position (save sprite coordinates)</li><li>Idle unless sprite is active on this line</li><li>Wait for the horizontal sprite position</li><li>Draw a line of sprite pixels</li><li>Idle</li></ol><p>This process is well represented by our old friend, the finite state machine (FSM). In fact, our first sprite design is little more than a simple finite state machine with a small array for the graphic <strong>[<a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sprite_inline.sv>sprite_inline.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> sprite_inline #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>,   <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> H_RES<span style=color:#f92672>=</span><span style=color:#ae81ff>640</span>,  <span style=color:#75715e>// horizontal screen resolution (pixels)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SX_OFFS<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>   <span style=color:#75715e>// horizontal screen offset (pixels)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk,                            <span style=color:#75715e>// clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst,                            <span style=color:#75715e>// reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> line,                           <span style=color:#75715e>// start of active screen line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy,      <span style=color:#75715e>// screen position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx, spry,  <span style=color:#75715e>// sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> pix,                            <span style=color:#75715e>// pixel colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> drawing                         <span style=color:#75715e>// drawing at position (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite bitmap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> SPR_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>SPR_WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] bmap [SPR_HEIGHT];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>initial</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// MSB first, so we can write initial block left to right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        bmap[<span style=color:#ae81ff>0</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1111</span>_1100;
</span></span><span style=display:flex><span>        bmap[<span style=color:#ae81ff>1</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>        bmap[<span style=color:#ae81ff>2</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>        bmap[<span style=color:#ae81ff>3</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1111</span>_1000;
</span></span><span style=display:flex><span>        bmap[<span style=color:#ae81ff>4</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>        bmap[<span style=color:#ae81ff>5</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0000;
</span></span><span style=display:flex><span>        bmap[<span style=color:#ae81ff>6</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b1100</span>_0011;
</span></span><span style=display:flex><span>        bmap[<span style=color:#ae81ff>7</span>]  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span><span style=color:#ae81ff>&#39;b0000</span>_0011;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// coordinates within sprite bitmap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(SPR_WIDTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>]  bmap_x;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(SPR_HEIGHT)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] bmap_y;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// for registering sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx_r, spry_r;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// status flags: used to change state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_active;  <span style=color:#75715e>// sprite active on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_begin;   <span style=color:#75715e>// begin sprite drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_end;     <span style=color:#75715e>// end of sprite on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> line_end;    <span style=color:#75715e>// end of screen line, corrected for sx offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        spr_active <span style=color:#f92672>=</span> (sy <span style=color:#f92672>-</span> spry_r <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>-</span> spry_r <span style=color:#f92672>&lt;</span> SPR_HEIGHT);
</span></span><span style=display:flex><span>        spr_begin  <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> sprx_r <span style=color:#f92672>-</span> SX_OFFS);
</span></span><span style=display:flex><span>        spr_end    <span style=color:#f92672>=</span> (bmap_x <span style=color:#f92672>==</span> SPR_WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        line_end   <span style=color:#f92672>=</span> (sx <span style=color:#f92672>==</span> H_RES <span style=color:#f92672>-</span> SX_OFFS);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite state machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>enum</span> {
</span></span><span style=display:flex><span>        IDLE,      <span style=color:#75715e>// awaiting line signal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        REG_POS,   <span style=color:#75715e>// register sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ACTIVE,    <span style=color:#75715e>// check if sprite is active on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WAIT_POS,  <span style=color:#75715e>// wait for horizontal sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SPR_LINE,  <span style=color:#75715e>// iterate over sprite pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WAIT_DATA  <span style=color:#75715e>// account for data latency
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } state;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// prepare for new line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            state <span style=color:#f92672>&lt;=</span> REG_POS;
</span></span><span style=display:flex><span>            pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>                REG_POS: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>&lt;=</span> ACTIVE;
</span></span><span style=display:flex><span>                    sprx_r <span style=color:#f92672>&lt;=</span> sprx;
</span></span><span style=display:flex><span>                    spry_r <span style=color:#f92672>&lt;=</span> spry;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                ACTIVE: state <span style=color:#f92672>&lt;=</span> spr_active <span style=color:#f92672>?</span> WAIT_POS <span style=color:#f92672>:</span> IDLE;
</span></span><span style=display:flex><span>                WAIT_POS: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (spr_begin) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                        state <span style=color:#f92672>&lt;=</span> SPR_LINE;
</span></span><span style=display:flex><span>                        bmap_x <span style=color:#f92672>&lt;=</span> sx <span style=color:#f92672>-</span> sprx_r <span style=color:#f92672>+</span> SX_OFFS;  <span style=color:#75715e>// account for start offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        bmap_y <span style=color:#f92672>&lt;=</span> sy <span style=color:#f92672>-</span> spry_r;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                SPR_LINE: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (spr_end <span style=color:#f92672>||</span> line_end) state <span style=color:#f92672>&lt;=</span> WAIT_DATA;
</span></span><span style=display:flex><span>                    bmap_x <span style=color:#f92672>&lt;=</span> bmap_x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    pix <span style=color:#f92672>&lt;=</span> bmap[bmap_y][bmap_x];
</span></span><span style=display:flex><span>                    drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                WAIT_DATA: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>&lt;=</span> IDLE;  <span style=color:#75715e>// 1 cycle between address set and data receipt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// default colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            bmap_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            bmap_y <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>State changes are driven by the four status flags.</p><p>At the start of each screen line, we use <code>spr_active</code> to check whether the sprite appears on this line. If it does, we wait for the horizontal position with <code>spr_begin</code>, compensating for data latency. Next, we select the pixels to draw from the graphic, stopping when we get a <code>spr_end</code> or <code>line_end</code> flag. We then wait out the data latency before idling. If we didn&rsquo;t account for the data latency, we&rsquo;d chop off the right-hand side of our sprite.</p><p>Our new display signals module uses <strong>signed</strong> coordinates, so both our screen <code>(sx, sy)</code> and sprite <code>(spx,spy)</code> coordinates are declared signed.</p><blockquote><p><strong>SX_OFFS</strong><br>You might be wondering why I&rsquo;ve set <code>SX_OFFS</code> to 2. Doesn&rsquo;t an asynchronous ROM provide data immediately?
It does, but one cycle is switching state from waiting to drawing, and one cycle is registering the memory address.</p></blockquote><h3 id=sprite-on-screen>Sprite on Screen</h3><p>With our new display module in hand, it&rsquo;s time to see our static sprite on screen:</p><ul><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_inline.sv>xc7/top_tinyf_inline.sv</a></strong></li><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_inline.sv>ice40/top_tinyf_inline.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_inline.sv>sim/top_tinyf_inline.sv</a></strong></li></ul><p>iCEBreaker version shown below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_tinyf_inline (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_12m,      <span style=color:#75715e>// 12 MHz clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_rst,      <span style=color:#75715e>// reset button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> dvi_clk,      <span style=color:#75715e>// DVI pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> dvi_hsync,    <span style=color:#75715e>// DVI horizontal sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> dvi_vsync,    <span style=color:#75715e>// DVI vertical sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> dvi_de,       <span style=color:#75715e>// DVI data enable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] dvi_r,  <span style=color:#75715e>// 4-bit DVI red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] dvi_g,  <span style=color:#75715e>// 4-bit DVI green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] dvi_b   <span style=color:#75715e>// 4-bit DVI blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// generate pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> clk_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> clk_pix_locked;
</span></span><span style=display:flex><span>    clock_480p clock_pix_inst (
</span></span><span style=display:flex><span>       .clk_12m,
</span></span><span style=display:flex><span>       .rst(btn_rst),
</span></span><span style=display:flex><span>       .clk_pix,
</span></span><span style=display:flex><span>       .clk_pix_locked
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// reset in pixel clock domain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> rst_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> rst_pix <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>clk_pix_locked;  <span style=color:#75715e>// wait for clock lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CORDW <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;  <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> hsync, vsync;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de, line;
</span></span><span style=display:flex><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync,
</span></span><span style=display:flex><span>        .vsync,
</span></span><span style=display:flex><span>        .de,
</span></span><span style=display:flex><span>        .frame(),
</span></span><span style=display:flex><span>        .line
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// screen dimensions (must match display_inst)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> H_RES <span style=color:#f92672>=</span> <span style=color:#ae81ff>640</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPRX <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;  <span style=color:#75715e>// horizontal position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPRY <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;  <span style=color:#75715e>// vertical position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> pix, drawing;
</span></span><span style=display:flex><span>    sprite_inline #(
</span></span><span style=display:flex><span>        .CORDW(CORDW),
</span></span><span style=display:flex><span>        .H_RES(H_RES)
</span></span><span style=display:flex><span>        ) sprite_f (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .line,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .sprx(SPRX),
</span></span><span style=display:flex><span>        .spry(SPRY),
</span></span><span style=display:flex><span>        .pix,
</span></span><span style=display:flex><span>        .drawing
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// paint colour: yellow sprite, blue background
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] paint_r, paint_g, paint_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        paint_r <span style=color:#f92672>=</span> (drawing <span style=color:#f92672>&amp;&amp;</span> pix) <span style=color:#f92672>?</span> <span style=color:#ae81ff>4&#39;hF</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h1</span>;
</span></span><span style=display:flex><span>        paint_g <span style=color:#f92672>=</span> (drawing <span style=color:#f92672>&amp;&amp;</span> pix) <span style=color:#f92672>?</span> <span style=color:#ae81ff>4&#39;hC</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h3</span>;
</span></span><span style=display:flex><span>        paint_b <span style=color:#f92672>=</span> (drawing <span style=color:#f92672>&amp;&amp;</span> pix) <span style=color:#f92672>?</span> <span style=color:#ae81ff>4&#39;h0</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h7</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display colour: paint colour but black in blanking interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] display_r, display_g, display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        display_r <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_r <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_g <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_g <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_b <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_b <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// DVI Pmod output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SB_IO #(
</span></span><span style=display:flex><span>        .PIN_TYPE(<span style=color:#ae81ff>6</span><span style=color:#ae81ff>&#39;b010100</span>)  <span style=color:#75715e>// PIN_OUTPUT_REGISTERED
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) dvi_signal_io [<span style=color:#ae81ff>14</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] (
</span></span><span style=display:flex><span>        .PACKAGE_PIN({dvi_hsync, dvi_vsync, dvi_de, dvi_r, dvi_g, dvi_b}),
</span></span><span style=display:flex><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style=display:flex><span>        .D_OUT_0({hsync, vsync, de, display_r, display_g, display_b}),
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* verilator lint_off PINCONNECTEMPTY */</span>
</span></span><span style=display:flex><span>        .D_OUT_1()
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* verilator lint_on PINCONNECTEMPTY */</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// DVI Pmod clock output: 180° out of phase with other DVI signals
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SB_IO #(
</span></span><span style=display:flex><span>        .PIN_TYPE(<span style=color:#ae81ff>6</span><span style=color:#ae81ff>&#39;b010000</span>)  <span style=color:#75715e>// PIN_OUTPUT_DDR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) dvi_clk_io (
</span></span><span style=display:flex><span>        .PACKAGE_PIN(dvi_clk),
</span></span><span style=display:flex><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style=display:flex><span>        .D_OUT_0(<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b0</span>),
</span></span><span style=display:flex><span>        .D_OUT_1(<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b1</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>This top module is straightforward: we generate display signals and feed them to the sprite module. We use the output of the sprite module to choose the colour to paint: yellow or blue in this example.</p><p>You may have spotted a new signal called <code>rst_pix</code>. This is a reset in the pixel clock domain. We standardise this name for clarity and so that all boards can use the same design. Later designs will introduce a system clock domain with its own reset named <code>rst_sys</code>.</p><blockquote><p><strong>Building the Designs</strong><br>In the <a href=https://github.com/projf/projf-explore/tree/main/graphics/hardware-sprites>Hardware Sprites</a> section of the git repo, you&rsquo;ll find the design files, a makefile for iCEBreaker and Verilator, and a Vivado project for Arty. There are also build instructions for boards and simulations.</p></blockquote><p>Build and run your design. You should see a small golden letter &lsquo;F&rsquo; and a dot towards the top left of the screen. From these tiny beginnings, mighty sprites will grow.</p><p>Try changing the sprite position using <code>SPRX</code> and <code>SPRY</code>. You can change the sprite and background colours using <code>paint_r</code>, <code>paint_g</code>, and <code>paint_b</code>.</p><h2 id=external-rom>External ROM</h2><p>Storing the sprite within the Verilog module is simple but inflexible. If we want to change the graphic, we must update the Verilog. A cleaner approach is to use a ROM module and then load a bitmap from an external file.</p><p>We&rsquo;re going to use an asynchronous (no clock) ROM module <strong>[<a href=https://github.com/projf/projf-explore/blob/main/lib/memory/rom_async.sv>rom_async.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> rom_async #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> WIDTH<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> DEPTH<span style=color:#f92672>=</span><span style=color:#ae81ff>256</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> INIT_F<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> ADDRW<span style=color:#f92672>=</span>$clog2(DEPTH)
</span></span><span style=display:flex><span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span> <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> [ADDRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] addr,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>output</span>     <span style=color:#66d9ef>logic</span> [WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] data
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] memory [DEPTH];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>initial</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (INIT_F <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            $display(<span style=color:#e6db74>&#34;Creating rom_async from init file &#39;%s&#39;.&#34;</span>, INIT_F);
</span></span><span style=display:flex><span>            $readmemh(INIT_F, memory);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> data <span style=color:#f92672>=</span> memory[addr];
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>And the memory initialization file looks like this <strong>[<a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/res/sprites/letter_f.mem>letter_f.mem</a>]</strong>:</p><pre tabindex=0><code>1 1 1 1 1 1 0 0
1 1 0 0 0 0 0 0
1 1 0 0 0 0 0 0
1 1 1 1 1 0 0 0
1 1 0 0 0 0 0 0
1 1 0 0 0 0 0 0
1 1 0 0 0 0 1 1
0 0 0 0 0 0 1 1
</code></pre><p>The sprite module pulls in our new ROM design <strong>[<a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sprite_rom.sv>sprite_rom.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> sprite_rom #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>,      <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> H_RES<span style=color:#f92672>=</span><span style=color:#ae81ff>640</span>,     <span style=color:#75715e>// horizontal screen resolution (pixels)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SX_OFFS<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>,     <span style=color:#75715e>// horizontal screen offset (pixels)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,   <span style=color:#75715e>// sprite bitmap file ($readmemh format)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_WIDTH<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,   <span style=color:#75715e>// sprite bitmap width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_HEIGHT<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,  <span style=color:#75715e>// sprite bitmap height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_DATAW<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    <span style=color:#75715e>// data width: bits per pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk,                            <span style=color:#75715e>// clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst,                            <span style=color:#75715e>// reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> line,                           <span style=color:#75715e>// start of active screen line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy,      <span style=color:#75715e>// screen position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx, spry,  <span style=color:#75715e>// sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [SPR_DATAW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] pix,            <span style=color:#75715e>// pixel colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> drawing                         <span style=color:#75715e>// drawing at position (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite bitmap ROM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_ROM_DEPTH <span style=color:#f92672>=</span> SPR_WIDTH <span style=color:#f92672>*</span> SPR_HEIGHT;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(SPR_ROM_DEPTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_rom_addr;  <span style=color:#75715e>// pixel position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_rom_data;  <span style=color:#75715e>// pixel colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rom_async #(
</span></span><span style=display:flex><span>        .WIDTH(SPR_DATAW),
</span></span><span style=display:flex><span>        .DEPTH(SPR_ROM_DEPTH),
</span></span><span style=display:flex><span>        .INIT_F(SPR_FILE)
</span></span><span style=display:flex><span>    ) spr_rom (
</span></span><span style=display:flex><span>        .addr(spr_rom_addr),
</span></span><span style=display:flex><span>        .data(spr_rom_data)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// horizontal coordinate within sprite bitmap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(SPR_WIDTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] bmap_x;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// for registering sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx_r, spry_r;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// status flags: used to change state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_active;  <span style=color:#75715e>// sprite active on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_begin;   <span style=color:#75715e>// begin sprite drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_end;     <span style=color:#75715e>// end of sprite on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> line_end;    <span style=color:#75715e>// end of screen line, corrected for sx offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        spr_active <span style=color:#f92672>=</span> (sy <span style=color:#f92672>-</span> spry_r <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;&amp;</span> (sy <span style=color:#f92672>-</span> spry_r <span style=color:#f92672>&lt;</span> SPR_HEIGHT);
</span></span><span style=display:flex><span>        spr_begin  <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> sprx_r <span style=color:#f92672>-</span> SX_OFFS);
</span></span><span style=display:flex><span>        spr_end    <span style=color:#f92672>=</span> (bmap_x <span style=color:#f92672>==</span> SPR_WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        line_end   <span style=color:#f92672>=</span> (sx <span style=color:#f92672>==</span> H_RES <span style=color:#f92672>-</span> SX_OFFS);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite state machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>enum</span> {
</span></span><span style=display:flex><span>        IDLE,      <span style=color:#75715e>// awaiting line signal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        REG_POS,   <span style=color:#75715e>// register sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ACTIVE,    <span style=color:#75715e>// check if sprite is active on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WAIT_POS,  <span style=color:#75715e>// wait for horizontal sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SPR_LINE,  <span style=color:#75715e>// iterate over sprite pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WAIT_DATA  <span style=color:#75715e>// account for data latency
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } state;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// prepare for new line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            state <span style=color:#f92672>&lt;=</span> REG_POS;
</span></span><span style=display:flex><span>            pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>                REG_POS: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>&lt;=</span> ACTIVE;
</span></span><span style=display:flex><span>                    sprx_r <span style=color:#f92672>&lt;=</span> sprx;
</span></span><span style=display:flex><span>                    spry_r <span style=color:#f92672>&lt;=</span> spry;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                ACTIVE: state <span style=color:#f92672>&lt;=</span> spr_active <span style=color:#f92672>?</span> WAIT_POS <span style=color:#f92672>:</span> IDLE;
</span></span><span style=display:flex><span>                WAIT_POS: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (spr_begin) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                        state <span style=color:#f92672>&lt;=</span> SPR_LINE;
</span></span><span style=display:flex><span>                        spr_rom_addr <span style=color:#f92672>&lt;=</span> (sy <span style=color:#f92672>-</span> spry_r) <span style=color:#f92672>*</span> SPR_WIDTH <span style=color:#f92672>+</span> (sx <span style=color:#f92672>-</span> sprx_r) <span style=color:#f92672>+</span> SX_OFFS;
</span></span><span style=display:flex><span>                        bmap_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                SPR_LINE: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (spr_end <span style=color:#f92672>||</span> line_end) state <span style=color:#f92672>&lt;=</span> WAIT_DATA;
</span></span><span style=display:flex><span>                    spr_rom_addr <span style=color:#f92672>&lt;=</span> spr_rom_addr <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    bmap_x <span style=color:#f92672>&lt;=</span> bmap_x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    pix <span style=color:#f92672>&lt;=</span> spr_rom_data;
</span></span><span style=display:flex><span>                    drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                WAIT_DATA: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>&lt;=</span> IDLE;  <span style=color:#75715e>// 1 cycle between address set and data receipt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// default colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            spr_rom_addr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            bmap_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>A quick tweak to our top module and we&rsquo;re ready to build the new version:</p><ul><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_rom.sv>xc7/top_tinyf_rom.sv</a></strong></li><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_rom.sv>ice40/top_tinyf_rom.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_rom.sv>sim/top_tinyf_rom.sv</a></strong></li></ul><h2 id=scaling-up>Scaling Up</h2><p>Next, let&rsquo;s scale our sprite up. We make larger sprites by increasing the size of the bitmap. However, it&rsquo;s also useful to be able to scale our sprites up when drawing them. A scaled-up sprite will be blocky but will use few resources and allows a design to work at different screen resolutions.</p><p>The new module is <strong>[<a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sprite.sv>sprite.sv</a>]</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> sprite #(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>,      <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> H_RES<span style=color:#f92672>=</span><span style=color:#ae81ff>640</span>,     <span style=color:#75715e>// horizontal screen resolution (pixels)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SX_OFFS<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>,     <span style=color:#75715e>// horizontal screen offset (pixels)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,   <span style=color:#75715e>// sprite bitmap file ($readmemh format)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_WIDTH<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,   <span style=color:#75715e>// sprite bitmap width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_HEIGHT<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,  <span style=color:#75715e>// sprite bitmap height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_SCALE<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,   <span style=color:#75715e>// scale factor: 0=1x, 1=2x, 2=4x, 3=8x etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> SPR_DATAW<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    <span style=color:#75715e>// data width: bits per pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ) (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk,                            <span style=color:#75715e>// clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst,                            <span style=color:#75715e>// reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> line,                           <span style=color:#75715e>// start of active screen line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy,      <span style=color:#75715e>// screen position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx, spry,  <span style=color:#75715e>// sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [SPR_DATAW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] pix,            <span style=color:#75715e>// pixel colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> drawing                         <span style=color:#75715e>// drawing at position (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite bitmap ROM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_ROM_DEPTH <span style=color:#f92672>=</span> SPR_WIDTH <span style=color:#f92672>*</span> SPR_HEIGHT;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(SPR_ROM_DEPTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_rom_addr;  <span style=color:#75715e>// pixel position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [SPR_DATAW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_rom_data;  <span style=color:#75715e>// pixel colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rom_async #(
</span></span><span style=display:flex><span>        .WIDTH(SPR_DATAW),
</span></span><span style=display:flex><span>        .DEPTH(SPR_ROM_DEPTH),
</span></span><span style=display:flex><span>        .INIT_F(SPR_FILE)
</span></span><span style=display:flex><span>    ) spr_rom (
</span></span><span style=display:flex><span>        .addr(spr_rom_addr),
</span></span><span style=display:flex><span>        .data(spr_rom_data)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// horizontal coordinate within sprite bitmap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(SPR_WIDTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] bmap_x;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// horizontal scale counter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [SPR_SCALE:<span style=color:#ae81ff>0</span>] cnt_x;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// for registering sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx_r, spry_r;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// status flags: used to change state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>]  spr_diff;  <span style=color:#75715e>// diff vertical screen and sprite positions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_active;  <span style=color:#75715e>// sprite active on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_begin;   <span style=color:#75715e>// begin sprite drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> spr_end;     <span style=color:#75715e>// end of sprite on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> line_end;    <span style=color:#75715e>// end of screen line, corrected for sx offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        spr_diff <span style=color:#f92672>=</span> (sy <span style=color:#f92672>-</span> spry_r) <span style=color:#f92672>&gt;&gt;&gt;</span> SPR_SCALE;  <span style=color:#75715e>// arithmetic right-shift
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        spr_active <span style=color:#f92672>=</span> (spr_diff <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;&amp;</span> (spr_diff <span style=color:#f92672>&lt;</span> SPR_HEIGHT);
</span></span><span style=display:flex><span>        spr_begin <span style=color:#f92672>=</span> (sx <span style=color:#f92672>&gt;=</span> sprx_r <span style=color:#f92672>-</span> SX_OFFS);
</span></span><span style=display:flex><span>        spr_end <span style=color:#f92672>=</span> (bmap_x <span style=color:#f92672>==</span> SPR_WIDTH<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        line_end <span style=color:#f92672>=</span> (sx <span style=color:#f92672>==</span> H_RES <span style=color:#f92672>-</span> SX_OFFS);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite state machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>enum</span> {
</span></span><span style=display:flex><span>        IDLE,      <span style=color:#75715e>// awaiting line signal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        REG_POS,   <span style=color:#75715e>// register sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ACTIVE,    <span style=color:#75715e>// check if sprite is active on this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WAIT_POS,  <span style=color:#75715e>// wait for horizontal sprite position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SPR_LINE,  <span style=color:#75715e>// iterate over sprite pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WAIT_DATA  <span style=color:#75715e>// account for data latency
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } state;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// prepare for new line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            state <span style=color:#f92672>&lt;=</span> REG_POS;
</span></span><span style=display:flex><span>            pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>                REG_POS: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>&lt;=</span> ACTIVE;
</span></span><span style=display:flex><span>                    sprx_r <span style=color:#f92672>&lt;=</span> sprx;
</span></span><span style=display:flex><span>                    spry_r <span style=color:#f92672>&lt;=</span> spry;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                ACTIVE: state <span style=color:#f92672>&lt;=</span> spr_active <span style=color:#f92672>?</span> WAIT_POS <span style=color:#f92672>:</span> IDLE;
</span></span><span style=display:flex><span>                WAIT_POS: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (spr_begin) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                        state <span style=color:#f92672>&lt;=</span> SPR_LINE;
</span></span><span style=display:flex><span>                        spr_rom_addr <span style=color:#f92672>&lt;=</span> spr_diff <span style=color:#f92672>*</span> SPR_WIDTH <span style=color:#f92672>+</span> (sx <span style=color:#f92672>-</span> sprx_r) <span style=color:#f92672>+</span> SX_OFFS;
</span></span><span style=display:flex><span>                        bmap_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                        cnt_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                SPR_LINE: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (line_end) state <span style=color:#f92672>&lt;=</span> WAIT_DATA;
</span></span><span style=display:flex><span>                    pix <span style=color:#f92672>&lt;=</span> spr_rom_data;
</span></span><span style=display:flex><span>                    drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (SPR_SCALE <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> cnt_x <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>SPR_SCALE<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (spr_end) state <span style=color:#f92672>&lt;=</span> WAIT_DATA;
</span></span><span style=display:flex><span>                        spr_rom_addr <span style=color:#f92672>&lt;=</span> spr_rom_addr <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                        bmap_x <span style=color:#f92672>&lt;=</span> bmap_x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                        cnt_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> cnt_x <span style=color:#f92672>&lt;=</span> cnt_x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                WAIT_DATA: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>&lt;=</span> IDLE;  <span style=color:#75715e>// 1 cycle between address set and data receipt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// default colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            spr_rom_addr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            bmap_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            cnt_x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            pix <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            drawing <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>We can then drive this with a small change to our top module.</p><ul><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_scale.sv>xc7/top_tinyf_scale.sv</a></strong></li><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_scale.sv>ice40/top_tinyf_scale.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_scale.sv>sim/top_tinyf_scale.sv</a></strong></li></ul><p>Build the design with scaling, and you should see a larger F:</p><p><img src=/img/posts/hardware-sprites/letter-f-720p.png alt="Letter F" title="Letter F: FPGA Capture"></p><h2 id=moving-around>Moving Around</h2><p>We can move our sprite around the screen by replacing the fixed position parameters with variables. I&rsquo;ve created a simple example that moves the scaled-up &lsquo;F&rsquo; back and forth across the screen.</p><ul><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_scale.sv>xc7/top_tinyf_move.sv</a></strong></li><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_scale.sv>ice40/top_tinyf_move.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_scale.sv>sim/top_tinyf_move.sv</a></strong></li></ul><p>Note how the sprite draws correctly as it moves off the left and right sides of the screen using signed coordinates.</p><p>The Arty version looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_tinyf_move (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_100m,     <span style=color:#75715e>// 100 MHz clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_rst_n,    <span style=color:#75715e>// reset button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_hsync,    <span style=color:#75715e>// horizontal sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_vsync,    <span style=color:#75715e>// vertical sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_r,  <span style=color:#75715e>// 4-bit VGA red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_g,  <span style=color:#75715e>// 4-bit VGA green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_b   <span style=color:#75715e>// 4-bit VGA blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// generate pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> clk_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> clk_pix_locked;
</span></span><span style=display:flex><span>    clock_480p clock_pix_inst (
</span></span><span style=display:flex><span>       .clk_100m,
</span></span><span style=display:flex><span>       .rst(<span style=color:#f92672>!</span>btn_rst_n),  <span style=color:#75715e>// reset button is active low
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix,
</span></span><span style=display:flex><span>       .clk_pix_5x(),  <span style=color:#75715e>// not used for VGA output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix_locked
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// reset in pixel clock domain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> rst_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> rst_pix <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>clk_pix_locked;  <span style=color:#75715e>// wait for clock lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CORDW <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;  <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> hsync, vsync;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de, frame, line;
</span></span><span style=display:flex><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync,
</span></span><span style=display:flex><span>        .vsync,
</span></span><span style=display:flex><span>        .de,
</span></span><span style=display:flex><span>        .frame,
</span></span><span style=display:flex><span>        .line
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// screen dimensions (must match display_inst)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> H_RES <span style=color:#f92672>=</span> <span style=color:#ae81ff>640</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> V_RES <span style=color:#f92672>=</span> <span style=color:#ae81ff>480</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;  <span style=color:#75715e>// bitmap width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;  <span style=color:#75715e>// bitmap height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_SCALE  <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// 2^3 = 8x scale
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_DATAW  <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// bits per pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_DRAWW  <span style=color:#f92672>=</span> SPR_WIDTH  <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>SPR_SCALE;  <span style=color:#75715e>// draw width
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_DRAWH  <span style=color:#f92672>=</span> SPR_HEIGHT <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>SPR_SCALE;  <span style=color:#75715e>// draw height
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_SPX    <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;  <span style=color:#75715e>// horizontal speed (pixels/frame)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_FILE   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letter_f.mem&#34;</span>;  <span style=color:#75715e>// bitmap file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// draw sprite at position (sprx,spry)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx, spry;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> dx;  <span style=color:#75715e>// direction: 0 is right/down
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// update sprite position once per frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (frame) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (dx <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (sprx <span style=color:#f92672>+</span> SPR_DRAWW <span style=color:#f92672>&gt;=</span> H_RES <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>SPR_DRAWW) dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// move left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>else</span> sprx <span style=color:#f92672>&lt;=</span> sprx <span style=color:#f92672>+</span> SPR_SPX;  <span style=color:#75715e>// continue right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// moving left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (sprx <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>SPR_DRAWW) dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// move right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>else</span> sprx <span style=color:#f92672>&lt;=</span> sprx <span style=color:#f92672>-</span> SPR_SPX;  <span style=color:#75715e>// continue left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst_pix) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// centre sprite and set direction right
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            sprx <span style=color:#f92672>&lt;=</span> H_RES<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>-</span> SPR_DRAWW<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>            spry <span style=color:#f92672>&lt;=</span> V_RES<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>-</span> SPR_DRAWH<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>            dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> drawing;  <span style=color:#75715e>// drawing at (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [SPR_DATAW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] pix;  <span style=color:#75715e>// pixel colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    sprite #(
</span></span><span style=display:flex><span>        .CORDW(CORDW),
</span></span><span style=display:flex><span>        .H_RES(H_RES),
</span></span><span style=display:flex><span>        .SPR_FILE(SPR_FILE),
</span></span><span style=display:flex><span>        .SPR_WIDTH(SPR_WIDTH),
</span></span><span style=display:flex><span>        .SPR_HEIGHT(SPR_HEIGHT),
</span></span><span style=display:flex><span>        .SPR_SCALE(SPR_SCALE),
</span></span><span style=display:flex><span>        .SPR_DATAW(SPR_DATAW)
</span></span><span style=display:flex><span>        ) sprite_f (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .line,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .sprx,
</span></span><span style=display:flex><span>        .spry,
</span></span><span style=display:flex><span>        .pix,
</span></span><span style=display:flex><span>        .drawing
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// paint colour: yellow sprite, blue background
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] paint_r, paint_g, paint_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        paint_r <span style=color:#f92672>=</span> (drawing <span style=color:#f92672>&amp;&amp;</span> pix) <span style=color:#f92672>?</span> <span style=color:#ae81ff>4&#39;hF</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h1</span>;
</span></span><span style=display:flex><span>        paint_g <span style=color:#f92672>=</span> (drawing <span style=color:#f92672>&amp;&amp;</span> pix) <span style=color:#f92672>?</span> <span style=color:#ae81ff>4&#39;hC</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h3</span>;
</span></span><span style=display:flex><span>        paint_b <span style=color:#f92672>=</span> (drawing <span style=color:#f92672>&amp;&amp;</span> pix) <span style=color:#f92672>?</span> <span style=color:#ae81ff>4&#39;h0</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h7</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display colour: paint colour but black in blanking interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] display_r, display_g, display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        display_r <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_r <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_g <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_g <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_b <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_b <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VGA Pmod output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        vga_hsync <span style=color:#f92672>&lt;=</span> hsync;
</span></span><span style=display:flex><span>        vga_vsync <span style=color:#f92672>&lt;=</span> vsync;
</span></span><span style=display:flex><span>        vga_r <span style=color:#f92672>&lt;=</span> display_r;
</span></span><span style=display:flex><span>        vga_g <span style=color:#f92672>&lt;=</span> display_g;
</span></span><span style=display:flex><span>        vga_b <span style=color:#f92672>&lt;=</span> display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><h2 id=hourglass>Hourglass</h2><p>The introduction promised &ldquo;colourful&rdquo; graphics: it&rsquo;s time to make good on this by introducing a colour lookup table (CLUT). As discussed in <a href=/posts/display-signals/>Display Signals</a>, we load a palette into a CLUT and then lookup colours before displaying them.</p><p>I&rsquo;ve created a simple hourglass sprite bitmap using 4-bit colour indexes. Each pixel is represented by a hexadecimal digit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>0 0 0 0 0 0 0 0
</span></span><span style=display:flex><span>F 1 1 1 1 1 1 F
</span></span><span style=display:flex><span>F F 2 2 2 2 F F
</span></span><span style=display:flex><span>F F F 3 3 F F F
</span></span><span style=display:flex><span>F F F 4 4 F F F
</span></span><span style=display:flex><span>F F 5 5 5 5 F F
</span></span><span style=display:flex><span>F 6 6 6 6 6 6 F
</span></span><span style=display:flex><span>7 7 7 7 7 7 7 7
</span></span></code></pre></div><p>And I&rsquo;ve chosen the teleport palette <strong>[<a href=https://github.com/projf/projf-explore/tree/main/lib/res/palettes/teleport16_4b.mem>teleport16_4b.mem</a>]</strong>.</p><p><img src=/img/posts/display-signals/teleport-palette.png alt="Teleport Palette" title></p><p>And top modules to draw the hourglass:</p><ul><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_hourglass.sv>xc7/top_hourglass.sv</a></strong></li><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_hourglass.sv>ice40/top_hourglass.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_hourglass.sv>sim/top_hourglass.sv</a></strong></li></ul><p>This is the Verilator simulation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_hourglass #(<span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>) (  <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_pix,      <span style=color:#75715e>// pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst_pix,      <span style=color:#75715e>// sim reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_sx,  <span style=color:#75715e>// horizontal SDL position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_sy,  <span style=color:#75715e>// vertical SDL position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> sdl_de,       <span style=color:#75715e>// data enable (low in blanking interval)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> sdl_frame,    <span style=color:#75715e>// high at start of frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_r,  <span style=color:#75715e>// 8-bit red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_g,  <span style=color:#75715e>// 8-bit green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_b   <span style=color:#75715e>// 8-bit blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de, frame, line;
</span></span><span style=display:flex><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync(),
</span></span><span style=display:flex><span>        .vsync(),
</span></span><span style=display:flex><span>        .de,
</span></span><span style=display:flex><span>        .frame,
</span></span><span style=display:flex><span>        .line
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// screen dimensions (must match display_inst)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> H_RES <span style=color:#f92672>=</span> <span style=color:#ae81ff>640</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// colour parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CHANW <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;         <span style=color:#75715e>// colour channel width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> COLRW <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span>CHANW;   <span style=color:#75715e>// colour width: three channels (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CIDXW <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;         <span style=color:#75715e>// colour index width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> TRANS_INDX <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;hF</span>;  <span style=color:#75715e>// transparant colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> BG_COLR <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;h137</span>;   <span style=color:#75715e>// background colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> PAL_FILE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../../../lib/res/palettes/teleport16_4b.mem&#34;</span>;  <span style=color:#75715e>// palette file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SX_OFFS    <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// horizontal screen offset (pixels): +1 for CLUT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;  <span style=color:#75715e>// bitmap width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;  <span style=color:#75715e>// bitmap height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_SCALE  <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;  <span style=color:#75715e>// 2^4 = 16x scale
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_FILE   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../res/sprites/hourglass.mem&#34;</span>;  <span style=color:#75715e>// bitmap file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> drawing;  <span style=color:#75715e>// drawing at (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CIDXW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_pix_indx;  <span style=color:#75715e>// pixel colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    sprite #(
</span></span><span style=display:flex><span>        .CORDW(CORDW),
</span></span><span style=display:flex><span>        .H_RES(H_RES),
</span></span><span style=display:flex><span>        .SX_OFFS(SX_OFFS),
</span></span><span style=display:flex><span>        .SPR_FILE(SPR_FILE),
</span></span><span style=display:flex><span>        .SPR_WIDTH(SPR_WIDTH),
</span></span><span style=display:flex><span>        .SPR_HEIGHT(SPR_HEIGHT),
</span></span><span style=display:flex><span>        .SPR_SCALE(SPR_SCALE),
</span></span><span style=display:flex><span>        .SPR_DATAW(CIDXW)
</span></span><span style=display:flex><span>        ) sprite_hourglass (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .line,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .sprx(<span style=color:#ae81ff>32</span>),
</span></span><span style=display:flex><span>        .spry(<span style=color:#ae81ff>16</span>),
</span></span><span style=display:flex><span>        .pix(spr_pix_indx),
</span></span><span style=display:flex><span>        .drawing
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// colour lookup table
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [COLRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_pix_colr;
</span></span><span style=display:flex><span>    clut_simple #(
</span></span><span style=display:flex><span>        .COLRW(COLRW),
</span></span><span style=display:flex><span>        .CIDXW(CIDXW),
</span></span><span style=display:flex><span>        .F_PAL(PAL_FILE)
</span></span><span style=display:flex><span>        ) clut_instance (
</span></span><span style=display:flex><span>        .clk_write(clk_pix),
</span></span><span style=display:flex><span>        .clk_read(clk_pix),
</span></span><span style=display:flex><span>        .we(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .cidx_write(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .cidx_read(spr_pix_indx),
</span></span><span style=display:flex><span>        .colr_in(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .colr_out(spr_pix_colr)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// account for transparency and delay drawing signal to match CLUT delay (1 cycle)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> drawing_t1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) drawing_t1 <span style=color:#f92672>&lt;=</span> drawing <span style=color:#f92672>&amp;&amp;</span> (spr_pix_indx <span style=color:#f92672>!=</span> TRANS_INDX);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// paint colour: sprite or background
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CHANW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] paint_r, paint_g, paint_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> (drawing_t1) <span style=color:#f92672>?</span> spr_pix_colr <span style=color:#f92672>:</span> BG_COLR;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display colour: paint colour but black in blanking interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CHANW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] display_r, display_g, display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        display_r <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_r <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_g <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_g <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_b <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_b <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SDL output (8 bits per colour channel)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        sdl_sx <span style=color:#f92672>&lt;=</span> sx;
</span></span><span style=display:flex><span>        sdl_sy <span style=color:#f92672>&lt;=</span> sy;
</span></span><span style=display:flex><span>        sdl_de <span style=color:#f92672>&lt;=</span> de;
</span></span><span style=display:flex><span>        sdl_frame <span style=color:#f92672>&lt;=</span> frame;
</span></span><span style=display:flex><span>        sdl_r <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_r}};
</span></span><span style=display:flex><span>        sdl_g <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_g}};
</span></span><span style=display:flex><span>        sdl_b <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_b}};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>Note how we increase <code>SX_OFFS</code> to 3 because it takes an additional cycle to lookup the pixel colour using the CLUT.</p><p>We now have two ways of changing colours: editing the pixels in the bitmap or changing the palette.</p><p>Try changing the palette to <code>sweetie16_4b.mem</code> and editing the pixels in <code>hourglass.mem</code>. The transparent colour is set by the <code>TRANS_INDX</code> parameter.</p><h2 id=hedgehog>Hedgehog</h2><p>Let&rsquo;s try something a little bit more artistic. Rather than continue to inflict my drawing skills on you, I&rsquo;m using the adorable hedgehog from the Amiga platformer, <a href="https://www.lemonamiga.com/games/details.php?id=1023">Superfrog</a>. You can download Team 17 Amiga games from <a href="http://dream17.abime.net/downloads.php?cat=1">Dream 17</a>.</p><p><img src=/img/posts/hardware-sprites/hedgehog-enlarged.png alt=Hedgehog title=Hedgehog></p><p>The hedgehog graphic is 32x20 for a total of 640 pixels. The original Amiga game uses 32 colours, of which the hedgehog uses ten, plus one transparent colour. As with the hourglass graphic, we use four bits per pixel.</p><p>The memory requirement for this sprite is: <code>32 x 20 x 4 = 2,560 or 2.5 kilobits</code>.</p><p>I use a tool called <a href=https://github.com/projf/fpgatools>img2fmem</a> to convert the sprite image to <strong>[<a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/res/sprites/hedgehog.mem>hedgehog.mem</a>]</strong>.</p><blockquote><p><strong>Sync ROM</strong><br>Using async ROM consumes logic. For larger sprites you might prefer to use a synchronous ROM (BRAM): <strong>[<a href=https://github.com/projf/projf-explore/blob/main/lib/memory/rom_sync.sv>rom_sync.sv</a>]</strong>. You will need to adjust <code>SX_OFFS</code> and the <code>WAIT_DATA</code> state to account for the increased latency.</p></blockquote><p>The hedgehog palette looks like this:</p><p><img src=/img/posts/hardware-sprites/hedgehog-palette.png alt="Hedgehog Palette" title="The colour of the hedge"></p><p>Next we make our hedgehog&rsquo;s world a little more interesting by creating a landscape. We do this by with horizontal bars of colour in the background:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    <span style=color:#75715e>// background colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [COLRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] bg_colr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>      (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)   bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h239</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>80</span>)  bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h24A</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>140</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h25B</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>190</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h26C</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>230</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h27D</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>265</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h29E</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>295</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h2BF</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>320</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h260</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>We move our hedgehog down the screen to walk on the ground:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (rst_pix) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// start off screen and level with grass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sprx <span style=color:#f92672>&lt;=</span> H_RES;
</span></span><span style=display:flex><span>        spry <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>240</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><ul><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_hedgehog.sv>xc7/top_hedgehog.sv</a></strong></li><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_hedgehog.sv>ice40/top_hedgehog.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_hedgehog.sv>sim/top_hedgehog.sv</a></strong></li></ul><p>Arty version shown below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_hedgehog (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_100m,     <span style=color:#75715e>// 100 MHz clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> btn_rst_n,    <span style=color:#75715e>// reset button
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_hsync,    <span style=color:#75715e>// horizontal sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> vga_vsync,    <span style=color:#75715e>// vertical sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_r,  <span style=color:#75715e>// 4-bit VGA red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_g,  <span style=color:#75715e>// 4-bit VGA green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] vga_b   <span style=color:#75715e>// 4-bit VGA blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// generate pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> clk_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> clk_pix_locked;
</span></span><span style=display:flex><span>    clock_480p clock_pix_inst (
</span></span><span style=display:flex><span>       .clk_100m,
</span></span><span style=display:flex><span>       .rst(<span style=color:#f92672>!</span>btn_rst_n),  <span style=color:#75715e>// reset button is active low
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix,
</span></span><span style=display:flex><span>       .clk_pix_5x(),  <span style=color:#75715e>// not used for VGA output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       .clk_pix_locked
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// reset in pixel clock domain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> rst_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> rst_pix <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>clk_pix_locked;  <span style=color:#75715e>// wait for clock lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CORDW <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;  <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> hsync, vsync;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de, frame, line;
</span></span><span style=display:flex><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync,
</span></span><span style=display:flex><span>        .vsync,
</span></span><span style=display:flex><span>        .de,
</span></span><span style=display:flex><span>        .frame,
</span></span><span style=display:flex><span>        .line
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// screen dimensions (must match display_inst)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> H_RES <span style=color:#f92672>=</span> <span style=color:#ae81ff>640</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// colour parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CHANW <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;         <span style=color:#75715e>// colour channel width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> COLRW <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span>CHANW;   <span style=color:#75715e>// colour width: three channels (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CIDXW <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;         <span style=color:#75715e>// colour index width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> TRANS_INDX <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;h9</span>;  <span style=color:#75715e>// transparant colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> PAL_FILE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hedgehog_4b.mem&#34;</span>;  <span style=color:#75715e>// palette file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// sprite parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SX_OFFS    <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// horizontal screen offset (pixels): +1 for CLUT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;  <span style=color:#75715e>// bitmap width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;  <span style=color:#75715e>// bitmap height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_SCALE  <span style=color:#f92672>=</span>  <span style=color:#ae81ff>2</span>;  <span style=color:#75715e>// 2^2 = 4x scale
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_DRAWW  <span style=color:#f92672>=</span> SPR_WIDTH <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>SPR_SCALE;  <span style=color:#75715e>// draw width
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_SPX    <span style=color:#f92672>=</span>  <span style=color:#ae81ff>2</span>;  <span style=color:#75715e>// horizontal speed (pixels/frame)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> SPR_FILE   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hedgehog.mem&#34;</span>;  <span style=color:#75715e>// bitmap file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sprx, spry;  <span style=color:#75715e>// draw sprite at position (sprx,spry)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// update sprite position once per frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (frame) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sprx <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>-</span>SPR_DRAWW) sprx <span style=color:#f92672>&lt;=</span> H_RES;  <span style=color:#75715e>// move back to right of screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> sprx <span style=color:#f92672>&lt;=</span> sprx <span style=color:#f92672>-</span> SPR_SPX;  <span style=color:#75715e>// otherwise keep moving left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst_pix) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// start off screen and level with grass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            sprx <span style=color:#f92672>&lt;=</span> H_RES;
</span></span><span style=display:flex><span>            spry <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>240</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> drawing;  <span style=color:#75715e>// drawing at (sx,sy)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CIDXW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_pix_indx;  <span style=color:#75715e>// pixel colour index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    sprite #(
</span></span><span style=display:flex><span>        .CORDW(CORDW),
</span></span><span style=display:flex><span>        .H_RES(H_RES),
</span></span><span style=display:flex><span>        .SX_OFFS(SX_OFFS),
</span></span><span style=display:flex><span>        .SPR_FILE(SPR_FILE),
</span></span><span style=display:flex><span>        .SPR_WIDTH(SPR_WIDTH),
</span></span><span style=display:flex><span>        .SPR_HEIGHT(SPR_HEIGHT),
</span></span><span style=display:flex><span>        .SPR_SCALE(SPR_SCALE),
</span></span><span style=display:flex><span>        .SPR_DATAW(CIDXW)
</span></span><span style=display:flex><span>        ) sprite_hedgehog (
</span></span><span style=display:flex><span>        .clk(clk_pix),
</span></span><span style=display:flex><span>        .rst(rst_pix),
</span></span><span style=display:flex><span>        .line,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .sprx,
</span></span><span style=display:flex><span>        .spry,
</span></span><span style=display:flex><span>        .pix(spr_pix_indx),
</span></span><span style=display:flex><span>        .drawing
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// colour lookup table
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [COLRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] spr_pix_colr;
</span></span><span style=display:flex><span>    clut_simple #(
</span></span><span style=display:flex><span>        .COLRW(COLRW),
</span></span><span style=display:flex><span>        .CIDXW(CIDXW),
</span></span><span style=display:flex><span>        .F_PAL(PAL_FILE)
</span></span><span style=display:flex><span>        ) clut_instance (
</span></span><span style=display:flex><span>        .clk_write(clk_pix),
</span></span><span style=display:flex><span>        .clk_read(clk_pix),
</span></span><span style=display:flex><span>        .we(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .cidx_write(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .cidx_read(spr_pix_indx),
</span></span><span style=display:flex><span>        .colr_in(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .colr_out(spr_pix_colr)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// account for transparency and delay drawing signal to match CLUT delay (1 cycle)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> drawing_t1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) drawing_t1 <span style=color:#f92672>&lt;=</span> drawing <span style=color:#f92672>&amp;&amp;</span> (spr_pix_indx <span style=color:#f92672>!=</span> TRANS_INDX);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// background colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [COLRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] bg_colr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>      (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)   bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h239</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>80</span>)  bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h24A</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>140</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h25B</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>190</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h26C</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>230</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h27D</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>265</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h29E</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>295</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h2BF</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sy <span style=color:#f92672>==</span> <span style=color:#ae81ff>320</span>) bg_colr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12&#39;h260</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// paint colour: sprite or background
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CHANW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] paint_r, paint_g, paint_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> (drawing_t1) <span style=color:#f92672>?</span> spr_pix_colr <span style=color:#f92672>:</span> bg_colr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display colour: paint colour but black in blanking interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CHANW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] display_r, display_g, display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        display_r <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_r <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_g <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_g <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>        display_b <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> paint_b <span style=color:#f92672>:</span> <span style=color:#ae81ff>4&#39;h0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// VGA Pmod output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        vga_hsync <span style=color:#f92672>&lt;=</span> hsync;
</span></span><span style=display:flex><span>        vga_vsync <span style=color:#f92672>&lt;=</span> vsync;
</span></span><span style=display:flex><span>        vga_r <span style=color:#f92672>&lt;=</span> display_r;
</span></span><span style=display:flex><span>        vga_g <span style=color:#f92672>&lt;=</span> display_g;
</span></span><span style=display:flex><span>        vga_b <span style=color:#f92672>&lt;=</span> display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>Here&rsquo;s our finished landscape with hedgehog:</p><p><img src=/img/posts/hardware-sprites/hedgehog-720p.png alt="Hedgehog walking under the sky" title="Hedgehog: FPGA Capture"></p><h2 id=explore>Explore</h2><p>I hope you enjoyed this instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few sprite suggestions:</p><ul><li>Design your own 8x8 spaceship sprite</li><li>Use buttons to control the position of a sprite on screen</li><li>Add additional hedgehogs sprite instances to the final design</li><li>Draw the numbers 0-9 as sprites and use them to score <a href=/posts/fpga-pong/>Pong</a></li></ul><h2 id=sprite-engine>Sprite Engine</h2><p>This sprite design works for simple cases but lacks many desirable features for games. One day I plan to write about a sprite engine, including external memory, animated graphics, rotation, and collision detection.</p><h2 id=whats-next>What&rsquo;s Next?</h2><p>In the next part, we learn about <a href=/posts/framebuffers/>framebuffers</a> and bitmap graphics. Check out <a href=/demos/>demos</a> and <a href=/tutorials/>tutorials</a> for more FPGA projects.</p><p>Have a question or suggestion? Contact <a href=https://mastodon.social/@WillFlux>@WillFlux</a> or join me on <a href=https://github.com/projf/projf-explore/discussions>Project F Discussions</a> or <a href=https://discord.gg/cf869yDbXf>1BitSquared Discord</a>. If you like what I do, consider <a href=https://github.com/sponsors/WillGreen>sponsoring me</a> on GitHub. Thank you.</p></section><footer class="mt-12 flex flex-wrap"><a class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/graphics>graphics</a>
<a class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/arty-a7>arty-a7</a>
<a class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/icebreaker>icebreaker</a>
<a class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/verilator>verilator</a></footer><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://projectf.io/posts/framebuffers/><span class=mr-1.5>←</span><span>Framebuffers</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://projectf.io/posts/life-on-screen/><span>Life on Screen</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto><a class=link href=https://projectf.io>Project F</a>
&copy; 2023 Will Green.</div></footer></body></html>