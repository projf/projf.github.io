<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Hardware Sprites | Project F: FPGA Dev</title>

<meta property='og:title' content='Hardware Sprites - Project F: FPGA Dev'>
<meta property='og:description' content='Welcome back to Exploring FPGA Graphics. In the previous part, we updated our display signals and learnt about colour palettes. This part shows you how to create fast, colourful graphics with minimal logic. Hardware sprites maintain much of the simplicity of our Pong design while offering greater creative freedom.
This post was completely revised in June 2022.
In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs.'>
<meta property='og:url' content='https://projectf.io/posts/hardware-sprites/'>
<meta property='og:site_name' content='Project F: FPGA Dev'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/hardware-sprites/social-card.png'><meta property='article:published_time' content='2020-10-28T00:00:00Z'><meta property='article:modified_time' content='2022-06-14T00:00:00Z'><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F: FPGA Dev">

<link rel="stylesheet" href="/css/style.css"><link rel='stylesheet' href='https://projectf.io/css/custom.css'>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/hardware-sprites/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F: FPGA Dev</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf/projf-explore'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="mastodon" href='https://mastodon.social/@WillFlux'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M 11.966876,0.80329086 C 9.1123466,0.82665791 6.3664935,1.1367094 4.7662978,1.8737549 c 0,0 -3.1736685,1.4237835 -3.1736685,6.2815982 0,1.1123884 -0.021554,2.4424309 0.013571,3.8529439 0.1152443,4.750677 0.8683725,9.432704 5.2479219,10.595273 2.0193066,0.53604 3.7531218,0.648348 5.1494078,0.571373 2.532141,-0.140797 3.953603,-0.906282 3.953603,-0.906282 l -0.08353,-1.842608 c 0,0 -1.809527,0.572181 -3.841713,0.50245 -2.013417,-0.06922 -4.138986,-0.217713 -4.4646269,-2.696937 -0.030082,-0.217772 -0.045075,-0.450712 -0.045075,-0.695267 0,0 1.9765387,0.484554 4.4813709,0.599656 1.531629,0.07049 2.9679,-0.08996 4.426746,-0.264563 2.797636,-0.335045 5.233581,-2.063856 5.539741,-3.643517 0.482392,-2.488386 0.442651,-6.0725219 0.442651,-6.0725219 0,-4.8578147 -3.173492,-6.2815982 -3.173492,-6.2815982 C 17.639136,1.1367094 14.891579,0.82669685 12.03704,0.80329086 Z"/>
  <path d="M 6.4286668,14.016701 V 9.1034254 c 0,-1.0041614 0.2549569,-1.8022059 0.7670342,-2.3925638 0.5280486,-0.590366 1.2196579,-0.8929946 2.0781049,-0.8929946 0.9931961,0 1.7452181,0.3828583 2.2425191,1.1486808 L 11.999859,7.7793695 12,11.451148 11.999859,7.7793695 12.483392,6.9665478 C 12.980596,6.2007253 13.732618,5.817867 14.72592,5.817867 c 0.858341,0 1.549951,0.3026286 2.078097,0.8929946 0.511971,0.5903579 0.766887,1.3884024 0.766887,2.3925638 v 4.9132756" />
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/@projf'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg>
</i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/demos">
          <h2 class="title is-5">Demos</h2>
        </a><a class="nav-item" href="/howto">
          <h2 class="title is-5">How To</h2>
        </a><a class="nav-item" href="/tags/news">
          <h2 class="title is-5">News</h2>
        </a><a class="nav-item" href="/tutorials">
          <h2 class="title is-5">Tutorials</h2>
        </a><a class="nav-item" href="/verilog-lib">
          <h2 class="title is-5">Verilog Lib</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/graphics/">#graphics</a>




      
    </div>
    <h2 class="subtitle is-6">28 October 2020</h2>
    <h1 class="title">Hardware Sprites</h1>
    
    <div class="content">
      <p>Welcome back to <em>Exploring FPGA Graphics</em>. In the previous part, we updated our <a href="/posts/display-signals/">display signals</a> and learnt about colour palettes. This part shows you how to create fast, colourful graphics with minimal logic. Hardware sprites maintain much of the simplicity of our <a href="/posts/fpga-pong/">Pong</a> design while offering greater creative freedom.</p>
<p><strong>This post was completely revised in June 2022.</strong></p>
<p>In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series? Start with <a href="/posts/fpga-graphics/">Beginning FPGA Graphics</a>.</p>
<p><em>Get in touch with <a href="https://mastodon.social/@WillFlux">@WillFlux</a> or join me on <a href="https://github.com/projf/projf-explore/discussions">GitHub Discussions</a> and <a href="https://discord.gg/cf869yDbXf">1BitSquared Discord</a>.</em></p>
<p><img src="/img/posts/hardware-sprites/banner.png" alt="" title=""></p>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li><a href="/posts/fpga-graphics/">Beginning FPGA Graphics</a> - video signals and basic graphics</li>
<li><a href="/posts/racing-the-beam/">Racing the Beam</a> - simple demo effects with minimal logic</li>
<li><a href="/posts/fpga-pong/">FPGA Pong</a> - recreate the classic arcade on an FPGA</li>
<li><a href="/posts/display-signals/">Display Signals</a> - revisit display signals and meet colour palettes</li>
<li>Hardware Sprites (this post) - fast, colourful graphics for games</li>
<li><a href="/posts/framebuffers/">Framebuffers</a> - bitmap graphics featuring Michelangelo&rsquo;s David</li>
<li><a href="/posts/lines-and-triangles/">Lines and Triangles</a> - drawing lines and triangles</li>
<li><a href="/posts/fpga-shapes/">2D Shapes</a> - filled shapes and simple pictures</li>
<li><a href="/posts/animated-shapes/">Animated Shapes</a> - animation and double-buffering</li>
</ul>
<blockquote>
<p><strong>Sponsor My Work</strong><br>
If you like what I do, consider <a href="https://github.com/sponsors/WillGreen">sponsoring me</a> on GitHub.<br>
I love FPGAs and want to help more people discover and use them in their projects.<br>
My hardware designs are open source, and my blog is advert free.</p>
</blockquote>
<h3 id="requirements">Requirements</h3>
<p>You should be to run these designs on any recent FPGA board. I include everything you need for the <a href="https://docs.icebreaker-fpga.org/hardware/icebreaker/">iCEBreaker</a> with <a href="https://docs.icebreaker-fpga.org/hardware/pmod/dvi/">12-Bit DVI Pmod</a>, <a href="https://digilent.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a> with <a href="https://digilent.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a>, and <a href="/posts/verilog-sim-verilator-sdl/">Verilator Simulation with SDL</a>. See <a href="/posts/fpga-graphics/#requirements">requirements</a> from <em>Beginning FPGA Graphics</em> for more details.</p>
<h2 id="what-is-a-sprite">What is a Sprite?</h2>
<p>A sprite is a graphics object that can be moved and animated independently of the background and other sprites. Hardware sprites use dedicated logic for drawing. Until the mid-90s, they were an essential part of computer graphics.</p>
<p>Hardware sprites are a good fit for an FPGA as they&rsquo;re easy to control, and we can scale them to fit a game design: whether we want hundreds of tiny sprites or a few huge ones. Hardware sprites are also valuable for cursors or pointers in professional applications, providing a responsive UI without complex screen redrawing.</p>
<p><img src="/img/posts/hardware-sprites/amiga-pointer.png" alt="Amiga Pointer" title="The future was here."><br>
<em>Workbench 2 Mouse Pointer (Commodore Amiga)</em></p>
<p><img src="/img/posts/hardware-sprites/sonic-megadrive.png" alt="Sonic" title="Don't you wag your finger at me!"><br>
<em>Sonic the Hedgehog (Sega Megadrive)</em></p>
<h2 id="a-simple-sprite">A Simple Sprite</h2>
<p>We&rsquo;re going to start with a tiny 8x8 pixel sprite using just two colours. Our first sprite is the letter &lsquo;F&rsquo; with a full stop (period). It&rsquo;s a simple, asymmetric design, making it easier to spot bugs (such as incorrect orientation or pixels being missed off):</p>
<p><img src="/img/posts/hardware-sprites/letter-f.png" alt="F." title="F for Project F"></p>
<p>We can represent this sprite as a two-dimensional array, like we did in the earlier <a href="/posts/racing-the-beam#hello">Hello</a> demo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">initial</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">0</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1111</span>_1100;
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">1</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">2</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">3</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1111</span>_1000;
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">4</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">5</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">6</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0011;
</span></span><span style="display:flex;"><span>    bmap[<span style="color:#ae81ff">7</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b0000</span>_0011;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h3 id="simple-sprite-drawing">Simple Sprite Drawing</h3>
<p>Before we start writing Verilog, we should outline the steps required to draw the sprite. You could take many approaches, but I&rsquo;ve opted for a simple line-based algorithm.</p>
<p>On every screen line:</p>
<ol>
<li>Register sprite position (save sprite coordinates)</li>
<li>Idle unless sprite is active on this line</li>
<li>Wait for the horizontal sprite position</li>
<li>Draw a line of sprite pixels</li>
<li>Idle</li>
</ol>
<p>This process is well represented by our old friend, the finite state machine (FSM). In fact, our first sprite design is little more than a simple finite state machine with a small array for the graphic <strong>[<a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sprite_inline.sv">sprite_inline.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> sprite_inline #(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">parameter</span> CORDW<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>,   <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> H_RES<span style="color:#f92672">=</span><span style="color:#ae81ff">640</span>,  <span style="color:#75715e">// horizontal screen resolution (pixels)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SX_OFFS<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>   <span style="color:#75715e">// horizontal screen offset (pixels)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,                            <span style="color:#75715e">// clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,                            <span style="color:#75715e">// reset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> line,                           <span style="color:#75715e">// start of active screen line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy,      <span style="color:#75715e">// screen position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx, spry,  <span style="color:#75715e">// sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> pix,                            <span style="color:#75715e">// pixel colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> drawing                         <span style="color:#75715e">// drawing at position (sx,sy)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite bitmap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> SPR_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>SPR_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] bmap [SPR_HEIGHT];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">initial</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// big endian vector, so we can write initial block left to right
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        bmap[<span style="color:#ae81ff">0</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1111</span>_1100;
</span></span><span style="display:flex;"><span>        bmap[<span style="color:#ae81ff">1</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>        bmap[<span style="color:#ae81ff">2</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>        bmap[<span style="color:#ae81ff">3</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1111</span>_1000;
</span></span><span style="display:flex;"><span>        bmap[<span style="color:#ae81ff">4</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>        bmap[<span style="color:#ae81ff">5</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0000;
</span></span><span style="display:flex;"><span>        bmap[<span style="color:#ae81ff">6</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b1100</span>_0011;
</span></span><span style="display:flex;"><span>        bmap[<span style="color:#ae81ff">7</span>]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b0000</span>_0011;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// coordinates within sprite bitmap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(SPR_WIDTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]  bmap_x;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [$clog2(SPR_HEIGHT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] bmap_y;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// for registering sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx_r, spry_r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// status flags: used to change state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_active;  <span style="color:#75715e">// sprite active on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_begin;   <span style="color:#75715e">// begin sprite drawing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_end;     <span style="color:#75715e">// end of sprite on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> line_end;    <span style="color:#75715e">// end of screen line, corrected for sx offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        spr_active <span style="color:#f92672">=</span> (sy <span style="color:#f92672">-</span> spry_r <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">-</span> spry_r <span style="color:#f92672">&lt;</span> SPR_HEIGHT);
</span></span><span style="display:flex;"><span>        spr_begin  <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;=</span> sprx_r <span style="color:#f92672">-</span> SX_OFFS);
</span></span><span style="display:flex;"><span>        spr_end    <span style="color:#f92672">=</span> (bmap_x <span style="color:#f92672">==</span> SPR_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        line_end   <span style="color:#f92672">=</span> (sx <span style="color:#f92672">==</span> H_RES <span style="color:#f92672">-</span> SX_OFFS);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite state machine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>        IDLE,      <span style="color:#75715e">// awaiting line signal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        REG_POS,   <span style="color:#75715e">// register sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ACTIVE,    <span style="color:#75715e">// check if sprite is active on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        WAIT_POS,  <span style="color:#75715e">// wait for horizontal sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SPR_LINE,  <span style="color:#75715e">// iterate over sprite pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        WAIT_DATA  <span style="color:#75715e">// account for data latency
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// prepare for new line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            state <span style="color:#f92672">&lt;=</span> REG_POS;
</span></span><span style="display:flex;"><span>            pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>                REG_POS: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> ACTIVE;
</span></span><span style="display:flex;"><span>                    sprx_r <span style="color:#f92672">&lt;=</span> sprx;
</span></span><span style="display:flex;"><span>                    spry_r <span style="color:#f92672">&lt;=</span> spry;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                ACTIVE: state <span style="color:#f92672">&lt;=</span> spr_active <span style="color:#f92672">?</span> WAIT_POS <span style="color:#f92672">:</span> IDLE;
</span></span><span style="display:flex;"><span>                WAIT_POS: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (spr_begin) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                        state <span style="color:#f92672">&lt;=</span> SPR_LINE;
</span></span><span style="display:flex;"><span>                        bmap_x <span style="color:#f92672">&lt;=</span> sx <span style="color:#f92672">-</span> sprx_r <span style="color:#f92672">+</span> SX_OFFS;  <span style="color:#75715e">// account for start offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        bmap_y <span style="color:#f92672">&lt;=</span> sy <span style="color:#f92672">-</span> spry_r;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                SPR_LINE: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (spr_end <span style="color:#f92672">||</span> line_end) state <span style="color:#f92672">&lt;=</span> WAIT_DATA;
</span></span><span style="display:flex;"><span>                    bmap_x <span style="color:#f92672">&lt;=</span> bmap_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    pix <span style="color:#f92672">&lt;=</span> bmap[bmap_y][bmap_x];
</span></span><span style="display:flex;"><span>                    drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                WAIT_DATA: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> IDLE;  <span style="color:#75715e">// 1 cycle between address set and data receipt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// default colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (rst) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>            bmap_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            bmap_y <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>State changes are driven by the four status flags.</p>
<p>At the start of each screen line, we use <code>spr_active</code> to check whether the sprite appears on this line. If it does, we wait for the horizontal position with <code>spr_begin</code>, compensating for data latency. Next, we select the pixels to draw from the graphic, stopping when we get a <code>spr_end</code> or <code>line_end</code> flag. We then wait out the data latency before idling. If we didn&rsquo;t account for the data latency, we&rsquo;d chop off the right-hand side of our sprite.</p>
<p>Our new display signals module uses <strong>signed</strong> coordinates, so both our screen <code>(sx, sy)</code> and sprite <code>(spx,spy)</code> coordinates are declared signed.</p>
<blockquote>
<p><strong>SX_OFFS</strong><br>
You might be wondering why I&rsquo;ve set <code>SX_OFFS</code> to 2. Doesn&rsquo;t an asynchronous ROM provide data immediately?
It does, but one cycle is switching state from waiting to drawing, and one cycle is registering the memory address.</p>
</blockquote>
<h3 id="sprite-on-screen">Sprite on Screen</h3>
<p>With our new display module in hand, it&rsquo;s time to see our static sprite on screen:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_inline.sv">xc7/top_tinyf_inline.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_inline.sv">ice40/top_tinyf_inline.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_inline.sv">sim/top_tinyf_inline.sv</a></strong></li>
</ul>
<p>iCEBreaker version shown below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_tinyf_inline (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_12m,      <span style="color:#75715e">// 12 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_clk,      <span style="color:#75715e">// DVI pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_hsync,    <span style="color:#75715e">// DVI horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_vsync,    <span style="color:#75715e">// DVI vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_de,       <span style="color:#75715e">// DVI data enable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_r,  <span style="color:#75715e">// 4-bit DVI red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_g,  <span style="color:#75715e">// 4-bit DVI green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_b   <span style="color:#75715e">// 4-bit DVI blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_12m,
</span></span><span style="display:flex;"><span>       .rst(btn_rst),
</span></span><span style="display:flex;"><span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// reset in pixel clock domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> rst_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> rst_pix <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>clk_pix_locked;  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;  <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de, line;
</span></span><span style="display:flex;"><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de,
</span></span><span style="display:flex;"><span>        .frame(),
</span></span><span style="display:flex;"><span>        .line
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// screen dimensions (must match display_inst)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> H_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPRX <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;  <span style="color:#75715e">// horizontal position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPRY <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;  <span style="color:#75715e">// vertical position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> pix, drawing;
</span></span><span style="display:flex;"><span>    sprite_inline #(
</span></span><span style="display:flex;"><span>        .CORDW(CORDW),
</span></span><span style="display:flex;"><span>        .H_RES(H_RES)
</span></span><span style="display:flex;"><span>        ) sprite_f (
</span></span><span style="display:flex;"><span>        .clk(clk_pix),
</span></span><span style="display:flex;"><span>        .rst(rst_pix),
</span></span><span style="display:flex;"><span>        .line,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .sprx(SPRX),
</span></span><span style="display:flex;"><span>        .spry(SPRY),
</span></span><span style="display:flex;"><span>        .pix,
</span></span><span style="display:flex;"><span>        .drawing
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint colours: yellow sprite, blue background
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_r <span style="color:#f92672">=</span> (drawing <span style="color:#f92672">&amp;&amp;</span> pix) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> (drawing <span style="color:#f92672">&amp;&amp;</span> pix) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hC</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h3</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> (drawing <span style="color:#f92672">&amp;&amp;</span> pix) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h7</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// DVI Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SB_IO #(
</span></span><span style="display:flex;"><span>        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010100</span>)  <span style="color:#75715e">// PIN_OUTPUT_REGISTERED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) dvi_signal_io [<span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] (
</span></span><span style="display:flex;"><span>        .PACKAGE_PIN({dvi_hsync, dvi_vsync, dvi_de, dvi_r, dvi_g, dvi_b}),
</span></span><span style="display:flex;"><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>        .D_OUT_0({hsync, vsync, de, paint_r, paint_g, paint_b}),
</span></span><span style="display:flex;"><span>        .D_OUT_1()
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// DVI Pmod clock output: 180° out of phase with other DVI signals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SB_IO #(
</span></span><span style="display:flex;"><span>        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010000</span>)  <span style="color:#75715e">// PIN_OUTPUT_DDR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) dvi_clk_io (
</span></span><span style="display:flex;"><span>        .PACKAGE_PIN(dvi_clk),
</span></span><span style="display:flex;"><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>        .D_OUT_0(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
</span></span><span style="display:flex;"><span>        .D_OUT_1(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>This top module is straightforward: we generate display signals and feed them to the sprite module. We use the output of the sprite module to choose the colour to paint: yellow or blue in this example.</p>
<p>You may have spotted a new signal called <code>rst_pix</code>. This is a reset in the pixel clock domain. We standardise this name for clarity and so that all boards can use the same design. Later designs will introduce a system clock domain with its own reset named <code>rst_sys</code>.</p>
<blockquote>
<p><strong>Building the Designs</strong><br>
In the <a href="https://github.com/projf/projf-explore/tree/main/graphics/hardware-sprites">Hardware Sprites</a> section of the git repo, you&rsquo;ll find the design files, a makefile for iCEBreaker and Verilator, and a Vivado project for Arty. There are also build instructions for boards and simulations.</p>
</blockquote>
<p>Build and run your design. You should see a small golden letter &lsquo;F&rsquo; and a dot towards the top left of the screen. From these tiny beginnings, mighty sprites will grow.</p>
<p>Try changing the sprite position using <code>SPRX</code> and <code>SPRY</code>. You can change the sprite and background colours using <code>paint_r</code>, <code>paint_g</code>, and <code>paint_b</code>.</p>
<h2 id="external-rom">External ROM</h2>
<p>Storing the sprite within the Verilog module is simple but inflexible. If we want to change the graphic, we must update the Verilog. A cleaner approach is to use a ROM module and then load a bitmap from an external file.</p>
<p>We&rsquo;re going to use an asynchronous (no clock) ROM module <strong>[<a href="https://github.com/projf/projf-explore/blob/main/lib/memory/rom_async.sv">rom_async.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> rom_async #(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">parameter</span> WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">parameter</span> DEPTH<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">parameter</span> INIT_F<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> ADDRW<span style="color:#f92672">=</span>$clog2(DEPTH)
</span></span><span style="display:flex;"><span>    ) (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] addr,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] data
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] memory [DEPTH];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">initial</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (INIT_F <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            $display(<span style="color:#e6db74">&#34;Creating rom_async from init file &#39;%s&#39;.&#34;</span>, INIT_F);
</span></span><span style="display:flex;"><span>            $readmemh(INIT_F, memory);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> data <span style="color:#f92672">=</span> memory[addr];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>And the memory initialization file looks like this <strong>[<a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/res/sprites/letter_f.mem">letter_f.mem</a>]</strong>:</p>
<pre tabindex="0"><code>1 1 1 1 1 1 0 0
1 1 0 0 0 0 0 0
1 1 0 0 0 0 0 0
1 1 1 1 1 0 0 0
1 1 0 0 0 0 0 0
1 1 0 0 0 0 0 0
1 1 0 0 0 0 1 1
0 0 0 0 0 0 1 1
</code></pre><p>The sprite module pulls in our new ROM design <strong>[<a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sprite_rom.sv">sprite_rom.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> sprite_rom #(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">parameter</span> CORDW<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>,      <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> H_RES<span style="color:#f92672">=</span><span style="color:#ae81ff">640</span>,     <span style="color:#75715e">// horizontal screen resolution (pixels)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SX_OFFS<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,     <span style="color:#75715e">// horizontal screen offset (pixels)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>,   <span style="color:#75715e">// sprite bitmap file ($readmemh format)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,   <span style="color:#75715e">// sprite bitmap width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_HEIGHT<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,  <span style="color:#75715e">// sprite bitmap height in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_DATAW<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    <span style="color:#75715e">// data width: bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,                            <span style="color:#75715e">// clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,                            <span style="color:#75715e">// reset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> line,                           <span style="color:#75715e">// start of active screen line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy,      <span style="color:#75715e">// screen position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx, spry,  <span style="color:#75715e">// sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [SPR_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] pix,            <span style="color:#75715e">// pixel colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> drawing                         <span style="color:#75715e">// drawing at position (sx,sy)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite bitmap ROM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_ROM_DEPTH <span style="color:#f92672">=</span> SPR_WIDTH <span style="color:#f92672">*</span> SPR_HEIGHT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [$clog2(SPR_ROM_DEPTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_rom_addr;  <span style="color:#75715e">// pixel position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_rom_data;  <span style="color:#75715e">// pixel colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    rom_async #(
</span></span><span style="display:flex;"><span>        .WIDTH(SPR_DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(SPR_ROM_DEPTH),
</span></span><span style="display:flex;"><span>        .INIT_F(SPR_FILE)
</span></span><span style="display:flex;"><span>    ) spr_rom (
</span></span><span style="display:flex;"><span>        .addr(spr_rom_addr),
</span></span><span style="display:flex;"><span>        .data(spr_rom_data)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// horizontal coordinate within sprite bitmap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(SPR_WIDTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] bmap_x;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// for registering sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx_r, spry_r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// status flags: used to change state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_active;  <span style="color:#75715e">// sprite active on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_begin;   <span style="color:#75715e">// begin sprite drawing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_end;     <span style="color:#75715e">// end of sprite on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> line_end;    <span style="color:#75715e">// end of screen line, corrected for sx offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        spr_active <span style="color:#f92672">=</span> (sy <span style="color:#f92672">-</span> spry_r <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">-</span> spry_r <span style="color:#f92672">&lt;</span> SPR_HEIGHT);
</span></span><span style="display:flex;"><span>        spr_begin  <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;=</span> sprx_r <span style="color:#f92672">-</span> SX_OFFS);
</span></span><span style="display:flex;"><span>        spr_end    <span style="color:#f92672">=</span> (bmap_x <span style="color:#f92672">==</span> SPR_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        line_end   <span style="color:#f92672">=</span> (sx <span style="color:#f92672">==</span> H_RES <span style="color:#f92672">-</span> SX_OFFS);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite state machine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>        IDLE,      <span style="color:#75715e">// awaiting line signal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        REG_POS,   <span style="color:#75715e">// register sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ACTIVE,    <span style="color:#75715e">// check if sprite is active on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        WAIT_POS,  <span style="color:#75715e">// wait for horizontal sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SPR_LINE,  <span style="color:#75715e">// iterate over sprite pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        WAIT_DATA  <span style="color:#75715e">// account for data latency
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// prepare for new line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            state <span style="color:#f92672">&lt;=</span> REG_POS;
</span></span><span style="display:flex;"><span>            pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>                REG_POS: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> ACTIVE;
</span></span><span style="display:flex;"><span>                    sprx_r <span style="color:#f92672">&lt;=</span> sprx;
</span></span><span style="display:flex;"><span>                    spry_r <span style="color:#f92672">&lt;=</span> spry;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                ACTIVE: state <span style="color:#f92672">&lt;=</span> spr_active <span style="color:#f92672">?</span> WAIT_POS <span style="color:#f92672">:</span> IDLE;
</span></span><span style="display:flex;"><span>                WAIT_POS: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (spr_begin) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                        state <span style="color:#f92672">&lt;=</span> SPR_LINE;
</span></span><span style="display:flex;"><span>                        spr_rom_addr <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">-</span> spry_r) <span style="color:#f92672">*</span> SPR_WIDTH <span style="color:#f92672">+</span> (sx <span style="color:#f92672">-</span> sprx_r) <span style="color:#f92672">+</span> SX_OFFS;
</span></span><span style="display:flex;"><span>                        bmap_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                SPR_LINE: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (spr_end <span style="color:#f92672">||</span> line_end) state <span style="color:#f92672">&lt;=</span> WAIT_DATA;
</span></span><span style="display:flex;"><span>                    spr_rom_addr <span style="color:#f92672">&lt;=</span> spr_rom_addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    bmap_x <span style="color:#f92672">&lt;=</span> bmap_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    pix <span style="color:#f92672">&lt;=</span> spr_rom_data;
</span></span><span style="display:flex;"><span>                    drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                WAIT_DATA: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> IDLE;  <span style="color:#75715e">// 1 cycle between address set and data receipt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// default colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (rst) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>            spr_rom_addr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            bmap_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>A quick tweak to our top module and we&rsquo;re ready to build the new version:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_rom.sv">xc7/top_tinyf_rom.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_rom.sv">ice40/top_tinyf_rom.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_rom.sv">sim/top_tinyf_rom.sv</a></strong></li>
</ul>
<h2 id="scaling-up">Scaling Up</h2>
<p>Next, let&rsquo;s scale our sprite up. We make larger sprites by increasing the size of the bitmap. However, it&rsquo;s also useful to be able to scale our sprites up when drawing them. A scaled-up sprite will be blocky but will use few resources and allows a design to work at different screen resolutions.</p>
<p>The new module is <strong>[<a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sprite.sv">sprite.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> sprite #(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">parameter</span> CORDW<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>,      <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> H_RES<span style="color:#f92672">=</span><span style="color:#ae81ff">640</span>,     <span style="color:#75715e">// horizontal screen resolution (pixels)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SX_OFFS<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,     <span style="color:#75715e">// horizontal screen offset (pixels)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>,   <span style="color:#75715e">// sprite bitmap file ($readmemh format)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,   <span style="color:#75715e">// sprite bitmap width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_HEIGHT<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>,  <span style="color:#75715e">// sprite bitmap height in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_SCALE<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,   <span style="color:#75715e">// scale factor: 0=1x, 1=2x, 2=4x, 3=8x etc.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SPR_DATAW<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    <span style="color:#75715e">// data width: bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,                            <span style="color:#75715e">// clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,                            <span style="color:#75715e">// reset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> line,                           <span style="color:#75715e">// start of active screen line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy,      <span style="color:#75715e">// screen position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx, spry,  <span style="color:#75715e">// sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [SPR_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] pix,            <span style="color:#75715e">// pixel colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> drawing                         <span style="color:#75715e">// drawing at position (sx,sy)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite bitmap ROM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_ROM_DEPTH <span style="color:#f92672">=</span> SPR_WIDTH <span style="color:#f92672">*</span> SPR_HEIGHT;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> [$clog2(SPR_ROM_DEPTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_rom_addr;  <span style="color:#75715e">// pixel position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [SPR_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_rom_data;  <span style="color:#75715e">// pixel colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    rom_async #(
</span></span><span style="display:flex;"><span>        .WIDTH(SPR_DATAW),
</span></span><span style="display:flex;"><span>        .DEPTH(SPR_ROM_DEPTH),
</span></span><span style="display:flex;"><span>        .INIT_F(SPR_FILE)
</span></span><span style="display:flex;"><span>    ) spr_rom (
</span></span><span style="display:flex;"><span>        .addr(spr_rom_addr),
</span></span><span style="display:flex;"><span>        .data(spr_rom_data)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// horizontal coordinate within sprite bitmap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(SPR_WIDTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] bmap_x;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// horizontal scale counter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [SPR_SCALE:<span style="color:#ae81ff">0</span>] cnt_x;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// for registering sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx_r, spry_r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// status flags: used to change state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]  spr_diff;  <span style="color:#75715e">// diff vertical screen and sprite positions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_active;  <span style="color:#75715e">// sprite active on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_begin;   <span style="color:#75715e">// begin sprite drawing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> spr_end;     <span style="color:#75715e">// end of sprite on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> line_end;    <span style="color:#75715e">// end of screen line, corrected for sx offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        spr_diff <span style="color:#f92672">=</span> (sy <span style="color:#f92672">-</span> spry_r) <span style="color:#f92672">&gt;&gt;&gt;</span> SPR_SCALE;  <span style="color:#75715e">// arithmetic right-shift
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        spr_active <span style="color:#f92672">=</span> (spr_diff <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (spr_diff <span style="color:#f92672">&lt;</span> SPR_HEIGHT);
</span></span><span style="display:flex;"><span>        spr_begin <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;=</span> sprx_r <span style="color:#f92672">-</span> SX_OFFS);
</span></span><span style="display:flex;"><span>        spr_end <span style="color:#f92672">=</span> (bmap_x <span style="color:#f92672">==</span> SPR_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        line_end <span style="color:#f92672">=</span> (sx <span style="color:#f92672">==</span> H_RES <span style="color:#f92672">-</span> SX_OFFS);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite state machine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>        IDLE,      <span style="color:#75715e">// awaiting line signal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        REG_POS,   <span style="color:#75715e">// register sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ACTIVE,    <span style="color:#75715e">// check if sprite is active on this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        WAIT_POS,  <span style="color:#75715e">// wait for horizontal sprite position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SPR_LINE,  <span style="color:#75715e">// iterate over sprite pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        WAIT_DATA  <span style="color:#75715e">// account for data latency
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// prepare for new line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            state <span style="color:#f92672">&lt;=</span> REG_POS;
</span></span><span style="display:flex;"><span>            pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> (state)
</span></span><span style="display:flex;"><span>                REG_POS: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> ACTIVE;
</span></span><span style="display:flex;"><span>                    sprx_r <span style="color:#f92672">&lt;=</span> sprx;
</span></span><span style="display:flex;"><span>                    spry_r <span style="color:#f92672">&lt;=</span> spry;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                ACTIVE: state <span style="color:#f92672">&lt;=</span> spr_active <span style="color:#f92672">?</span> WAIT_POS <span style="color:#f92672">:</span> IDLE;
</span></span><span style="display:flex;"><span>                WAIT_POS: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (spr_begin) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                        state <span style="color:#f92672">&lt;=</span> SPR_LINE;
</span></span><span style="display:flex;"><span>                        spr_rom_addr <span style="color:#f92672">&lt;=</span> spr_diff <span style="color:#f92672">*</span> SPR_WIDTH <span style="color:#f92672">+</span> (sx <span style="color:#f92672">-</span> sprx_r) <span style="color:#f92672">+</span> SX_OFFS;
</span></span><span style="display:flex;"><span>                        bmap_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                        cnt_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                SPR_LINE: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (line_end) state <span style="color:#f92672">&lt;=</span> WAIT_DATA;
</span></span><span style="display:flex;"><span>                    pix <span style="color:#f92672">&lt;=</span> spr_rom_data;
</span></span><span style="display:flex;"><span>                    drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (SPR_SCALE <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> cnt_x <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>SPR_SCALE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> (spr_end) state <span style="color:#f92672">&lt;=</span> WAIT_DATA;
</span></span><span style="display:flex;"><span>                        spr_rom_addr <span style="color:#f92672">&lt;=</span> spr_rom_addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        bmap_x <span style="color:#f92672">&lt;=</span> bmap_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        cnt_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> cnt_x <span style="color:#f92672">&lt;=</span> cnt_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                WAIT_DATA: <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>                    state <span style="color:#f92672">&lt;=</span> IDLE;  <span style="color:#75715e">// 1 cycle between address set and data receipt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// default colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">endcase</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (rst) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">&lt;=</span> IDLE;
</span></span><span style="display:flex;"><span>            spr_rom_addr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            bmap_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            cnt_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            pix <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            drawing <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>We can then drive this with a small change to our top module.</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_scale.sv">xc7/top_tinyf_scale.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_scale.sv">ice40/top_tinyf_scale.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_scale.sv">sim/top_tinyf_scale.sv</a></strong></li>
</ul>
<p>Build the design with scaling, and you should see a larger F:</p>
<p><img src="/img/posts/hardware-sprites/letter-f-720p.png" alt="Letter F" title="Letter F: FPGA Capture"></p>
<h2 id="moving-around">Moving Around</h2>
<p>We can move our sprite around the screen by replacing the fixed position parameters with variables. I&rsquo;ve created a simple example that moves the scaled-up &lsquo;F&rsquo; back and forth across the screen.</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_tinyf_scale.sv">xc7/top_tinyf_move.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_tinyf_scale.sv">ice40/top_tinyf_move.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_tinyf_scale.sv">sim/top_tinyf_move.sv</a></strong></li>
</ul>
<p>Note how the sprite draws correctly as it moves off the left and right sides of the screen using signed coordinates.</p>
<p>The Arty version looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_tinyf_move (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst_n,    <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_100m,
</span></span><span style="display:flex;"><span>       .rst(<span style="color:#f92672">!</span>btn_rst_n),  <span style="color:#75715e">// reset button is active low
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_5x(),  <span style="color:#75715e">// not used for VGA output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// reset in pixel clock domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> rst_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> rst_pix <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>clk_pix_locked;  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;  <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de, frame, line;
</span></span><span style="display:flex;"><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de,
</span></span><span style="display:flex;"><span>        .frame,
</span></span><span style="display:flex;"><span>        .line
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// screen dimensions (must match display_inst)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> H_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">localparam</span> V_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">480</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;  <span style="color:#75715e">// bitmap width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;  <span style="color:#75715e">// bitmap height in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_SCALE  <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">// 2^3 = 8x scale
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_DATAW  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// bits per pixel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_DRAWW  <span style="color:#f92672">=</span> SPR_WIDTH  <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>SPR_SCALE;  <span style="color:#75715e">// draw width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_DRAWH  <span style="color:#f92672">=</span> SPR_HEIGHT <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>SPR_SCALE;  <span style="color:#75715e">// draw height
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_SPX    <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;  <span style="color:#75715e">// horizontal speed (pixels/frame)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_FILE   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;letter_f.mem&#34;</span>;  <span style="color:#75715e">// bitmap file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// draw sprite at position (sprx,spry)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx, spry;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> dx;  <span style="color:#75715e">// direction: 0 is right/down
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// update sprite position once per frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (dx <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// moving right
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (sprx <span style="color:#f92672">+</span> SPR_DRAWW <span style="color:#f92672">&gt;=</span> H_RES <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>SPR_DRAWW) dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// move left
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">else</span> sprx <span style="color:#f92672">&lt;=</span> sprx <span style="color:#f92672">+</span> SPR_SPX;  <span style="color:#75715e">// continue right
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// moving left
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (sprx <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>SPR_DRAWW) dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// move right
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">else</span> sprx <span style="color:#f92672">&lt;=</span> sprx <span style="color:#f92672">-</span> SPR_SPX;  <span style="color:#75715e">// continue left
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (rst_pix) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// centre sprite and set direction right
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            sprx <span style="color:#f92672">&lt;=</span> H_RES<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> SPR_DRAWW<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>            spry <span style="color:#f92672">&lt;=</span> V_RES<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> SPR_DRAWH<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>            dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> drawing;  <span style="color:#75715e">// drawing at (sx,sy)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [SPR_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] pix;  <span style="color:#75715e">// pixel colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sprite #(
</span></span><span style="display:flex;"><span>        .CORDW(CORDW),
</span></span><span style="display:flex;"><span>        .H_RES(H_RES),
</span></span><span style="display:flex;"><span>        .SPR_FILE(SPR_FILE),
</span></span><span style="display:flex;"><span>        .SPR_WIDTH(SPR_WIDTH),
</span></span><span style="display:flex;"><span>        .SPR_HEIGHT(SPR_HEIGHT),
</span></span><span style="display:flex;"><span>        .SPR_SCALE(SPR_SCALE),
</span></span><span style="display:flex;"><span>        .SPR_DATAW(SPR_DATAW)
</span></span><span style="display:flex;"><span>        ) sprite_f (
</span></span><span style="display:flex;"><span>        .clk(clk_pix),
</span></span><span style="display:flex;"><span>        .rst(rst_pix),
</span></span><span style="display:flex;"><span>        .line,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .sprx,
</span></span><span style="display:flex;"><span>        .spry,
</span></span><span style="display:flex;"><span>        .pix,
</span></span><span style="display:flex;"><span>        .drawing
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint colours: yellow sprite, blue background
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_r <span style="color:#f92672">=</span> (drawing <span style="color:#f92672">&amp;&amp;</span> pix) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> (drawing <span style="color:#f92672">&amp;&amp;</span> pix) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hC</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h3</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> (drawing <span style="color:#f92672">&amp;&amp;</span> pix) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h7</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// VGA Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
</span></span><span style="display:flex;"><span>        vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (de) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            vga_r <span style="color:#f92672">&lt;=</span> paint_r;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> paint_g;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> paint_b;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// VGA colour should be black in blanking interval
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            vga_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h2 id="hourglass">Hourglass</h2>
<p>The introduction promised &ldquo;colourful&rdquo; graphics: it&rsquo;s time to make good on this by introducing a colour lookup table (CLUT). As discussed in <a href="/posts/display-signals/">Display Signals</a>, we load a palette into a CLUT and then lookup colours before displaying them.</p>
<p>I&rsquo;ve created a simple hourglass sprite bitmap using 4-bit colour indexes. Each pixel is represented by a hexadecimal digit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>0 0 0 0 0 0 0 0
</span></span><span style="display:flex;"><span>F 1 1 1 1 1 1 F
</span></span><span style="display:flex;"><span>F F 2 2 2 2 F F
</span></span><span style="display:flex;"><span>F F F 3 3 F F F
</span></span><span style="display:flex;"><span>F F F 4 4 F F F
</span></span><span style="display:flex;"><span>F F 5 5 5 5 F F
</span></span><span style="display:flex;"><span>F 6 6 6 6 6 6 F
</span></span><span style="display:flex;"><span>7 7 7 7 7 7 7 7
</span></span></code></pre></div><p>And I&rsquo;ve chosen the teleport palette <strong>[<a href="https://github.com/projf/projf-explore/tree/main/lib/res/palettes/teleport16_4b.mem">teleport16_4b.mem</a>]</strong>.</p>
<p><img src="/img/posts/display-signals/teleport-palette.png" alt="Teleport Palette" title=""></p>
<p>And top modules to draw the hourglass:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_hourglass.sv">xc7/top_hourglass.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_hourglass.sv">ice40/top_hourglass.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_hourglass.sv">sim/top_hourglass.sv</a></strong></li>
</ul>
<p>This is the Verilator simulation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_hourglass #(<span style="color:#66d9ef">parameter</span> CORDW<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>) (  <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_pix,      <span style="color:#75715e">// pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst_pix,      <span style="color:#75715e">// sim reset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_sx,  <span style="color:#75715e">// horizontal SDL position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_sy,  <span style="color:#75715e">// vertical SDL position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> sdl_de,       <span style="color:#75715e">// data enable (low in blanking interval)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> sdl_frame,    <span style="color:#75715e">// high at start of frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_r,  <span style="color:#75715e">// 8-bit red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_g,  <span style="color:#75715e">// 8-bit green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_b   <span style="color:#75715e">// 8-bit blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de, frame, line;
</span></span><span style="display:flex;"><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync(),
</span></span><span style="display:flex;"><span>        .vsync(),
</span></span><span style="display:flex;"><span>        .de,
</span></span><span style="display:flex;"><span>        .frame,
</span></span><span style="display:flex;"><span>        .line
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// screen dimensions (must match display_inst)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> H_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CHANW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;         <span style="color:#75715e">// colour channel width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> COLRW <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>CHANW;   <span style="color:#75715e">// colour width: three channels (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CIDXW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;         <span style="color:#75715e">// colour index width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> TRANS_INDX <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;hF</span>;  <span style="color:#75715e">// transparant colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> BG_COLR <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;h137</span>;   <span style="color:#75715e">// background colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> PAL_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../../../lib/res/palettes/teleport16_4b.mem&#34;</span>;  <span style="color:#75715e">// palette file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SX_OFFS    <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">// horizontal screen offset (pixels): +1 for CLUT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;  <span style="color:#75715e">// bitmap width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;  <span style="color:#75715e">// bitmap height in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_SCALE  <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;  <span style="color:#75715e">// 2^4 = 16x scale
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_FILE   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../res/sprites/hourglass.mem&#34;</span>;  <span style="color:#75715e">// bitmap file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> drawing;  <span style="color:#75715e">// drawing at (sx,sy)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CIDXW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_pix_indx;  <span style="color:#75715e">// pixel colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sprite #(
</span></span><span style="display:flex;"><span>        .CORDW(CORDW),
</span></span><span style="display:flex;"><span>        .H_RES(H_RES),
</span></span><span style="display:flex;"><span>        .SX_OFFS(SX_OFFS),
</span></span><span style="display:flex;"><span>        .SPR_FILE(SPR_FILE),
</span></span><span style="display:flex;"><span>        .SPR_WIDTH(SPR_WIDTH),
</span></span><span style="display:flex;"><span>        .SPR_HEIGHT(SPR_HEIGHT),
</span></span><span style="display:flex;"><span>        .SPR_SCALE(SPR_SCALE),
</span></span><span style="display:flex;"><span>        .SPR_DATAW(CIDXW)
</span></span><span style="display:flex;"><span>        ) sprite_hourglass (
</span></span><span style="display:flex;"><span>        .clk(clk_pix),
</span></span><span style="display:flex;"><span>        .rst(rst_pix),
</span></span><span style="display:flex;"><span>        .line,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .sprx(<span style="color:#ae81ff">32</span>),
</span></span><span style="display:flex;"><span>        .spry(<span style="color:#ae81ff">16</span>),
</span></span><span style="display:flex;"><span>        .pix(spr_pix_indx),
</span></span><span style="display:flex;"><span>        .drawing
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour lookup table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [COLRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_pix_colr;
</span></span><span style="display:flex;"><span>    clut_simple #(
</span></span><span style="display:flex;"><span>        .COLRW(COLRW),
</span></span><span style="display:flex;"><span>        .CIDXW(CIDXW),
</span></span><span style="display:flex;"><span>        .F_PAL(PAL_FILE)
</span></span><span style="display:flex;"><span>        ) clut_instance (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_write(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_read(spr_pix_indx),
</span></span><span style="display:flex;"><span>        .colr_in(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .colr_out(spr_pix_colr)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// account for transparency and delay drawing signal to match CLUT delay (1 cycle)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> drawing_t1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) drawing_t1 <span style="color:#f92672">&lt;=</span> drawing <span style="color:#f92672">&amp;&amp;</span> (spr_pix_indx <span style="color:#f92672">!=</span> TRANS_INDX);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint colours
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> {paint_r, paint_g, paint_b} <span style="color:#f92672">=</span> (drawing_t1) <span style="color:#f92672">?</span> spr_pix_colr <span style="color:#f92672">:</span> BG_COLR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// SDL output (8 bits per colour channel)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        sdl_sx <span style="color:#f92672">&lt;=</span> sx;
</span></span><span style="display:flex;"><span>        sdl_sy <span style="color:#f92672">&lt;=</span> sy;
</span></span><span style="display:flex;"><span>        sdl_de <span style="color:#f92672">&lt;=</span> de;
</span></span><span style="display:flex;"><span>        sdl_frame <span style="color:#f92672">&lt;=</span> frame;
</span></span><span style="display:flex;"><span>        sdl_r <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_r}};  <span style="color:#75715e">// double signal width (assumes CHANW=4)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sdl_g <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_g}};
</span></span><span style="display:flex;"><span>        sdl_b <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_b}};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>Note how we increase <code>SX_OFFS</code> to 3 because it takes an additional cycle to lookup the pixel colour using the CLUT.</p>
<p>We now have two ways of changing colours: editing the pixels in the bitmap or changing the palette.</p>
<p>Try changing the palette to <code>sweetie16_4b.mem</code> and editing the pixels in <code>hourglass.mem</code>. The transparent colour is set by the <code>TRANS_INDX</code> parameter.</p>
<h2 id="hedgehog">Hedgehog</h2>
<p>Let&rsquo;s try something a little bit more artistic. Rather than continue to inflict my drawing skills on you, I&rsquo;m using the adorable hedgehog from the Amiga platformer, <a href="https://www.lemonamiga.com/games/details.php?id=1023">Superfrog</a>. You can download Team 17 Amiga games from <a href="http://dream17.abime.net/downloads.php?cat=1">Dream 17</a>.</p>
<p><img src="/img/posts/hardware-sprites/hedgehog-enlarged.png" alt="Hedgehog" title="Hedgehog"></p>
<p>The hedgehog graphic is 32x20 for a total of 640 pixels. The original Amiga game uses 32 colours, of which the hedgehog uses ten, plus one transparent colour. As with the hourglass graphic, we use four bits per pixel.</p>
<p>The memory requirement for this sprite is: <code>32 x 20 x 4 = 2,560 or 2.5 kilobits</code>.</p>
<p>I use a tool called <a href="https://github.com/projf/fpgatools">img2fmem</a> to convert the sprite image to <strong>[<a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/res/sprites/hedgehog.mem">hedgehog.mem</a>]</strong>.</p>
<blockquote>
<p><strong>Sync ROM</strong><br>
Using async ROM consumes logic. For larger sprites you might prefer to use a synchronous ROM (BRAM): <strong>[<a href="https://github.com/projf/projf-explore/blob/main/lib/memory/rom_sync.sv">rom_sync.sv</a>]</strong>. You will need to adjust <code>SX_OFFS</code> and the <code>WAIT_DATA</code> state to account for the increased latency.</p>
</blockquote>
<p>The hedgehog palette looks like this:</p>
<p><img src="/img/posts/hardware-sprites/hedgehog-palette.png" alt="Hedgehog Palette" title="The colour of the hedge"></p>
<p>Next we make our hedgehog&rsquo;s world a little more interesting by creating a landscape. We do this by with horizontal bars of colour in the background:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#75715e">// background colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [COLRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] bg_colr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>      (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)   bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h239</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">80</span>)  bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h24A</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">140</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h25B</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">190</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h26C</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">230</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h27D</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">265</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h29E</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">295</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h2BF</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">320</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h260</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We move our hedgehog down the screen to walk on the ground:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (rst_pix) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// start off screen and level with grass
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sprx <span style="color:#f92672">&lt;=</span> H_RES;
</span></span><span style="display:flex;"><span>        spry <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">240</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/xc7/top_hedgehog.sv">xc7/top_hedgehog.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/ice40/top_hedgehog.sv">ice40/top_hedgehog.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/hardware-sprites/sim/top_hedgehog.sv">sim/top_hedgehog.sv</a></strong></li>
</ul>
<p>Arty version shown below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_hedgehog (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst_n,    <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_100m,
</span></span><span style="display:flex;"><span>       .rst(<span style="color:#f92672">!</span>btn_rst_n),  <span style="color:#75715e">// reset button is active low
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_5x(),  <span style="color:#75715e">// not used for VGA output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// reset in pixel clock domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> rst_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> rst_pix <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>clk_pix_locked;  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;  <span style="color:#75715e">// signed coordinate width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de, frame, line;
</span></span><span style="display:flex;"><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de,
</span></span><span style="display:flex;"><span>        .frame,
</span></span><span style="display:flex;"><span>        .line
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// screen dimensions (must match display_inst)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> H_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CHANW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;         <span style="color:#75715e">// colour channel width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> COLRW <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">*</span>CHANW;   <span style="color:#75715e">// colour width: three channels (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CIDXW <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;         <span style="color:#75715e">// colour index width (bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> TRANS_INDX <span style="color:#f92672">=</span> <span style="color:#ae81ff">&#39;h9</span>;  <span style="color:#75715e">// transparant colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> PAL_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hedgehog_4b.mem&#34;</span>;  <span style="color:#75715e">// palette file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sprite parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SX_OFFS    <span style="color:#f92672">=</span>  <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">// horizontal screen offset (pixels): +1 for CLUT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;  <span style="color:#75715e">// bitmap width in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>;  <span style="color:#75715e">// bitmap height in pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_SCALE  <span style="color:#f92672">=</span>  <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// 2^2 = 4x scale
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_DRAWW  <span style="color:#f92672">=</span> SPR_WIDTH <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>SPR_SCALE;  <span style="color:#75715e">// draw width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_SPX    <span style="color:#f92672">=</span>  <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// horizontal speed (pixels/frame)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SPR_FILE   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hedgehog.mem&#34;</span>;  <span style="color:#75715e">// bitmap file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sprx, spry;  <span style="color:#75715e">// draw sprite at position (sprx,spry)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// update sprite position once per frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (frame) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (sprx <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span>SPR_DRAWW) sprx <span style="color:#f92672">&lt;=</span> H_RES;  <span style="color:#75715e">// move back to right of screen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span> sprx <span style="color:#f92672">&lt;=</span> sprx <span style="color:#f92672">-</span> SPR_SPX;  <span style="color:#75715e">// otherwise keep moving left
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (rst_pix) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// start off screen and level with grass
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            sprx <span style="color:#f92672">&lt;=</span> H_RES;
</span></span><span style="display:flex;"><span>            spry <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">240</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> drawing;  <span style="color:#75715e">// drawing at (sx,sy)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CIDXW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_pix_indx;  <span style="color:#75715e">// pixel colour index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sprite #(
</span></span><span style="display:flex;"><span>        .CORDW(CORDW),
</span></span><span style="display:flex;"><span>        .H_RES(H_RES),
</span></span><span style="display:flex;"><span>        .SX_OFFS(SX_OFFS),
</span></span><span style="display:flex;"><span>        .SPR_FILE(SPR_FILE),
</span></span><span style="display:flex;"><span>        .SPR_WIDTH(SPR_WIDTH),
</span></span><span style="display:flex;"><span>        .SPR_HEIGHT(SPR_HEIGHT),
</span></span><span style="display:flex;"><span>        .SPR_SCALE(SPR_SCALE),
</span></span><span style="display:flex;"><span>        .SPR_DATAW(CIDXW)
</span></span><span style="display:flex;"><span>        ) sprite_hedgehog (
</span></span><span style="display:flex;"><span>        .clk(clk_pix),
</span></span><span style="display:flex;"><span>        .rst(rst_pix),
</span></span><span style="display:flex;"><span>        .line,
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .sprx,
</span></span><span style="display:flex;"><span>        .spry,
</span></span><span style="display:flex;"><span>        .pix(spr_pix_indx),
</span></span><span style="display:flex;"><span>        .drawing
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// colour lookup table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [COLRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] spr_pix_colr;
</span></span><span style="display:flex;"><span>    clut_simple #(
</span></span><span style="display:flex;"><span>        .COLRW(COLRW),
</span></span><span style="display:flex;"><span>        .CIDXW(CIDXW),
</span></span><span style="display:flex;"><span>        .F_PAL(PAL_FILE)
</span></span><span style="display:flex;"><span>        ) clut_instance (
</span></span><span style="display:flex;"><span>        .clk_write(clk_pix),
</span></span><span style="display:flex;"><span>        .clk_read(clk_pix),
</span></span><span style="display:flex;"><span>        .we(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_write(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .cidx_read(spr_pix_indx),
</span></span><span style="display:flex;"><span>        .colr_in(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        .colr_out(spr_pix_colr)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// account for transparency and delay drawing signal to match CLUT delay (1 cycle)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> drawing_t1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) drawing_t1 <span style="color:#f92672">&lt;=</span> drawing <span style="color:#f92672">&amp;&amp;</span> (spr_pix_indx <span style="color:#f92672">!=</span> TRANS_INDX);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// background colour
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [COLRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] bg_colr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (line) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>      (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)   bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h239</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">80</span>)  bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h24A</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">140</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h25B</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">190</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h26C</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">230</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h27D</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">265</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h29E</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">295</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h2BF</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">==</span> <span style="color:#ae81ff">320</span>) bg_colr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">12&#39;h260</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint colours
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> {paint_r, paint_g, paint_b} <span style="color:#f92672">=</span> (drawing_t1) <span style="color:#f92672">?</span> spr_pix_colr <span style="color:#f92672">:</span> bg_colr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// VGA Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
</span></span><span style="display:flex;"><span>        vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (de) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            vga_r <span style="color:#f92672">&lt;=</span> paint_r;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> paint_g;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> paint_b;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// VGA colour should be black in blanking interval
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            vga_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p>Here&rsquo;s our finished landscape with hedgehog:</p>
<p><img src="/img/posts/hardware-sprites/hedgehog-720p.png" alt="Hedgehog walking under the sky" title="Hedgehog: FPGA Capture"></p>
<h2 id="explore">Explore</h2>
<p>I hope you enjoyed this instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few sprite suggestions:</p>
<ul>
<li>Design your own 8x8 spaceship sprite</li>
<li>Use buttons to control the position of a sprite on screen</li>
<li>Add additional hedgehogs sprite instances to the final design</li>
<li>Draw the numbers 0-9 as sprites and use them to score <a href="/posts/fpga-pong/">Pong</a></li>
</ul>
<h2 id="sprite-engine">Sprite Engine</h2>
<p>This sprite design works for simple cases but lacks many desirable features for games. In 2023, I plan to write about a sprite engine, including external memory, animated graphics, rotation, and collision detection.</p>
<h2 id="next-time">Next Time</h2>
<p>In the next part, we learn about <a href="/posts/framebuffers/">framebuffers</a> and bitmap graphics. Check out the <a href="/demos/">demo</a> and <a href="/tutorials/">tutorial</a> sections for more FPGA projects.</p>
<p><em>Get in touch with <a href="https://mastodon.social/@WillFlux">@WillFlux</a> or join me on <a href="https://github.com/projf/projf-explore/discussions">GitHub Discussions</a> and <a href="https://discord.gg/cf869yDbXf">1BitSquared Discord</a>.</em></p>

      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>©2023 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://badgers.projectf.io/script.js" data-site="EVCGKVDN" defer></script>



</body>
</html>

