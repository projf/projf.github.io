<!doctype html><html class="not-ready lg:text-base" style=--bg:#fff lang=en-gb><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Animated Shapes - Project F</title>
<meta name=theme-color><meta name=description content="Welcome back to Exploring FPGA Graphics. In the final part of our introductory graphics series, we&rsquo;re looking at animation. We&rsquo;ve already seen animation with hardware sprites, but double buffering gives us maximum creative freedom with fast, tear-free motion."><meta name=author content="Will Green"><link rel="preload stylesheet" as=style href=https://projectf.io/main.min.css><link rel=preload as=image href=https://projectf.io/theme.png><link rel=preload as=image href=https://projectf.io/twitter.svg><link rel=preload as=image href=https://projectf.io/github.svg><link rel=preload as=image href=https://projectf.io/mastodon.svg><link rel=preload as=image href=https://projectf.io/rss.svg><script defer src=https://projectf.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://projectf.io/favicon.ico><link rel=apple-touch-icon href=https://projectf.io/apple-touch-icon.png><meta name=generator content="Hugo 0.125.3"><script src=https://cdn-eu.usefathom.com/script.js data-site=EVCGKVDN defer></script><meta itemprop=name content="Animated Shapes"><meta itemprop=description content="Welcome back to Exploring FPGA Graphics. In the final part of our introductory graphics series, we&rsquo;re looking at animation. We&rsquo;ve already seen animation with hardware sprites, but double buffering gives us maximum creative freedom with fast, tear-free motion."><meta itemprop=datePublished content="2021-08-31T00:00:00+00:00"><meta itemprop=dateModified content="2024-01-15T00:00:00+00:00"><meta itemprop=wordCount content="1856"><meta itemprop=image content="https://projectf.io/img/posts/animated-shapes/social-card.png"><meta itemprop=keywords content="Graphics,Arty-A7,Icebreaker,Verilator"><meta property="og:url" content="https://projectf.io/posts/animated-shapes/"><meta property="og:site_name" content="Project F"><meta property="og:title" content="Animated Shapes"><meta property="og:description" content="Welcome back to Exploring FPGA Graphics. In the final part of our introductory graphics series, we&amp;rsquo;re looking at animation. We&amp;rsquo;ve already seen animation with hardware sprites, but double buffering gives us maximum creative freedom with fast, tear-free motion."><meta property="og:locale" content="en-gb"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-31T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-15T00:00:00+00:00"><meta property="article:tag" content="Graphics"><meta property="article:tag" content="Arty-A7"><meta property="article:tag" content="Icebreaker"><meta property="article:tag" content="Verilator"><meta property="og:image" content="https://projectf.io/img/posts/animated-shapes/social-card.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://projectf.io/img/posts/animated-shapes/social-card.png"><meta name=twitter:title content="Animated Shapes"><meta name=twitter:description content="Welcome back to Exploring FPGA Graphics. In the final part of our introductory graphics series, we&rsquo;re looking at animation. We&rsquo;ve already seen animation with hardware sprites, but double buffering gives us maximum creative freedom with fast, tear-free motion."><link rel=canonical href=https://projectf.io/posts/animated-shapes/></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-4xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://projectf.io/>Project F</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#fff".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/demos/>Demos</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/verilog-lib/>Lib</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tools/>Tools</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/tutorials/>Tutorials</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/@WillFlux target=_blank rel=me>twitter
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/projf target=_blank rel=me>github
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./mastodon.svg) href=https://mastodon.social/@WillFlux target=_blank rel=me>mastodon
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://projectf.io/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-4xl px-8 pb-4 pt-4 dark:prose-invert"><article><header class=mb-4><h1 class="!my-0 pb-2.5">Animated Shapes</h1><div class="text-sm antialiased opacity-60">Published
<time>31 Aug 2021</time>
<span class=mx-1>&#183;</span>
<span>Updated
<time>15 Jan 2024</time></span></div></header><section><p>Welcome back to <em>Exploring FPGA Graphics</em>. In the final part of our introductory graphics series, we&rsquo;re looking at animation. We&rsquo;ve already seen animation with <a href=/posts/hardware-sprites/>hardware sprites</a>, but double buffering gives us maximum creative freedom with fast, tear-free motion. We&rsquo;ll be making extensive use of our designs from <a href=/posts/fpga-shapes/>2D Shapes</a>, so have a look back at that post if you need a refresher on drawing shapes.</p><p>In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. New to the series? Start with <a href=/posts/fpga-graphics/>Beginning FPGA Graphics</a>.</p><p>Share your thoughts with @WillFlux on <a href=https://mastodon.social/@WillFlux>Mastodon</a> or <a href=https://twitter.com/WillFlux>Twitter</a>. If you like what I do, <a href=https://github.com/sponsors/WillGreen>sponsor me</a>. üôè</p><p><img src=/img/posts/animated-shapes/banner.png alt title></p><h3 id=series-outline>Series Outline</h3><ul><li><a href=/posts/fpga-graphics/>Beginning FPGA Graphics</a> - video signals and basic graphics</li><li><a href=/posts/racing-the-beam/>Racing the Beam</a> - simple demo effects with minimal logic</li><li><a href=/posts/fpga-pong/>FPGA Pong</a> - recreate the classic arcade on an FPGA</li><li><a href=/posts/display-signals/>Display Signals</a> - revisit display signals and meet colour palettes</li><li><a href=/posts/hardware-sprites/>Hardware Sprites</a> - fast, colourful graphics for games</li><li><a href=/posts/framebuffers/>Framebuffers</a> - bitmap graphics featuring Michelangelo&rsquo;s David</li><li><a href=/posts/lines-and-triangles/>Lines and Triangles</a> - drawing lines and triangles</li><li><a href=/posts/fpga-shapes/>2D Shapes</a> - filled shapes and simple pictures</li><li>Animated Shapes (this post) - animation and double-buffering</li></ul><h3 id=requirements>Requirements</h3><p>You should be to run these designs on any recent FPGA board. I include everything you need for the <a href=https://docs.icebreaker-fpga.org/hardware/icebreaker/>iCEBreaker</a> with <a href=https://docs.icebreaker-fpga.org/hardware/pmod/dvi/>12-Bit DVI Pmod</a>, <a href=https://digilent.com/reference/programmable-logic/arty-a7/reference-manual>Digilent Arty A7-35T</a> with <a href=https://digilent.com/reference/pmod/pmodvga/reference-manual>Pmod VGA</a>, <a href=https://digilent.com/reference/programmable-logic/nexys-video/reference-manual>Digilent Nexys Video</a> with on-board HDMI output, and <a href=/posts/verilog-sim-verilator-sdl/>Verilator Simulation with SDL</a>. See <a href=/posts/fpga-graphics/#requirements>requirements</a> from <em>Beginning FPGA Graphics</em> for more details.</p><h2 id=blazing-a-trail>Blazing a Trail</h2><p>Early on this series, we <a href=/posts/racing-the-beam/#bounce>animated a bouncing square</a>; now we&rsquo;re going to do it with a framebuffer. We take a filled square and bounce it around the screen, changing its colour every few frames. This design uses a single framebuffer hence the &ldquo;sb&rdquo; name.</p><ul><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/ice40/top_demo_sb.sv>ice40/top_demo_sb.sv</a></strong></li><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/xc7/top_demo_sb.sv>xc7/top_demo_sb.sv</a></strong></li><li>Nexys Video (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/xc7-dvi/top_demo_sb.sv>xc7-dvi/top_demo_sb.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/sim/top_demo_sb.sv>sim/top_demo_sb.sv</a></strong></li></ul><p>The square rendering module:</p><ul><li><strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/160x90/render_square_colr.sv>160x90/render_square_colr.sv</a></strong> (4 colour)</li><li><strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/320x180/render_square_colr.sv>320x180/render_square_colr.sv</a></strong> (16 colour)</li></ul><blockquote><p><strong>Building the Designs</strong><br>In the <a href=https://github.com/projf/projf-explore/tree/main/graphics/animated-shapes>Animated Shapes</a> section of the git repo, you&rsquo;ll find the design files, a makefile for iCEBreaker and Verilator, and a Vivado project for Xilinx-based boards. There are also build instructions for boards and simulations.</p></blockquote><p>Our framebuffer remembers all the squares we&rsquo;ve drawn, so the screen gradually fills with striped colour. While this is a fun effect, it&rsquo;s not usually what you want.</p><p><img src=/img/posts/animated-shapes/bounce-sb.png alt="Bounce Single Buffer" title="Verilator simulation running under macOS."></p><h3 id=clean-movement>Clean Movement</h3><p>There are three approaches we can take to move an object around the screen cleanly:</p><ol><li>Use <a href=/posts/hardware-sprites/>hardware sprites</a> - suitable for simple 2D graphics</li><li>Use a blitter to cut out and move a framebuffer region - effective for small 2D objects</li><li>Clear the framebuffer and draw from scratch - versatile but requires plenty of bandwidth</li></ol><p>For this post, we&rsquo;ll go with option 3, but more than that, we&rsquo;ll also introduce double buffering.</p><h2 id=double-buffering>Double Buffering</h2><p>We can&rsquo;t draw in a framebuffer while the display controller reads it; otherwise, we&rsquo;ll get <a href=https://en.wikipedia.org/wiki/Screen_tearing>tearing</a>. We could limit ourselves to drawing in the vertical blanking interval, but even for 640x480 with its generous blanking, we&rsquo;d only be able to draw for less than 10% of the time. This is not enough time to do much interesting, especially as we probably want to clear the framebuffer before drawing each frame.</p><p>To draw all the time, we can double up our buffers: drawing in one while the display controller reads from the other. That way, we can be drawing all the time and avoid screen tearing. The only downsides are the need for twice the memory, and an extra frame of latency before the new output is visible.</p><p>Double-buffer:</p><ul><li>iCEBreaker (iCE40): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/ice40/top_demo.sv>ice40/top_demo.sv</a></strong></li><li>Arty (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/xc7/top_demo.sv>xc7/top_demo.sv</a></strong></li><li>Nexys Video (XC7): <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/xc7-dvi/top_demo.sv>xc7-dvi/top_demo.sv</a></strong></li><li>Verilator Sim: <strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/sim/top_demo.sv>sim/top_demo.sv</a></strong></li></ul><p>If you build this demo you&rsquo;ll see a single square cleanly bounce around the screen.</p><p>The Verilator version looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#66d9ef>module</span> top_demo #(<span style=color:#66d9ef>parameter</span> CORDW<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>) (  <span style=color:#75715e>// signed coordinate width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> clk_pix,      <span style=color:#75715e>// pixel clock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>input</span>  <span style=color:#66d9ef>wire</span> <span style=color:#66d9ef>logic</span> rst_pix,      <span style=color:#75715e>// sim reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_sx,  <span style=color:#75715e>// horizontal SDL position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_sy,  <span style=color:#75715e>// vertical SDL position
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> sdl_de,       <span style=color:#75715e>// data enable (low in blanking interval)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> sdl_frame,    <span style=color:#75715e>// high at start of frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_r,  <span style=color:#75715e>// 8-bit red
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_g,  <span style=color:#75715e>// 8-bit green
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>output</span>      <span style=color:#66d9ef>logic</span> [<span style=color:#ae81ff>7</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sdl_b   <span style=color:#75715e>// 8-bit blue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// system clock is the same as pixel clock in simulation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> clk_sys, rst_sys;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        clk_sys <span style=color:#f92672>=</span> clk_pix;
</span></span><span style=display:flex><span>        rst_sys <span style=color:#f92672>=</span> rst_pix;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display sync signals and coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] sx, sy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> de, frame, line;
</span></span><span style=display:flex><span>    display_480p #(.CORDW(CORDW)) display_inst (
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .rst_pix,
</span></span><span style=display:flex><span>        .sx,
</span></span><span style=display:flex><span>        .sy,
</span></span><span style=display:flex><span>        .hsync(),
</span></span><span style=display:flex><span>        .vsync(),
</span></span><span style=display:flex><span>        .de,
</span></span><span style=display:flex><span>        .frame,
</span></span><span style=display:flex><span>        .line
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// library resource path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> LIB_RES <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../../../lib/res&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// colour parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CHANW <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;        <span style=color:#75715e>// colour channel width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> COLRW <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>*</span>CHANW;  <span style=color:#75715e>// colour width: three channels (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> CIDXW <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;        <span style=color:#75715e>// colour index width (bits)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> BG_COLR <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#39;h137</span>;  <span style=color:#75715e>// background colour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> PAL_FILE <span style=color:#f92672>=</span> {LIB_RES,<span style=color:#e6db74>&#34;/palettes/teleport16_4b.mem&#34;</span>};  <span style=color:#75715e>// palette file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// framebuffer (FB)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_WIDTH  <span style=color:#f92672>=</span> <span style=color:#ae81ff>320</span>;  <span style=color:#75715e>// framebuffer width in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_HEIGHT <span style=color:#f92672>=</span> <span style=color:#ae81ff>180</span>;  <span style=color:#75715e>// framebuffer height in pixels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_SCALE  <span style=color:#f92672>=</span>   <span style=color:#ae81ff>2</span>;  <span style=color:#75715e>// framebuffer display scale (1-63)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_OFFX   <span style=color:#f92672>=</span>   <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// horizontal offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_OFFY   <span style=color:#f92672>=</span>  <span style=color:#ae81ff>60</span>;  <span style=color:#75715e>// vertical offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_PIXELS <span style=color:#f92672>=</span> FB_WIDTH <span style=color:#f92672>*</span> FB_HEIGHT;  <span style=color:#75715e>// total pixels in buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_ADDRW  <span style=color:#f92672>=</span> $clog2(FB_PIXELS);  <span style=color:#75715e>// address width
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> FB_DATAW  <span style=color:#f92672>=</span> CIDXW;  <span style=color:#75715e>// colour bits per pixel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// pixel read and write addresses and colours
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [FB_ADDRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] fb_addr_write, fb_addr_clear, fb_addr_render;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [FB_ADDRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] fb_addr_read;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [FB_DATAW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] fb_colr_write, fb_colr_clear, fb_colr_render;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [FB_DATAW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] fb_colr_read, fb_colr_read_0, fb_colr_read_1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> fb_we;  <span style=color:#75715e>// framebuffer write enable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// buffer selection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> fb_front;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// framebuffer memories
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    bram_sdp #(
</span></span><span style=display:flex><span>        .WIDTH(FB_DATAW),
</span></span><span style=display:flex><span>        .DEPTH(FB_PIXELS),
</span></span><span style=display:flex><span>        .INIT_F(<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    ) bram_inst_0 (
</span></span><span style=display:flex><span>        .clk_write(clk_sys),
</span></span><span style=display:flex><span>        .clk_read(clk_sys),
</span></span><span style=display:flex><span>        .we(fb_we <span style=color:#f92672>&amp;&amp;</span> fb_front),
</span></span><span style=display:flex><span>        .addr_write(fb_addr_write),
</span></span><span style=display:flex><span>        .addr_read(fb_addr_read),
</span></span><span style=display:flex><span>        .data_in(fb_colr_write),
</span></span><span style=display:flex><span>        .data_out(fb_colr_read_0)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    bram_sdp #(
</span></span><span style=display:flex><span>        .WIDTH(FB_DATAW),
</span></span><span style=display:flex><span>        .DEPTH(FB_PIXELS),
</span></span><span style=display:flex><span>        .INIT_F(<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    ) bram_inst_1 (
</span></span><span style=display:flex><span>        .clk_write(clk_sys),
</span></span><span style=display:flex><span>        .clk_read(clk_sys),
</span></span><span style=display:flex><span>        .we(fb_we <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>fb_front),
</span></span><span style=display:flex><span>        .addr_write(fb_addr_write),
</span></span><span style=display:flex><span>        .addr_read(fb_addr_read),
</span></span><span style=display:flex><span>        .data_in(fb_colr_write),
</span></span><span style=display:flex><span>        .data_out(fb_colr_read_1)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display flags in system clock domain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> frame_sys, line_sys, line0_sys;
</span></span><span style=display:flex><span>    xd xd_frame (.clk_src(clk_pix), .clk_dst(clk_sys),
</span></span><span style=display:flex><span>        .flag_src(frame), .flag_dst(frame_sys));
</span></span><span style=display:flex><span>    xd xd_line  (.clk_src(clk_pix), .clk_dst(clk_sys),
</span></span><span style=display:flex><span>        .flag_src(line),  .flag_dst(line_sys));
</span></span><span style=display:flex><span>    xd xd_line0 (.clk_src(clk_pix), .clk_dst(clk_sys),
</span></span><span style=display:flex><span>        .flag_src(line <span style=color:#f92672>&amp;&amp;</span> sy<span style=color:#f92672>==</span>FB_OFFY), .flag_dst(line0_sys));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// draw in framebuffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> render_start;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> render_done;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// framebuffer state machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>enum</span> {IDLE, INIT, CLEAR, DRAW, DONE} state;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_sys) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> (state)
</span></span><span style=display:flex><span>            INIT: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                state <span style=color:#f92672>&lt;=</span> CLEAR;
</span></span><span style=display:flex><span>                fb_front <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>~</span>fb_front; <span style=color:#75715e>// swap buffers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                fb_addr_clear <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                fb_colr_clear <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>&#39;h0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            CLEAR: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                fb_addr_clear <span style=color:#f92672>&lt;=</span> fb_addr_clear <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (fb_addr_clear <span style=color:#f92672>==</span> FB_PIXELS<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>&lt;=</span> DRAW;
</span></span><span style=display:flex><span>                    render_start <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            DRAW: <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>                state <span style=color:#f92672>&lt;=</span> render_done <span style=color:#f92672>?</span> DONE <span style=color:#f92672>:</span> DRAW;
</span></span><span style=display:flex><span>                render_start <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            DONE: state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>if</span> (frame_sys) state <span style=color:#f92672>&lt;=</span> INIT;  <span style=color:#75715e>// IDLE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>endcase</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst_sys) state <span style=color:#f92672>&lt;=</span> IDLE;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_sys) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        fb_addr_write <span style=color:#f92672>&lt;=</span> (state <span style=color:#f92672>==</span> CLEAR) <span style=color:#f92672>?</span> fb_addr_clear <span style=color:#f92672>:</span> fb_addr_render;
</span></span><span style=display:flex><span>        fb_colr_write <span style=color:#f92672>&lt;=</span> (state <span style=color:#f92672>==</span> CLEAR) <span style=color:#f92672>?</span> fb_colr_clear <span style=color:#f92672>:</span> fb_colr_render;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// render shapes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>parameter</span> DRAW_SCALE <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// relative to framebuffer dimensions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> drawing;  <span style=color:#75715e>// actively drawing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> clip;  <span style=color:#75715e>// location is clipped
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> <span style=color:#66d9ef>signed</span> [CORDW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] drx, dry;  <span style=color:#75715e>// draw coordinates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    render_square_colr #(  <span style=color:#75715e>// switch module name to change demo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .CORDW(CORDW),
</span></span><span style=display:flex><span>        .CIDXW(CIDXW),
</span></span><span style=display:flex><span>        .SCALE(DRAW_SCALE)
</span></span><span style=display:flex><span>    ) render_instance (
</span></span><span style=display:flex><span>        .clk(clk_sys),
</span></span><span style=display:flex><span>        .rst(rst_sys),
</span></span><span style=display:flex><span>        .oe(<span style=color:#ae81ff>1</span><span style=color:#ae81ff>&#39;b1</span>),
</span></span><span style=display:flex><span>        .start(render_start),
</span></span><span style=display:flex><span>        .x(drx),
</span></span><span style=display:flex><span>        .y(dry),
</span></span><span style=display:flex><span>        .cidx(fb_colr_render),
</span></span><span style=display:flex><span>        .drawing,
</span></span><span style=display:flex><span>        .done(render_done)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// calculate pixel address in framebuffer (three-cycle latency)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    bitmap_addr #(
</span></span><span style=display:flex><span>        .CORDW(CORDW),
</span></span><span style=display:flex><span>        .ADDRW(FB_ADDRW)
</span></span><span style=display:flex><span>    ) bitmap_addr_instance (
</span></span><span style=display:flex><span>        .clk(clk_sys),
</span></span><span style=display:flex><span>        .bmpw(FB_WIDTH),
</span></span><span style=display:flex><span>        .bmph(FB_HEIGHT),
</span></span><span style=display:flex><span>        .x(drx),
</span></span><span style=display:flex><span>        .y(dry),
</span></span><span style=display:flex><span>        .offx(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .offy(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .addr(fb_addr_render),
</span></span><span style=display:flex><span>        .clip
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// delay write enable to match address calculation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>localparam</span> LAT_ADDR <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;  <span style=color:#75715e>// latency (cycles)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [LAT_ADDR<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] fb_we_sr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_sys) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        fb_we_sr <span style=color:#f92672>&lt;=</span> {drawing, fb_we_sr[LAT_ADDR<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span>]};
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rst_sys) fb_we_sr <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        fb_we <span style=color:#f92672>&lt;=</span> (state <span style=color:#f92672>==</span> CLEAR) <span style=color:#f92672>||</span> (fb_we_sr[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>clip);  <span style=color:#75715e>// check for clipping
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// read framebuffer for display output via linebuffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select buffer to read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_sys) fb_colr_read <span style=color:#f92672>&lt;=</span> fb_front <span style=color:#f92672>?</span> fb_colr_read_1 <span style=color:#f92672>:</span> fb_colr_read_0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// count lines for scaling via linebuffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [$clog2(FB_SCALE)<span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] cnt_lb_line;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_sys) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line0_sys) cnt_lb_line <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (line_sys) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>            cnt_lb_line <span style=color:#f92672>&lt;=</span> (cnt_lb_line <span style=color:#f92672>==</span> FB_SCALE<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>?</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>:</span> cnt_lb_line <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// which screen lines need linebuffer?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> lb_line;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_sys) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line0_sys) lb_line <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;  <span style=color:#75715e>// enable from sy==0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (frame_sys) lb_line <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// disable at frame start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// enable linebuffer input
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> lb_en_in;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>logic</span> [$clog2(FB_WIDTH)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] cnt_lbx;  <span style=color:#75715e>// horizontal pixel counter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> lb_en_in <span style=color:#f92672>=</span> (lb_line <span style=color:#f92672>&amp;&amp;</span> cnt_lb_line <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> cnt_lbx <span style=color:#f92672>&lt;</span> FB_WIDTH);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// calculate framebuffer read address for linebuffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_sys) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (line_sys) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// reset horizontal counter at start of line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            cnt_lbx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (lb_en_in) <span style=color:#66d9ef>begin</span>  <span style=color:#75715e>// increment address when LB enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            fb_addr_read <span style=color:#f92672>&lt;=</span> fb_addr_read <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            cnt_lbx <span style=color:#f92672>&lt;=</span> cnt_lbx <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (frame_sys) fb_addr_read <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>;  <span style=color:#75715e>// reset address at frame start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// enable linebuffer output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> lb_en_out;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>localparam</span> LAT_LB <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;  <span style=color:#75715e>// latency compensation: lb_en_out+1, DB+1, LB+1, CLUT+1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        lb_en_out <span style=color:#f92672>&lt;=</span> (sy <span style=color:#f92672>&gt;=</span> FB_OFFY <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>&lt;</span> (FB_HEIGHT <span style=color:#f92672>*</span> FB_SCALE) <span style=color:#f92672>+</span> FB_OFFY
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> sx <span style=color:#f92672>&gt;=</span> FB_OFFX <span style=color:#f92672>-</span> LAT_LB <span style=color:#f92672>&amp;&amp;</span> sx <span style=color:#f92672>&lt;</span> (FB_WIDTH <span style=color:#f92672>*</span> FB_SCALE) <span style=color:#f92672>+</span> FB_OFFX <span style=color:#f92672>-</span> LAT_LB);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display linebuffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [FB_DATAW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] lb_colr_out;
</span></span><span style=display:flex><span>    linebuffer_simple #(
</span></span><span style=display:flex><span>        .DATAW(FB_DATAW),
</span></span><span style=display:flex><span>        .LEN(FB_WIDTH)
</span></span><span style=display:flex><span>    ) linebuffer_instance (
</span></span><span style=display:flex><span>        .clk_sys,
</span></span><span style=display:flex><span>        .clk_pix,
</span></span><span style=display:flex><span>        .line,
</span></span><span style=display:flex><span>        .line_sys,
</span></span><span style=display:flex><span>        .en_in(lb_en_in),
</span></span><span style=display:flex><span>        .en_out(lb_en_out),
</span></span><span style=display:flex><span>        .scale(FB_SCALE),
</span></span><span style=display:flex><span>        .data_in(fb_colr_read),
</span></span><span style=display:flex><span>        .data_out(lb_colr_out)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// colour lookup table (CLUT)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [COLRW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] fb_pix_colr;
</span></span><span style=display:flex><span>    clut_simple #(
</span></span><span style=display:flex><span>        .COLRW(COLRW),
</span></span><span style=display:flex><span>        .CIDXW(CIDXW),
</span></span><span style=display:flex><span>        .F_PAL(PAL_FILE)
</span></span><span style=display:flex><span>        ) clut_instance (
</span></span><span style=display:flex><span>        .clk_write(clk_pix),
</span></span><span style=display:flex><span>        .clk_read(clk_pix),
</span></span><span style=display:flex><span>        .we(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .cidx_write(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .cidx_read(lb_colr_out),
</span></span><span style=display:flex><span>        .colr_in(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        .colr_out(fb_pix_colr)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// paint screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> paint_area;  <span style=color:#75715e>// area of screen to paint
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CHANW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] paint_r, paint_g, paint_b;  <span style=color:#75715e>// colour channels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_comb</span> <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        paint_area <span style=color:#f92672>=</span> (sy <span style=color:#f92672>&gt;=</span> FB_OFFY <span style=color:#f92672>&amp;&amp;</span> sy <span style=color:#f92672>&lt;</span> (FB_HEIGHT <span style=color:#f92672>*</span> FB_SCALE) <span style=color:#f92672>+</span> FB_OFFY
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> sx <span style=color:#f92672>&gt;=</span> FB_OFFX <span style=color:#f92672>&amp;&amp;</span> sx <span style=color:#f92672>&lt;</span> (FB_WIDTH <span style=color:#f92672>*</span> FB_SCALE) <span style=color:#f92672>+</span> FB_OFFX);
</span></span><span style=display:flex><span>        {paint_r, paint_g, paint_b} <span style=color:#f92672>=</span> paint_area <span style=color:#f92672>?</span> fb_pix_colr <span style=color:#f92672>:</span> BG_COLR;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// display colour: paint colour but black in blanking interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>logic</span> [CHANW<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>] display_r, display_g, display_b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>always_comb</span> {display_r, display_g, display_b} <span style=color:#f92672>=</span> (de) <span style=color:#f92672>?</span> {paint_r, paint_g, paint_b} <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SDL output (8 bits per colour channel)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>always_ff</span> @(<span style=color:#66d9ef>posedge</span> clk_pix) <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        sdl_sx <span style=color:#f92672>&lt;=</span> sx;
</span></span><span style=display:flex><span>        sdl_sy <span style=color:#f92672>&lt;=</span> sy;
</span></span><span style=display:flex><span>        sdl_de <span style=color:#f92672>&lt;=</span> de;
</span></span><span style=display:flex><span>        sdl_frame <span style=color:#f92672>&lt;=</span> frame;
</span></span><span style=display:flex><span>        sdl_r <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_r}};
</span></span><span style=display:flex><span>        sdl_g <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_g}};
</span></span><span style=display:flex><span>        sdl_b <span style=color:#f92672>&lt;=</span> {<span style=color:#ae81ff>2</span>{display_b}};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>endmodule</span>
</span></span></code></pre></div><p>We now have two BRAM instances <code>bram_inst_0</code> and <code>bram_inst_1</code> and a finite state machine to handle clearing the buffers.</p><p>The front buffer is read into the linebufer for display, while we draw into the back buffer in the same way as previous designs. We select buffers using the <code>fb_front</code> signal.</p><h3 id=shattered-cube>Shattered Cube</h3><p>Back when we learnt about <a href=/posts/fpga-shapes/#filled-triangle>filled triangles</a> we built a cube, now we can tear it apart:</p><ul><li><strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/160x90/render_square_colr.sv>160x90/render_cube_shatter.sv</a></strong></li><li><strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/320x180/render_square_colr.sv>320x180/render_cube_shatter.sv</a></strong></li></ul><p>Replace replace <code>render_*</code> with <code>render_cube_shatter</code> in your top module and rebuild.</p><p><img src=/img/posts/animated-shapes/cube-shatter.png alt="Cube Shatter" title="Verilator simulation running under macOS."></p><h3 id=teleport>Teleport</h3><p>Using our double-buffer and a few animated rectangles we can create a teleport effect:</p><ul><li><strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/160x90/render_teleport.sv>160x90/render_teleport.sv</a></strong></li><li><strong><a href=https://github.com/projf/projf-explore/blob/main/graphics/animated-shapes/320x180/render_teleport.sv>320x180/render_teleport.sv</a></strong></li></ul><p>Replace replace <code>render_*</code> with <code>render_teleport</code> in your top module and rebuild.</p><p><img src=/img/posts/animated-shapes/teleport.png alt=Teleport! title="Verilator simulation running under macOS."></p><h2 id=explore>Explore</h2><p>I hope you enjoyed this instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. The double-buffered <a href=/posts/sinescroll/>Sine Scroller Demo</a> could be a useful starting point.</p><h2 id=whats-next>What&rsquo;s Next?</h2><p>If you enjoyed this post, please <a href=https://github.com/sponsors/WillGreen>sponsor me</a>. Sponsors help me create more FPGA and RISC-V projects for everyone, <em>and</em> they get early access to blog posts and source code. üôè</p><p>This is the end of the current series of FPGA Graphics. Watch out for a future series covering more advanced graphics. Until then, why not check out my FPGA <a href=/demos/>demos</a> and <a href=/tutorials/>tutorials</a> for more FPGA projects.</p></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/graphics>graphics</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/arty-a7>arty-a7</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/icebreaker>icebreaker</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://projectf.io/tags/verilator>verilator</a></footer></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-4xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto><a class=link href=https://projectf.io/>Project F</a>: A little oasis for FPGA and RISC-V design.
&copy; 2024 Will Green.</div></footer></body></html>