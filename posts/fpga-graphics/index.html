<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Beginning FPGA Graphics | Project F: FPGA Dev</title>

<meta property='og:title' content='Beginning FPGA Graphics - Project F: FPGA Dev'>
<meta property='og:description' content='Welcome to Exploring FPGA Graphics. In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. Along the way, you&rsquo;ll experience a range of designs and techniques, from memory and finite state machines to crossing clock domains and translating C algorithms into Verilog.'>
<meta property='og:url' content='https://projectf.io/posts/fpga-graphics/'>
<meta property='og:site_name' content='Project F: FPGA Dev'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/fpga-graphics/social-card.png'><meta property='article:published_time' content='2020-05-20T00:00:00Z'><meta property='article:modified_time' content='2022-06-13T00:00:00Z'><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F: FPGA Dev">

<link rel="stylesheet" href="/css/style.css"><link rel='stylesheet' href='https://projectf.io/css/custom.css'>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/fpga-graphics/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F: FPGA Dev</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf/projf-explore'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="mastodon" href='https://mastodon.social/@WillFlux'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M 11.966876,0.80329086 C 9.1123466,0.82665791 6.3664935,1.1367094 4.7662978,1.8737549 c 0,0 -3.1736685,1.4237835 -3.1736685,6.2815982 0,1.1123884 -0.021554,2.4424309 0.013571,3.8529439 0.1152443,4.750677 0.8683725,9.432704 5.2479219,10.595273 2.0193066,0.53604 3.7531218,0.648348 5.1494078,0.571373 2.532141,-0.140797 3.953603,-0.906282 3.953603,-0.906282 l -0.08353,-1.842608 c 0,0 -1.809527,0.572181 -3.841713,0.50245 -2.013417,-0.06922 -4.138986,-0.217713 -4.4646269,-2.696937 -0.030082,-0.217772 -0.045075,-0.450712 -0.045075,-0.695267 0,0 1.9765387,0.484554 4.4813709,0.599656 1.531629,0.07049 2.9679,-0.08996 4.426746,-0.264563 2.797636,-0.335045 5.233581,-2.063856 5.539741,-3.643517 0.482392,-2.488386 0.442651,-6.0725219 0.442651,-6.0725219 0,-4.8578147 -3.173492,-6.2815982 -3.173492,-6.2815982 C 17.639136,1.1367094 14.891579,0.82669685 12.03704,0.80329086 Z"/>
  <path d="M 6.4286668,14.016701 V 9.1034254 c 0,-1.0041614 0.2549569,-1.8022059 0.7670342,-2.3925638 0.5280486,-0.590366 1.2196579,-0.8929946 2.0781049,-0.8929946 0.9931961,0 1.7452181,0.3828583 2.2425191,1.1486808 L 11.999859,7.7793695 12,11.451148 11.999859,7.7793695 12.483392,6.9665478 C 12.980596,6.2007253 13.732618,5.817867 14.72592,5.817867 c 0.858341,0 1.549951,0.3026286 2.078097,0.8929946 0.511971,0.5903579 0.766887,1.3884024 0.766887,2.3925638 v 4.9132756" />
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/@projf'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg>
</i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/demos">
          <h2 class="title is-5">Demos</h2>
        </a><a class="nav-item" href="/howto">
          <h2 class="title is-5">How To</h2>
        </a><a class="nav-item" href="/tags/news">
          <h2 class="title is-5">News</h2>
        </a><a class="nav-item" href="/tutorials">
          <h2 class="title is-5">Tutorials</h2>
        </a><a class="nav-item" href="/verilog-lib">
          <h2 class="title is-5">Verilog Lib</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/graphics/">#graphics</a>




      
    </div>
    <h2 class="subtitle is-6">20 May 2020</h2>
    <h1 class="title">Beginning FPGA Graphics</h1>
    
    <div class="content">
      <p>Welcome to <em>Exploring FPGA Graphics</em>. In this series, we learn about graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how screens work, play Pong, create starfields and sprites, paint Michelangelo&rsquo;s David, draw lines and triangles, and animate characters and shapes. Along the way, you&rsquo;ll experience a range of designs and techniques, from memory and finite state machines to crossing clock domains and translating C algorithms into Verilog. This post was last updated in June 2022.</p>
<p><strong>This post was completely revised in March 2022.</strong></p>
<p><em>Get in touch with <a href="https://mastodon.social/@WillFlux">@WillFlux</a> or join me on <a href="https://github.com/projf/projf-explore/discussions">GitHub Discussions</a> and <a href="https://discord.gg/cf869yDbXf">1BitSquared Discord</a>.</em></p>
<p><img src="/img/posts/fpga-graphics/banner.png" alt="" title=""></p>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li>Beginning FPGA Graphics (this post) - video signals and basic graphics</li>
<li><a href="/posts/racing-the-beam/">Racing the Beam</a> - simple demo effects with minimal logic</li>
<li><a href="/posts/fpga-pong/">FPGA Pong</a> - recreate the classic arcade on an FPGA</li>
<li><a href="/posts/display-signals/">Display Signals</a> - revisit display signals and meet colour palettes</li>
<li><a href="/posts/hardware-sprites/">Hardware Sprites</a> - fast, colourful graphics for games</li>
<li><a href="/posts/framebuffers/">Framebuffers</a> - bitmap graphics featuring Michelangelo&rsquo;s David</li>
<li><a href="/posts/lines-and-triangles/">Lines and Triangles</a> - drawing lines and triangles</li>
<li><a href="/posts/fpga-shapes/">2D Shapes</a> - filled shapes and simple pictures</li>
<li><a href="/posts/animated-shapes/">Animated Shapes</a> - animation and double-buffering</li>
</ul>
<blockquote>
<p><strong>Sponsor My Work</strong><br>
If you like what I do, consider <a href="https://github.com/sponsors/WillGreen">sponsoring me</a> on GitHub.<br>
I love FPGAs and want to help more people discover and use them in their projects.<br>
My hardware designs are open source, and my blog is advert free.</p>
</blockquote>
<h3 id="requirements">Requirements</h3>
<p>For this series, you need an FPGA board with video output. We&rsquo;ll be working at 640x480, so almost any video output will work. It helps to be comfortable with programming your FPGA board and reasonably familiar with Verilog. If you don&rsquo;t have a dev board, not to worry, you can use the Verilator simulator.</p>
<p>We&rsquo;ll demonstrate the designs with two boards and one simulator:</p>
<ul>
<li><strong><a href="https://docs.icebreaker-fpga.org/hardware/icebreaker/">iCEBreaker</a></strong> (Lattice iCE40) with <strong><a href="https://docs.icebreaker-fpga.org/hardware/pmod/dvi/">12-Bit DVI Pmod</a></strong></li>
<li><strong><a href="https://digilent.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a></strong> (Xilinx Artix-7) with <strong><a href="https://digilent.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a></strong></li>
<li><strong><a href="/posts/verilog-sim-verilator-sdl/">Verilator Simulation with SDL</a></strong> - free hardware sim that runs on your PC</li>
</ul>
<p><img src="/img/posts/fpga-graphics/arty-icebreaker.jpg" alt="iCEBreaker and Arty Dev Boards" title="iCEBreaker with DVI Pmod, Arty with Pmod VGA"></p>
<h3 id="source">Source</h3>
<p>The SystemVerilog designs featured in this series are available from the <strong><a href="https://github.com/projf/projf-explore/tree/main/graphics">projf-explore</a></strong> git repo under the open-source MIT licence: build on them to your heart&rsquo;s content. The rest of the blog content is subject to standard copyright restrictions: don&rsquo;t republish it without permission.</p>
<blockquote>
<p><strong>SystemVerilog</strong><br>
We&rsquo;ll use a few choice features from SystemVerilog to make Verilog a little more pleasant. If you&rsquo;re familiar with Verilog, you&rsquo;ll have no trouble. All the SystemVerilog features used are compatible with recent versions of Verilator, Yosys, and Xilinx Vivado.</p>
</blockquote>
<h2 id="space-and-time">Space and Time</h2>
<p>A screen is a miniature universe with its own space and time.</p>
<p>Seem from afar, a screen shows a smooth two-dimensional image. Up close, it breaks up into many individual blocks of colour: red, green, and blue. We hide this complexity behind the abstract idea of a <strong>pixel</strong>: the smallest part of the screen we can control. A typical HD screen is 1920 by 1080: two million pixels in total. Even a 640x480 display has more than 300,000 pixels.</p>
<p>A screen creates the illusion of movement by refreshing many times every second. At 60 Hz, a 1920x1080 screen draws 124 million pixels every second! The need to quickly handle so much data is a big part of the challenge of working with graphics at a hardware level.</p>
<p>Display connectors and cabling vary, but VGA, HDMI, and DisplayPort have a similar data design. There are three channels for colour, usually red, green, and blue, and horizontal and vertical sync signals. There may also be audio and configuration data, but that&rsquo;s not important right now.</p>
<p>The red, green, and blue channels carry the colour of each pixel in turn. A screen begins a new line when it receives a <strong>horizontal sync</strong> and a new frame on a <strong>vertical sync</strong>. The sync signals are part of <strong>blanking</strong> intervals.</p>
<p>Blanking intervals allow time for the electron gun in cathode ray tubes (CRTs) to move to the following line (horizontal retrace) or top of the screen (vertical retrace). Modern digital displays have retained the blanking intervals and repurposed them to transmit audio and other data.</p>
<p>Check out Tim Hunkin&rsquo;s <a href="https://www.youtube.com/watch?v=dEW8QoJ-5Co">Secret Life of the Television</a> (1987) to see a CRT television cut in half and its inner workings revealed.</p>
<p><img src="/img/posts/fpga-graphics/raster-scan.png" alt="Raster scan on a CRT Monitor" title="CRT raster scan by Ian Harvey in the public domain from https://commons.wikimedia.org/wiki/File:Raster-scan.svg"></p>
<h2 id="display-timings">Display Timings</h2>
<p>A screen mode is defined by its <strong>display timings</strong>. Standard timings are set by <a href="https://en.wikipedia.org/wiki/Video_Electronics_Standards_Association">VESA</a> and the <a href="https://en.wikipedia.org/wiki/Consumer_Technology_Association">CTA</a>.</p>
<p>In this series, we&rsquo;ll use <strong>640x480 at 60Hz</strong>. Almost all displays support 640x480, and its low resource requirements make it possible to work with even the smallest FPGAs.</p>
<p>Display timings for 640x480 at 60Hz in units of pixels:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th style="text-align:right">Horizontal</th>
<th style="text-align:right">Vertical</th>
</tr>
</thead>
<tbody>
<tr>
<td>Active Pixels</td>
<td style="text-align:right">640</td>
<td style="text-align:right">480</td>
</tr>
<tr>
<td>Front Porch</td>
<td style="text-align:right">16</td>
<td style="text-align:right">10</td>
</tr>
<tr>
<td>Sync Width</td>
<td style="text-align:right">96</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td>Back Porch</td>
<td style="text-align:right">48</td>
<td style="text-align:right">33</td>
</tr>
<tr>
<td>Total Blanking</td>
<td style="text-align:right">160</td>
<td style="text-align:right">45</td>
</tr>
<tr>
<td>Total Pixels</td>
<td style="text-align:right">800</td>
<td style="text-align:right">525</td>
</tr>
<tr>
<td>Sync Polarity</td>
<td style="text-align:right">negative</td>
<td style="text-align:right">negative</td>
</tr>
</tbody>
</table>
<p><em>For other screen modes, see <a href="/posts/video-timings-vga-720p-1080p/">Video Timings: VGA, SVGA, 720p, 1080p</a>.</em></p>
<p>The blanking interval has three parts: <strong>front porch</strong>, <strong>sync</strong>, and <strong>back porch</strong>. The front porch occurs before the sync signal, the back porch after.</p>
<p>If your screen showed all parts of the signal, it would look something like this:</p>
<p><img src="/img/posts/fpga-graphics/display-timings.png" alt="Display Timings Visualized" title="Sitting on the back porch."></p>
<p>Including blanking, we have a total of 800x525 pixels.</p>
<p>The refresh rate is 60 Hz, so the total number of pixels per second is:</p>
<p><code>800 x 525 x 60 = 25,200,000</code></p>
<p>Therefore, we want a <strong>pixel clock</strong> of 25.2 MHz.</p>
<h2 id="driving-a-display">Driving a Display</h2>
<p>Having selected our display timings, we&rsquo;re ready to create a video signal. There are four stages:</p>
<ol>
<li>Pixel Clock</li>
<li>Display Signals</li>
<li>Drawing Graphics</li>
<li>Video Output (VGA, HDMI, DisplayPort)</li>
</ol>
<p><img src="/img/posts/fpga-graphics/driving-a-display.png" alt="Driving a Display" title="Board oscillator in... video out"></p>
<h2 id="pixel-clock">Pixel Clock</h2>
<p>We know we want a frequency of 25.2 MHz, but how to reach it?</p>
<p>FPGAs include <strong><a href="https://en.wikipedia.org/wiki/Phase-locked_loop">phase-locked loops</a></strong> (PLLs) to generate custom clock frequencies. Alas, there isn&rsquo;t a standard way to configure a PLL; we need a vendor-specific design.</p>
<p>I have provided implementations for the Arty (Xilinx 7 Series) and iCEBreaker (iCE40):</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/lib/clock/xc7/clock_480p.sv">xc7/clock_480p.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/lib/clock/ice40/clock_480p.sv">ice40/clock_480p.sv</a></strong></li>
</ul>
<p><em>NB. The iCEBreaker can&rsquo;t generate 25.2 MHz but runs fine at 25.125 MHz.</em></p>
<p>For other FPGA architectures, you&rsquo;ll need to consult your vendor documentation. If you can&rsquo;t reach 25.2 MHz exactly, 25 MHz or thereabouts should be fine.</p>
<blockquote>
<p><strong>CAUTION: CRT Monitors</strong><br>
Modern displays, including <a href="https://en.wikipedia.org/wiki/Multisync_monitor">multisync CRTs</a>, should be fine with a 25.2 or 25 MHz pixel clock. Fixed-frequency CRTs, such as the original IBM 85xx series, could be damaged by an out-of-spec signal. Use these designs at your own risk.</p>
</blockquote>
<h2 id="display-signals">Display Signals</h2>
<p>Next, we can generate sync signals from our pixel clock and display timings. We also want to report the current screen position to know <em>when</em> to draw things.</p>
<p>We do both of these things with a simple display module <strong>[<a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/simple_480p.sv">simple_480p.sv</a>]</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> simple_480p (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_pix,   <span style="color:#75715e">// pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst_pix,   <span style="color:#75715e">// reset in pixel clock domain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">9</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx,  <span style="color:#75715e">// horizontal screen position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">9</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sy,  <span style="color:#75715e">// vertical screen position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> hsync,     <span style="color:#75715e">// horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vsync,     <span style="color:#75715e">// vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> de         <span style="color:#75715e">// data enable (low in blanking interval)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// horizontal timings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HA_END <span style="color:#f92672">=</span> <span style="color:#ae81ff">639</span>;           <span style="color:#75715e">// end of active pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HS_STA <span style="color:#f92672">=</span> HA_END <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>;   <span style="color:#75715e">// sync starts after front porch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HS_END <span style="color:#f92672">=</span> HS_STA <span style="color:#f92672">+</span> <span style="color:#ae81ff">96</span>;   <span style="color:#75715e">// sync ends
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> LINE   <span style="color:#f92672">=</span> <span style="color:#ae81ff">799</span>;           <span style="color:#75715e">// last pixel on line (after back porch)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// vertical timings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> VA_END <span style="color:#f92672">=</span> <span style="color:#ae81ff">479</span>;           <span style="color:#75715e">// end of active pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> VS_STA <span style="color:#f92672">=</span> VA_END <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>;   <span style="color:#75715e">// sync starts after front porch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> VS_END <span style="color:#f92672">=</span> VS_STA <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>;    <span style="color:#75715e">// sync ends
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SCREEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">524</span>;           <span style="color:#75715e">// last line on screen (after back porch)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        hsync <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>(sx <span style="color:#f92672">&gt;=</span> HS_STA <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> HS_END);  <span style="color:#75715e">// invert: negative polarity
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        vsync <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>(sy <span style="color:#f92672">&gt;=</span> VS_STA <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> VS_END);  <span style="color:#75715e">// invert: negative polarity
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        de <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&lt;=</span> HA_END <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;=</span> VA_END);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// calculate horizontal and vertical screen position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (sx <span style="color:#f92672">==</span> LINE) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// last pixel on line?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            sx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            sy <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">==</span> SCREEN) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> sy <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// last line on screen?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            sx <span style="color:#f92672">&lt;=</span> sx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (rst_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            sx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            sy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p><em>ProTip: The last assignment wins in Verilog, so the reset overrides existing values for <code>sx</code> and <code>sy</code>.</em></p>
<p><strong>sx</strong> and <strong>sy</strong> store the horizontal and vertical screen position. Counting starts at zero, so the maximum values are 799 for <code>sx</code> and 524 for <code>sy</code>, requiring 10 bits to hold the coordinates (2<sup>10</sup> = 1024).</p>
<p>For simplicity, we put blanking <em>after</em> the visible pixels; that way, <code>(0,0)</code> is the top-left visible pixel and <code>(639,479)</code> the bottom right.</p>
<p>The following diagram shows the display signals to scale with two 64x64 pixel squares drawn:</p>
<p><img src="/img/posts/fpga-graphics/simple-display-signals.png" alt="Simple Display Signals" title=""></p>
<p><strong>de</strong> is <em>data enable</em>, which is low during the blanking interval (grey area of above diagram) and tells us when it&rsquo;s safe to draw.</p>
<p>From the display timings, we know our sync polarity is negative for both <strong>hsync</strong> and <strong>vsync</strong>. Negative polarity means that a <em>low voltage</em> indicates a sync.</p>
<p>The following simulation shows the vertical sync starting at line 489. The vertical sync is low for two lines, as expected from the display timings. Note the horizontal sync at the end of each line.</p>
<p><img src="/img/posts/fpga-graphics/hsync-vsync-vga.png" alt="Sync Signal Simulation" title="Simulating VGA horizontal &amp; vertical sync signals"></p>
<h3 id="test-benches">Test Benches</h3>
<p>If you&rsquo;re using Vivado, try exercising the designs with these test benches:</p>
<ul>
<li><strong><a href="https://github.com/projf/projf-explore/tree/main/lib/clock/xc7/clock_tb.sv">Clock Test Bench</a></strong></li>
<li><strong><a href="https://github.com/projf/projf-explore/tree/main/graphics/fpga-graphics/xc7/simple_480p_tb.sv">Simple Display Test Bench</a></strong></li>
</ul>
<p>Some things to check:</p>
<ul>
<li>What is the pixel clock period?</li>
<li>How long does the pixel clock take to lock?</li>
<li>Does a frame last exactly 1/60th of a second?</li>
<li>How much time does a single line last?</li>
<li>What is the maximum values of <code>sx</code> and <code>sy</code> when <code>de</code> is low?</li>
</ul>
<p><em>You can find instructions for running the Vivado simulations in the source <a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/README.md">README</a>.</em></p>
<h2 id="drawing-graphics">Drawing Graphics</h2>
<p>For our first design, we&rsquo;re going to draw a square like this:</p>
<p><img src="/img/posts/fpga-graphics/square.png" alt="Square" title="All persons should report on board as the vessel is about to proceed to sea."></p>
<p>We use the screen coordinates <code>(sx,sy)</code> to define a square in the centre of the screen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">logic</span> square;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    square <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">220</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">420</span>) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">140</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">340</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h3 id="12-bit-colour">12-bit Colour</h3>
<p>The VGA and DVI Pmods output 12-bit colour with three 4-bit channels: red, green, and blue.</p>
<p>We can represent a specific colour using a <a href="https://en.wikipedia.org/wiki/Web_colors#Hex_triplet">hex triplet</a>:</p>
<ul>
<li><code>#F00</code> - bright red</li>
<li><code>#FA0</code> - orange</li>
<li><code>#0E3</code> - bright green</li>
<li><code>#137</code> - dark blue</li>
<li><code>#FFF</code> - white</li>
</ul>
<p>In Verilog, hex literals use the letter <code>h</code>, so we can set our colours as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    paint_r <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>    paint_g <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h3</span>;
</span></span><span style="display:flex;"><span>    paint_b <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h7</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We generate a separate signal for each colour channel, ready for video output.</p>
<h2 id="video-output">Video Output</h2>
<p>Video output works differently for each board and simulation, so we&rsquo;ll cover them in turn.</p>
<h3 id="arty-vga">Arty VGA</h3>
<p>VGA output is straightforward. We register each signal to improve timing and avoid skew:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#75715e">// VGA Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
</span></span><span style="display:flex;"><span>    vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (de) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        vga_r <span style="color:#f92672">&lt;=</span> paint_r;
</span></span><span style="display:flex;"><span>        vga_g <span style="color:#f92672">&lt;=</span> paint_g;
</span></span><span style="display:flex;"><span>        vga_b <span style="color:#f92672">&lt;=</span> paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// VGA colour should be black in blanking interval
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        vga_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        vga_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        vga_b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>The VGA Pmod handles the conversion of digital colour signals into analogue voltages. You need to ensure the colour is black during blanking; otherwise, you&rsquo;ll see corrupted output on some screens.</p>
<h3 id="icebreaker-dvi">iCEBreaker DVI</h3>
<p>The <a href="https://www.ti.com/product/TFP410">TFP410</a> chip on the DVI Pmod takes our colour and sync signals and encodes them into DVI using <a href="https://en.wikipedia.org/wiki/Transition-minimized_differential_signaling">Transition-minimized differential signalling</a> (TMDS).</p>
<p>We use the <strong>SB_IO</strong> primitive to produce high-quality output from the iCE40 FPGA. It&rsquo;s not necessary to understand how SB_IO works for this series; use this snippet in your designs, and all will be well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#75715e">// DVI Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SB_IO #(
</span></span><span style="display:flex;"><span>    .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010100</span>)  <span style="color:#75715e">// PIN_OUTPUT_REGISTERED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>) dvi_signal_io [<span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] (
</span></span><span style="display:flex;"><span>    .PACKAGE_PIN({dvi_hsync, dvi_vsync, dvi_de, dvi_r, dvi_g, dvi_b}),
</span></span><span style="display:flex;"><span>    .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>    .D_OUT_0({hsync, vsync, de, paint_r, paint_g, paint_b}),
</span></span><span style="display:flex;"><span>    .D_OUT_1()
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// DVI Pmod clock output: 180Â° out of phase with other DVI signals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SB_IO #(
</span></span><span style="display:flex;"><span>    .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010000</span>)  <span style="color:#75715e">// PIN_OUTPUT_DDR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>) dvi_clk_io (
</span></span><span style="display:flex;"><span>    .PACKAGE_PIN(dvi_clk),
</span></span><span style="display:flex;"><span>    .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>    .D_OUT_0(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
</span></span><span style="display:flex;"><span>    .D_OUT_1(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><blockquote>
<p><strong>Lattice SB_IO</strong><br>
The SB_IO primitive (with registered outputs) ensures our DVI signals are in sync when they leave the FPGA. The DVI clock is 180 degrees out of phase so that the TFP410 will sample the middle of the colour values. You can learn more about iCE primitives from the <a href="http://media.latticesemi.com/view_document?document_id=52206">Lattice ICE Technology Library</a>.</p>
</blockquote>
<h3 id="verilator-sim">Verilator Sim</h3>
<p>The simulation output is similar to the Arty VGA, but it expects eight bits per colour channel:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#75715e">// SDL output (8 bits per colour channel)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    sdl_sx <span style="color:#f92672">&lt;=</span> sx;
</span></span><span style="display:flex;"><span>    sdl_sy <span style="color:#f92672">&lt;=</span> sy;
</span></span><span style="display:flex;"><span>    sdl_de <span style="color:#f92672">&lt;=</span> de;
</span></span><span style="display:flex;"><span>    sdl_r <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_r}};  <span style="color:#75715e">// double signal width from 4 to 8 bits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sdl_g <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_g}};
</span></span><span style="display:flex;"><span>    sdl_b <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_b}};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h2 id="square-one">Square One</h2>
<p>Bringing the four stages together we have a complete top module:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/xc7/top_square.sv">xc7/top_square.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/ice40/top_square.sv">ice40/top_square.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/sim/top_square.sv">sim/top_square.sv</a></strong></li>
</ul>
<p>All of these top modules are listed in full, below. See if you can match each of the four stages of <a href="#driving-a-display">driving a display</a> with the Verilog for your top module.</p>
<h3 id="arty-vga-square">Arty VGA Square</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_square (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst_n,    <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// VGA horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// VGA vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_100m,
</span></span><span style="display:flex;"><span>       .rst(<span style="color:#f92672">!</span>btn_rst_n),  <span style="color:#75715e">// reset button is active low
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_5x(),  <span style="color:#75715e">// not used for VGA output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;  <span style="color:#75715e">// screen coordinate width in bits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync, de;
</span></span><span style="display:flex;"><span>    simple_480p display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix(<span style="color:#f92672">!</span>clk_pix_locked),  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// define a square with screen coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> square;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        square <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">220</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">420</span>) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">140</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">340</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint colours: white inside square, blue outside
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_r <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h3</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h7</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// VGA Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
</span></span><span style="display:flex;"><span>        vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (de) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>            vga_r <span style="color:#f92672">&lt;=</span> paint_r;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> paint_g;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> paint_b;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// VGA colour should be black in blanking interval
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            vga_r <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_g <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>            vga_b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h3 id="icebreaker-dvi-square">iCEBreaker DVI Square</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_square (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_12m,      <span style="color:#75715e">// 12 MHz clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_clk,      <span style="color:#75715e">// DVI pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_hsync,    <span style="color:#75715e">// DVI horizontal sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_vsync,    <span style="color:#75715e">// DVI vertical sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_de,       <span style="color:#75715e">// DVI data enable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_r,  <span style="color:#75715e">// 4-bit DVI red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_g,  <span style="color:#75715e">// 4-bit DVI green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_b   <span style="color:#75715e">// 4-bit DVI blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// generate pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> clk_pix_locked;
</span></span><span style="display:flex;"><span>    clock_480p clock_pix_inst (
</span></span><span style="display:flex;"><span>       .clk_12m,
</span></span><span style="display:flex;"><span>       .rst(btn_rst),
</span></span><span style="display:flex;"><span>       .clk_pix,
</span></span><span style="display:flex;"><span>       .clk_pix_locked
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;  <span style="color:#75715e">// screen coordinate width in bits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> hsync, vsync, de;
</span></span><span style="display:flex;"><span>    simple_480p display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix(<span style="color:#f92672">!</span>clk_pix_locked),  <span style="color:#75715e">// wait for clock lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync,
</span></span><span style="display:flex;"><span>        .vsync,
</span></span><span style="display:flex;"><span>        .de
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// define a square with screen coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> square;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        square <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">220</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">420</span>) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">140</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">340</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint colours: white inside square, blue outside
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_r <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h3</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h7</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// DVI Pmod output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SB_IO #(
</span></span><span style="display:flex;"><span>        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010100</span>)  <span style="color:#75715e">// PIN_OUTPUT_REGISTERED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) dvi_signal_io [<span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] (
</span></span><span style="display:flex;"><span>        .PACKAGE_PIN({dvi_hsync, dvi_vsync, dvi_de, dvi_r, dvi_g, dvi_b}),
</span></span><span style="display:flex;"><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>        .D_OUT_0({hsync, vsync, de, paint_r, paint_g, paint_b}),
</span></span><span style="display:flex;"><span>        .D_OUT_1()
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// DVI Pmod clock output: 180Â° out of phase with other DVI signals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SB_IO #(
</span></span><span style="display:flex;"><span>        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010000</span>)  <span style="color:#75715e">// PIN_OUTPUT_DDR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ) dvi_clk_io (
</span></span><span style="display:flex;"><span>        .PACKAGE_PIN(dvi_clk),
</span></span><span style="display:flex;"><span>        .OUTPUT_CLK(clk_pix),
</span></span><span style="display:flex;"><span>        .D_OUT_0(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
</span></span><span style="display:flex;"><span>        .D_OUT_1(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><h3 id="verilator-sim-1">Verilator Sim</h3>
<p>The Verilator simulation works a little differently; we output the coordinates <code>sdl_sx</code>, and <code>sdl_sy</code>, as well as the colour information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> top_square #(<span style="color:#66d9ef">parameter</span> CORDW<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>) (  <span style="color:#75715e">// coordinate width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_pix,             <span style="color:#75715e">// pixel clock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> sim_rst,             <span style="color:#75715e">// sim reset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_sx,  <span style="color:#75715e">// horizontal SDL position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_sy,  <span style="color:#75715e">// vertical SDL position
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> sdl_de,              <span style="color:#75715e">// data enable (low in blanking interval)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_r,         <span style="color:#75715e">// 8-bit red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_g,         <span style="color:#75715e">// 8-bit green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sdl_b          <span style="color:#75715e">// 8-bit blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// display sync signals and coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">logic</span> de;
</span></span><span style="display:flex;"><span>    simple_480p display_inst (
</span></span><span style="display:flex;"><span>        .clk_pix,
</span></span><span style="display:flex;"><span>        .rst_pix(sim_rst),
</span></span><span style="display:flex;"><span>        .sx,
</span></span><span style="display:flex;"><span>        .sy,
</span></span><span style="display:flex;"><span>        .hsync(),
</span></span><span style="display:flex;"><span>        .vsync(),
</span></span><span style="display:flex;"><span>        .de
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// define a square with screen coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> square;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        square <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">220</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">420</span>) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">140</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">340</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// paint colours: white inside square, blue outside
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        paint_r <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h3</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> (square) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h7</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// SDL output (8 bits per colour channel)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>        sdl_sx <span style="color:#f92672">&lt;=</span> sx;
</span></span><span style="display:flex;"><span>        sdl_sy <span style="color:#f92672">&lt;=</span> sy;
</span></span><span style="display:flex;"><span>        sdl_de <span style="color:#f92672">&lt;=</span> de;
</span></span><span style="display:flex;"><span>        sdl_r <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_r}};  <span style="color:#75715e">// double signal width from 4 to 8 bits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sdl_g <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_g}};
</span></span><span style="display:flex;"><span>        sdl_b <span style="color:#f92672">&lt;=</span> {<span style="color:#ae81ff">2</span>{paint_b}};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">endmodule</span>
</span></span></code></pre></div><p><em>NB. The Verilator simulation receives its pixel clock from the C++ wrapper, so there&rsquo;s no pixel clock generation in this version.</em></p>
<h2 id="constraints">Constraints</h2>
<p>Before building the design, we need board constraints. The constraints map the pins on the FPGA to the signals in our design. For example, we need to know which FPGA pin connects to the reset button and which to the vertical sync.</p>
<p>Take a look at the constraints for your board:</p>
<ul>
<li>Arty Constraints: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/xc7/arty.xdc">arty.xdc</a></strong></li>
<li>iCEBreaker Constraints: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/ice40/icebreaker.pcf">icebreaker.pcf</a></strong></li>
</ul>
<p>The Verilator sim doesn&rsquo;t require constraints.</p>
<h2 id="building">Building</h2>
<p>Each part of this series includes a <a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/README.md">README</a> and <a href="https://github.com/projf/projf-explore/tree/main/graphics/fpga-graphics/sim">Sim README</a> with build instructions. I have provided basic instructions here to get you started. If you need help with your board or tools, I recommend the <a href="https://forum.digilentinc.com/">Digilent Forum</a> for Arty and <a href="https://discord.gg/cf869yDbXf">1BitSquared Discord</a> for iCEBreaker.</p>
<h3 id="arty">Arty</h3>
<p>We build Arty designs using Xilinx Vivado. To create a Vivado project, clone the <a href="https://github.com/projf/projf-explore">projf-explore repo</a> from GitHub. Then, start Vivado and run the following in the Tcl Console:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tcl" data-lang="tcl"><span style="display:flex;"><span>cd projf-explore<span style="color:#f92672">/</span>graphics<span style="color:#f92672">/</span>fpga-graphics<span style="color:#f92672">/</span>xc7<span style="color:#f92672">/</span>vivado
</span></span><span style="display:flex;"><span>source .<span style="color:#f92672">/</span>create_project.tcl
</span></span></code></pre></div><p>This creates a Vivado project with all four designs from this post.</p>
<h3 id="icebreaker">iCEBreaker</h3>
<p>We build iCEBreaker designs with the open-source toolchain of <a href="http://yosyshq.net/yosys/">Yosys</a>, <a href="https://github.com/YosysHQ/nextpnr">nextpnr</a>, and <a href="http://bygone.clairexen.net/icestorm/">IceStorm Tools</a>. If you don&rsquo;t already have these tools see the <a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/README.md">README</a>.</p>
<p>To build and program the <em>square</em> design; clone the <a href="https://github.com/projf/projf-explore">projf-explore repo</a>, then in a shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd projf-explore/graphics/fpga-graphics/ice40
</span></span><span style="display:flex;"><span>make square
</span></span><span style="display:flex;"><span>iceprog square.bin
</span></span></code></pre></div><p><em>If you have problems building the iCE40 designs, make sure you&rsquo;re using Yosys 0.10 or later.</em></p>
<h3 id="verilator-simulation">Verilator Simulation</h3>
<p>If this is the first time you&rsquo;ve used Verilator and SDL, you need to <a href="https://github.com/projf/projf-explore/tree/main/graphics/fpga-graphics/sim#installing-dependencies">install dependencies</a>.</p>
<p>Make sure you&rsquo;re in the sim directory <code>projf-explore/graphics/fpga-graphics/sim</code>.</p>
<p>Build a specific simulation (square, flag_ethiopia, flag_sweden, or colour):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make square
</span></span></code></pre></div><p>Or build all simulations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make all
</span></span></code></pre></div><p>Run the simulation executables from <code>obj_dir</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./obj_dir/square
</span></span></code></pre></div><p>See also <a href="/posts/verilog-sim-verilator-sdl/">Verilog Simulation with Verilator and SDL</a> and the <a href="https://github.com/projf/projf-explore/tree/main/graphics/fpga-graphics/sim">Simulation README</a>.</p>
<h2 id="flags">Flags</h2>
<p>Our first design is not only a square but also the <a href="https://en.wikipedia.org/wiki/International_maritime_signal_flags">naval signal flag</a> for the letter &lsquo;P&rsquo; (blue Peter).</p>
<p>I have created designs for two more flags: Ethiopia and Sweden. Take a look at these examples, then have a go at drawing a flag yourself.</p>
<h3 id="flag-of-ethiopia">Flag of Ethiopia</h3>
<p>The traditional <a href="https://en.wikipedia.org/wiki/Flag_of_Ethiopia">flag of Ethiopia</a> is a tricolour of green, yellow, and red.</p>
<p><img src="/img/posts/fpga-graphics/flag_ethiopia.png" alt="Traditional Flag of Ethiopia" title=""></p>
<p>We only need the horizontal screen coordinate, <code>sy</code>, to define this flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">160</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// top of flag is green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h9</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">320</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// middle of flag is yellow
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hF</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hE</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// bottom of flag is red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hE</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h1</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>You can find the full flag design in git:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/xc7/top_flag_ethiopia.sv">xc7/top_flag_ethiopia.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/ice40/top_flag_ethiopia.sv">ice40/top_flag_ethiopia.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/sim/top_flag_ethiopia.sv">sim/top_flag_ethiopia.sv</a></strong></li>
</ul>
<h3 id="flag-of-sweden">Flag of Sweden</h3>
<p>The <a href="https://en.wikipedia.org/wiki/Flag_of_Sweden">flag of Sweden</a> consists of a yellow Nordic cross on a blue background.</p>
<p><img src="/img/posts/fpga-graphics/flag_sweden.png" alt="Flag of Sweden" title=""></p>
<p>The official flag has a ratio of 8:5, which equates to 640x400 on our screen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">400</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// black outside the flag area
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sy <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">160</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">240</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// yellow cross horizontal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hF</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hC</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (sx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">200</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">280</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// yellow cross vertical
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hF</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hC</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// blue flag background
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h6</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;hA</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>You can find the full flag design in git:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/xc7/top_flag_sweden.sv">xc7/top_flag_sweden.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/ice40/top_flag_sweden.sv">ice40/top_flag_sweden.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/sim/top_flag_sweden.sv">sim/top_flag_sweden.sv</a></strong></li>
</ul>
<h2 id="colour-test">Colour Test</h2>
<p>No introduction to graphics hardware would be complete without a colour gradient. 12-bit graphics can handle 4,096 colours; this demo shows 256 of them.</p>
<p><img src="/img/posts/fpga-graphics/colour.jpeg" alt="Colour Gradient Test" title="256 fresh colours"></p>
<p>For this example, I&rsquo;ve kept the blue level contant while varying the red and green:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] paint_r, paint_g, paint_b;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// colour square in top-left 256x256 pixels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> sx[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>];  <span style="color:#75715e">// 16 horizontal pixels of each red level
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_g <span style="color:#f92672">=</span> sy[<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>];  <span style="color:#75715e">// 16 vertical pixels of each green level
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h4</span>;     <span style="color:#75715e">// constant blue level
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// otherwise black
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        paint_r <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        paint_g <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>        paint_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4&#39;h0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We select bits <code>[7:4]</code> from <code>sx</code> and <code>sy</code>, so the colour level changes every 16 pixels.</p>
<p>You can find the full design in git:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/xc7/top_colour.sv">xc7/top_colour.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/ice40/top_colour.sv">ice40/top_colour.sv</a></strong></li>
<li>Verilator Sim: <strong><a href="https://github.com/projf/projf-explore/blob/main/graphics/fpga-graphics/sim/top_colour.sv">sim/top_colour.sv</a></strong></li>
</ul>
<h2 id="next-time">Next Time</h2>
<p>I hope you enjoyed this introduction to FPGA Graphics. Next time, we&rsquo;ll be <em><a href="/posts/racing-the-beam/">Racing the Beam</a></em> to create simple demos effects with our new graphics skills.</p>
<h2 id="whats-possible">What&rsquo;s Possible?</h2>
<p>Here are some projects to inspire you:</p>
<ul>
<li><a href="https://bikerglen.com/blog/driving-a-32x32-rgb-led-matrix-with-a-beaglebone-black-and-an-fpga/">Driving a 32Ã32 RGB LED Matrix</a> by Glen Akins</li>
<li><a href="https://github.com/dan-rodrigues/icestation-32">icestation-32: open-source FPGA game console</a> by Dan Rodrigues</li>
<li><a href="https://github.com/mattvenn/vga-clock">VGA Clock</a> by Matt Venn</li>
<li><a href="https://tomverbeure.github.io/rtl/2018/11/26/Racing-the-Beam-Ray-Tracer.html">Racing the Beam Ray Tracer</a> by Tom Verbeure</li>
<li><a href="https://github.com/ultraembedded/FPGAmp">FPGA Media Player</a> by ultraembedded</li>
</ul>
<p><em>Get in touch with <a href="https://mastodon.social/@WillFlux">@WillFlux</a> or join me on <a href="https://github.com/projf/projf-explore/discussions">GitHub Discussions</a> and <a href="https://discord.gg/cf869yDbXf">1BitSquared Discord</a>.</em></p>

      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>Â©2023 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://badgers.projectf.io/script.js" data-site="EVCGKVDN" defer></script>



</body>
</html>

