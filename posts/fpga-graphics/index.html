<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Exploring FPGA Graphics | Project F - FPGA Development</title>

<meta property='og:title' content='Exploring FPGA Graphics - Project F - FPGA Development'>
<meta property='og:description' content='Welcome to Exploring FPGA Graphics. In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how displays work, race the beam with Pong, animate starfields and sprites, paint Michelangelo&rsquo;s David, simulate life with bitmaps, draw lines and shapes, and finally render simple 3D models. Along the way, you&rsquo;ll experience a Smörgåsbord of designs and techniques, from BRAM and finite state machines to crossing clock domains and translating C algorithms into Verilog.'>
<meta property='og:url' content='https://projectf.io/posts/fpga-graphics/'>
<meta property='og:site_name' content='Project F - FPGA Development'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/fpga-graphics/social-card.png'><meta property='article:published_time' content='2020-05-20T00:00:00Z'/><meta property='article:modified_time' content='2020-05-20T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F - FPGA Development" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/fpga-graphics/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="referrer" content="no-referrer, same-origin">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F - FPGA Development</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/sitemap">
          <h2 class="title is-5">Sitemap</h2>
        </a><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/explore">
          <h2 class="title is-5">Explore</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/explore/">#explore</a>



  
  | <a class="subtitle is-6" href="/tags/graphics/">#graphics</a>
  


      
    </div>
    <h2 class="subtitle is-6">20 May 2020</h2>
    <h1 class="title">Exploring FPGA Graphics</h1>
    
    <div class="content">
      <p>Welcome to <em>Exploring FPGA Graphics</em>. In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how displays work, race the beam with Pong, animate starfields and sprites, paint Michelangelo&rsquo;s David, simulate life with bitmaps, draw lines and shapes, and finally render simple 3D models. Along the way, you&rsquo;ll experience a Smörgåsbord of designs and techniques, from BRAM and finite state machines to crossing clock domains and translating C algorithms into Verilog.</p>
<p>We begin with the basics of computer displays and animating shapes in real-time.</p>
<p><em>Updated 2021-04-23. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>
<blockquote>
<p>In all beginnings dwells a magic force<br>
<em>Herman Hesse, Stages from <a href="https://en.wikipedia.org/wiki/The_Glass_Bead_Game">The Glass Bead Game</a></em></p>
</blockquote>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li>Exploring FPGA Graphics (this post) - learn how displays work and animate simple shapes</li>
<li><a href="/posts/fpga-pong/">Pong</a> - race the beam to create the arcade classic</li>
<li><a href="/posts/hardware-sprites/">Hardware Sprites</a> - fast, colourful, graphics with minimal resources</li>
<li><a href="/posts/fpga-ad-astra/">Ad Astra</a> - demo with hardware sprites and animated starfields</li>
<li><a href="/posts/framebuffers/">Framebuffers</a> - driving the display from a bitmap in memory</li>
<li><a href="/posts/life-on-screen/">Life on Screen</a> - the screen comes alive with Conway&rsquo;s Game of Life</li>
<li><a href="/posts/lines-and-triangles/">Lines and Triangles</a> - drawing lines and triangles with a framebuffer</li>
<li><a href="/posts/fpga-shapes/">Shapes</a> - filling and animating shapes</li>
<li>Simple 3D - models and wireframe rendering (draft coming soon)</li>
</ul>
<h3 id="requirements">Requirements</h3>
<p>For this series, you need an FPGA board with video output. We&rsquo;ll be working at 640x480, so pretty much any video output will work. It helps to be comfortable with programming your FPGA board and reasonably familiar with Verilog.</p>
<p>We&rsquo;ll be demoing the designs with two boards:</p>
<ul>
<li><strong><a href="https://docs.icebreaker-fpga.org/hardware/icebreaker/">iCEBreaker</a></strong> (Lattice iCE40) with <strong><a href="https://docs.icebreaker-fpga.org/hardware/pmod/dvi/">12-Bit DVI Pmod</a></strong></li>
<li><strong><a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a></strong> (Xilinx Artix-7) with <strong><a href="https://reference.digilentinc.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a></strong></li>
</ul>
<p>Neither of these boards has built-in video, but it&rsquo;s easy to add with VGA or DVI Pmod.</p>
<p><em>NB. The original Arty (without the A7) is the same as the Arty A7-35T for our purposes.</em></p>
<p><img src="/img/posts/fpga-graphics/arty-icebreaker.jpg" alt="iCEBreaker and Arty Dev Boards" title="iCEBreaker with DVI Pmod, Arty with Pmod VGA, "></p>
<h3 id="source">Source</h3>
<p>The SystemVerilog designs featured in this series are available from the <a href="https://github.com/projf/projf-explore/">projf-explore</a> git repo under the open-source MIT licence: build on them to your heart&rsquo;s content. The rest of the blog content is subject to standard copyright restrictions: don&rsquo;t republish it without permission.</p>
<blockquote>
<p><strong>SystemVerilog?!</strong><br>
We&rsquo;ll use a few choice features from SystemVerilog to make Verilog a little more pleasant (no laughing at the back). If you&rsquo;re familiar with Verilog, you&rsquo;ll have no trouble. All the designs in this series are tested with Yosys and Vivado.</p>
</blockquote>
<h2 id="space-and-time">Space and Time</h2>
<p>A screen is a miniature universe with its own rules of space and time.</p>
<p>Seem from afar, a screen shows a smooth two-dimensional image. Up close, it breaks up into many individual blocks of primary colour: red, green, and blue. We hide this complexity behind the abstract idea of a <strong>pixel</strong>: the smallest part of the screen we can control. A typical HD screen is 1920 by 1080: two million pixels in total. Even an ancient 640x480 VGA screen has more than 300,000 pixels.</p>
<p>To create the illusion of movement, a screen must be redrawn many times every second. A 60 Hz <strong>refresh rate</strong> is typical of computer screens in 2021. At 60 Hz, a 1920x1080 screen is drawing 124 million pixels every second! The need to quickly handle so much data is a big part of the challenge of working with graphics at a hardware level. Ever wondered why you don&rsquo;t see many microcontrollers hooked up to TVs?</p>
<p>Display connectors and cabling vary, but VGA, HDMI, and DisplayPort have a shared data design. There are three channels for colour, usually red, green, and blue, and there are horizontal and vertical sync signals. There may also be audio and configuration data, but that&rsquo;s not important right now.</p>
<p>The red, green, and blue channels carry the colour of each pixel in turn. A screen begins a new line when it receives a <strong>horizontal sync</strong> and a new frame on a <strong>vertical sync</strong>. The sync signals are part of <strong>blanking</strong> intervals. Blanking intervals exist to allow time for the electron gun in cathode ray tubes (CRTs) to move to the following line (horizontal retrace) or top of the screen (vertical retrace). Modern digital displays retained blanking intervals, repurposing them to transmit audio and other data.</p>
<p><img src="/img/posts/fpga-graphics/raster-scan.png" alt="Raster scan on a CRT Monitor" title="CRT raster scan by Ian Harvey in the public domain from https://commons.wikimedia.org/wiki/File:Raster-scan.svg"></p>
<h2 id="display-timings">Display Timings</h2>
<p>In this series, we&rsquo;re going to use <strong>640x480 at 60Hz</strong>. Almost all displays support 640x480, and its low resource requirements make it simple to work with on small FPGAs. The same principles apply at higher resolutions, such as 1280x720 and 4K.</p>
<p>We&rsquo;ll use traditional horizontal and vertical timings based on the original VGA specification:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">    640x480 Timings      HOR    VER
    -------------------------------
    Active Pixels        640    480
    Front Porch           16     10
    Sync Width            96      2
    Back Porch            48     33
    Blanking Total       160     45
    Total Pixels         800    525
    Sync Polarity        neg    neg
</code></pre></div><p><em>Learn more from <a href="/posts/video-timings-vga-720p-1080p/">Video Timings: VGA, SVGA, 720p, 1080p</a>.</em></p>
<p>The blanking interval has three parts: <strong>front porch</strong>, <strong>sync</strong>, and <strong>back porch</strong>. The front porch occurs before the sync signal, the back porch after. Taking blanking into account, we have a total of 800x525 pixels. A typical LCD refreshes 60 times a second, so the number of pixels per second is <code>800 x 525 x 60 = 25,200,000</code>, which equates to a <strong>pixel clock</strong> of 25.2 MHz.</p>
<p>If the different parts of the display timings were made visible, they&rsquo;d look something like this:</p>
<p><img src="/img/posts/fpga-graphics/display-timings.png" alt="Display Timings" title="Display Timings"></p>
<blockquote>
<p><strong>CAUTION: CRT Monitors</strong><br>
Modern displays, including <a href="https://en.wikipedia.org/wiki/Multisync_monitor">multisync CRTs</a>, should be fine with a 25.2 or 25 MHz pixel clock. Fixed-frequency CRTs, such as the original IBM 85xx series, could be damaged by an out-of-spec signal. Use these designs at your own risk.</p>
</blockquote>
<h2 id="running-to-time">Running to Time</h2>
<p>We&rsquo;ve decided we need a 25.2 MHz pixel clock, but neither of our demo boards includes such a clock. To reach the required frequency, we&rsquo;re going to use a <strong><a href="https://en.wikipedia.org/wiki/Phase-locked_loop">phase-locked loop</a></strong> (PLL). Almost all FPGAs include one or more PLLs, but there isn&rsquo;t a standard way to configure them in Verilog, so we have to use vendor-specific designs.</p>
<p>We have provided implementations for the Arty (XC7) and iCEBreaker (iCE40); for other FPGAs, you&rsquo;ll need to consult your vendor documentation. If you can&rsquo;t reach 25.2 MHz exactly, then 25 MHz or thereabouts should be fine. The iCE40 can&rsquo;t generate 25.2 MHz using the oscillators on iCEBreaker but works fine at 25.125 MHz.</p>
<h3 id="clock-generator-modules">Clock Generator Modules</h3>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/lib/clock/xc7/clock_gen_480p.sv">xc7/clock_gen_480p.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/lib/clock/ice40/clock_gen_480p.sv">ice40/clock_gen_480p.sv</a></strong></li>
</ul>
<p>These modules are part of the <a href="https://github.com/projf/projf-explore/tree/master/lib">Project F Library</a> of useful Verilog designs.</p>
<h2 id="simple-display-timings">Simple Display Timings</h2>
<p>Using our ~25 MHz pixel clock, we can generate timings for our 640x480 display. Creating display timings is straightforward: there&rsquo;s one counter for horizontal position and one for vertical. We use these counters to decide on the correct time for sync signals.</p>
<p>Create a module for 640x480 60Hz display timings <strong>[<a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/simple_display_timings_480p.sv">simple_display_timings_480p.sv</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> simple_display_timings_480p (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_pix,   <span style="color:#75715e">// pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,       <span style="color:#75715e">// reset
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">9</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx,  <span style="color:#75715e">// horizontal screen position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">9</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sy,  <span style="color:#75715e">// vertical screen position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> hsync,     <span style="color:#75715e">// horizontal sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vsync,     <span style="color:#75715e">// vertical sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> de         <span style="color:#75715e">// data enable (low in blanking interval)
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// horizontal timings
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HA_END <span style="color:#f92672">=</span> <span style="color:#ae81ff">639</span>;           <span style="color:#75715e">// end of active pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HS_STA <span style="color:#f92672">=</span> HA_END <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>;   <span style="color:#75715e">// sync starts after front porch
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HS_END <span style="color:#f92672">=</span> HS_STA <span style="color:#f92672">+</span> <span style="color:#ae81ff">96</span>;   <span style="color:#75715e">// sync ends
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> LINE   <span style="color:#f92672">=</span> <span style="color:#ae81ff">799</span>;           <span style="color:#75715e">// last pixel on line (after back porch)
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// vertical timings
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> VA_END <span style="color:#f92672">=</span> <span style="color:#ae81ff">479</span>;           <span style="color:#75715e">// end of active pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> VS_STA <span style="color:#f92672">=</span> VA_END <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>;   <span style="color:#75715e">// sync starts after front porch
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> VS_END <span style="color:#f92672">=</span> VS_STA <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>;    <span style="color:#75715e">// sync ends
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SCREEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">524</span>;           <span style="color:#75715e">// last line on screen (after back porch)
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        hsync <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>(sx <span style="color:#f92672">&gt;=</span> HS_STA <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">&lt;</span> HS_END);  <span style="color:#75715e">// invert: negative polarity
</span><span style="color:#75715e"></span>        vsync <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>(sy <span style="color:#f92672">&gt;=</span> VS_STA <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> VS_END);  <span style="color:#75715e">// invert: negative polarity
</span><span style="color:#75715e"></span>        de <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&lt;=</span> HA_END <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;=</span> VA_END);
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// calculate horizontal and vertical screen position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (sx <span style="color:#f92672">==</span> LINE) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// last pixel on line?
</span><span style="color:#75715e"></span>            sx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            sy <span style="color:#f92672">&lt;=</span> (sy <span style="color:#f92672">==</span> SCREEN) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> sy <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// last line on screen?
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
            sx <span style="color:#f92672">&lt;=</span> sx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">if</span> (rst) <span style="color:#66d9ef">begin</span>
            sx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            sy <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p><em>ProTip: The last assignment wins in Verilog, so the reset overrides existing values for <code>sx</code> and <code>sy</code>.</em></p>
<p><strong>sx</strong> and <strong>sy</strong> store the horizontal and vertical position; their maximum values are 800 and 525, respectively, so we need 10 bits to hold them (2<sup>10</sup> = 1024).</p>
<p><strong>de</strong> is <em>data enable</em>, which is low during the blanking interval: we use it to decide when to draw pixels.</p>
<p>Display modes vary in their sync polarity; for traditional 640x480, the polarity is negative for both <strong>hsync</strong> and <strong>vsync</strong>. Negative polarity means the voltage is normally high, with low voltage indicating a sync.</p>
<p>The following simulation shows the vertical sync starting at line 489; it&rsquo;s low for two lines as expected from our display timings. Note the horizontal sync at the end of every line.</p>
<p><img src="/img/posts/fpga-graphics/hsync-vsync-vga.png" alt="Sync Signal Simulation" title="Simulating VGA horizontal &amp; vertical sync signals"></p>
<h2 id="test-benches">Test Benches</h2>
<p>You can exercise the designs with the included test benches (Xilinx only):</p>
<ul>
<li><strong><a href="https://github.com/projf/projf-explore/tree/master/lib/clock/xc7/clock_gen_480p_tb.sv">Clock Gen Test Bench</a></strong></li>
<li><strong><a href="https://github.com/projf/projf-explore/tree/master/graphics/exploring-graphics/xc7/simple_display_timings_480p_tb.sv">Display Timings Test Bench</a></strong></li>
</ul>
<p>Some things to check:</p>
<ul>
<li>What is the pixel clock period?</li>
<li>How long does the pixel clock take to lock?</li>
<li>Does a frame last exactly 1/60th of a second?</li>
<li>How much time does a single line last?</li>
<li>What is the maximum values of <code>sx</code> and <code>sy</code> when <code>de</code> is low?</li>
</ul>
<p><em>You can find instructions for running the simulation in the source <a href="https://github.com/projf/projf-explore/tree/master/fpga-graphics">README</a>.</em></p>
<h2 id="driving-a-display">Driving a Display</h2>
<p>Now we have our pixel clock and display signals, we&rsquo;re ready to drive a display. The following diagram shows the basic architecture, with the three Verilog modules and their key signals:</p>
<p><img src="/img/posts/fpga-graphics/driving-a-display.png" alt="Driving a Display" title="Board oscillator in... video out"></p>
<h3 id="square-one">Square One</h3>
<p>We&rsquo;ll keep things simple for the first outing of our display logic: let’s draw a square.
When the screen coordinates, <code>sx</code> and <code>sy</code>, are both less than 32, we draw orange; otherwise, we draw blue.</p>
<p>There are two versions of the square top module, one for each demo board:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/xc7/top_square.sv">xc7/top_square.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/ice40/top_square.sv">ice40/top_square.sv</a></strong></li>
</ul>
<p>We&rsquo;ll review both of them in turn then explain how to build the designs for your board.</p>
<h3 id="arty-vga">Arty VGA</h3>
<p>Take a look at the VGA output of the Arty square module, below. For each colour, we check whether we&rsquo;re in the blanking interval (when de is 0). If we are in the blanking interval, we set the colour intensity to zero. Otherwise, we look at the value of <code>q_draw</code>: if true, we set the pixel to orange; if false, we set it to blue. The colour intensity must be zero in the blanking interval; otherwise, your display may be garbled or misaligned. We want the output signals to be registered and in sync with each other, so we use an <code>always_ff</code> with all five output signals.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top_square (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button (active low)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// generate pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
    <span style="color:#66d9ef">logic</span> clk_locked;
    clock_gen_480p clock_pix_inst (
       .clk(clk_100m),
       .rst(<span style="color:#f92672">!</span>btn_rst),  <span style="color:#75715e">// reset button is active low
</span><span style="color:#75715e"></span>       .clk_pix,
       .clk_locked
    );

    <span style="color:#75715e">// display timings
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;  <span style="color:#75715e">// screen coordinate width in bits
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
    <span style="color:#66d9ef">logic</span> hsync, vsync, de;
    display_timings_480p display_timings_inst (
        .clk_pix,
        .rst(<span style="color:#f92672">!</span>clk_locked),  <span style="color:#75715e">// wait for clock lock
</span><span style="color:#75715e"></span>        .sx,
        .sy,
        .hsync,
        .vsync,
        .de
    );

    <span style="color:#75715e">// 32 x 32 pixel square
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> q_draw;
    <span style="color:#66d9ef">always_comb</span> q_draw <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// VGA output
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        vga_hsync <span style="color:#f92672">&lt;=</span> hsync;
        vga_vsync <span style="color:#f92672">&lt;=</span> vsync;
        vga_r <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">!</span>de <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> (q_draw <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>);
        vga_g <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">!</span>de <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> (q_draw <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h8</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h8</span>);
        vga_b <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">!</span>de <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> (q_draw <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;hF</span>);
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><blockquote>
<p><strong>Representing Colour</strong><br>
The colour output is 12-bit, which is 4 bits per colour channel.<br>
We use a single hex digit from <code>0-F</code> to represent the intensity of red, green, and blue.</p>
</blockquote>
<h3 id="icebreaker-dvi">iCEBreaker DVI</h3>
<p>The iCE40 DVI implementation is similar, but the DVI output requires data enable, <code>de</code>, and pixel clock, <code>clk_pix</code>, too. The <a href="https://www.ti.com/product/TFP410">TFP410</a> chip on the DVI Pmod takes our colour and sync signals and encodes them into DVI using <a href="https://en.wikipedia.org/wiki/Transition-minimized_differential_signaling">Transition-minimized differential signalling</a> (TMDS).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top_square (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_12m,      <span style="color:#75715e">// 12 MHz clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button (active high)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_clk,      <span style="color:#75715e">// DVI pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_hsync,    <span style="color:#75715e">// DVI horizontal sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_vsync,    <span style="color:#75715e">// DVI vertical sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> dvi_de,       <span style="color:#75715e">// DVI data enable
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_r,  <span style="color:#75715e">// 4-bit DVI red
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_g,  <span style="color:#75715e">// 4-bit DVI green
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] dvi_b   <span style="color:#75715e">// 4-bit DVI blue
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// generate pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
    <span style="color:#66d9ef">logic</span> clk_locked;
    clock_gen_480p clock_pix_inst (
       .clk(clk_12m),
       .rst(btn_rst),
       .clk_pix,
       .clk_locked
    );

    <span style="color:#75715e">// display timings
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;  <span style="color:#75715e">// screen coordinate width in bits
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
    <span style="color:#66d9ef">logic</span> hsync, vsync, de;
    display_timings_480p display_timings_inst (
        .clk_pix,
        .rst(<span style="color:#f92672">!</span>clk_locked),  <span style="color:#75715e">// wait for clock lock
</span><span style="color:#75715e"></span>        .sx,
        .sy,
        .hsync,
        .vsync,
        .de
    );

    <span style="color:#75715e">// 32 x 32 pixel square
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> q_draw;
    <span style="color:#66d9ef">always_comb</span> q_draw <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">&amp;&amp;</span> sy <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// colours
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] red, green, blue;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        red   <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>de <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> (q_draw <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;hF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>);
        green <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>de <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> (q_draw <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h8</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h8</span>);
        blue  <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>de <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> (q_draw <span style="color:#f92672">?</span> <span style="color:#ae81ff">4&#39;h0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;hF</span>);
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// Output DVI clock: 180° out of phase with other DVI signals
</span><span style="color:#75715e"></span>    SB_IO #(
        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010000</span>)  <span style="color:#75715e">// PIN_OUTPUT_DDR
</span><span style="color:#75715e"></span>    ) dvi_clk_io (
        .PACKAGE_PIN(dvi_clk),
        .OUTPUT_CLK(clk_pix),
        .D_OUT_0(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),  <span style="color:#75715e">// output not DDR because we disable rising edge out
</span><span style="color:#75715e"></span>        .D_OUT_1(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b1</span>)   <span style="color:#75715e">// output 180° out of phase using falling edge out
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// Output DVI signals
</span><span style="color:#75715e"></span>    SB_IO #(
        .PIN_TYPE(<span style="color:#ae81ff">6</span><span style="color:#ae81ff">&#39;b010100</span>)  <span style="color:#75715e">// PIN_OUTPUT_REGISTERED
</span><span style="color:#75715e"></span>    ) dvi_signal_io [<span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] (
        .PACKAGE_PIN({dvi_hsync, dvi_vsync, dvi_de, dvi_r, dvi_g, dvi_b}),
        .OUTPUT_CLK(clk_pix),
        .D_OUT_0({hsync, vsync, de, red, green, blue}),
        .D_OUT_1()
    );
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><blockquote>
<p><strong>Lattice SB_IO</strong><br>
The SB_IO primitive (with registered outputs) ensures our DVI signals are in sync when they leave the FPGA. The DVI clock is 180 degrees out of phase, so the TFP410 will sample the middle of the colour values. You can learn more about iCE primitives from the <a href="http://media.latticesemi.com/view_document?document_id=52206">Lattice ICE Technology Library</a>.</p>
</blockquote>
<h2 id="constraints">Constraints</h2>
<p>Before building the design, we need board constraints. The constraints map the pins on the FPGA to the signals in our design. For example, we need to know which FPGA pin is connected to the oscillator. The Arty constraints use Xilinx&rsquo;s XDC format, which is written in Tcl.</p>
<p>Take a look at the constraints for your board:</p>
<ul>
<li>Arty Constraints: <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/xc7/arty.xdc">arty.xdc</a></strong></li>
<li>iCEBreaker Constraints: <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/ice40/icebreaker.pcf">icebreaker.pcf</a></strong></li>
</ul>
<h2 id="building">Building</h2>
<p>Every part of <em>FPGA Graphics</em> includes a <a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/README.md">README</a> with build instructions. I have included the basic instructions in this post to get you started. If you need help with your board or tools, I recommend the <a href="https://forum.digilentinc.com/">Digilent Forum</a> for Arty and <a href="https://1bitsquared.com/pages/chat">1BitSquared Discord</a> for iCEBreaker.</p>
<h3 id="arty">Arty</h3>
<p>We build Arty designs using Xilinx Vivado. To create a Vivado project, clone the <a href="https://github.com/projf/projf-explore">projf-explore repo</a> from GitHub. Then, start Vivado and run the following in the Tcl Console:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tcl" data-lang="tcl">cd projf-explore<span style="color:#f92672">/</span>fpga-graphics<span style="color:#f92672">/</span>xc7<span style="color:#f92672">/</span>vivado
source .<span style="color:#f92672">/</span>create_project.tcl
</code></pre></div><h3 id="icebreaker">iCEBreaker</h3>
<p>We build iCEBreaker designs with the open-source toolchain of <a href="http://www.clifford.at/yosys/">Yosys</a>, <a href="https://github.com/YosysHQ/nextpnr">nextpnr</a>, and <a href="http://www.clifford.at/icestorm/">IceStorm Tools</a>. If you don&rsquo;t already have these tools see the <a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/README.md">README</a>.</p>
<p>For example, to build and program <code>top_bounce</code>; clone the <a href="https://github.com/projf/projf-explore">projf-explore repo</a>, then in a shell:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd projf-explore/fpga-graphics/ice40
make top_bounce
iceprog top_bounce.bin
</code></pre></div><h2 id="hip-to-be-square">Hip to be Square</h2>
<p>Once you&rsquo;ve programmed your board, you should see something like this:</p>
<p><img src="/img/posts/fpga-graphics/vga-square.png" alt="A Square" title="Orange and blue; what a lovely combination!"></p>
<p>Try experimenting with your own square size, position, and colours.</p>
<h2 id="animation">Animation</h2>
<p>To create a simple animation, we can update the position of the square every frame. If we move the square during active drawing, we risk <strong><a href="https://en.wikipedia.org/wiki/Screen_tearing">screen tearing</a></strong>, so we create an <code>animate</code> signal at the start of the vertical blanking period.</p>
<p>We&rsquo;re going to replicate the behaviour of the video display itself, scanning across then down the screen. The square &ldquo;beam&rdquo; disappears off the edge of the screen, like the signal in the blanking interval. Try rebuilding the design with <code>top_beam</code>:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/xc7/top_beam.sv">xc7/top_beam.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/ice40/top_beam.sv">ice40/top_beam.sv</a></strong></li>
</ul>
<p>The square animation logic looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// size of screen with and without blanking
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> H_RES_FULL <span style="color:#f92672">=</span> <span style="color:#ae81ff">800</span>;
    <span style="color:#66d9ef">localparam</span> V_RES_FULL <span style="color:#f92672">=</span> <span style="color:#ae81ff">525</span>;
    <span style="color:#66d9ef">localparam</span> H_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span>;
    <span style="color:#66d9ef">localparam</span> V_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">480</span>;

    <span style="color:#66d9ef">logic</span> animate;  <span style="color:#75715e">// high for one clock tick at start of vertical blanking
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> animate <span style="color:#f92672">=</span> (sy <span style="color:#f92672">==</span> V_RES <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);

    <span style="color:#75715e">// square &#39;Q&#39; - origin at top-left
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> Q_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>;    <span style="color:#75715e">// square size in pixels
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> Q_SPEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;    <span style="color:#75715e">// pixels moved per frame
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] qx, qy;  <span style="color:#75715e">// square position
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// update square position once per frame
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (animate) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (qx <span style="color:#f92672">&gt;=</span> H_RES_FULL <span style="color:#f92672">-</span> Q_SIZE) <span style="color:#66d9ef">begin</span>
                qx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                qy <span style="color:#f92672">&lt;=</span> (qy <span style="color:#f92672">&gt;=</span> V_RES_FULL <span style="color:#f92672">-</span> Q_SIZE) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> qy <span style="color:#f92672">+</span> Q_SIZE;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                qx <span style="color:#f92672">&lt;=</span> qx <span style="color:#f92672">+</span> Q_SPEED;
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// is square at current screen position?
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> q_draw;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        q_draw <span style="color:#f92672">=</span> (sx <span style="color:#f92672">&gt;=</span> qx) <span style="color:#f92672">&amp;&amp;</span> (sx <span style="color:#f92672">&lt;</span> qx <span style="color:#f92672">+</span> Q_SIZE)
              <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&gt;=</span> qy) <span style="color:#f92672">&amp;&amp;</span> (sy <span style="color:#f92672">&lt;</span> qy <span style="color:#f92672">+</span> Q_SIZE);
    <span style="color:#66d9ef">end</span>
</code></pre></div><h2 id="bounce">Bounce!</h2>
<p>Now we can animate, we can start to create some interesting effects. By adding collision detection, we can bounce squares around the screen. If we draw three squares: red, green, and blue, we have a simple demo. While simple, it&rsquo;s satisfying to watch the squares combine colours as they move around the screen.</p>
<p>Try rebuilding the design with <code>top_bounce</code>:</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/xc7/top_bounce.sv">xc7/top_bounce.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/exploring-graphics/ice40/top_bounce.sv">ice40/top_bounce.sv</a></strong></li>
</ul>
<p><img src="/img/posts/fpga-graphics/bounce.jpg" alt="Bouncing Squares" title="Bounce!"></p>
<h3 id="collision-detection">Collision Detection</h3>
<p>Collision detection is one of those things that seems trivial but has several subtleties. In our bounce module, each square checks for collisions in both horizontal and vertical directions. We&rsquo;ll make use of this in the next part of this series on <a href="/posts/fpga-pong/">Pong</a>, so it&rsquo;s worth understanding.</p>
<p>Horizontal collision detection example from <code>top_bounce</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#66d9ef">if</span> (q1x <span style="color:#f92672">&gt;=</span> H_RES <span style="color:#f92672">-</span> (Q1_SIZE <span style="color:#f92672">+</span> q1s)) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// right edge
</span><span style="color:#75715e"></span>        q1dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
        q1x <span style="color:#f92672">&lt;=</span> q1x <span style="color:#f92672">-</span> q1s;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (q1x <span style="color:#f92672">&lt;</span> q1s) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// left edge
</span><span style="color:#75715e"></span>        q1dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        q1x <span style="color:#f92672">&lt;=</span> q1x <span style="color:#f92672">+</span> q1s;
    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> q1x <span style="color:#f92672">&lt;=</span> (q1dx) <span style="color:#f92672">?</span> q1x <span style="color:#f92672">-</span> q1s <span style="color:#f92672">:</span> q1x <span style="color:#f92672">+</span> q1s;
</code></pre></div><ul>
<li><code>H_RES</code> - horizontal screen resolution</li>
<li><code>Q1_SIZE</code> - size of 1st square</li>
<li><code>q1x</code> - horizontal position of 1st square</li>
<li><code>q1dx</code> - horizontal direction of 1st square</li>
<li><code>q1s</code> - horizontal speed of 1st square</li>
</ul>
<p>A couple of things to consider:</p>
<ol>
<li>What needs to change to make the left and right edge collision tests symmetrical?</li>
<li>Why do we need to account for the speed of the square?</li>
</ol>
<p>At first blush, it seems we can simplify this to the following, with a single position update for all situations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog">    <span style="color:#75715e">// questionable collision design
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (q1x <span style="color:#f92672">&gt;=</span> H_RES <span style="color:#f92672">-</span> (Q1_SIZE <span style="color:#f92672">+</span> q1s)) q1dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (q1x <span style="color:#f92672">&lt;</span> q1s) q1dx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
    q1x <span style="color:#f92672">&lt;=</span> (q1dx) <span style="color:#f92672">?</span> q1x <span style="color:#f92672">-</span> q1s <span style="color:#f92672">:</span> q1x <span style="color:#f92672">+</span> q1s;
</code></pre></div><p>What&rsquo;s the problem with this approach? Hint: logic in an <code>always_ff</code> block operates in parallel.</p>
<p>Can you suggest a change to the comparisons to make this simpler approach work?</p>
<h2 id="explore">Explore</h2>
<p>I hope you enjoyed the first instalment of <em>Exploring FPGA Graphics</em>. Nothing beats creating your own designs; here are a few suggestions to get you started:</p>
<ul>
<li>Try drawing some <a href="https://en.wikipedia.org/wiki/Gallery_of_sovereign_state_flags">country flags</a> (many are composed of rectangular shapes)</li>
<li>Animate the size of the squares so they grow and shrink</li>
<li>Add collision detection between squares, so they bounce off each other</li>
<li>Create a square Verilog module to avoid code duplication</li>
</ul>
<h2 id="next-time">Next Time</h2>
<p>Next time we&rsquo;ll put your new graphics skills to work recreating the arcade classic: <a href="/posts/fpga-pong/">Pong</a>.</p>
<p><em>Constructive feedback is always welcome. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/hello-arty-2/">Hello Arty - Part 2</a></li>
	
	<li><a href="/posts/hello-arty-1/">Hello Arty - Part 1</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>©2021 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://narwhal.projectf.io/script.js" site="EVCGKVDN" defer></script>
</body>
</html>

