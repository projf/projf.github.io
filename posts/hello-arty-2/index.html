<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Hello Arty - Part 2 | Project F</title>

<meta property='og:title' content='Hello Arty - Part 2 - Project F'>
<meta property='og:description' content='Welcome back to our three-part FPGA tutorial with SystemVerilog and the Digilent Arty A7. In part two, we&rsquo;re going to learn about clocks and counting. Along the way, we&rsquo;ll cover maintaining state with flip-flops, timing things with clock dividers, creating our first Verilog module, and controlling LEDs with pulse width modulation. You might be surprised how far counting take yous: by the end of this tutorial, you&rsquo;ll be creating RGB lighting effects worthy of the best cheesy gaming PC.'>
<meta property='og:url' content='https://projectf.io/posts/hello-arty-2/'>
<meta property='og:site_name' content='Project F'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/arty-board-card.jpg'><meta property='article:published_time' content='2020-05-06T00:00:00Z'/><meta property='article:modified_time' content='2020-05-06T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/hello-arty-2/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/explore">
          <h2 class="title is-5">Explore</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/explore/">#explore</a>




      
    </div>
    <h2 class="subtitle is-6">May 6, 2020</h2>
    <h1 class="title">Hello Arty - Part 2</h1>
    
    <div class="content">
      <p>Welcome back to our three-part FPGA tutorial with <strong>SystemVerilog</strong> and the <strong>Digilent Arty A7</strong>. In part two, we&rsquo;re going to learn about clocks and counting. Along the way, we&rsquo;ll cover maintaining state with flip-flops, timing things with clock dividers, creating our first Verilog module, and controlling LEDs with pulse width modulation. You might be surprised how far counting take yous: by the end of this tutorial, you&rsquo;ll be creating RGB lighting effects worthy of the best cheesy gaming PC.</p>
<p>If you&rsquo;ve not already completed <a href="/posts/hello-arty-1/">part 1</a>, you should start there. In the final part of this series, we&rsquo;ll be covering shift registers, button debouncing, and the all-important finite state machine. Part three will be available later in May 2020.</p>
<p><em>Feedback to <a href="https://twitter.com/WillFlux">@WillFlux</a> is most welcome.</em></p>
<h3 id="requirements">Requirements</h3>
<p>For this series, we are using the <a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/start">Digilent Arty A7-35T</a>, a $130 dev board based on a <a href="https://www.xilinx.com/products/silicon-devices/fpga/artix-7.html">Xilinx Artix-7 FPGA</a>. This board is widely available and supports Xilinx&rsquo;s latest Vivado software, which runs on Linux and Windows 10.</p>
<p>For this <em>Hello Arty</em> series you need:</p>
<ol>
<li><a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/start">Digilent Arty A7-35T</a></li>
<li>Micro USB cable to program and power the Arty board</li>
<li><a href="https://www.xilinx.com/support/documentation-navigation/see-all-versions.html?xlnxproducttypes=Design%20Tools&amp;xlnxdocumentid=UG973">Xilinx Vivado</a> (2019 or later) installed<br>
Linux users need to remember to install cable drivers after running setup</li>
<li><a href="https://reference.digilentinc.com/vivado/installing-vivado/start#installing_digilent_board_files">Digilent board files</a></li>
</ol>
<p><em>The original Arty (without the A7) is the same physical board so you can use that too.</em></p>
<h3 id="source">Source</h3>
<p>All the designs featured in this tutorial are available in the <a href="https://github.com/projf/projf-explore/tree/master/hello-arty">Exploring FPGAs repo</a>. Look out for the <strong>[src]</strong> links throughout the post for links to the relevant files. All the designs are open source under the permissive MIT licence, but the tutorial itself is subject to normal copyright restrictions.</p>
<h2 id="learning-to-count">Learning to Count</h2>
<p>Think about what happens when you count <a href="https://www.youtube.com/watch?v=M7AAwIWxIpM">1, 2, 3, 4, 5…</a>. You need to <em>remember</em> the current number in order to decide what comes next. If you&rsquo;re interrupted while counting, you lose your place and have to start over. Without memory, you can&rsquo;t count.</p>
<p>In <a href="/posts/hello-arty-1/">part 1</a> our designs had no memory; to put it more abstractly they didn&rsquo;t maintain any <strong>state</strong>.</p>
<p>That&rsquo;s not quite true: when you moved a slide switch, it did maintain its state. Alas, that&rsquo;s not a viable approach for circuit design: the switches are huge, and the FPGA can&rsquo;t move them! Instead, we&rsquo;re going to make use of <strong>flip-flops</strong>.</p>
<p>A flip-flop maintains the state of a single bit. That&rsquo;s right 1 bit. Are you dismayed? Don&rsquo;t be: the FPGA on the Arty board has 40,000 flip-flops, and we don&rsquo;t use them as general-purpose ram (there&rsquo;s other stuff for that). Think of a flip-flop as a teeny, tiny, extremely fast, box for storing something you&rsquo;re working on right now.</p>
<p>When a flip-flop receives a trigger, it updates its bit. You could use any signal to trigger an update, but we&rsquo;ll always use a common clock to trigger our flip-flops simultaneously. Using a common clock ensures that all signals are updated and ready at the same time. Think of the clock like the conductor of an orchestra keeping everyone playing to time. If everyone played at their own speed, the result would be unpleasant!</p>
<p>To see a flip-flop in action watch the LearnElectronics video: <a href="https://youtu.be/OYtGr2faYpw">Digital Logic: D type Flip Flop</a>.</p>
<h3 id="counting-project">Counting Project</h3>
<p>Create a new project in Vivado called <strong><code>hello-arty-2</code></strong> using the same settings as in <a href="/posts/hello-arty-1/">part 1</a>: an RTL Project with the Arty A7-35 board.</p>
<p>Add a new SystemVerilog design source to your project called <code>top.sv</code> with [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/E/top.sv">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">31</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// 32-bit counter
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        led[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">26</span>];
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>In part 1, we used <code>always_comb</code> blocks. Flip-flips require a new type of block: <strong>always_ff</strong>.</p>
<p>Our <code>always_ff</code> block has the positive edge (<code>posedge</code>) of the clock (<code>clk</code>) on its <strong>sensitivity list</strong> <code>@(…)</code>. This means the block is triggered on every rising (positive) edge of <code>clk</code>.</p>
<p>We&rsquo;re using the 100 MHz oscillator on the Arty board as our clock, so we get a rising edge every 10 nanoseconds: this is known as the <strong>clock period</strong>. Every 10 ns our counter <code>cnt</code> increments; when it reaches its maximum value, it rolls over to 0 and repeats. How many seconds does this counter take to roll over?</p>
<p>At the <em>same time</em> as our counter is being incremented, one bit of the counter is being copied to a flip-flop that maintains the LED state. Statements in an <code>always_ff</code> block happen independently and in parallel.</p>
<blockquote>
<p><strong>Quick Aside: Assignment</strong><br>
You may have noticed we snuck in a new type of assignment with flip-flops:</p>
<p><code>always_comb</code> blocks use <code>=</code> for assignment<br>
<code>always_ff</code> blocks use <code>&lt;=</code> for assignment</p>
<p><em>We won&rsquo;t go into the reasons for this right now, but follow this rule and all will be well.</em></p>
</blockquote>
<h3 id="constraints">Constraints</h3>
<p>Add the following <code>arty.xdc</code>constraints file to your project [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/E/arty.xdc">src</a>].</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tcl" data-lang="tcl"><span style="color:#75715e">## FPGA Configuration I/O Options
</span><span style="color:#75715e"></span>set_property CONFIG_VOLTAGE <span style="color:#ae81ff">3.3</span> <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>
set_property CFGBVS VCCO <span style="color:#66d9ef">[</span>current_design<span style="color:#66d9ef">]</span>

<span style="color:#75715e">## Master Clock: 100 MHz
</span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN E3 IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>
create_clock <span style="color:#f92672">-</span>name clk <span style="color:#f92672">-</span>period <span style="color:#ae81ff">10.00</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>clk<span style="color:#66d9ef">}];</span>

<span style="color:#75715e">## LEDs
</span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN H5  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>0<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN J5  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>1<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN T9  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>2<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN T10 IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led<span style="color:#66d9ef">[</span>3<span style="color:#66d9ef">]}];</span>
</code></pre></div><p><em>See <a href="/posts/hello-arty-1/#constraints-file">part 1</a> if you need a reminder on how to add constraints to projects.</em></p>
<p>Note how the period of the clock is set to 10.00 ns. This tells Vivado what the oscillator clock period is: you can&rsquo;t use it to adjust the clock frequency! We&rsquo;ll learn how to generate other frequencies later in this tutorial.</p>
<h3 id="generate--program-bitstream">Generate &amp; Program Bitstream</h3>
<p>We&rsquo;re ready to run this design on our board. We could individually synthesise, implement, and generate bitstream as we learnt in part 1. However, you don&rsquo;t have to run these steps one-by-one: you can select <strong>Generate Bitstream</strong>, and Vivado performs all the necessary steps.</p>
<p>Program your board, and you should see the green LED <strong><code>LD4</code></strong> blinking. We&rsquo;ve wired up bit 26 of our counter to <code>led[0]</code>, so it switches every 2<sup>26</sup> x 10 ns = 0.67 seconds. That&rsquo;s one blink every 1.34 seconds.</p>
<h3 id="blinky-blinky">Blinky, Blinky</h3>
<p>Try replacing the <code>always_ff</code> block in <code>top.sv</code> with [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/F/top.sv">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
    cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    led[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">26</span>];
    led[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">24</span>];
    led[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">22</span>];
    led[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&lt;=</span> cnt[<span style="color:#ae81ff">20</span>];
<span style="color:#66d9ef">end</span>
</code></pre></div><p><em>ProTip: We use snippets to focus on what&rsquo;s changed, but the full design is available via [src].</em></p>
<p>Rerun bitstream generation and program your board. How often is each LED blinking?</p>
<p><img src="/img/posts/hello-arty/blinkenlights.gif" alt="Flashing LEDs" title="Blinkenlights!"></p>
<p><strong><code>LD7</code></strong> on our board (<strong><code>led[3]</code></strong> in Verilog) looks like it&rsquo;s on all time, but is less bright. It&rsquo;s blinking fifty times per second, so fast that your eyes hardly see the flashes. We&rsquo;ll make use of this later.</p>
<h2 id="division-of-time">Division of Time</h2>
<p>Earlier we said we would always use a single clock in our designs. What happens if we want to do something less than 100 million times a second? We could take a bit from a counter, but there&rsquo;s a more elegant way using the <strong>concatenate operator</strong> <code>{a,b,…}</code> and overflow to create a <strong>strobe</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">logic</span> stb;        <span style="color:#75715e">// strobe
</span><span style="color:#75715e"></span><span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt;  <span style="color:#75715e">// 8-bit counter
</span><span style="color:#75715e"></span><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
    {stb, cnt} <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d85</span>;
<span style="color:#66d9ef">end</span>
</code></pre></div><p><em>Thanks to <a href="https://zipcpu.com/blog/2017/06/02/generating-timing.html">Daniel Gisselquist</a> for this design. You&rsquo;ll find many great FPGA resources on <a href="https://zipcpu.com">zipcpu.com</a>.</em></p>
<p>This example divides our clock by three. When the counter overflows, the strobe <code>stb</code> gets set to 1. The next cycle <code>stb</code> goes back to 0 and <code>cnt</code> is left with the remainder.</p>
<p>You may have spotted that our maths is a little iffy. Our counter is eight bits wide (256 possible values), but <code>3 x 85 = 255</code>. Because we&rsquo;re short, occasionally our strobe happens every four, rather than three cycles. With our small 8-bit counter the error is 3%; we can reduce this with a wider counter. For example: with a 16-bit counter 65,536/21,845 = 3.00005. Much better (though it takes more logic on your FPGA).</p>
<p>To use the strobe, you add a test for it inside your always block:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
    <span style="color:#66d9ef">if</span> (stb) <span style="color:#66d9ef">begin</span>
        <span style="color:#75715e">// do something every time the strobe fires
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="every-second-counts">Every Second Counts</h3>
<p>Let&rsquo;s say you want a one-second strobe: our clock is 100 MHz, so need to divide by 100 million! What we need is a counter wide enough to do this precisely: no one wants an inaccurate timer.</p>
<p>Let&rsquo;s try a 40-bit counter: 2<sup>40</sup> / 100 million = 10,995.1. The error is only 1 part in 100,000. Given there are 84,600 seconds in a day this seems like sufficient accuracy for most purposes.</p>
<p>We can use our new second strobe to turn the four green LEDs into a simple binary clock [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/G/top.sv">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    <span style="color:#66d9ef">logic</span> stb;
    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">39</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) {stb, cnt} <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">40</span><span style="color:#ae81ff">&#39;d10995</span>;

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (stb) led <span style="color:#f92672">&lt;=</span> led <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p><em>ProTip: If you only have one statement in a block you don&rsquo;t need <code>begin</code> and <code>end</code>.</em></p>
<h2 id="brighter-dimmer">Brighter, Dimmer</h2>
<p>Earlier we used a counter to blink LEDs. At low switching speeds they blink, but at higher speeds, they look like they&rsquo;re on all the time, but less bright. By altering the <em>proportion</em> of time the signal is high, and hence the LED is illuminated, we can control the perceived brightness. The is known as <strong>pulse width modulation</strong> or <strong>PWM</strong>.</p>
<p>PWN is commonly used in digital circuits to control the speed of motors as well as the brightness of lights (for example in the backlight of LCD screens).</p>
<p>The proportion of time the signal is high is known as the <strong>duty cycle</strong>. An 8-bit value (0-255), is commonly used for the duty cycle. The brightness of the LED is proportional to the duty cycle: for example, if the duty is 64/255, the LED is roughly a quarter as bright.</p>
<p><img src="/img/posts/hello-arty/pwm.jpg" alt="Pulse Width Modulation" title="Pulse Width Modulation"></p>
<p>In the following example, we reduce the brightness of all four LEDs using a small duty cycle of 5/255. Replace the existing module in <code>top.sv</code> with [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/H/top.sv">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;d5</span>;

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        led[<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> (cnt <span style="color:#f92672">&lt;</span> duty) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b1111</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;b0000</span>;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>Run through the usual steps to program your board. The green LEDs should all be very dim; around 2% of maximum brightness.</p>
<p>Try adjusting the <strong>duty</strong> value to different values between 0 and 255 to see how the brightness changes. You can use binary, decimal, or hexadecimal literals as you like.</p>
<h2 id="duty-cycle-module">Duty Cycle Module</h2>
<p>If we wanted to control the brightness of each individual LED using the above approach we&rsquo;d end up with a great deal of duplication. Instead, we can break out the PWM design into a separate Verilog <strong>module</strong>.</p>
<p>The <code>pwm</code> module has inputs and outputs, just like the <code>top</code> module: it takes a duty input between 0 and 255 and produces the expected PWM output.</p>
<p>Create a <strong>new</strong> design source called <code>pwm.sv</code>, being sure to choose SystemVerilog as the file type. The module looks like this [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/I/pwm.sv">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> pwm (
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] duty,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> pwm_out
    );

    <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span><span style="color:#ae81ff">&#39;b0</span>;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        cnt <span style="color:#f92672">&lt;=</span> cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        pwm_out <span style="color:#f92672">=</span> (cnt <span style="color:#f92672">&lt;</span> duty);
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>Note how this design makes use of an <code>always_comb</code> and an <code>always_ff</code> block. <code>pwm_out</code> only depends on its current inputs, so we use as <code>always_comb</code> block.</p>
<blockquote>
<p><strong>Quick Aside: Logic Types</strong></p>
<p><strong>Combinational logic</strong> depends on its present inputs only: it has no memory of the past.
Combinational logic is created with an <code>always_comb</code> block.</p>
<p><strong>Synchronous sequential logic</strong> uses a clock and depends on the past sequence of inputs, as well as the present ones.
Synchronous sequential logic is created with an <code>always_ff</code> block and uses flip-flops.</p>
<p><em>Don&rsquo;t worry if this doesn&rsquo;t make sense right away. Keep designing and come back to it.</em></p>
</blockquote>
<h3 id="duty-to-our-leds">Duty to our LEDs</h3>
<p>To use the <code>pwm</code> module within our <code>top</code> module, we create an instance and connect the inputs and outputs we want to use. Each module instance needs a unique name. We have four LEDs, so we create four instances: <code>pwm_led_0</code>, <code>pwm_led_1</code> etc. Replace your existing <code>top.sv</code> with [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/I/top.sv">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top(
    <span style="color:#66d9ef">input</span> <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>     <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led
    );

    pwm pwm_led_0 (.clk, .duty(<span style="color:#ae81ff">4</span>),   .pwm_out(led[<span style="color:#ae81ff">0</span>]));
    pwm pwm_led_1 (.clk, .duty(<span style="color:#ae81ff">16</span>),  .pwm_out(led[<span style="color:#ae81ff">1</span>]));
    pwm pwm_led_2 (.clk, .duty(<span style="color:#ae81ff">64</span>),  .pwm_out(led[<span style="color:#ae81ff">2</span>]));
    pwm pwm_led_3 (.clk, .duty(<span style="color:#ae81ff">255</span>), .pwm_out(led[<span style="color:#ae81ff">3</span>]));
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>Once you&rsquo;ve programmed your board with the updated design, you should see all four green LEDs lit, getting brighter from <strong><code>LD4</code></strong> to <strong><code>LD7</code></strong>.</p>
<h2 id="red-green-blue">Red, Green, Blue</h2>
<p>This is the 21st century: we don&rsquo;t have to slum it with green LEDs: we have RGB!</p>
<p>An RGB LED isn&rsquo;t really magic: it&rsquo;s a red, green, and blue LED side-by-side. Provided they&rsquo;re close enough together the three component LEDs create the illusion of many different colours. An OLED screen is composed of millions of tiny LEDs. We have four, but it&rsquo;s a start.</p>
<p>Each RGB LED has three pins: one for each of red, green, and blue. We can control them with PWM as if they were three separate LED.</p>
<p>To use the RGB LEDs we need to replace the old LED entries with these new ones [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/J/arty.xdc">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tcl" data-lang="tcl"><span style="color:#75715e">## RGB LEDs
</span><span style="color:#75715e"></span>set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN G6  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_r<span style="color:#66d9ef">[</span>0<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN F6  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_g<span style="color:#66d9ef">[</span>0<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN E1  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_b<span style="color:#66d9ef">[</span>0<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN G3  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_r<span style="color:#66d9ef">[</span>1<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN J4  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_g<span style="color:#66d9ef">[</span>1<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN G4  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_b<span style="color:#66d9ef">[</span>1<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN J3  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_r<span style="color:#66d9ef">[</span>2<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN J2  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_g<span style="color:#66d9ef">[</span>2<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN H4  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_b<span style="color:#66d9ef">[</span>2<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN K1  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_r<span style="color:#66d9ef">[</span>3<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN H6  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_g<span style="color:#66d9ef">[</span>3<span style="color:#66d9ef">]}];</span>
set_property <span style="color:#f92672">-</span>dict <span style="color:#66d9ef">{</span>PACKAGE_PIN K2  IOSTANDARD LVCMOS33<span style="color:#66d9ef">}</span> <span style="color:#66d9ef">[</span>get_ports <span style="color:#66d9ef">{</span>led_b<span style="color:#66d9ef">[</span>3<span style="color:#66d9ef">]}];</span>
</code></pre></div><p>Then replace the top module in <code>top.sv</code> with [<a href="https://github.com/projf/projf-explore/blob/master/hello-arty/J/top.sv">src</a>]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top(
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led_r,
    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led_g,
    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] led_b
    );

    pwm pwm_led_r0 (.clk, .duty(<span style="color:#ae81ff">0</span>),  .pwm_out(led_r[<span style="color:#ae81ff">0</span>]));
    pwm pwm_led_g0 (.clk, .duty(<span style="color:#ae81ff">64</span>), .pwm_out(led_g[<span style="color:#ae81ff">0</span>]));
    pwm pwm_led_b0 (.clk, .duty(<span style="color:#ae81ff">64</span>), .pwm_out(led_b[<span style="color:#ae81ff">0</span>]));
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>The LED <strong><code>LD0</code></strong> should be a cyan colour (50/50 mix of green and blue). If you look closely, you&rsquo;ll see the separate red, green, and blue components.</p>
<p>If you use a duty cycle of 32 for red, 4 for green, and 48 for blue, then you&rsquo;ll get pinky-purple. Try out some different combinations: some colours are easier to create than others. The RGB LEDs are intensely bright, so I recommend limiting your duty values to a maximum of 64.</p>
<p><img src="/img/posts/hello-arty/colour-led.jpeg" alt="Four RGB LEDs" title="All the colours!"></p>
<h2 id="explore">Explore</h2>
<p>Put your new-found LED control skills to the test. Imagine you&rsquo;ve been asked to create a controller for a new RGB-backlit keyboard, but before you get the job, you need to demo two effects:</p>
<ul>
<li><strong>Breath</strong> - one colour slowly fades from off to full brightness and back again</li>
<li><strong>Spectrum</strong> - cycle through all the colours: red, orange, yellow, green, blue, pink, red…</li>
</ul>
<p>Use can use a slide switch to select different effects.</p>
<h2 id="whats-next">What&rsquo;s Next?</h2>
<p>In the final part of this series, we’ll be covering shift registers, button debouncing, and the all-important finite state machine. Part three will be available later in May 2020.</p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/hello-arty-1/">Hello Arty - Part 1</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>©2020 Will Green, Project F</p>
    
  </div>
</section>



<script>
(function(f, a, t, h, o, m){
a[h]=a[h]||function(){
(a[h].q=a[h].q||[]).push(arguments)
};
o=f.createElement('script'),
m=f.getElementsByTagName('script')[0];
o.async=1; o.src=t; o.id='fathom-script';
m.parentNode.insertBefore(o,m)
})(document, window, 'https://cdn.usefathom.com/tracker.js', 'fathom');
fathom('set', 'siteId', 'EVCGKVDN');
fathom('trackPageview');
</script>


</body>
</html>

