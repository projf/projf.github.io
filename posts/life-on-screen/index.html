<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Life on Screen | Project F - FPGA Development</title>

<meta property='og:title' content='Life on Screen - Project F - FPGA Development'>
<meta property='og:description' content='Welcome back to Exploring FPGA Graphics. In this post we&rsquo;re going to use the designs we created in Framebuffers to experiment with Conway&rsquo;s Game of Life.
In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We start by learning how displays work, before racing the beam with Pong, starfields and sprites, simulating life with bitmaps, drawing lines and triangles, and finally creating simple 3D models.'>
<meta property='og:url' content='https://projectf.io/posts/life-on-screen/'>
<meta property='og:site_name' content='Project F - FPGA Development'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/life-on-screen/social-card.jpg'><meta property='article:published_time' content='2020-09-22T00:00:00Z'/><meta property='article:modified_time' content='2020-09-22T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F - FPGA Development" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/life-on-screen/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="referrer" content="no-referrer, same-origin">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F - FPGA Development</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/sitemap">
          <h2 class="title is-5">Sitemap</h2>
        </a><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/explore">
          <h2 class="title is-5">Explore</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/explore/">#explore</a>



  
  | <a class="subtitle is-6" href="/tags/graphics/">#graphics</a>
  


      
    </div>
    <h2 class="subtitle is-6">22 September 2020</h2>
    <h1 class="title">Life on Screen</h1>
    
    <div class="content">
      <p>Welcome back to <em>Exploring FPGA Graphics</em>. In this post we&rsquo;re going to use the designs we created in <a href="/posts/framebuffers/">Framebuffers</a> to experiment with Conway&rsquo;s Game of Life.</p>
<p>In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We start by learning how displays work, before racing the beam with Pong, starfields and sprites, simulating life with bitmaps, drawing lines and triangles, and finally creating simple 3D models. I&rsquo;ll be writing and revising this series throughout 2020. New to the series? Start with <a href="/posts/fpga-graphics/">Exploring FPGA Graphics</a>.</p>
<p><strong>Draft post. Additional content and designs for iCEBreaker are coming.</strong></p>
<p><em>Updated 2020-11-18. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>
<blockquote>
<p>He is Archimedes, Mick Jagger, Salvador Dal√≠, and Richard Feynman, all rolled into one.<br>
<em>The Guardian, <a href="https://www.theguardian.com/science/2015/jul/23/john-horton-conway-the-most-charismatic-mathematician-in-the-world">John Horton Conway: the world&rsquo;s most charismatic mathematician</a> (2015)</em></p>
</blockquote>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li><a href="/posts/fpga-graphics/">Exploring FPGA Graphics</a> - learn how displays work and animate simple shapes</li>
<li><a href="/posts/fpga-pong/">FPGA Pong</a> - race the beam to create the arcade classic</li>
<li><a href="/posts/hardware-sprites/">Hardware Sprites</a> - fast, colourful, graphics with minimal resources</li>
<li><a href="/posts/fpga-ad-astra/">FPGA Ad Astra</a> - demo with hardware sprites and animated starfields</li>
<li><a href="/posts/framebuffers/">Framebuffers</a> - driving the display from a bitmap in memory</li>
<li>Life on Screen (this post) - the screen comes alive with Conway&rsquo;s Game of Life</li>
</ul>
<p><em>More parts to follow.</em></p>
<h3 id="requirements">Requirements</h3>
<p>For this series, you need an FPGA board with video output. We&rsquo;ll be working at 640x480, so pretty much any video output will do. You should be comfortable with programming your FPGA board and reasonably familiar with Verilog.</p>
<p>We&rsquo;ll be demoing with these boards (FPGA type):</p>
<ul>
<li><strong><a href="https://docs.icebreaker-fpga.org/hardware/icebreaker/">iCEBreaker</a></strong> (Lattice iCE40) with <strong><a href="https://docs.icebreaker-fpga.org/hardware/pmod/dvi/">12-Bit DVI Pmod</a></strong>
(designs available soon)</li>
<li><strong><a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a></strong> (Xilinx Artix-7) with <strong><a href="https://reference.digilentinc.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a></strong></li>
</ul>
<h3 id="source">Source</h3>
<p>The SystemVerilog designs featured in this series are available from the <a href="https://github.com/projf/projf-explore/">projf-explore</a> repo on GitHub. The designs are open source hardware under the permissive MIT licence, but this blog is subject to normal copyright restrictions.</p>
<h2 id="conways-life">Conway&rsquo;s Life</h2>
<p>John Conway was a remarkable mathematician, active in many fields, who sadly died in 2020. Conway is best known to the public for recreational mathematics with Martin Gardner in Scientific American. I remember playing <a href="https://en.wikipedia.org/wiki/Sprouts_(game)">Sprouts</a> at school and trying to impress people by calculating the day of the week with the <a href="https://en.wikipedia.org/wiki/Doomsday_rule">Doomsday rule</a>. For now, I&rsquo;ll be limiting myself to Game of Life, but I highly recommend learning more of Conway: <a href="https://www.theguardian.com/science/2015/jul/23/john-horton-conway-the-most-charismatic-mathematician-in-the-world">The world&rsquo;s most charismatic mathematician</a> is an excellent place to start.</p>
<p>Game of Life first appeared in the <em>Mathematical Games</em> column in the October 1970 issue of Scientific American. Anyone can access the article at <a href="https://www.ibiblio.org/lifepatterns/october1970.html">ibiblio.org</a>, or you can see a scan of the original at <a href="https://www.jstor.org/stable/24927642">JSTOR</a> (requires login via academic institution or library).</p>
<h3 id="the-rules-of-life">The Rules of Life</h3>
<p>The universe of the Game of Life is an infinite, two-dimensional, grid of cells. A cell is one of two states: dead or alive. Every cell interacts with its eight neighbours (those to the left, right, top, bottom, and the four diagonals).</p>
<p>The following rules determine the fate of a cell in the next generation:</p>
<ol>
<li>Survival: Every cell with two or three neighbours survives.</li>
<li>Deaths:<br>
a. Every cell with four or more neighbours dies from overpopulation.<br>
b. Every cell with zero or one neighbours dies from isolation.</li>
<li>Births: Every empty cell with exactly three neighbours comes to life.</li>
</ol>
<p>To understand this, it helps to see some practical examples. Common patterns within the Life universe have been given names. The diagram below shows two patterns: &ldquo;Beehive&rdquo; and &ldquo;Beacon&rdquo;.</p>
<p><img src="/img/posts/life-on-screen/life-examples.jpg" alt="Conway&rsquo;s Life Examples" title="Life Examples: Beehive &amp; Beacon"></p>
<p>Every live cell in the <strong>Beehive</strong> pattern has two or three neighbours: so, no cells die. No dead cells in Beehive have three neighbours: so, no cells come to life. This pattern is categorised as a &ldquo;still life&rdquo;, because it doesn&rsquo;t change from one generation to the next.</p>
<p>The <strong>Beacon</strong> pattern is a bit more interesting: it oscillates between two states. Two dead cells in the centre of the pattern have three neighbours, so come to life. However, they then have four neighbours, so die the next generation due to overcrowding: this pattern repeats endlessly.</p>
<p>However, things start to get <em>really</em> interesting with slightly more complex patters. The following photo shows the <strong>Gosper glider gun</strong>, which repeatedly generates small repeating patterns called gliders.</p>
<p><img src="/img/posts/life-on-screen/gosper-glider-gun.jpg" alt="Gosper Glider Gun" title="The Gosper glider gun repeatedly generates small gliders."></p>
<p>It&rsquo;s even possible to construct logic gates using gliders, and ultimately a universal Turing machine. As this post is primarily about FPGA graphics, we&rsquo;re not going to dig further into the possibilities of Conway&rsquo;s Life, but check out Wikipedia&rsquo;s article on <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Conway&rsquo;s Game of Life</a>.</p>
<h3 id="life-in-hardware">Life in Hardware</h3>
<p>Now we have a basic understanding of Conway&rsquo;s Life we&rsquo;re going to create a hardware implementation in Verilog.</p>
<p>We start by rearranging the rules to simplify the design:</p>
<ol>
<li>If a cell is alive<br>
a. if it has 2 or 3 neighbours, it&rsquo;s alive next generation<br>
b. otherwise, it&rsquo;s dead next generation</li>
<li>If a cell is dead<br>
a. if it has 3 neighbours, it&rsquo;s alive next generation<br>
b. otherwise, it&rsquo;s dead next generation</li>
</ol>
<p>Handily, a bitmap is a two-dimensional grid as required by Life, but our bitmap won&rsquo;t be infinite! Instead, our bitmap wraps around top and bottom, and between left and right: this is known as <a href="https://en.wikipedia.org/wiki/Torus">toroidal</a> array. Contrast this with a 2D map of Earth: which wraps around at the east and west, but not at the north and south.</p>
<p>Since a cell&rsquo;s state depends on all those around it, we can&rsquo;t calculate the new state of each cell sequentially in one bitmap. Instead, we have two buffers: one contains the current generation that we use to calculate the next generation. We swap buffers, repeating the process. This <strong>double buffering</strong> also allows us to safely update the display without risking any artefacts or tearing: the display is always being driven from a complete bitmap. Our life module is ignorant of the two buffers, this will be handled in the controlling top module, with reads and writes directed to different offsets.</p>
<p>Create a life module with the following design - <strong><a href="https://github.com/projf/projf-explore/blob/master/life-on-screen/life.sv">life.sv</a></strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> life #(
    <span style="color:#66d9ef">parameter</span> WORLD_WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,
    <span style="color:#66d9ef">parameter</span> WORLD_HEIGHT<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,
    <span style="color:#66d9ef">parameter</span> ADDRW<span style="color:#f92672">=</span>$clog2(WORLD_WIDTH <span style="color:#f92672">*</span> WORLD_HEIGHT)
    ) (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> start,
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> run,
    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] id,
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> r_status,
    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> w_status,
    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> we,
    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> done
    );

    <span style="color:#75715e">// simulation parameters
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CELL_COUNT <span style="color:#f92672">=</span> WORLD_WIDTH <span style="color:#f92672">*</span> WORLD_HEIGHT;  <span style="color:#75715e">// total number of cells
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> NEIGHBOURS_COUNT <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;  <span style="color:#75715e">// number of neighbours each cell has
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// number of alive neighbours (could be eight!)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(NEIGHBOURS_COUNT<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] neighbours_alive;

    <span style="color:#75715e">// internal cell and neighbour IDs
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cid, cid_next;
    <span style="color:#66d9ef">logic</span> [ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] nid;  <span style="color:#75715e">// adding nid_next would improve timing slack
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(NEIGHBOURS_COUNT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] npos, npos_next;

    <span style="color:#75715e">// simulation state (once started, only stops after updating a cell)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {IDLE, NEXT_CELL, NEIGHBOURS, CURRENT_CELL, UPDATE_CELL} state, state_next;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">case</span>(state)
            IDLE: state_next <span style="color:#f92672">=</span> (start <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>done) <span style="color:#f92672">?</span> NEXT_CELL <span style="color:#f92672">:</span> IDLE;
            NEXT_CELL: <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (done) <span style="color:#66d9ef">begin</span>
                    state_next <span style="color:#f92672">=</span> IDLE;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (run) <span style="color:#66d9ef">begin</span>
                    state_next <span style="color:#f92672">=</span> NEIGHBOURS;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                    state_next <span style="color:#f92672">=</span> NEXT_CELL;
                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span>
            NEIGHBOURS: state_next <span style="color:#f92672">=</span> (npos <span style="color:#f92672">==</span> NEIGHBOURS_COUNT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> CURRENT_CELL <span style="color:#f92672">:</span> NEIGHBOURS;
            CURRENT_CELL: state_next <span style="color:#f92672">=</span> UPDATE_CELL;
            UPDATE_CELL: state_next <span style="color:#f92672">=</span> NEXT_CELL;
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> state_next <span style="color:#f92672">=</span> IDLE;
        <span style="color:#66d9ef">endcase</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        state <span style="color:#f92672">&lt;=</span> state_next;
        cid <span style="color:#f92672">&lt;=</span> cid_next;
        npos <span style="color:#f92672">&lt;=</span> npos_next;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// simulation calculations
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        we <span style="color:#f92672">=</span> (state <span style="color:#f92672">==</span> UPDATE_CELL) <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// enable writing when updating
</span><span style="color:#75715e"></span>        id <span style="color:#f92672">=</span> cid;
        npos_next <span style="color:#f92672">=</span> npos;
        cid_next <span style="color:#f92672">=</span> cid;
        w_status <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">case</span>(state)
            IDLE: <span style="color:#66d9ef">begin</span>
                cid_next <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                nid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                npos_next <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span>
            NEIGHBOURS: <span style="color:#66d9ef">begin</span>
                <span style="color:#75715e">// map neighbour index onto ID
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">case</span> (npos)
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d0</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">-</span> (WORLD_WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d1</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">-</span> WORLD_WIDTH;
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d2</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">-</span> (WORLD_WIDTH <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d3</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d4</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d5</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">+</span> (WORLD_WIDTH <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d6</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">+</span> WORLD_WIDTH;
                    <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d7</span><span style="color:#f92672">:</span> nid <span style="color:#f92672">=</span> cid <span style="color:#f92672">+</span> (WORLD_WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
                <span style="color:#66d9ef">endcase</span>

                <span style="color:#75715e">// because the life universe wraps we need to correct for possible under/overflow
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (nid <span style="color:#f92672">&gt;=</span> CELL_COUNT) <span style="color:#66d9ef">begin</span>
                    <span style="color:#66d9ef">if</span> (npos <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d3</span>) <span style="color:#66d9ef">begin</span>
                        nid <span style="color:#f92672">=</span> CELL_COUNT <span style="color:#f92672">-</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>ADDRW <span style="color:#f92672">-</span> nid);
                    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                        nid <span style="color:#f92672">=</span> nid <span style="color:#f92672">-</span> CELL_COUNT;
                    <span style="color:#66d9ef">end</span>
                <span style="color:#66d9ef">end</span>

                npos_next <span style="color:#f92672">=</span> (state <span style="color:#f92672">==</span> NEIGHBOURS) <span style="color:#f92672">?</span> npos <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
                id <span style="color:#f92672">=</span> nid;
            <span style="color:#66d9ef">end</span>
            UPDATE_CELL: <span style="color:#66d9ef">begin</span>
                <span style="color:#66d9ef">if</span> (r_status <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// if cell is currently alive
</span><span style="color:#75715e"></span>                    w_status <span style="color:#f92672">=</span> (neighbours_alive <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d2</span> <span style="color:#f92672">||</span> neighbours_alive <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d3</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// or dead
</span><span style="color:#75715e"></span>                    w_status <span style="color:#f92672">=</span> (neighbours_alive <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d3</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">end</span>

                <span style="color:#75715e">// ready for next cell
</span><span style="color:#75715e"></span>                cid_next <span style="color:#f92672">=</span> (cid <span style="color:#f92672">&lt;</span> CELL_COUNT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> cid <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span>
            <span style="color:#75715e">// consider adding a default case
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">endcase</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">case</span>(state)
            IDLE: <span style="color:#66d9ef">begin</span>
                neighbours_alive <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span>
            <span style="color:#75715e">// BRAM takes one cycle to read data, so we need to offset by one cycle
</span><span style="color:#75715e"></span>            NEIGHBOURS: <span style="color:#66d9ef">if</span> (npos <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;d1</span>) neighbours_alive <span style="color:#f92672">&lt;=</span> neighbours_alive <span style="color:#f92672">+</span> {<span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;b0</span>, r_status};
            CURRENT_CELL: neighbours_alive <span style="color:#f92672">&lt;=</span> neighbours_alive <span style="color:#f92672">+</span> {<span style="color:#ae81ff">3</span><span style="color:#ae81ff">&#39;b0</span>, r_status};
            UPDATE_CELL: <span style="color:#66d9ef">begin</span>
                <span style="color:#75715e">// prepare for next cell
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (cid <span style="color:#f92672">&lt;</span> CELL_COUNT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
                    neighbours_alive <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                    done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">endcase</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>Our module is a simple finite state machine (FSM) that reads all eight neighbours for each cell. This isn&rsquo;t the most efficient design in terms of memory access: you could reuse the previous neighbour reads at the cost of slightly more complex logic. I may improve this module at a future date.</p>
<p>The cell under consideration is <code>cid</code> (between 0 and 4,799). <code>npos</code> is the position of a neighbour relative to the cell we&rsquo;re dealing with (1 is top left, 2 top middle, 3 top right etc.), while <code>nid</code> is position in the bitmap of the neighbour (again between 0 and 4,799). <em>Further details on the operation of the Life module will be added in later drafts.</em></p>
<p>To exercise this module we have a test bench for Vivado: <strong><a href="https://github.com/projf/projf-explore/tree/master/life-on-screen/xc7/life_tb.sv">life_tb.sv</a></strong>. If you have a Xilinx Vivado installed, try using the test bench with the included test seed files. You can find instructions for running the simulation in the source <a href="https://github.com/projf/projf-explore/tree/master/life-on-screen">README</a>.</p>
<h3 id="top-life">Top Life</h3>
<p>Now we have our simulation design, we&rsquo;re ready to draw it with a framebuffer. We can use the design from the <a href="/posts/framebuffers/">Framebuffers</a> post, with the dimensions set to 80x60 and the depth to 1 bit. However, as already discussed, we need a double buffer to run the simulation; we&rsquo;ve used one larger buffer and an offset to select the front and back portions. The front buffer is read by the display controller and life simulation, and the back buffer is written to by the simulation.</p>
<blockquote>
<p><strong>Quick Aside: iCE40 BRAM Ports</strong><br>
The iCE40 FPGA has pseudo dual-port BRAM; you can read from one port, and write to the other, but you can&rsquo;t read and write to the same port. This explains our somewhat curious buffer design.</p>
</blockquote>
<p>The linebuffer and life simulation need to share read access to the front buffer. We use a simple arbitration technique: the life simulation gets to read the buffer in the vertical blanking interval, when the linebuffer is idle. We need at least three frames to complete a full simulation with this arbitration method, so <code>GEN_FRAMES</code> in <code>top_life</code>, below, must be set to at least 3.</p>
<p><strong>New linebuffer module will be added shortly, see <a href="/posts/framebuffers/">framebuffers</a> for current linebuffer design.</strong></p>
<ul>
<li>Xilinx XC7: <strong><a href="https://github.com/projf/projf-explore/blob/master/life-on-screen/xc7/top_life.sv">xc7/top_life.sv</a></strong></li>
<li>Lattice iCE40: <em>coming soon</em></li>
</ul>
<p>The Xilinx version is shown below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top_life (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button (active low)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span><span style="color:#75715e"></span>    );

    <span style="color:#66d9ef">parameter</span> GEN_FRAMES <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>;  <span style="color:#75715e">// each generation lasts this many frames
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> SEED_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;simple_life.mem&#34;</span>;  <span style="color:#75715e">// seed to initiate universe with
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// generate pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
    <span style="color:#66d9ef">logic</span> clk_locked;
    clock_gen clock_640x480 (
       .clk(clk_100m),
       .rst(<span style="color:#f92672">!</span>btn_rst),  <span style="color:#75715e">// reset button is active low
</span><span style="color:#75715e"></span>       .clk_pix,
       .clk_locked
    );

    <span style="color:#75715e">// display timings
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;  <span style="color:#75715e">// screen coordinate width in bits
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] sx, sy;
    <span style="color:#66d9ef">logic</span> de;
    display_timings timings_640x480 (
        .clk_pix,
        .rst(<span style="color:#f92672">!</span>clk_locked),  <span style="color:#75715e">// wait for clock lock
</span><span style="color:#75715e"></span>        .sx,
        .sy,
        .hsync(vga_hsync),
        .vsync(vga_vsync),
        .de
    );

    <span style="color:#75715e">// size of screen with and without blanking
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> H_RES_FULL <span style="color:#f92672">=</span> <span style="color:#ae81ff">800</span>;
    <span style="color:#66d9ef">localparam</span> V_RES_FULL <span style="color:#f92672">=</span> <span style="color:#ae81ff">525</span>;
    <span style="color:#66d9ef">localparam</span> H_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span>;
    <span style="color:#66d9ef">localparam</span> V_RES <span style="color:#f92672">=</span> <span style="color:#ae81ff">480</span>;

    <span style="color:#66d9ef">logic</span> frame_end;   <span style="color:#75715e">// high for one clycle at the end of a frame
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        frame_end <span style="color:#f92672">=</span> (sy <span style="color:#f92672">==</span> V_RES_FULL<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> sx <span style="color:#f92672">==</span> H_RES_FULL<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// framebuffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_COUNT  <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// double buffered
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_WIDTH  <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>;
    <span style="color:#66d9ef">localparam</span> FB_HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>;
    <span style="color:#66d9ef">localparam</span> FB_PIXELS <span style="color:#f92672">=</span> FB_WIDTH <span style="color:#f92672">*</span> FB_HEIGHT;
    <span style="color:#66d9ef">localparam</span> FB_DEPTH  <span style="color:#f92672">=</span> FB_COUNT <span style="color:#f92672">*</span> FB_PIXELS;
    <span style="color:#66d9ef">localparam</span> FB_ADDRW  <span style="color:#f92672">=</span> $clog2(FB_DEPTH);
    <span style="color:#66d9ef">localparam</span> FB_DATAW  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// colour bits per pixel
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">logic</span> fb_we;
    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_addr_read, fb_addr_write;
    <span style="color:#66d9ef">logic</span> [FB_DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] pix_in, pix_out;

    bram_sdp #(
        .WIDTH(FB_DATAW),
        .DEPTH(FB_DEPTH),
        .INIT_F(SEED_FILE)
    ) framebuffer (
        .clk_read(clk_pix),
        .clk_write(clk_pix),
        .we(fb_we),
        .addr_write(fb_addr_write),
        .addr_read(fb_addr_read),
        .data_in(pix_in),
        .data_out(pix_out)
    );

    <span style="color:#75715e">// update frame counter and choose front buffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> life_start;    <span style="color:#75715e">// trigger next calculation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> front_buffer;  <span style="color:#75715e">// which buffer to draw the display from
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(GEN_FRAMES)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_frames;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (frame_end) cnt_frames <span style="color:#f92672">&lt;=</span> cnt_frames <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">if</span> (cnt_frames <span style="color:#f92672">==</span> GEN_FRAMES <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
            front_buffer <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">~</span>front_buffer;
            cnt_frames <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            life_start <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> life_start <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">logic</span> life_run;
    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cell_id;
    life #(
        .WORLD_WIDTH(FB_WIDTH),
        .WORLD_HEIGHT(FB_HEIGHT),
        .ADDRW(FB_ADDRW)
    ) life_sim (
        .clk(clk_pix),
        .start(life_start),
        .run(life_run),
        .id(cell_id),
        .r_status(pix_out),
        .w_status(pix_in),
        .we(fb_we),
        .done()
    );

    <span style="color:#75715e">// linebuffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LB_SCALE_V <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;                <span style="color:#75715e">// factor to scale vertical drawing
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LB_SCALE_H <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;                <span style="color:#75715e">// factor to scale horizontal drawing
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LB_LINE  <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span> <span style="color:#f92672">/</span> LB_SCALE_H;   <span style="color:#75715e">// line length
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LB_ADDRW <span style="color:#f92672">=</span> $clog2(LB_LINE);    <span style="color:#75715e">// line address width
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> LB_WIDTH <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;                  <span style="color:#75715e">// bits per colour channel
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// linebuffer read port
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [LB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb_addr_read;
    <span style="color:#66d9ef">logic</span> [LB_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb0_out, lb1_out, lb2_out;

    <span style="color:#75715e">// linebuffer write port (latency corrected for reading from FB)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> lb_we, lb_we_l1;
    <span style="color:#66d9ef">logic</span> [LB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb_addr_write, lb_addr_write_l1;
    <span style="color:#66d9ef">logic</span> [LB_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb0_in, lb1_in, lb2_in;

    <span style="color:#75715e">// latency correction for reading framebuffer BRAM (1 cycle)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        lb_we_l1 <span style="color:#f92672">&lt;=</span> lb_we;
        lb_addr_write_l1 <span style="color:#f92672">&lt;=</span> lb_addr_write;
    <span style="color:#66d9ef">end</span>

    linebuffer #(
        .WIDTH(LB_WIDTH),
        .DEPTH(LB_LINE)
        ) lb (
        .clk_write(clk_pix),
        .clk_read(clk_pix),
        .we(lb_we_l1),                  <span style="color:#75715e">// corrects for BRAM latency
</span><span style="color:#75715e"></span>        .addr_write(lb_addr_write_l1),  <span style="color:#75715e">// corrects for BRAM latency
</span><span style="color:#75715e"></span>        .addr_read(lb_addr_read),
        .data_in_0(lb0_in),
        .data_in_1(lb1_in),
        .data_in_2(lb2_in),
        .data_out_0(lb0_out),
        .data_out_1(lb1_out),
        .data_out_2(lb2_out)
    );

    <span style="color:#75715e">// linebuffer state machine for reading framebuffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(FB_HEIGHT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]  fb_line_cnt;  <span style="color:#75715e">// count of framebuffer lines
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(LB_SCALE_V)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb_line_rpt;  <span style="color:#75715e">// repeat line based on scale
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// linebuffer addresses for accessing framebuffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb_fb_addr_read;

    <span style="color:#66d9ef">enum</span> {
        IDLE,       <span style="color:#75715e">// awaiting start signal
</span><span style="color:#75715e"></span>        START,      <span style="color:#75715e">// prepare for new frame
</span><span style="color:#75715e"></span>        AWAIT_POS,  <span style="color:#75715e">// await horizontal position
</span><span style="color:#75715e"></span>        START_LINE, <span style="color:#75715e">// begin a new line
</span><span style="color:#75715e"></span>        READ_FB,    <span style="color:#75715e">// read fb into lb
</span><span style="color:#75715e"></span>        IDLE_LINE,  <span style="color:#75715e">// do nothing on this line
</span><span style="color:#75715e"></span>        LINE_DONE   <span style="color:#75715e">// line read complete
</span><span style="color:#75715e"></span>    } state, state_next;

    <span style="color:#66d9ef">logic</span> hblank_start;    <span style="color:#75715e">// start of horizontal blanking
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> fb_last_line;    <span style="color:#75715e">// last line of framebuffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> fb_last_pixel;   <span style="color:#75715e">// last pixel of framebuffer line
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> start_fb_to_lb;  <span style="color:#75715e">// start copying data from fb to lb
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> fb_read_line;    <span style="color:#75715e">// do we need to read fb on current line?
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        hblank_start    <span style="color:#f92672">=</span> (sx <span style="color:#f92672">==</span> H_RES);
        fb_last_line    <span style="color:#f92672">=</span> (fb_line_cnt <span style="color:#f92672">==</span> FB_HEIGHT<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
        fb_last_pixel   <span style="color:#f92672">=</span> (lb_addr_write <span style="color:#f92672">==</span> FB_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
        start_fb_to_lb  <span style="color:#f92672">=</span> (sy <span style="color:#f92672">==</span> V_RES_FULL<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
        fb_read_line    <span style="color:#f92672">=</span> (lb_line_rpt <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// determine next state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">case</span>(state)
            IDLE:       state_next <span style="color:#f92672">=</span> (start_fb_to_lb) <span style="color:#f92672">?</span> START <span style="color:#f92672">:</span> IDLE;
            START:      state_next <span style="color:#f92672">=</span> AWAIT_POS;
            AWAIT_POS:  state_next <span style="color:#f92672">=</span> hblank_start <span style="color:#f92672">?</span> START_LINE <span style="color:#f92672">:</span> AWAIT_POS;
            START_LINE: state_next <span style="color:#f92672">=</span> fb_read_line <span style="color:#f92672">?</span> READ_FB <span style="color:#f92672">:</span> AWAIT_POS;
            READ_FB:    state_next <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>fb_last_pixel <span style="color:#f92672">?</span> READ_FB <span style="color:#f92672">:</span> LINE_DONE;
            LINE_DONE:  state_next <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>fb_last_line <span style="color:#f92672">?</span> AWAIT_POS <span style="color:#f92672">:</span> IDLE;
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>    state_next <span style="color:#f92672">=</span> IDLE;
        <span style="color:#66d9ef">endcase</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        state <span style="color:#f92672">&lt;=</span> state_next;  <span style="color:#75715e">// advance to next state
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">// reset framebuffer position at start of frame
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> START) <span style="color:#66d9ef">begin</span>
            lb_fb_addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            fb_line_cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            lb_line_rpt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>

        <span style="color:#75715e">// reset pixel count and linebuffer write address
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> AWAIT_POS) <span style="color:#66d9ef">begin</span>
            lb_addr_write <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>

        <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> START_LINE) <span style="color:#66d9ef">begin</span>
            <span style="color:#75715e">/* verilator lint_off WIDTH */</span>
            <span style="color:#66d9ef">if</span> (lb_line_rpt <span style="color:#f92672">==</span> LB_SCALE_V<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
            <span style="color:#75715e">/* verilator lint_on WIDTH */</span>
                fb_line_cnt <span style="color:#f92672">&lt;=</span> fb_line_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                lb_line_rpt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>
                lb_line_rpt <span style="color:#f92672">&lt;=</span> lb_line_rpt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>

        <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> READ_FB) <span style="color:#66d9ef">begin</span>
            lb_we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
            lb_addr_write <span style="color:#f92672">&lt;=</span> lb_addr_write <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            lb_fb_addr_read <span style="color:#f92672">&lt;=</span> lb_fb_addr_read <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span>

        <span style="color:#66d9ef">if</span> (state <span style="color:#f92672">==</span> LINE_DONE) <span style="color:#66d9ef">begin</span>
            lb_we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// linebuffer read address (display reads from)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(LB_SCALE_H)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] lb_pix_rpt;  <span style="color:#75715e">// repeat pixel based on scale
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (sx <span style="color:#f92672">==</span> H_RES_FULL<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// address 0 when H_RES_FULL-1, so we need -2 (latency=1)
</span><span style="color:#75715e"></span>            lb_addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            lb_pix_rpt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (lb_addr_read <span style="color:#f92672">&lt;</span> LB_LINE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
            lb_pix_rpt <span style="color:#f92672">&lt;=</span> (lb_pix_rpt <span style="color:#f92672">&lt;</span> LB_SCALE_H<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> lb_pix_rpt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">if</span> (lb_pix_rpt <span style="color:#f92672">==</span> LB_SCALE_H<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) lb_addr_read <span style="color:#f92672">&lt;=</span> lb_addr_read <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// sim can run when linebuffer is not using framebuffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> life_run <span style="color:#f92672">=</span> (state <span style="color:#f92672">==</span> IDLE);

    <span style="color:#75715e">// read into line buffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        fb_addr_read <span style="color:#f92672">=</span> (life_run) <span style="color:#f92672">?</span> cell_id <span style="color:#f92672">:</span> lb_fb_addr_read;
        <span style="color:#66d9ef">if</span> (front_buffer <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) fb_addr_read <span style="color:#f92672">=</span> fb_addr_read <span style="color:#f92672">+</span> FB_PIXELS;
        fb_addr_write <span style="color:#f92672">=</span> (front_buffer <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> cell_id <span style="color:#f92672">:</span> cell_id <span style="color:#f92672">+</span> FB_PIXELS;
        {lb2_in, lb1_in, lb0_in} <span style="color:#f92672">=</span> pix_out <span style="color:#f92672">?</span> <span style="color:#ae81ff">12&#39;hFFF</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">12&#39;h009</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// VGA output
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        vga_r <span style="color:#f92672">=</span> de <span style="color:#f92672">?</span> lb2_out <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
        vga_g <span style="color:#f92672">=</span> de <span style="color:#f92672">?</span> lb1_out <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
        vga_b <span style="color:#f92672">=</span> de <span style="color:#f92672">?</span> lb0_out <span style="color:#f92672">:</span> <span style="color:#ae81ff">4&#39;h0</span>;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>And we need a constraints file for our design:</p>
<ul>
<li>Xilinx XC7: <strong><a href="https://github.com/projf/projf-explore/blob/master/life-on-screen/xc7/arty.xdc">arty.xdc</a></strong></li>
<li>Lattice iCE40: <em>coming soon</em></li>
</ul>
<p>You should be able to build this design and see the simple example with a beehive, blinker, toad, and beacon patterns.</p>
<blockquote>
<p><strong>Building the Designs</strong><br>
In the <a href="https://github.com/projf/projf-explore/tree/master/life-on-screen">Life on Screen</a> section of the git repo, you&rsquo;ll find the design files, a makefile for iCEBreaker, a Vivado project for Arty, and instructions for building the designs for both boards.</p>
</blockquote>
<p>If that works, try the Gosper glider gun by changing the seed file in <code>top_life.sv</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">parameter</span> SEED_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gosper_glider.mem&#34;</span>;  <span style="color:#75715e">// seed to initiate universe with
</span></code></pre></div><p>The Gosper pattern repeatedly generates small gliders that move down the screen. Our glider gun doesn&rsquo;t continue indefinitely because our universe wraps around: the gliders interfere with the gun pattern, and the universe eventually breaks down, before settling into a pattern of simple oscillators and still lives. It&rsquo;s straightforward to update the life module not to wrap around: imagine a world bordered by dead cells.</p>
<p>You can also change how fast the simulation runs by changing the value of <code>GEN_FRAMES</code> (a value of 60 makes each generation last 1 second):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">parameter</span> GEN_FRAMES  <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>;  <span style="color:#75715e">// each generation lasts this many frames
</span></code></pre></div><h2 id="explore">Explore</h2>
<p>I hope you enjoyed this (draft) instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few suggestions to get you started:</p>
<ul>
<li>Experiment with your own Game of Life seed files</li>
<li>Implement a Universal Turing Machine using Life: take a look at <a href="http://www.rendell-attic.org/gol/tm.htm">Paul Rendell&rsquo;s Attic</a> to get started</li>
</ul>
<p><em>More ideas to follow&hellip;</em></p>
<h2 id="next-time">Next Time</h2>
<p>In the next part, we&rsquo;ll learn about drawing lines: the basis of most 2D and 3D graphics. Follow <a href="https://twitter.com/WillFlux">@WillFlux</a> for news on this and other FPGA posts.</p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/fpga-pong/">FPGA Pong</a></li>
	
	<li><a href="/posts/fpga-ad-astra/">FPGA Ad Astra</a></li>
	
	<li><a href="/posts/fpga-graphics/">Exploring FPGA Graphics</a></li>
	
	<li><a href="/posts/video-timings-vga-720p-1080p/">Video Timings: VGA, SVGA, 720p, 1080p</a></li>
	
	<li><a href="/posts/hello-arty-2/">Hello Arty - Part 2</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>¬©2020 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://narwhal.projectf.io/script.js" site="EVCGKVDN" defer></script>
</body>
</html>

