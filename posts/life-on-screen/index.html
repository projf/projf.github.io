<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-gb">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Life on Screen | Project F - FPGA Development</title>

<meta property='og:title' content='Life on Screen - Project F - FPGA Development'>
<meta property='og:description' content='Welcome back to Exploring FPGA Graphics. In this post we&rsquo;re going to use the designs we created in Framebuffers to experiment with Conway&rsquo;s Game of Life.
In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how displays work, race the beam with Pong, animate starfields and sprites, paint Michelangelo&rsquo;s David, simulate life with bitmaps, draw lines and shapes, and finally render simple 3D models.'>
<meta property='og:url' content='https://projectf.io/posts/life-on-screen/'>
<meta property='og:site_name' content='Project F - FPGA Development'>
<meta property='og:type' content='article'><meta property='og:image' content='https://projectf.io/img/posts/life-on-screen/social-card.jpg'><meta property='article:published_time' content='2020-09-22T00:00:00Z'/><meta property='article:modified_time' content='2020-09-22T00:00:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@WillFlux'><meta name='twitter:creator' content='@WillFlux'>


<link href="https://projectf.io/index.xml" rel="alternate" type="application/rss+xml" title="Project F - FPGA Development" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://projectf.io/posts/life-on-screen/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="referrer" content="no-referrer, same-origin">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://projectf.io">
          <h1 id="nav-heading" class="title is-4">Project F - FPGA Development</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/projf'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/WillFlux'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="youtube" href='https://youtube.com/channel/UCaT0lvfWo1GStbp0neg8weg'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">About</h2>
        </a><a class="nav-item" href="/sitemap">
          <h2 class="title is-5">Sitemap</h2>
        </a><a class="nav-item" href="/tags/cookbook">
          <h2 class="title is-5">Cookbook</h2>
        </a><a class="nav-item" href="/tags/explore">
          <h2 class="title is-5">Explore</h2>
        </a><a class="nav-item" href="/tags/tools">
          <h2 class="title is-5">Tools</h2>
        </a></div>
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/explore/">#explore</a>



  
  | <a class="subtitle is-6" href="/tags/graphics/">#graphics</a>
  


      
    </div>
    <h2 class="subtitle is-6">22 September 2020</h2>
    <h1 class="title">Life on Screen</h1>
    
    <div class="content">
      <p>Welcome back to <em>Exploring FPGA Graphics</em>. In this post we&rsquo;re going to use the designs we created in <a href="/posts/framebuffers/">Framebuffers</a> to experiment with Conway&rsquo;s Game of Life.</p>
<p>In this series, we explore graphics at the hardware level and get a feel for the power of FPGAs. We&rsquo;ll learn how displays work, race the beam with Pong, animate starfields and sprites, paint Michelangelo&rsquo;s David, simulate life with bitmaps, draw lines and shapes, and finally render simple 3D models. New to the series? Start with <a href="/posts/fpga-graphics/">FPGA Graphics</a>.</p>
<p><em>Updated 2021-05-12. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>
<blockquote>
<p>He is Archimedes, Mick Jagger, Salvador Dal√≠, and Richard Feynman, all rolled into one.<br>
<em>The Guardian, <a href="https://www.theguardian.com/science/2015/jul/23/john-horton-conway-the-most-charismatic-mathematician-in-the-world">John Horton Conway: the world&rsquo;s most charismatic mathematician</a> (2015)</em></p>
</blockquote>
<h3 id="series-outline">Series Outline</h3>
<ul>
<li><a href="/posts/fpga-graphics/">FPGA Graphics</a> - learn how displays work and animate simple shapes</li>
<li><a href="/posts/fpga-pong/">Pong</a> - race the beam to create the arcade classic</li>
<li><a href="/posts/hardware-sprites/">Hardware Sprites</a> - fast, colourful, graphics with minimal resources</li>
<li><a href="/posts/fpga-ad-astra/">Ad Astra</a> - demo with hardware sprites and animated starfields</li>
<li><a href="/posts/framebuffers/">Framebuffers</a> - driving the display from a bitmap in memory</li>
<li>Life on Screen (this post) - the screen comes alive with Conway&rsquo;s Game of Life</li>
<li><a href="/posts/lines-and-triangles/">Lines and Triangles</a> - drawing lines and triangles with a framebuffer</li>
<li><a href="/posts/fpga-shapes/">2D Shapes</a> - filling and animating shapes</li>
<li>Simple 3D - models and wireframe rendering (draft coming soon)</li>
</ul>
<h3 id="requirements">Requirements</h3>
<p>For this series, you need an FPGA board with video output. We&rsquo;ll be working at 640x480, so pretty much any video output will do. It helps to be comfortable with programming your FPGA board and reasonably familiar with Verilog.</p>
<p>We&rsquo;ll be demoing with these boards (FPGA type):</p>
<ul>
<li><strong><a href="https://docs.icebreaker-fpga.org/hardware/icebreaker/">iCEBreaker</a></strong> (Lattice iCE40) with <strong><a href="https://docs.icebreaker-fpga.org/hardware/pmod/dvi/">12-Bit DVI Pmod</a></strong></li>
<li><strong><a href="https://reference.digilentinc.com/reference/programmable-logic/arty-a7/reference-manual">Digilent Arty A7-35T</a></strong> (Xilinx Artix-7) with <strong><a href="https://reference.digilentinc.com/reference/pmod/pmodvga/reference-manual">Pmod VGA</a></strong></li>
</ul>
<h3 id="source">Source</h3>
<p>The SystemVerilog designs featured in this series are available from the <a href="https://github.com/projf/projf-explore/">projf-explore</a> git repo under the open-source MIT licence: build on them to your heart&rsquo;s content. The rest of the blog content is subject to standard copyright restrictions: don&rsquo;t republish it without permission.</p>
<h2 id="conways-life">Conway&rsquo;s Life</h2>
<p>John Conway was a remarkable mathematician, active in many fields, who sadly died in 2020. Conway is best known to the public for recreational mathematics with Martin Gardner in Scientific American. I remember playing <a href="https://en.wikipedia.org/wiki/Sprouts_(game)">Sprouts</a> at school and trying to impress people by calculating the day of the week with the <a href="https://en.wikipedia.org/wiki/Doomsday_rule">Doomsday rule</a>. For now, I&rsquo;ll be limiting myself to Game of Life, but I highly recommend learning more of Conway: <a href="https://www.theguardian.com/science/2015/jul/23/john-horton-conway-the-most-charismatic-mathematician-in-the-world">The world&rsquo;s most charismatic mathematician</a> is an excellent place to start.</p>
<p>Game of Life first appeared in the <em>Mathematical Games</em> column in the October 1970 issue of Scientific American. Anyone can access the article at <a href="https://www.ibiblio.org/lifepatterns/october1970.html">ibiblio.org</a>, or you can see a scan of the original at <a href="https://www.jstor.org/stable/24927642">JSTOR</a> (requires login via academic institution or library).</p>
<h3 id="the-rules-of-life">The Rules of Life</h3>
<p>The universe of the Game of Life is an infinite, two-dimensional, grid of cells. A cell is one of two states: dead or alive. Every cell interacts with its eight neighbours (those to the left, right, top, bottom, and the four diagonals).</p>
<p>The following rules determine the fate of a cell in the next generation:</p>
<ol>
<li>Survival: Every cell with two or three neighbours survives.</li>
<li>Deaths:<br>
a. Every cell with four or more neighbours dies from overpopulation.<br>
b. Every cell with zero or one neighbours dies from isolation.</li>
<li>Births: Every empty cell with exactly three neighbours comes to life.</li>
</ol>
<p>To understand this, it helps to see some practical examples. Common patterns within the Life universe have been given names. The diagram below shows two patterns: &ldquo;Beehive&rdquo; and &ldquo;Beacon&rdquo;.</p>
<p><img src="/img/posts/life-on-screen/life-examples.jpg" alt="Conway&rsquo;s Life Examples" title="Life Examples: Beehive &amp; Beacon"></p>
<p>Every live cell in the <strong>Beehive</strong> pattern has two or three neighbours: so, no cells die. No dead cells in Beehive have three neighbours: so, no cells come to life. This pattern is categorised as a &ldquo;still life&rdquo;, because it doesn&rsquo;t change from one generation to the next.</p>
<p>The <strong>Beacon</strong> pattern is a bit more interesting: it oscillates between two states. Two dead cells in the centre of the pattern have three neighbours, so come to life. However, they then have four neighbours, so die the next generation due to overcrowding: this pattern repeats endlessly.</p>
<p>However, things start to get <em>really</em> interesting with slightly more complex patters. The following photo shows the <strong>Gosper glider gun</strong> running on the Arty board. The gun repeatedly generates small patterns called gliders that step across the world.</p>
<p><img src="/img/posts/life-on-screen/gosper-glider-gun.jpg" alt="Gosper Glider Gun" title="The Gosper glider gun repeatedly generates small gliders."></p>
<p>It&rsquo;s even possible to construct logic gates using gliders, and ultimately a universal Turing machine. As this post is primarily about FPGA graphics, we&rsquo;re not going to dig further into the esoteric possibilities of Conway&rsquo;s Life, but check out Wikipedia&rsquo;s article on <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Conway&rsquo;s Game of Life</a>.</p>
<h3 id="a-hard-life">A Hard Life</h3>
<p>Now we have a basic understanding of Life, we&rsquo;re going to create a hardware implementation.</p>
<p>Let&rsquo;s start by rearranging the rules to simplify the design:</p>
<ol>
<li>If a cell is alive<br>
a. if it has 2 or 3 neighbours, it&rsquo;s alive next generation<br>
b. otherwise, it&rsquo;s dead next generation</li>
<li>If a cell is dead<br>
a. if it has 3 neighbours, it&rsquo;s alive next generation<br>
b. otherwise, it&rsquo;s dead next generation</li>
</ol>
<p>We need a two-dimensional array to hold our world. Our memory array obviously can&rsquo;t be infinite, so we need a way to handle the edges.</p>
<ol>
<li>Surround the world with a border of dead cells</li>
<li>Wrap the world around at left and right, and at top and bottom</li>
</ol>
<p>Both approaches have their advantages and disadvantages, so we&rsquo;ll support both, but start with option 1.</p>
<p>Since a cell&rsquo;s state depends on all those around it, we can&rsquo;t calculate the new state of each cell with one array. Instead, we have two array (or buffers): one contains the current generation; we use it to calculate the next generation in the second buffer. Every generation, we swap buffers and repeat the generation process.</p>
<p>Create a life module with the following design - <strong>[<a href="https://github.com/projf/projf-explore/blob/master/graphics/life-on-screen/life.sv">life.sv</a>]</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> life #(
    <span style="color:#66d9ef">parameter</span> CORDW<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>,   <span style="color:#75715e">// signed coordinate width
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> WIDTH<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,    <span style="color:#75715e">// world width in cells
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> HEIGHT<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,   <span style="color:#75715e">// world height in cells
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">parameter</span> F_INIT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>   <span style="color:#75715e">// initial world state
</span><span style="color:#75715e"></span>    ) (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk,      <span style="color:#75715e">// clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> rst,      <span style="color:#75715e">// reset
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> start,    <span style="color:#75715e">// start generation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> ready,    <span style="color:#75715e">// cell state ready to be read
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> alive,    <span style="color:#75715e">// is the cell alive? (when ready)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> changed,  <span style="color:#75715e">// cell&#39;s state changed (when ready)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] x,  <span style="color:#75715e">// horizontal cell position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] y,  <span style="color:#75715e">// vertical cell position
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> running,  <span style="color:#75715e">// life is running
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> done      <span style="color:#75715e">// generation complete (high for one tick)
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// world buffer selection
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> next_gen;  <span style="color:#75715e">// where to write the next generation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#66d9ef">if</span> (start) next_gen <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">~</span>next_gen;  <span style="color:#75715e">// swap every generation
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (rst) next_gen <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// world in BRAM
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> DATAW <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// cells are either dead or alive
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> WORLD_WIDTH  <span style="color:#f92672">=</span> WIDTH  <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// wider to handle boundary
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> WORLD_HEIGHT <span style="color:#f92672">=</span> HEIGHT <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">// taller to handle boundary
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> WORLD_CELLS <span style="color:#f92672">=</span> WORLD_WIDTH <span style="color:#f92672">*</span> WORLD_HEIGHT;
    <span style="color:#66d9ef">localparam</span> DEPTH <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> WORLD_CELLS;
    <span style="color:#66d9ef">localparam</span> ADDRW <span style="color:#f92672">=</span> $clog2(DEPTH);

    <span style="color:#66d9ef">logic</span> we;
    <span style="color:#66d9ef">logic</span> [ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cell_id, addr_read;  <span style="color:#75715e">// cell_id is basis of write address
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [DATAW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] data_in, data_out;

    <span style="color:#75715e">// add offset to read and write addresses to match buffer used
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [ADDRW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] addr_read_offs, addr_write_offs;
    <span style="color:#66d9ef">always_comb</span> <span style="color:#66d9ef">begin</span>
        addr_read_offs <span style="color:#f92672">=</span> addr_read <span style="color:#f92672">+</span> ((next_gen) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> WORLD_CELLS);
        addr_write_offs <span style="color:#f92672">=</span> cell_id <span style="color:#f92672">+</span> ((next_gen) <span style="color:#f92672">?</span> WORLD_CELLS <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">end</span>

    bram_sdp #(
        .WIDTH(DATAW),
        .DEPTH(DEPTH),
        .INIT_F(F_INIT)
    ) bram_inst (
        .clk_write(clk),
        .clk_read(clk),
        .we,
        .addr_write(addr_write_offs),
        .addr_read(addr_read_offs),
        .data_in,
        .data_out
    );

    <span style="color:#75715e">// cell coordinates
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> GRID <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;    <span style="color:#75715e">// neighbours are a 3x3 grid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> STEPS <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>;  <span style="color:#75715e">// 9 reads and 2 cycles of latency
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(WORLD_WIDTH)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>]  cell_x;  <span style="color:#75715e">// active cell (horizontal)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(WORLD_HEIGHT)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cell_y;  <span style="color:#75715e">// active cell (vertical)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(STEPS)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] read_step;      <span style="color:#75715e">// reading step
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> inc_read;                           <span style="color:#75715e">// perform incremental read
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [GRID<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] top_sr, mid_sr, bot_sr;  <span style="color:#75715e">// shift reg for neighbours
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(GRID<span style="color:#f92672">*</span>GRID)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] neigh_cnt;  <span style="color:#75715e">// count of neighbours
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// life generation state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">enum</span> {IDLE, INIT, READ, NEIGH, UPDATE, NEW_CELL, NEW_LINE} state;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk) <span style="color:#66d9ef">begin</span>
        <span style="color:#75715e">// single-cycle flags: 0 by default
</span><span style="color:#75715e"></span>        ready <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">case</span>(state)
            INIT: <span style="color:#66d9ef">begin</span>
                read_step <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                inc_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                top_sr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                mid_sr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                bot_sr <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                neigh_cnt <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                state <span style="color:#f92672">&lt;=</span> READ;
                running <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;

                <span style="color:#75715e">// first cell after padding
</span><span style="color:#75715e"></span>                cell_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                cell_y <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                cell_id <span style="color:#f92672">&lt;=</span> WORLD_WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">end</span>
            READ: <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// 1 cycle to set address and 1 cycle BRAM read latency
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">case</span> (read_step)
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d0</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">-</span> WORLD_WIDTH <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// A
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d1</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// B
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d2</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">+</span> WORLD_WIDTH <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// C
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>inc_read) top_sr <span style="color:#f92672">&lt;=</span> {top_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// A
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d3</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">-</span> WORLD_WIDTH;  <span style="color:#75715e">// D
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>inc_read) mid_sr <span style="color:#f92672">&lt;=</span> {mid_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// B
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d4</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id;  <span style="color:#75715e">// E
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>inc_read) bot_sr <span style="color:#f92672">&lt;=</span> {bot_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// C
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d5</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">+</span> WORLD_WIDTH;  <span style="color:#75715e">// F
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>inc_read) top_sr <span style="color:#f92672">&lt;=</span> {top_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// D
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d6</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">-</span> WORLD_WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// G
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>inc_read) mid_sr <span style="color:#f92672">&lt;=</span> {mid_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// E
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d7</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// H
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>inc_read) bot_sr <span style="color:#f92672">&lt;=</span> {bot_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// F
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d8</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        addr_read <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">+</span> WORLD_WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// I
</span><span style="color:#75715e"></span>                        top_sr <span style="color:#f92672">&lt;=</span> {top_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// G
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d9</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        mid_sr <span style="color:#f92672">&lt;=</span> {mid_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// H
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#ae81ff">4</span><span style="color:#ae81ff">&#39;d10</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">begin</span>
                        bot_sr <span style="color:#f92672">&lt;=</span> {bot_sr[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>], data_out};  <span style="color:#75715e">// I
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">end</span>
                    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> addr_read <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                <span style="color:#66d9ef">endcase</span>

                <span style="color:#66d9ef">if</span> (read_step <span style="color:#f92672">==</span> STEPS<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) state <span style="color:#f92672">&lt;=</span> NEIGH;
                <span style="color:#66d9ef">else</span> read_step <span style="color:#f92672">&lt;=</span> read_step <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#66d9ef">end</span>
            NEIGH: <span style="color:#66d9ef">begin</span>
                neigh_cnt <span style="color:#f92672">&lt;=</span> top_sr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> top_sr[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> top_sr[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span>
                             mid_sr[<span style="color:#ae81ff">0</span>]             <span style="color:#f92672">+</span> mid_sr[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span>
                             bot_sr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> bot_sr[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> bot_sr[<span style="color:#ae81ff">2</span>];
                state <span style="color:#f92672">&lt;=</span> UPDATE;
            <span style="color:#66d9ef">end</span>
            UPDATE: <span style="color:#66d9ef">begin</span>
                <span style="color:#75715e">// update cell state
</span><span style="color:#75715e"></span>                we <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;     <span style="color:#75715e">// write new cell state next cycle
</span><span style="color:#75715e"></span>                ready <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// ready for output next cycle
</span><span style="color:#75715e"></span>                x <span style="color:#f92672">&lt;=</span> cell_x <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// correct horizontal position for padding
</span><span style="color:#75715e"></span>                y <span style="color:#f92672">&lt;=</span> cell_y <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// correct vertical position for padding
</span><span style="color:#75715e"></span>
                <span style="color:#66d9ef">if</span> (mid_sr[<span style="color:#ae81ff">1</span>]) <span style="color:#66d9ef">begin</span> <span style="color:#75715e">// cell was alive this generation
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (neigh_cnt <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">||</span> neigh_cnt <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// still alive
</span><span style="color:#75715e"></span>                        data_in <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                        alive <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                        changed <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// now dead
</span><span style="color:#75715e"></span>                        data_in <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                        alive <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                        changed <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                    <span style="color:#66d9ef">end</span>
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// was dead this generation
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (neigh_cnt <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// now alive
</span><span style="color:#75715e"></span>                        data_in <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                        alive <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                        changed <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// still dead
</span><span style="color:#75715e"></span>                        data_in <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                        alive <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                        changed <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                    <span style="color:#66d9ef">end</span>
                <span style="color:#66d9ef">end</span>

                <span style="color:#75715e">// what next?
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (cell_x <span style="color:#f92672">==</span> WORLD_WIDTH<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// final cell on line
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (cell_y <span style="color:#f92672">==</span> WORLD_HEIGHT<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">begin</span>  <span style="color:#75715e">// final line of cells
</span><span style="color:#75715e"></span>                        state <span style="color:#f92672">&lt;=</span> IDLE;
                        running <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
                        done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                    <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> state <span style="color:#f92672">&lt;=</span> NEW_LINE;
                <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> state <span style="color:#f92672">&lt;=</span> NEW_CELL;
            <span style="color:#66d9ef">end</span>
            NEW_CELL: <span style="color:#66d9ef">begin</span>
                cell_x <span style="color:#f92672">&lt;=</span> cell_x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                cell_id <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                inc_read  <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// incremental read
</span><span style="color:#75715e"></span>                read_step <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">6</span>;  <span style="color:#75715e">// read new column of 3 cells (skip A-F)
</span><span style="color:#75715e"></span>                state <span style="color:#f92672">&lt;=</span> READ;
            <span style="color:#66d9ef">end</span>
            NEW_LINE: <span style="color:#66d9ef">begin</span>
                cell_y <span style="color:#f92672">&lt;=</span> cell_y <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
                cell_x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                cell_id <span style="color:#f92672">&lt;=</span> cell_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">// skip 2 cells of padding
</span><span style="color:#75715e"></span>                read_step <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// read all nine cells at start of line
</span><span style="color:#75715e"></span>                state <span style="color:#f92672">&lt;=</span> READ;
            <span style="color:#66d9ef">end</span>
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> state <span style="color:#f92672">&lt;=</span> (start) <span style="color:#f92672">?</span> INIT <span style="color:#f92672">:</span> IDLE;  <span style="color:#75715e">// IDLE
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">endcase</span>
        <span style="color:#66d9ef">if</span> (rst) <span style="color:#66d9ef">begin</span>
            state <span style="color:#f92672">&lt;=</span> IDLE;
            ready <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            alive <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            changed <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            y <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            running <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            done <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p><em>Explanation of life module will be added shortly.</em></p>
<p>To exercise this module we have a test bench for Vivado: <strong><a href="https://github.com/projf/projf-explore/tree/master/graphics/life-on-screen/xc7/life_tb.sv">life_tb.sv</a></strong>. If you have a Xilinx Vivado installed, try using the test bench with the included test seed files. You can find instructions for running the simulation in the design <a href="https://github.com/projf/projf-explore/tree/master/life-on-screen">README</a>.</p>
<h3 id="top-life">Top Life</h3>
<p>Now we have our life sim, we&rsquo;re ready to render it with the design from <a href="/posts/framebuffers/">Framebuffers</a>.</p>
<ul>
<li>Arty (XC7): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/life-on-screen/xc7/top_life.sv">xc7/top_life.sv</a></strong></li>
<li>iCEBreaker (iCE40): <strong><a href="https://github.com/projf/projf-explore/blob/master/graphics/life-on-screen/ice40/top_life.sv">ice40/top_life.sv</a></strong></li>
</ul>
<p>The Arty version is shown below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">module</span> top_life (
    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> clk_100m,     <span style="color:#75715e">// 100 MHz clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">input</span>  <span style="color:#66d9ef">wire</span> <span style="color:#66d9ef">logic</span> btn_rst,      <span style="color:#75715e">// reset button (active low)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_hsync,    <span style="color:#75715e">// horizontal sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> vga_vsync,    <span style="color:#75715e">// vertical sync
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_r,  <span style="color:#75715e">// 4-bit VGA red
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_g,  <span style="color:#75715e">// 4-bit VGA green
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">output</span>      <span style="color:#66d9ef">logic</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] vga_b   <span style="color:#75715e">// 4-bit VGA blue
</span><span style="color:#75715e"></span>    );

    <span style="color:#66d9ef">localparam</span> GEN_FRAMES <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>;  <span style="color:#75715e">// each generation lasts this many frames
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> SEED_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;simple_64x48.mem&#34;</span>;  <span style="color:#75715e">// world seed
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// generate pixel clock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> clk_pix;
    <span style="color:#66d9ef">logic</span> clk_locked;
    clock_gen_480p clock_pix_inst (
       .clk(clk_100m),
       .rst(<span style="color:#f92672">!</span>btn_rst),  <span style="color:#75715e">// reset button is active low
</span><span style="color:#75715e"></span>       .clk_pix,
       .clk_locked
    );

    <span style="color:#75715e">// display timings
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> CORDW <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
    <span style="color:#66d9ef">logic</span> hsync, vsync;
    <span style="color:#66d9ef">logic</span> de, frame, line;
    display_timings_480p #(.CORDW(CORDW)) display_timings_inst (
        .clk_pix,
        .rst(<span style="color:#f92672">!</span>clk_locked),  <span style="color:#75715e">// wait for pixel clock lock
</span><span style="color:#75715e"></span>        .sx(),
        .sy(),
        .hsync,
        .vsync,
        .de,
        .frame,
        .line
    );

    <span style="color:#66d9ef">logic</span> frame_sys;  <span style="color:#75715e">// start of new frame in system clock domain
</span><span style="color:#75715e"></span>    xd xd_frame (.clk_i(clk_pix), .clk_o(clk_100m),
                 .rst_i(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>), .rst_o(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>), .i(frame), .o(frame_sys));

    <span style="color:#75715e">// life signals
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> life_start, life_alive, life_changed;

    <span style="color:#75715e">// start life generation in blanking every GEN_FRAMES
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [$clog2(GEN_FRAMES)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] cnt_frames;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_100m) <span style="color:#66d9ef">begin</span>
        life_start <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">if</span> (frame_sys) <span style="color:#66d9ef">begin</span>
            <span style="color:#66d9ef">if</span> (cnt_frames <span style="color:#f92672">==</span> GEN_FRAMES<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">begin</span>
                life_start <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>;
                cnt_frames <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">else</span> cnt_frames <span style="color:#f92672">&lt;=</span> cnt_frames <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// framebuffer (FB)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">localparam</span> FB_WIDTH   <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>;
    <span style="color:#66d9ef">localparam</span> FB_HEIGHT  <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span>;
    <span style="color:#66d9ef">localparam</span> FB_CIDXW   <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
    <span style="color:#66d9ef">localparam</span> FB_CHANW   <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
    <span style="color:#66d9ef">localparam</span> FB_SCALE   <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
    <span style="color:#66d9ef">localparam</span> FB_IMAGE   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
    <span style="color:#66d9ef">localparam</span> FB_PALETTE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;life_palette.mem&#34;</span>;

    <span style="color:#66d9ef">logic</span> fb_we;
    <span style="color:#66d9ef">logic</span> <span style="color:#66d9ef">signed</span> [CORDW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fbx, fby;  <span style="color:#75715e">// framebuffer coordinates
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> [FB_CIDXW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_cidx;
    <span style="color:#66d9ef">logic</span> [FB_CHANW<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>] fb_red, fb_green, fb_blue;  <span style="color:#75715e">// colours for display
</span><span style="color:#75715e"></span>
    framebuffer #(
        .WIDTH(FB_WIDTH),
        .HEIGHT(FB_HEIGHT),
        .CIDXW(FB_CIDXW),
        .CHANW(FB_CHANW),
        .SCALE(FB_SCALE),
        .F_IMAGE(FB_IMAGE),
        .F_PALETTE(FB_PALETTE)
    ) fb_inst (
        .clk_sys(clk_100m),
        .clk_pix,
        .rst_sys(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
        .rst_pix(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),
        .de,
        .frame,
        .line,
        .we(fb_we),
        .x(fbx),
        .y(fby),
        .cidx(fb_cidx),
        .clip(),
        .red(fb_red),
        .green(fb_green),
        .blue(fb_blue)
    );

    <span style="color:#75715e">// select colour based on cell state
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_comb</span> fb_cidx <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>, life_alive};

    life #(
        .CORDW(CORDW),
        .WIDTH(FB_WIDTH),
        .HEIGHT(FB_HEIGHT),
        .F_INIT(SEED_FILE)
    ) life_inst (
        .clk(clk_100m),          <span style="color:#75715e">// clock
</span><span style="color:#75715e"></span>        .rst(<span style="color:#ae81ff">1</span><span style="color:#ae81ff">&#39;b0</span>),              <span style="color:#75715e">// reset
</span><span style="color:#75715e"></span>        .start(life_start),      <span style="color:#75715e">// start generation
</span><span style="color:#75715e"></span>        .ready(fb_we),           <span style="color:#75715e">// cell state ready to be read
</span><span style="color:#75715e"></span>        .alive(life_alive),      <span style="color:#75715e">// is the cell alive? (when ready)
</span><span style="color:#75715e"></span>        .changed(life_changed),  <span style="color:#75715e">// cell&#39;s state changed (when ready)
</span><span style="color:#75715e"></span>        .x(fbx),                 <span style="color:#75715e">// horizontal cell position
</span><span style="color:#75715e"></span>        .y(fby),                 <span style="color:#75715e">// vertical cell position
</span><span style="color:#75715e"></span>        .running(),              <span style="color:#75715e">// life is running
</span><span style="color:#75715e"></span>        .done()                  <span style="color:#75715e">// generation complete (high for one tick)
</span><span style="color:#75715e"></span>    );

    <span style="color:#75715e">// reading from FB takes one cycle: delay display signals to match
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">logic</span> hsync_p1, vsync_p1;
    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        hsync_p1 <span style="color:#f92672">&lt;=</span> hsync;
        vsync_p1 <span style="color:#f92672">&lt;=</span> vsync;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">// VGA output
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">always_ff</span> @(<span style="color:#66d9ef">posedge</span> clk_pix) <span style="color:#66d9ef">begin</span>
        vga_hsync <span style="color:#f92672">&lt;=</span> hsync_p1;
        vga_vsync <span style="color:#f92672">&lt;=</span> vsync_p1;
        vga_r <span style="color:#f92672">&lt;=</span> fb_red;
        vga_g <span style="color:#f92672">&lt;=</span> fb_green;
        vga_b <span style="color:#f92672">&lt;=</span> fb_blue;
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">endmodule</span>
</code></pre></div><p>We use a 64x48 world, which is a tenth of the 640x480 screen dimensions. With the padding of dead cells, each world array has <code>66 x 50 = 3,300</code> cells, which comfortably fits into 4Kb (though iCEBreaker BRAM has a minimum width of two bits, so it uses two BRAMs per world buffer).</p>
<blockquote>
<p><strong>Building the Designs</strong><br>
In the <a href="https://github.com/projf/projf-explore/tree/master/graphics/life-on-screen">Life on Screen</a> section of the git repo, you&rsquo;ll find the design files, a makefile for iCEBreaker, a Vivado project for Arty, and instructions for building the designs for both boards.</p>
</blockquote>
<p>Once you&rsquo;ve programmed your board, you should see a simple test pattern of oscillators and a still life.
If that works, try the Gosper glider gun by changing the seed file in <code>top_life.sv</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">localparam</span> SEED_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gosper_gun_64x48.mem&#34;</span>;  <span style="color:#75715e">// world seed
</span></code></pre></div><p>The Gosper pattern repeatedly generates small gliders that move down the screen. Our gliders doesn&rsquo;t continue indefinitely because our world is currently surrounded by dead cells, which kill the gliders when they collide with it.</p>
<p>You can also change how fast Life runs by adjusting <code>GEN_FRAMES</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-verilog" data-lang="verilog"><span style="color:#66d9ef">localparam</span> GEN_FRAMES <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;  <span style="color:#75715e">// each generation lasts this many frames
</span></code></pre></div><p>At 60 frames per second, a value of &lsquo;4&rsquo; results in 15 generations per second.</p>
<h2 id="wrap-around">Wrap Around</h2>
<p>Let&rsquo;s wrap our world around at left and right, and at top and bottom; this is known as a <a href="https://en.wikipedia.org/wiki/Torus">toroidal</a> array. Contrast a toroidal array with a 2D map of Earth: the map wraps around at the east and west, but <em>not</em> at the north and south.</p>
<p><em>Design in progress</em></p>
<h2 id="explore">Explore</h2>
<p>I hope you enjoyed this (draft) instalment of <em>Exploring FPGA Graphics</em>, but nothing beats creating your own designs. Here are a few suggestions to get you started:</p>
<ul>
<li>Experiment with your own Life seed. Start with empty seed: <code>res/seeds/empty_64x48.mem</code></li>
<li>Use <code>changed</code> from the life module to colour cells when they&rsquo;re born or die</li>
<li>Implement a Universal Turing Machine with Life: take a look at <a href="http://www.rendell-attic.org/gol/tm.htm">Paul Rendell&rsquo;s Attic</a></li>
</ul>
<p><em>More ideas to follow&hellip;</em></p>
<h2 id="next-time">Next Time</h2>
<p>In part seven of this series, we&rsquo;ll learn how to draw <a href="/posts/lines-and-triangles/">Lines and Triangles</a>: the basis of 2D and 3D graphics.</p>
<p><em>Constructive feedback is always welcome. Get in touch with <a href="https://twitter.com/WillFlux">@WillFlux</a> or open an <a href="https://github.com/projf/projf-explore/issues">issue on GitHub</a>.</em></p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/posts/fpga-pong/">Pong</a></li>
	
	<li><a href="/posts/fpga-ad-astra/">Ad Astra</a></li>
	
	<li><a href="/posts/fpga-graphics/">FPGA Graphics</a></li>
	
	<li><a href="/posts/video-timings-vga-720p-1080p/">Video Timings: VGA, SVGA, 720p, 1080p</a></li>
	
	<li><a href="/posts/hello-arty-2/">Hello Arty - Part 2</a></li>
	
</ul>
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>¬©2021 Will Green, Project F</p>
    
  </div>
</section>


<script src="https://narwhal.projectf.io/script.js" site="EVCGKVDN" defer></script>
</body>
</html>

